{
  "version": 3,
  "sources": ["../../node_modules/inkjs/src/engine/Path.ts", "../../node_modules/inkjs/src/engine/Debug.ts", "../../node_modules/inkjs/src/engine/Value.ts", "../../node_modules/inkjs/src/engine/PushPop.ts", "../../node_modules/inkjs/src/engine/Error.ts", "../../node_modules/inkjs/src/engine/TypeAssertion.ts", "../../node_modules/inkjs/src/engine/NullException.ts", "../../node_modules/inkjs/src/engine/Object.ts", "../../node_modules/inkjs/src/engine/StringBuilder.ts", "../../node_modules/inkjs/src/engine/InkList.ts", "../../node_modules/inkjs/src/engine/StoryException.ts", "../../node_modules/inkjs/src/engine/TryGetResult.ts", "../../node_modules/inkjs/src/engine/SearchResult.ts", "../../node_modules/inkjs/src/engine/Container.ts", "../../node_modules/inkjs/src/engine/Glue.ts", "../../node_modules/inkjs/src/engine/ControlCommand.ts", "../../node_modules/inkjs/src/engine/Pointer.ts", "../../node_modules/inkjs/src/engine/Divert.ts", "../../node_modules/inkjs/src/engine/ChoicePoint.ts", "../../node_modules/inkjs/src/engine/VariableReference.ts", "../../node_modules/inkjs/src/engine/VariableAssignment.ts", "../../node_modules/inkjs/src/engine/Void.ts", "../../node_modules/inkjs/src/engine/NativeFunctionCall.ts", "../../node_modules/inkjs/src/engine/Tag.ts", "../../node_modules/inkjs/src/engine/Choice.ts", "../../node_modules/inkjs/src/engine/ListDefinition.ts", "../../node_modules/inkjs/src/engine/ListDefinitionsOrigin.ts", "../../node_modules/inkjs/src/engine/JsonSerialisation.ts", "../../node_modules/inkjs/src/engine/CallStack.ts", "../../node_modules/inkjs/src/engine/VariablesState.ts", "../../node_modules/inkjs/src/engine/PRNG.ts", "../../node_modules/inkjs/src/engine/StatePatch.ts", "../../node_modules/inkjs/src/engine/SimpleJson.ts", "../../node_modules/inkjs/src/engine/Flow.ts", "../../node_modules/inkjs/src/engine/StoryState.ts", "../../node_modules/inkjs/src/engine/StopWatch.ts", "../../node_modules/inkjs/src/engine/Story.ts", "../../src/js/notification-manager.js", "../../src/js/ink-functions.js", "../../src/js/error-manager.js", "../../src/js/base-modal.js", "../../src/js/story-manager.js", "../../src/js/tag-registry.js", "../../src/js/utils.js", "../../src/js/keyboard-shortcuts.js", "../../src/js/keyboard-help-modal.js", "../../src/js/markdown-processor.js", "../../src/js/dom-helpers.js", "../../src/js/display-manager.js", "../../src/js/content-processor.js", "../../src/js/tag-processor.js", "../../src/js/settings-manager.js", "../../src/js/settings-modal.js", "../../src/js/page-manager.js", "../../src/js/choice-manager.js", "../../src/js/navigation-manager.js", "../../src/js/saves-modal.js", "../../src/js/version.js", "../../src/js/error-modal.js", "../../src/js/saves-manager.js", "../../src/js/main.js"],
  "sourcesContent": ["export class Path {\n  public static parentId = \"^\";\n\n  public _isRelative: boolean;\n  public _components: Path.Component[];\n  public _componentsString: string | null;\n\n  constructor();\n  constructor(componentsString: string);\n  constructor(head: Path.Component, tail: Path);\n  constructor(head: Path.Component[], relative?: boolean);\n  constructor() {\n    this._components = [];\n    this._componentsString = null;\n    this._isRelative = false;\n\n    if (typeof arguments[0] == \"string\") {\n      let componentsString = arguments[0] as string;\n      this.componentsString = componentsString;\n    } else if (\n      arguments[0] instanceof Path.Component &&\n      arguments[1] instanceof Path\n    ) {\n      let head = arguments[0] as Path.Component;\n      let tail = arguments[1] as Path;\n      this._components.push(head);\n      this._components = this._components.concat(tail._components);\n    } else if (arguments[0] instanceof Array) {\n      let head = arguments[0] as Path.Component[];\n      let relative = !!arguments[1] as boolean;\n      this._components = this._components.concat(head);\n      this._isRelative = relative;\n    }\n  }\n  get isRelative() {\n    return this._isRelative;\n  }\n  get componentCount(): number {\n    return this._components.length;\n  }\n  get head(): Path.Component | null {\n    if (this._components.length > 0) {\n      return this._components[0];\n    } else {\n      return null;\n    }\n  }\n  get tail(): Path {\n    if (this._components.length >= 2) {\n      // careful, the original code uses length-1 here. This is because the second argument of\n      // List.GetRange is a number of elements to extract, wherease Array.slice uses an index\n      let tailComps = this._components.slice(1, this._components.length);\n      return new Path(tailComps);\n    } else {\n      return Path.self;\n    }\n  }\n  get length(): number {\n    return this._components.length;\n  }\n  get lastComponent(): Path.Component | null {\n    let lastComponentIdx = this._components.length - 1;\n    if (lastComponentIdx >= 0) {\n      return this._components[lastComponentIdx];\n    } else {\n      return null;\n    }\n  }\n  get containsNamedComponent(): boolean {\n    for (let i = 0, l = this._components.length; i < l; i++) {\n      if (!this._components[i].isIndex) {\n        return true;\n      }\n    }\n    return false;\n  }\n  static get self(): Path {\n    let path = new Path();\n    path._isRelative = true;\n    return path;\n  }\n\n  public GetComponent(index: number): Path.Component {\n    return this._components[index];\n  }\n  public PathByAppendingPath(pathToAppend: Path): Path {\n    let p = new Path();\n\n    let upwardMoves = 0;\n    for (let i = 0; i < pathToAppend._components.length; ++i) {\n      if (pathToAppend._components[i].isParent) {\n        upwardMoves++;\n      } else {\n        break;\n      }\n    }\n\n    for (let i = 0; i < this._components.length - upwardMoves; ++i) {\n      p._components.push(this._components[i]);\n    }\n\n    for (let i = upwardMoves; i < pathToAppend._components.length; ++i) {\n      p._components.push(pathToAppend._components[i]);\n    }\n\n    return p;\n  }\n  get componentsString(): string {\n    if (this._componentsString == null) {\n      this._componentsString = this._components.join(\".\");\n      if (this.isRelative)\n        this._componentsString = \".\" + this._componentsString;\n    }\n\n    return this._componentsString;\n  }\n  set componentsString(value: string) {\n    this._components.length = 0;\n\n    this._componentsString = value;\n\n    if (this._componentsString == null || this._componentsString == \"\") return;\n\n    if (this._componentsString[0] == \".\") {\n      this._isRelative = true;\n      this._componentsString = this._componentsString.substring(1);\n    }\n\n    let componentStrings = this._componentsString.split(\".\");\n    for (let str of componentStrings) {\n      // we need to distinguish between named components that start with a number, eg \"42somewhere\", and indexed components\n      // the normal parseInt won't do for the detection because it's too relaxed.\n      // see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/parseInt\n      if (/^(\\-|\\+)?([0-9]+|Infinity)$/.test(str)) {\n        this._components.push(new Path.Component(parseInt(str)));\n      } else {\n        this._components.push(new Path.Component(str));\n      }\n    }\n  }\n  public toString(): string {\n    return this.componentsString;\n  }\n  public Equals(otherPath: Path | null): boolean {\n    if (otherPath == null) return false;\n\n    if (otherPath._components.length != this._components.length) return false;\n\n    if (otherPath.isRelative != this.isRelative) return false;\n\n    // the original code uses SequenceEqual here, so we need to iterate over the components manually.\n    for (let i = 0, l = otherPath._components.length; i < l; i++) {\n      // it's not quite clear whether this test should use Equals or a simple == operator,\n      // see https://github.com/y-lohse/inkjs/issues/22\n      if (!otherPath._components[i].Equals(this._components[i])) return false;\n    }\n\n    return true;\n  }\n  public PathByAppendingComponent(c: Path.Component): Path {\n    let p = new Path();\n    p._components.push(...this._components);\n    p._components.push(c);\n    return p;\n  }\n}\n\nexport namespace Path {\n  export class Component {\n    public readonly index: number;\n    public readonly name: string | null;\n\n    constructor(indexOrName: string | number) {\n      this.index = -1;\n      this.name = null;\n      if (typeof indexOrName == \"string\") {\n        this.name = indexOrName;\n      } else {\n        this.index = indexOrName;\n      }\n    }\n    get isIndex(): boolean {\n      return this.index >= 0;\n    }\n    get isParent(): boolean {\n      return this.name == Path.parentId;\n    }\n\n    public static ToParent(): Component {\n      return new Component(Path.parentId);\n    }\n    public toString(): string | null {\n      if (this.isIndex) {\n        return this.index.toString();\n      } else {\n        return this.name;\n      }\n    }\n    public Equals(otherComp: Component): boolean {\n      if (otherComp != null && otherComp.isIndex == this.isIndex) {\n        if (this.isIndex) {\n          return this.index == otherComp.index;\n        } else {\n          return this.name == otherComp.name;\n        }\n      }\n\n      return false;\n    }\n  }\n}\n", "export namespace Debug {\n  export function AssertType<T>(\n    variable: any,\n    type: new () => T,\n    message: string\n  ): void | never {\n    Assert(variable instanceof type, message);\n  }\n\n  export function Assert(condition: boolean, message?: string): void | never {\n    if (!condition) {\n      if (typeof message !== \"undefined\") {\n        console.warn(message);\n      }\n\n      if (console.trace) {\n        console.trace();\n      }\n\n      throw new Error(\"\");\n    }\n  }\n}\n", "import { InkObject } from \"./Object\";\nimport { Path } from \"./Path\";\nimport { InkList, InkListItem } from \"./InkList\";\nimport { StoryException } from \"./StoryException\";\nimport { asOrNull, asOrThrows } from \"./TypeAssertion\";\nimport { tryParseInt, tryParseFloat } from \"./TryGetResult\";\nimport { throwNullException } from \"./NullException\";\n\nexport abstract class AbstractValue extends InkObject {\n  public abstract get valueType(): ValueType;\n  public abstract get isTruthy(): boolean;\n  public abstract get valueObject(): any;\n\n  public abstract Cast(newType: ValueType): Value<any>;\n\n  public static Create(\n    val: any,\n    preferredNumberType?: ValueType\n  ): Value<any> | null {\n    // This code doesn't exist in upstream and is simply here to enforce\n    // the creation of the proper number value.\n    // If `preferredNumberType` is not provided or if value doesn't match\n    // `preferredNumberType`, this conditional does nothing.\n    if (preferredNumberType) {\n      if (\n        preferredNumberType === (ValueType.Int as ValueType) &&\n        Number.isInteger(Number(val))\n      ) {\n        return new IntValue(Number(val));\n      } else if (\n        preferredNumberType === (ValueType.Float as ValueType) &&\n        !isNaN(val)\n      ) {\n        return new FloatValue(Number(val));\n      }\n    }\n\n    if (typeof val === \"boolean\") {\n      return new BoolValue(Boolean(val));\n    }\n\n    // https://github.com/y-lohse/inkjs/issues/425\n    // Changed condition sequence, because Number('') is\n    // parsed to 0, which made setting string to empty\n    // impossible\n    if (typeof val === \"string\") {\n      return new StringValue(String(val));\n    } else if (Number.isInteger(Number(val))) {\n      return new IntValue(Number(val));\n    } else if (!isNaN(val)) {\n      return new FloatValue(Number(val));\n    } else if (val instanceof Path) {\n      return new DivertTargetValue(asOrThrows(val, Path));\n    } else if (val instanceof InkList) {\n      return new ListValue(asOrThrows(val, InkList));\n    }\n\n    return null;\n  }\n  public Copy() {\n    return asOrThrows(AbstractValue.Create(this.valueObject), InkObject);\n  }\n  public BadCastException(targetType: ValueType) {\n    return new StoryException(\n      \"Can't cast \" +\n        this.valueObject +\n        \" from \" +\n        this.valueType +\n        \" to \" +\n        targetType\n    );\n  }\n}\n\nexport abstract class Value<\n  T extends { toString: () => string },\n> extends AbstractValue {\n  public value: T | null;\n\n  constructor(val: T | null) {\n    super();\n    this.value = val;\n  }\n  public get valueObject() {\n    return this.value;\n  }\n  public toString() {\n    if (this.value === null) return throwNullException(\"Value.value\");\n    return this.value.toString();\n  }\n}\n\nexport class BoolValue extends Value<boolean> {\n  constructor(val: boolean) {\n    super(val || false);\n  }\n  public get isTruthy() {\n    return Boolean(this.value);\n  }\n  public get valueType() {\n    return ValueType.Bool;\n  }\n\n  public Cast(newType: ValueType): Value<any> {\n    if (this.value === null) return throwNullException(\"Value.value\");\n\n    if (newType == this.valueType) {\n      return this;\n    }\n\n    if (newType == ValueType.Int) {\n      return new IntValue(this.value ? 1 : 0);\n    }\n\n    if (newType == ValueType.Float) {\n      return new FloatValue(this.value ? 1.0 : 0.0);\n    }\n\n    if (newType == ValueType.String) {\n      return new StringValue(this.value ? \"true\" : \"false\");\n    }\n\n    throw this.BadCastException(newType);\n  }\n\n  public toString() {\n    return this.value ? \"true\" : \"false\";\n  }\n}\n\nexport class IntValue extends Value<number> {\n  constructor(val: number) {\n    super(val || 0);\n  }\n  public get isTruthy() {\n    return this.value != 0;\n  }\n  public get valueType() {\n    return ValueType.Int;\n  }\n\n  public Cast(newType: ValueType): Value<any> {\n    if (this.value === null) return throwNullException(\"Value.value\");\n\n    if (newType == this.valueType) {\n      return this;\n    }\n\n    if (newType == ValueType.Bool) {\n      return new BoolValue(this.value === 0 ? false : true);\n    }\n\n    if (newType == ValueType.Float) {\n      return new FloatValue(this.value);\n    }\n\n    if (newType == ValueType.String) {\n      return new StringValue(\"\" + this.value);\n    }\n\n    throw this.BadCastException(newType);\n  }\n}\n\nexport class FloatValue extends Value<number> {\n  constructor(val: number) {\n    super(val || 0.0);\n  }\n  public get isTruthy() {\n    return this.value != 0.0;\n  }\n  public get valueType() {\n    return ValueType.Float;\n  }\n\n  public Cast(newType: ValueType): Value<any> {\n    if (this.value === null) return throwNullException(\"Value.value\");\n\n    if (newType == this.valueType) {\n      return this;\n    }\n\n    if (newType == ValueType.Bool) {\n      return new BoolValue(this.value === 0.0 ? false : true);\n    }\n\n    if (newType == ValueType.Int) {\n      return new IntValue(this.value);\n    }\n\n    if (newType == ValueType.String) {\n      return new StringValue(\"\" + this.value);\n    }\n\n    throw this.BadCastException(newType);\n  }\n}\n\nexport class StringValue extends Value<string> {\n  public _isNewline: boolean;\n  public _isInlineWhitespace: boolean;\n\n  constructor(val: string) {\n    super(val || \"\");\n\n    this._isNewline = this.value == \"\\n\";\n    this._isInlineWhitespace = true;\n\n    if (this.value === null) return throwNullException(\"Value.value\");\n\n    if (this.value.length > 0) {\n      this.value.split(\"\").every((c) => {\n        if (c != \" \" && c != \"\\t\") {\n          this._isInlineWhitespace = false;\n          return false;\n        }\n\n        return true;\n      });\n    }\n  }\n  public get valueType() {\n    return ValueType.String;\n  }\n  public get isTruthy() {\n    if (this.value === null) return throwNullException(\"Value.value\");\n    return this.value.length > 0;\n  }\n  public get isNewline() {\n    return this._isNewline;\n  }\n  public get isInlineWhitespace() {\n    return this._isInlineWhitespace;\n  }\n  public get isNonWhitespace() {\n    return !this.isNewline && !this.isInlineWhitespace;\n  }\n\n  public Cast(newType: ValueType): Value<any> {\n    if (newType == this.valueType) {\n      return this;\n    }\n\n    if (newType == ValueType.Int) {\n      let parsedInt = tryParseInt(this.value);\n      if (parsedInt.exists) {\n        return new IntValue(parsedInt.result);\n      } else {\n        throw this.BadCastException(newType);\n      }\n    }\n\n    if (newType == ValueType.Float) {\n      let parsedFloat = tryParseFloat(this.value);\n      if (parsedFloat.exists) {\n        return new FloatValue(parsedFloat.result);\n      } else {\n        throw this.BadCastException(newType);\n      }\n    }\n\n    throw this.BadCastException(newType);\n  }\n}\n\nexport class DivertTargetValue extends Value<Path> {\n  constructor(targetPath: Path | null = null) {\n    super(targetPath);\n  }\n  public get valueType() {\n    return ValueType.DivertTarget;\n  }\n  public get targetPath() {\n    if (this.value === null) return throwNullException(\"Value.value\");\n    return this.value;\n  }\n  public set targetPath(value: Path) {\n    this.value = value;\n  }\n  public get isTruthy(): never {\n    throw new Error(\"Shouldn't be checking the truthiness of a divert target\");\n  }\n\n  public Cast(newType: ValueType): Value<any> {\n    if (newType == this.valueType) return this;\n\n    throw this.BadCastException(newType);\n  }\n  public toString() {\n    return \"DivertTargetValue(\" + this.targetPath + \")\";\n  }\n}\n\nexport class VariablePointerValue extends Value<string> {\n  public _contextIndex: number;\n\n  constructor(variableName: string, contextIndex: number = -1) {\n    super(variableName);\n\n    this._contextIndex = contextIndex;\n  }\n\n  public get contextIndex() {\n    return this._contextIndex;\n  }\n  public set contextIndex(value: number) {\n    this._contextIndex = value;\n  }\n  public get variableName() {\n    if (this.value === null) return throwNullException(\"Value.value\");\n    return this.value;\n  }\n  public set variableName(value: string) {\n    this.value = value;\n  }\n  public get valueType() {\n    return ValueType.VariablePointer;\n  }\n\n  public get isTruthy(): never {\n    throw new Error(\n      \"Shouldn't be checking the truthiness of a variable pointer\"\n    );\n  }\n\n  public Cast(newType: ValueType): Value<any> {\n    if (newType == this.valueType) return this;\n\n    throw this.BadCastException(newType);\n  }\n  public toString() {\n    return \"VariablePointerValue(\" + this.variableName + \")\";\n  }\n  public Copy() {\n    return new VariablePointerValue(this.variableName, this.contextIndex);\n  }\n}\n\nexport class ListValue extends Value<InkList> {\n  public get isTruthy() {\n    if (this.value === null) {\n      return throwNullException(\"this.value\");\n    }\n    return this.value.Count > 0;\n  }\n  public get valueType() {\n    return ValueType.List;\n  }\n  public Cast(newType: ValueType): Value<any> {\n    if (this.value === null) return throwNullException(\"Value.value\");\n\n    if (newType == ValueType.Int) {\n      let max = this.value.maxItem;\n      if (max.Key.isNull) return new IntValue(0);\n      else return new IntValue(max.Value);\n    } else if (newType == ValueType.Float) {\n      let max = this.value.maxItem;\n      if (max.Key.isNull) return new FloatValue(0.0);\n      else return new FloatValue(max.Value);\n    } else if (newType == ValueType.String) {\n      let max = this.value.maxItem;\n      if (max.Key.isNull) return new StringValue(\"\");\n      else {\n        return new StringValue(max.Key.toString());\n      }\n    }\n\n    if (newType == this.valueType) return this;\n\n    throw this.BadCastException(newType);\n  }\n  constructor();\n  constructor(list: InkList);\n  constructor(listOrSingleItem: InkListItem, singleValue: number);\n  constructor(listOrSingleItem?: InkListItem | InkList, singleValue?: number) {\n    super(null);\n\n    if (!listOrSingleItem && !singleValue) {\n      this.value = new InkList();\n    } else if (listOrSingleItem instanceof InkList) {\n      this.value = new InkList(listOrSingleItem);\n    } else if (\n      listOrSingleItem instanceof InkListItem &&\n      typeof singleValue === \"number\"\n    ) {\n      this.value = new InkList({\n        Key: listOrSingleItem,\n        Value: singleValue,\n      });\n    }\n  }\n  public static RetainListOriginsForAssignment(\n    oldValue: InkObject | null,\n    newValue: InkObject\n  ) {\n    let oldList = asOrNull(oldValue, ListValue);\n    let newList = asOrNull(newValue, ListValue);\n\n    if (newList && newList.value === null)\n      return throwNullException(\"newList.value\");\n    if (oldList && oldList.value === null)\n      return throwNullException(\"oldList.value\");\n\n    // When assigning the empty list, try to retain any initial origin names\n    if (oldList && newList && newList.value!.Count == 0)\n      newList.value!.SetInitialOriginNames(oldList.value!.originNames);\n  }\n}\n\nexport enum ValueType {\n  Bool = -1,\n  Int = 0,\n  Float = 1,\n  List = 2,\n  String = 3,\n  DivertTarget = 4,\n  VariablePointer = 5,\n}\n", "export enum PushPopType {\n  Tunnel = 0,\n  Function = 1,\n  FunctionEvaluationFromGame = 2,\n}\n", "// TODO: Unify with Compiler.\n\nexport type ErrorHandler = (message: string, type: ErrorType) => void;\n\nexport enum ErrorType {\n  Author,\n  Warning,\n  Error,\n}\n", "import { INamedContent } from \"./INamedContent\";\n\nexport function asOrNull<T>(\n  obj: any,\n  type: (new (...arg: any[]) => T) | (Function & { prototype: T })\n): T | null {\n  if (obj instanceof type) {\n    return unsafeTypeAssertion(obj, type);\n  } else {\n    return null;\n  }\n}\n\nexport function asOrThrows<T>(\n  obj: any,\n  type: (new (...arg: any[]) => T) | (Function & { prototype: T })\n): T | never {\n  if (obj instanceof type) {\n    return unsafeTypeAssertion(obj, type);\n  } else {\n    throw new Error(`${obj} is not of type ${type}`);\n  }\n}\n\nexport function asNumberOrThrows(obj: any) {\n  if (typeof obj === \"number\") {\n    return obj as number;\n  } else {\n    throw new Error(`${obj} is not a number`);\n  }\n}\n\nexport function asBooleanOrThrows(obj: any) {\n  if (typeof obj === \"boolean\") {\n    return obj as boolean;\n  } else {\n    throw new Error(`${obj} is not a boolean`);\n  }\n}\n\n// So here, in the reference implementation, contentObj is casted to an INamedContent\n// but here we use js-style duck typing: if it implements the same props as the interface,\n// we treat it as valid.\nexport function asINamedContentOrNull(obj: any): INamedContent | null {\n  if (obj.hasValidName && obj.name) {\n    return obj as INamedContent;\n  }\n\n  return null;\n}\n\nexport function nullIfUndefined<T>(obj: T | undefined): T | null {\n  if (typeof obj === \"undefined\") {\n    return null;\n  }\n\n  return obj;\n}\n\nexport function isEquatable(type: any) {\n  return typeof type === \"object\" && typeof type.Equals === \"function\";\n}\n\nfunction unsafeTypeAssertion<T>(\n  obj: any,\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  type: (new () => T) | (Function & { prototype: T })\n) {\n  return obj as T;\n}\n\nexport function filterUndef<T>(element: T | undefined): element is T {\n  return element != undefined;\n}\n", "/**\n * In the original C# code, a SystemException would be thrown when passing\n * null to methods expected a valid instance. Javascript has no such\n * concept, but TypeScript will not allow `null` to be passed to methods\n * explicitely requiring a valid type.\n *\n * Whenever TypeScript complain about the possibility of a `null` value,\n * check the offending value and it it's null, throw this exception using\n * `throwNullException(name: string)`.\n */\nexport class NullException extends Error {}\n\n/**\n * Throw a NullException.\n *\n * @param name a short description of the offending value (often its name within the code).\n */\nexport function throwNullException(name: string): never {\n  throw new NullException(`${name} is null or undefined`);\n}\n", "import { Path } from \"./Path\";\nimport { Container } from \"./Container\";\nimport { Debug } from \"./Debug\";\nimport { asOrNull, asINamedContentOrNull } from \"./TypeAssertion\";\nimport { throwNullException } from \"./NullException\";\nimport { SearchResult } from \"./SearchResult\";\nimport { DebugMetadata } from \"./DebugMetadata\";\n\nexport class InkObject {\n  public parent: InkObject | null = null;\n\n  get debugMetadata(): DebugMetadata | null {\n    if (this._debugMetadata === null) {\n      if (this.parent) {\n        return this.parent.debugMetadata;\n      }\n    }\n\n    return this._debugMetadata;\n  }\n\n  set debugMetadata(value) {\n    this._debugMetadata = value;\n  }\n\n  get ownDebugMetadata() {\n    return this._debugMetadata;\n  }\n\n  private _debugMetadata: DebugMetadata | null = null;\n\n  public DebugLineNumberOfPath(path: Path) {\n    if (path === null) return null;\n\n    // Try to get a line number from debug metadata\n    let root = this.rootContentContainer;\n    if (root) {\n      let targetContent = root.ContentAtPath(path).obj;\n      if (targetContent) {\n        let dm = targetContent.debugMetadata;\n        if (dm !== null) {\n          return dm.startLineNumber;\n        }\n      }\n    }\n\n    return null;\n  }\n\n  get path() {\n    if (this._path == null) {\n      if (this.parent == null) {\n        this._path = new Path();\n      } else {\n        let comps: Path.Component[] = [];\n\n        let child: InkObject = this;\n        let container = asOrNull(child.parent, Container);\n\n        while (container !== null) {\n          let namedChild = asINamedContentOrNull(child);\n          if (namedChild != null && namedChild.hasValidName) {\n            if (namedChild.name === null)\n              return throwNullException(\"namedChild.name\");\n            comps.unshift(new Path.Component(namedChild.name!));\n          } else {\n            comps.unshift(new Path.Component(container.content.indexOf(child)));\n          }\n\n          child = container;\n          container = asOrNull(container.parent, Container);\n        }\n\n        this._path = new Path(comps);\n      }\n    }\n\n    return this._path;\n  }\n  private _path: Path | null = null;\n\n  public ResolvePath(path: Path | null): SearchResult {\n    if (path === null) return throwNullException(\"path\");\n    if (path.isRelative) {\n      let nearestContainer = asOrNull(this, Container);\n\n      if (nearestContainer === null) {\n        Debug.Assert(\n          this.parent !== null,\n          \"Can't resolve relative path because we don't have a parent\"\n        );\n        nearestContainer = asOrNull(this.parent, Container);\n        Debug.Assert(\n          nearestContainer !== null,\n          \"Expected parent to be a container\"\n        );\n        Debug.Assert(path.GetComponent(0).isParent);\n        path = path.tail;\n      }\n\n      if (nearestContainer === null) {\n        return throwNullException(\"nearestContainer\");\n      }\n      return nearestContainer.ContentAtPath(path);\n    } else {\n      let contentContainer = this.rootContentContainer;\n      if (contentContainer === null) {\n        return throwNullException(\"contentContainer\");\n      }\n      return contentContainer.ContentAtPath(path);\n    }\n  }\n\n  public ConvertPathToRelative(globalPath: Path) {\n    let ownPath = this.path;\n\n    let minPathLength = Math.min(globalPath.length, ownPath.length);\n    let lastSharedPathCompIndex = -1;\n\n    for (let i = 0; i < minPathLength; ++i) {\n      let ownComp = ownPath.GetComponent(i);\n      let otherComp = globalPath.GetComponent(i);\n\n      if (ownComp.Equals(otherComp)) {\n        lastSharedPathCompIndex = i;\n      } else {\n        break;\n      }\n    }\n\n    // No shared path components, so just use global path\n    if (lastSharedPathCompIndex == -1) return globalPath;\n\n    let numUpwardsMoves = ownPath.componentCount - 1 - lastSharedPathCompIndex;\n\n    let newPathComps: Path.Component[] = [];\n\n    for (let up = 0; up < numUpwardsMoves; ++up)\n      newPathComps.push(Path.Component.ToParent());\n\n    for (\n      let down = lastSharedPathCompIndex + 1;\n      down < globalPath.componentCount;\n      ++down\n    )\n      newPathComps.push(globalPath.GetComponent(down));\n\n    let relativePath = new Path(newPathComps, true);\n    return relativePath;\n  }\n\n  public CompactPathString(otherPath: Path) {\n    let globalPathStr = null;\n    let relativePathStr = null;\n\n    if (otherPath.isRelative) {\n      relativePathStr = otherPath.componentsString;\n      globalPathStr = this.path.PathByAppendingPath(otherPath).componentsString;\n    } else {\n      let relativePath = this.ConvertPathToRelative(otherPath);\n      relativePathStr = relativePath.componentsString;\n      globalPathStr = otherPath.componentsString;\n    }\n\n    if (relativePathStr.length < globalPathStr.length) return relativePathStr;\n    else return globalPathStr;\n  }\n\n  get rootContentContainer() {\n    let ancestor: InkObject = this;\n    while (ancestor.parent) {\n      ancestor = ancestor.parent;\n    }\n    return asOrNull(ancestor, Container);\n  }\n\n  public Copy(): InkObject {\n    throw Error(\"Not Implemented: Doesn't support copying\");\n  }\n  // SetChild works slightly diferently in the js implementation.\n  // Since we can't pass an objets property by reference, we instead pass\n  // the object and the property string.\n  // TODO: This method can probably be rewritten with type-safety in mind.\n  public SetChild(obj: any, prop: any, value: any) {\n    if (obj[prop]) obj[prop] = null;\n\n    obj[prop] = value;\n\n    if (obj[prop]) obj[prop].parent = this;\n  }\n\n  public Equals(obj: any) {\n    return obj === this;\n  }\n}\n", "export class StringBuilder {\n  private string: string;\n\n  constructor(str?: string) {\n    str = typeof str !== \"undefined\" ? str.toString() : \"\";\n    this.string = str;\n  }\n  get Length(): number {\n    return this.string.length;\n  }\n  public Append(str: string | null) {\n    if (str !== null) {\n      this.string += str;\n    }\n  }\n  public AppendLine(str?: string) {\n    if (typeof str !== \"undefined\") this.Append(str);\n    this.string += \"\\n\";\n  }\n  public AppendFormat(format: string, ...args: any[]) {\n    // taken from http://stackoverflow.com/questions/610406/javascript-equivalent-to-printf-string-format\n    this.string += format.replace(/{(\\d+)}/g, (match: string, num: number) =>\n      typeof args[num] != \"undefined\" ? args[num] : match\n    );\n  }\n  public toString(): string {\n    return this.string;\n  }\n\n  public Clear() {\n    this.string = \"\";\n  }\n}\n", "import { throwNullException } from \"./NullException\";\nimport { StringBuilder } from \"./StringBuilder\";\nimport { ListDefinition } from \"./ListDefinition\";\nimport { Story } from \"./Story\";\n\nexport class InkListItem implements IInkListItem {\n  // InkListItem is a struct\n\n  public readonly originName: string | null = null;\n  public readonly itemName: string | null = null;\n\n  constructor(originName: string | null, itemName: string | null);\n  constructor(fullName: string | null);\n  constructor() {\n    if (typeof arguments[1] !== \"undefined\") {\n      let originName = arguments[0] as string | null;\n      let itemName = arguments[1] as string | null;\n\n      this.originName = originName;\n      this.itemName = itemName;\n    } else if (arguments[0]) {\n      let fullName = arguments[0] as string;\n\n      let nameParts = fullName.toString().split(\".\");\n      this.originName = nameParts[0];\n      this.itemName = nameParts[1];\n    }\n  }\n  public static get Null() {\n    return new InkListItem(null, null);\n  }\n  public get isNull() {\n    return this.originName == null && this.itemName == null;\n  }\n  get fullName() {\n    return (\n      (this.originName !== null ? this.originName : \"?\") + \".\" + this.itemName\n    );\n  }\n  public toString(): string {\n    return this.fullName;\n  }\n  public Equals(obj: InkListItem) {\n    if (obj instanceof InkListItem) {\n      let otherItem = obj;\n      return (\n        otherItem.itemName == this.itemName &&\n        otherItem.originName == this.originName\n      );\n    }\n\n    return false;\n  }\n\n  // These methods did not exist in the original C# code. Their purpose is to\n  // make `InkListItem` mimics the value-type semantics of the original\n  // struct. Please refer to the end of this file, for a more in-depth\n  // explanation.\n\n  /**\n   * Returns a shallow clone of the current instance.\n   */\n  public copy() {\n    return new InkListItem(this.originName, this.itemName);\n  }\n  /**\n   * Returns a `SerializedInkListItem` representing the current\n   * instance. The result is intended to be used as a key inside a Map.\n   */\n  public serialized(): SerializedInkListItem {\n    // We are simply using a JSON representation as a value-typed key.\n    return JSON.stringify({\n      originName: this.originName,\n      itemName: this.itemName,\n    });\n  }\n\n  /**\n   * Reconstructs a `InkListItem` from the given SerializedInkListItem.\n   */\n  public static fromSerializedKey(key: SerializedInkListItem): InkListItem {\n    let obj = JSON.parse(key);\n    if (!InkListItem.isLikeInkListItem(obj)) return InkListItem.Null;\n\n    let inkListItem = obj as IInkListItem;\n\n    return new InkListItem(inkListItem.originName, inkListItem.itemName);\n  }\n\n  /**\n   * Determines whether the given item is sufficiently `InkListItem`-like\n   * to be used as a template when reconstructing the InkListItem.\n   */\n  private static isLikeInkListItem(item: any) {\n    if (typeof item !== \"object\") return false;\n    if (!item.hasOwnProperty(\"originName\") || !item.hasOwnProperty(\"itemName\"))\n      return false;\n    if (typeof item.originName !== \"string\" && typeof item.originName !== null)\n      return false;\n    if (typeof item.itemName !== \"string\" && typeof item.itemName !== null)\n      return false;\n\n    return true;\n  }\n}\n\nexport class InkList extends Map<SerializedInkListItem, number> {\n  public origins: ListDefinition[] | null = null;\n  public _originNames: string[] | null = [];\n\n  constructor();\n  constructor(otherList: InkList);\n  constructor(singleOriginListName: string, originStory: Story);\n  constructor(singleElement: KeyValuePair<InkListItem, number>);\n  constructor() {\n    // Trying to be smart here, this emulates the constructor inheritance found\n    // in the original code, but only if otherList is an InkList. IIFE FTW.\n    super(\n      (() => {\n        if (arguments[0] instanceof InkList) {\n          return arguments[0];\n        } else {\n          return [];\n        }\n      })()\n    );\n\n    if (arguments[0] instanceof InkList) {\n      let otherList = arguments[0] as InkList;\n\n      let otherOriginNames = otherList.originNames as string[];\n      if (otherOriginNames !== null)\n        this._originNames = otherOriginNames.slice();\n      if (otherList.origins !== null) {\n        this.origins = otherList.origins.slice();\n      }\n    } else if (typeof arguments[0] === \"string\") {\n      let singleOriginListName = arguments[0] as string;\n      let originStory = arguments[1] as Story;\n      this.SetInitialOriginName(singleOriginListName);\n\n      if (originStory.listDefinitions === null) {\n        return throwNullException(\"originStory.listDefinitions\");\n      }\n      let def = originStory.listDefinitions.TryListGetDefinition(\n        singleOriginListName,\n        null\n      );\n      if (def.exists) {\n        // Throwing now, because if the value is `null` it will\n        // eventually throw down the line.\n        if (def.result === null) {\n          return throwNullException(\"def.result\");\n        }\n        this.origins = [def.result];\n      } else {\n        throw new Error(\n          \"InkList origin could not be found in story when constructing new list: \" +\n            singleOriginListName\n        );\n      }\n    } else if (\n      typeof arguments[0] === \"object\" &&\n      arguments[0].hasOwnProperty(\"Key\") &&\n      arguments[0].hasOwnProperty(\"Value\")\n    ) {\n      let singleElement = arguments[0] as KeyValuePair<InkListItem, number>;\n      this.Add(singleElement.Key, singleElement.Value);\n    }\n  }\n\n  public static FromString(myListItem: string, originStory: Story) {\n    if (myListItem == null || myListItem == \"\") return new InkList();\n    let listValue =\n      originStory.listDefinitions?.FindSingleItemListWithName(myListItem);\n    if (listValue) {\n      if (listValue.value === null) {\n        return throwNullException(\"listValue.value\");\n      }\n      return new InkList(listValue.value);\n    } else {\n      throw new Error(\n        \"Could not find the InkListItem from the string '\" +\n          myListItem +\n          \"' to create an InkList because it doesn't exist in the original list definition in ink.\"\n      );\n    }\n  }\n\n  public AddItem(\n    itemOrItemName: InkListItem | string | null,\n    storyObject: Story | null = null\n  ) {\n    if (itemOrItemName instanceof InkListItem) {\n      let item = itemOrItemName;\n\n      if (item.originName == null) {\n        this.AddItem(item.itemName);\n        return;\n      }\n\n      if (this.origins === null) return throwNullException(\"this.origins\");\n\n      for (let origin of this.origins) {\n        if (origin.name == item.originName) {\n          let intVal = origin.TryGetValueForItem(item, 0);\n          if (intVal.exists) {\n            this.Add(item, intVal.result);\n            return;\n          } else {\n            throw new Error(\n              \"Could not add the item \" +\n                item +\n                \" to this list because it doesn't exist in the original list definition in ink.\"\n            );\n          }\n        }\n      }\n\n      throw new Error(\n        \"Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.\"\n      );\n    } else if (itemOrItemName !== null) {\n      //itemOrItemName is a string\n      let itemName = itemOrItemName as string;\n\n      let foundListDef: ListDefinition | null = null;\n\n      if (this.origins === null) return throwNullException(\"this.origins\");\n\n      for (let origin of this.origins) {\n        if (itemName === null) return throwNullException(\"itemName\");\n\n        if (origin.ContainsItemWithName(itemName)) {\n          if (foundListDef != null) {\n            throw new Error(\n              \"Could not add the item \" +\n                itemName +\n                \" to this list because it could come from either \" +\n                origin.name +\n                \" or \" +\n                foundListDef.name\n            );\n          } else {\n            foundListDef = origin;\n          }\n        }\n      }\n\n      if (foundListDef == null) {\n        if (storyObject == null) {\n          throw new Error(\n            \"Could not add the item \" +\n              itemName +\n              \" to this list because it isn't known to any list definitions previously associated with this list.\"\n          );\n        } else {\n          let newItem = InkList.FromString(itemName, storyObject)\n            .orderedItems[0];\n          this.Add(newItem.Key, newItem.Value);\n        }\n      } else {\n        let item = new InkListItem(foundListDef.name, itemName);\n        let itemVal = foundListDef.ValueForItem(item);\n        this.Add(item, itemVal);\n      }\n    }\n  }\n  public ContainsItemNamed(itemName: string | null) {\n    for (let [key] of this) {\n      let item = InkListItem.fromSerializedKey(key);\n      if (item.itemName == itemName) return true;\n    }\n\n    return false;\n  }\n  public ContainsKey(key: InkListItem) {\n    return this.has(key.serialized());\n  }\n  public Add(key: InkListItem, value: number) {\n    let serializedKey = key.serialized();\n    if (this.has(serializedKey)) {\n      // Throw an exception to match the C# behavior.\n      throw new Error(`The Map already contains an entry for ${key}`);\n    }\n    this.set(serializedKey, value);\n  }\n  public Remove(key: InkListItem) {\n    return this.delete(key.serialized());\n  }\n  get Count() {\n    return this.size;\n  }\n  get originOfMaxItem(): ListDefinition | null {\n    if (this.origins == null) return null;\n\n    let maxOriginName = this.maxItem.Key.originName;\n    let result = null;\n    this.origins.every((origin) => {\n      if (origin.name == maxOriginName) {\n        result = origin;\n        return false;\n      } else return true;\n    });\n\n    return result;\n  }\n  get originNames(): string[] {\n    if (this.Count > 0) {\n      if (this._originNames == null && this.Count > 0) this._originNames = [];\n      else {\n        if (!this._originNames) this._originNames = [];\n        this._originNames.length = 0;\n      }\n\n      for (let [key] of this) {\n        let item = InkListItem.fromSerializedKey(key);\n        if (item.originName === null)\n          return throwNullException(\"item.originName\");\n        this._originNames.push(item.originName);\n      }\n    }\n\n    return this._originNames as string[];\n  }\n  public SetInitialOriginName(initialOriginName: string) {\n    this._originNames = [initialOriginName];\n  }\n  public SetInitialOriginNames(initialOriginNames: string[]) {\n    if (initialOriginNames == null) this._originNames = null;\n    else this._originNames = initialOriginNames.slice(); // store a copy\n  }\n  get maxItem() {\n    let max: KeyValuePair<InkListItem, number> = {\n      Key: InkListItem.Null,\n      Value: 0,\n    };\n    for (let [key, value] of this) {\n      let item = InkListItem.fromSerializedKey(key);\n      if (max.Key.isNull || value > max.Value)\n        max = { Key: item, Value: value };\n    }\n\n    return max;\n  }\n  get minItem() {\n    let min: KeyValuePair<InkListItem, number> = {\n      Key: InkListItem.Null,\n      Value: 0,\n    };\n    for (let [key, value] of this) {\n      let item = InkListItem.fromSerializedKey(key);\n      if (min.Key.isNull || value < min.Value) {\n        min = { Key: item, Value: value };\n      }\n    }\n    return min;\n  }\n  get inverse() {\n    let list = new InkList();\n    if (this.origins != null) {\n      for (let origin of this.origins) {\n        for (let [key, value] of origin.items) {\n          let item = InkListItem.fromSerializedKey(key);\n          if (!this.ContainsKey(item)) list.Add(item, value);\n        }\n      }\n    }\n    return list;\n  }\n  get all() {\n    let list = new InkList();\n    if (this.origins != null) {\n      for (let origin of this.origins) {\n        for (let [key, value] of origin.items) {\n          let item = InkListItem.fromSerializedKey(key);\n          list.set(item.serialized(), value);\n        }\n      }\n    }\n    return list;\n  }\n  public Union(otherList: InkList) {\n    let union = new InkList(this);\n    for (let [key, value] of otherList) {\n      union.set(key, value);\n    }\n    return union;\n  }\n  public Intersect(otherList: InkList) {\n    let intersection = new InkList();\n    for (let [key, value] of this) {\n      if (otherList.has(key)) intersection.set(key, value);\n    }\n\n    return intersection;\n  }\n  public HasIntersection(otherList: InkList): boolean {\n    for (let [key] of this) {\n      if (otherList.has(key)) return true;\n    }\n    return false;\n  }\n  public Without(listToRemove: InkList) {\n    let result = new InkList(this);\n    for (let [key] of listToRemove) {\n      result.delete(key);\n    }\n\n    return result;\n  }\n\n  public Contains(key: string): boolean;\n  public Contains(otherList: InkList): boolean;\n  public Contains(what: string | InkList): boolean {\n    if (typeof what == \"string\") return this.ContainsItemNamed(what);\n    const otherList = what;\n    if (otherList.size == 0 || this.size == 0) return false;\n    for (let [key] of otherList) {\n      if (!this.has(key)) return false;\n    }\n\n    return true;\n  }\n  public GreaterThan(otherList: InkList) {\n    if (this.Count == 0) return false;\n    if (otherList.Count == 0) return true;\n\n    return this.minItem.Value > otherList.maxItem.Value;\n  }\n  public GreaterThanOrEquals(otherList: InkList) {\n    if (this.Count == 0) return false;\n    if (otherList.Count == 0) return true;\n\n    return (\n      this.minItem.Value >= otherList.minItem.Value &&\n      this.maxItem.Value >= otherList.maxItem.Value\n    );\n  }\n  public LessThan(otherList: InkList) {\n    if (otherList.Count == 0) return false;\n    if (this.Count == 0) return true;\n\n    return this.maxItem.Value < otherList.minItem.Value;\n  }\n  public LessThanOrEquals(otherList: InkList) {\n    if (otherList.Count == 0) return false;\n    if (this.Count == 0) return true;\n\n    return (\n      this.maxItem.Value <= otherList.maxItem.Value &&\n      this.minItem.Value <= otherList.minItem.Value\n    );\n  }\n  public MaxAsList() {\n    if (this.Count > 0) return new InkList(this.maxItem);\n    else return new InkList();\n  }\n  public MinAsList() {\n    if (this.Count > 0) return new InkList(this.minItem);\n    else return new InkList();\n  }\n  public ListWithSubRange(minBound: any, maxBound: any) {\n    if (this.Count == 0) return new InkList();\n\n    let ordered = this.orderedItems;\n\n    let minValue = 0;\n    let maxValue = Number.MAX_SAFE_INTEGER;\n\n    if (Number.isInteger(minBound)) {\n      minValue = minBound;\n    } else {\n      if (minBound instanceof InkList && minBound.Count > 0)\n        minValue = minBound.minItem.Value;\n    }\n\n    if (Number.isInteger(maxBound)) {\n      maxValue = maxBound;\n    } else {\n      if (maxBound instanceof InkList && maxBound.Count > 0)\n        maxValue = maxBound.maxItem.Value;\n    }\n\n    let subList = new InkList();\n    subList.SetInitialOriginNames(this.originNames);\n    for (let item of ordered) {\n      if (item.Value >= minValue && item.Value <= maxValue) {\n        subList.Add(item.Key, item.Value);\n      }\n    }\n\n    return subList;\n  }\n  public Equals(otherInkList: InkList) {\n    if (otherInkList instanceof InkList === false) return false;\n    if (otherInkList.Count != this.Count) return false;\n\n    for (let [key] of this) {\n      if (!otherInkList.has(key)) return false;\n    }\n\n    return true;\n  }\n  // GetHashCode not implemented\n  get orderedItems() {\n    // List<KeyValuePair<InkListItem, int>>\n    let ordered = new Array<KeyValuePair<InkListItem, number>>();\n\n    for (let [key, value] of this) {\n      let item = InkListItem.fromSerializedKey(key);\n      ordered.push({ Key: item, Value: value });\n    }\n\n    ordered.sort((x, y) => {\n      if (x.Key.originName === null) {\n        return throwNullException(\"x.Key.originName\");\n      }\n      if (y.Key.originName === null) {\n        return throwNullException(\"y.Key.originName\");\n      }\n\n      if (x.Value == y.Value) {\n        return x.Key.originName.localeCompare(y.Key.originName);\n      } else {\n        // TODO: refactor this bit into a numberCompareTo method?\n        if (x.Value < y.Value) return -1;\n        return x.Value > y.Value ? 1 : 0;\n      }\n    });\n\n    return ordered;\n  }\n\n  get singleItem(): InkListItem | null {\n    for (let item of this.orderedItems) {\n      return item.Key;\n    }\n    return null;\n  }\n\n  public toString() {\n    let ordered = this.orderedItems;\n\n    let sb = new StringBuilder();\n    for (let i = 0; i < ordered.length; i++) {\n      if (i > 0) sb.Append(\", \");\n\n      let item = ordered[i].Key;\n      if (item.itemName === null) return throwNullException(\"item.itemName\");\n      sb.Append(item.itemName);\n    }\n\n    return sb.toString();\n  }\n  // casting a InkList to a Number, for somereason, actually gives a number.\n  // This messes up the type detection when creating a Value from a InkList.\n  // Returning NaN here prevents that.\n  public valueOf() {\n    return NaN;\n  }\n}\n\n/**\n * In the original C# code, `InkListItem` was defined as value type, meaning\n * that two `InkListItem` would be considered equal as long as they held the\n * same values. This doesn't hold true in Javascript, as `InkListItem` is a\n * reference type (Javascript doesn't allow the creation of custom value types).\n *\n * The key equality of Map objects is based on the \"SameValueZero\" algorithm;\n * since `InkListItem` is a value type, two keys will only be considered\n * equal if they are, in fact, the same object. As we are trying to emulate\n * the original behavior as close as possible, this will lead to unforeseen\n * side effects.\n *\n * In order to have a key equality based on value semantics, we'll convert\n * `InkListItem` to a valid string representation and use this representation\n * as a key (strings are value types in Javascript). Rather than using the\n * type `string` directly, we'll alias it to `SerializedInkListItem` and use\n * this type as the key for our Map-based `InkList`.\n *\n * Reducing `InkListItem` to a JSON representation would not be bulletproof\n * in the general case, but for our needs it works well. The major downside of\n * this method is that we will have to to reconstruct the original `InkListItem`\n * every time we'll need to access its properties.\n */\nexport type SerializedInkListItem = string;\n\n/**\n * An interface inherited by `InkListItem`, defining exposed\n * properties. It's mainly used when deserializing a `InkListItem` from its\n * key (`SerializedInkListItem`)\n */\ninterface IInkListItem {\n  readonly originName: string | null;\n  readonly itemName: string | null;\n}\nexport interface KeyValuePair<K, V> {\n  Key: K;\n  Value: V;\n}\n", "export class StoryException extends Error {\n  public useEndLineNumber: boolean;\n  public message: string;\n  public name: string;\n\n  constructor(message: string) {\n    super(message);\n    this.useEndLineNumber = false;\n    this.message = message;\n    this.name = \"StoryException\";\n  }\n}\n", "/**\n * This interface normalize the `TryGet` behavior found in the original\n * C# project. Any `TryGet` method will return a object conforming to this\n * interface.\n *\n * The original function returns a boolean and has a second parameter called\n * item that is an `out`. Both are needed and we can't just return the item\n * because it'll always be truthy. Instead, we return an object containing\n * whether the result exists (`exists`) and the result itself (`result`).\n *\n * For instance a `TryGet` prototype would look like this:\n```\nTryGetItemWithValue(val: number, item: InkListItem): TryGetResult<InkListItem>{\n```\n *\n * On the other hand, dealing with the result can be done in the following way:\n```\nvar item = item.TryGetItemWithValue(intVal, InkListItem.Null);\nif (item.exists) {\n\tconsole.log(item.result)\n}\n```\n *\n */\nexport interface TryGetResult<T> {\n  result: T;\n  exists: boolean;\n}\n\nexport function tryGetValueFromMap<K, V>(\n  map: Map<K, V> | null,\n  key: K,\n  /* out */ value: V\n): TryGetResult<V> {\n  if (map === null) {\n    return { result: value, exists: false };\n  }\n\n  let val = map.get(key);\n\n  if (typeof val === \"undefined\") {\n    return { result: value, exists: false };\n  } else {\n    return { result: val, exists: true };\n  }\n}\n\nexport function tryParseInt(\n  value: any,\n  /* out */ defaultValue: number = 0\n): TryGetResult<number> {\n  let val = parseInt(value);\n\n  if (!Number.isNaN(val)) {\n    return { result: val, exists: true };\n  } else {\n    return { result: defaultValue, exists: false };\n  }\n}\n\nexport function tryParseFloat(\n  value: any,\n  /* out */ defaultValue: number = 0\n): TryGetResult<number> {\n  let val = parseFloat(value);\n\n  if (!Number.isNaN(val)) {\n    return { result: val, exists: true };\n  } else {\n    return { result: defaultValue, exists: false };\n  }\n}\n", "import { InkObject } from \"./Object\";\nimport { Container } from \"./Container\";\n\nexport class SearchResult {\n  public obj: InkObject | null = null;\n  public approximate: boolean = false;\n\n  get correctObj() {\n    return this.approximate ? null : this.obj;\n  }\n\n  get container() {\n    return this.obj instanceof Container ? this.obj : null;\n  }\n\n  public copy() {\n    let searchResult = new SearchResult();\n    searchResult.obj = this.obj;\n    searchResult.approximate = this.approximate;\n\n    return searchResult;\n  }\n}\n", "import { StringValue } from \"./Value\";\nimport { throwNullException } from \"./NullException\";\nimport { StringBuilder } from \"./StringBuilder\";\nimport { INamedContent } from \"./INamedContent\";\nimport { InkObject } from \"./Object\";\nimport { SearchResult } from \"./SearchResult\";\nimport { Path } from \"./Path\";\nimport { Debug } from \"./Debug\";\nimport { tryGetValueFromMap } from \"./TryGetResult\";\nimport { asINamedContentOrNull, asOrNull, asOrThrows } from \"./TypeAssertion\";\n\nexport class Container extends InkObject implements INamedContent {\n  public name: string | null = null;\n\n  public _content: InkObject[] = [];\n  public namedContent: Map<string, INamedContent> = new Map();\n\n  public visitsShouldBeCounted: boolean = false;\n  public turnIndexShouldBeCounted: boolean = false;\n  public countingAtStartOnly: boolean = false;\n\n  public _pathToFirstLeafContent: Path | null = null;\n\n  get hasValidName() {\n    return this.name != null && this.name.length > 0;\n  }\n  get content() {\n    return this._content;\n  }\n  set content(value: InkObject[]) {\n    this.AddContent(value);\n  }\n  get namedOnlyContent() {\n    let namedOnlyContentDict: Map<string, InkObject> | null = new Map();\n\n    for (let [key, value] of this.namedContent) {\n      let inkObject = asOrThrows(value, InkObject);\n      namedOnlyContentDict.set(key, inkObject);\n    }\n\n    for (let c of this.content) {\n      let named = asINamedContentOrNull(c);\n      if (named != null && named.hasValidName) {\n        namedOnlyContentDict.delete(named.name!);\n      }\n    }\n\n    if (namedOnlyContentDict.size == 0) namedOnlyContentDict = null;\n\n    return namedOnlyContentDict;\n  }\n  set namedOnlyContent(value: Map<string, InkObject> | null) {\n    let existingNamedOnly = this.namedOnlyContent;\n    if (existingNamedOnly != null) {\n      for (let [key] of existingNamedOnly) {\n        this.namedContent.delete(key);\n      }\n    }\n\n    if (value == null) return;\n\n    for (let [, val] of value) {\n      let named = asINamedContentOrNull(val);\n      if (named != null) this.AddToNamedContentOnly(named);\n    }\n  }\n  get countFlags(): number {\n    let flags: Container.CountFlags = 0;\n    if (this.visitsShouldBeCounted) flags |= Container.CountFlags.Visits;\n    if (this.turnIndexShouldBeCounted) flags |= Container.CountFlags.Turns;\n    if (this.countingAtStartOnly) flags |= Container.CountFlags.CountStartOnly;\n\n    if (flags == Container.CountFlags.CountStartOnly) {\n      flags = 0;\n    }\n\n    return flags;\n  }\n  set countFlags(value: number) {\n    let flag: Container.CountFlags = value;\n    if ((flag & Container.CountFlags.Visits) > 0)\n      this.visitsShouldBeCounted = true;\n    if ((flag & Container.CountFlags.Turns) > 0)\n      this.turnIndexShouldBeCounted = true;\n    if ((flag & Container.CountFlags.CountStartOnly) > 0)\n      this.countingAtStartOnly = true;\n  }\n  get pathToFirstLeafContent() {\n    if (this._pathToFirstLeafContent == null)\n      this._pathToFirstLeafContent = this.path.PathByAppendingPath(\n        this.internalPathToFirstLeafContent\n      );\n\n    return this._pathToFirstLeafContent;\n  }\n  get internalPathToFirstLeafContent() {\n    let components: Path.Component[] = [];\n    let container: Container = this;\n    while (container instanceof Container) {\n      if (container.content.length > 0) {\n        components.push(new Path.Component(0));\n        container = container.content[0] as Container;\n      }\n    }\n    return new Path(components);\n  }\n\n  public AddContent(contentObjOrList: InkObject | InkObject[]) {\n    if (contentObjOrList instanceof Array) {\n      let contentList = contentObjOrList as InkObject[];\n\n      for (let c of contentList) {\n        this.AddContent(c);\n      }\n    } else {\n      let contentObj = contentObjOrList as InkObject;\n\n      this._content.push(contentObj);\n\n      if (contentObj.parent) {\n        throw new Error(\"content is already in \" + contentObj.parent);\n      }\n\n      contentObj.parent = this;\n\n      this.TryAddNamedContent(contentObj);\n    }\n  }\n  public TryAddNamedContent(contentObj: InkObject) {\n    let namedContentObj = asINamedContentOrNull(contentObj);\n    if (namedContentObj != null && namedContentObj.hasValidName) {\n      this.AddToNamedContentOnly(namedContentObj);\n    }\n  }\n  public AddToNamedContentOnly(namedContentObj: INamedContent) {\n    Debug.AssertType(\n      namedContentObj,\n      InkObject,\n      \"Can only add Runtime.Objects to a Runtime.Container\"\n    );\n    let runtimeObj = asOrThrows(namedContentObj, InkObject);\n    runtimeObj.parent = this;\n\n    if (namedContentObj.name === null)\n      return throwNullException(\"namedContentObj.name\");\n    this.namedContent.set(namedContentObj.name!, namedContentObj);\n  }\n  public ContentAtPath(\n    path: Path,\n    partialPathStart: number = 0,\n    partialPathLength: number = -1\n  ) {\n    if (partialPathLength == -1) partialPathLength = path.length;\n\n    let result = new SearchResult();\n    result.approximate = false;\n\n    let currentContainer: Container | null = this;\n    let currentObj: InkObject = this;\n\n    for (let i = partialPathStart; i < partialPathLength; ++i) {\n      let comp = path.GetComponent(i);\n      if (currentContainer == null) {\n        result.approximate = true;\n        break;\n      }\n\n      let foundObj: InkObject | null =\n        currentContainer.ContentWithPathComponent(comp);\n\n      // Couldn't resolve entire path?\n      if (foundObj == null) {\n        result.approximate = true;\n        break;\n      }\n\n      // Are we about to loop into another container?\n      // Is the object a container as expected? It might\n      // no longer be if the content has shuffled around, so what\n      // was originally a container no longer is.\n      const nextContainer: Container | null = asOrNull(foundObj, Container);\n      if (i < partialPathLength - 1 && nextContainer == null) {\n        result.approximate = true;\n        break;\n      }\n\n      currentObj = foundObj;\n      currentContainer = nextContainer;\n    }\n\n    result.obj = currentObj;\n\n    return result;\n  }\n  public InsertContent(contentObj: InkObject, index: number) {\n    this.content.splice(index, 0, contentObj);\n\n    if (contentObj.parent) {\n      throw new Error(\"content is already in \" + contentObj.parent);\n    }\n\n    contentObj.parent = this;\n\n    this.TryAddNamedContent(contentObj);\n  }\n  public AddContentsOfContainer(otherContainer: Container) {\n    this.content.push(...otherContainer.content);\n\n    for (let obj of otherContainer.content) {\n      obj.parent = this;\n      this.TryAddNamedContent(obj);\n    }\n  }\n  public ContentWithPathComponent(component: Path.Component): InkObject | null {\n    if (component.isIndex) {\n      if (component.index >= 0 && component.index < this.content.length) {\n        return this.content[component.index];\n      } else {\n        return null;\n      }\n    } else if (component.isParent) {\n      return this.parent;\n    } else {\n      if (component.name === null) {\n        return throwNullException(\"component.name\");\n      }\n      let foundContent = tryGetValueFromMap(\n        this.namedContent,\n        component.name,\n        null\n      );\n      if (foundContent.exists) {\n        return asOrThrows(foundContent.result, InkObject);\n      } else {\n        return null;\n      }\n    }\n  }\n  public BuildStringOfHierarchy(): string;\n  public BuildStringOfHierarchy(\n    sb: StringBuilder,\n    indentation: number,\n    pointedObj: InkObject | null\n  ): string;\n  public BuildStringOfHierarchy() {\n    let sb: StringBuilder;\n    if (arguments.length == 0) {\n      sb = new StringBuilder();\n      this.BuildStringOfHierarchy(sb, 0, null);\n      return sb.toString();\n    }\n\n    sb = arguments[0] as StringBuilder;\n    let indentation = arguments[1] as number;\n    let pointedObj = arguments[2] as InkObject | null;\n\n    function appendIndentation() {\n      const spacesPerIndent = 4; // Truly const in the original code\n      for (let i = 0; i < spacesPerIndent * indentation; ++i) {\n        sb.Append(\" \");\n      }\n    }\n\n    appendIndentation();\n    sb.Append(\"[\");\n\n    if (this.hasValidName) {\n      sb.AppendFormat(\" ({0})\", this.name);\n    }\n\n    if (this == pointedObj) {\n      sb.Append(\"  <---\");\n    }\n\n    sb.AppendLine();\n\n    indentation++;\n\n    for (let i = 0; i < this.content.length; ++i) {\n      let obj = this.content[i];\n\n      if (obj instanceof Container) {\n        let container = obj as Container;\n\n        container.BuildStringOfHierarchy(sb, indentation, pointedObj);\n      } else {\n        appendIndentation();\n        if (obj instanceof StringValue) {\n          sb.Append('\"');\n          sb.Append(obj.toString().replace(\"\\n\", \"\\\\n\"));\n          sb.Append('\"');\n        } else {\n          sb.Append(obj.toString());\n        }\n      }\n\n      if (i != this.content.length - 1) {\n        sb.Append(\",\");\n      }\n\n      if (!(obj instanceof Container) && obj == pointedObj) {\n        sb.Append(\"  <---\");\n      }\n\n      sb.AppendLine();\n    }\n\n    let onlyNamed: Map<string, INamedContent> = new Map();\n\n    for (let [key, value] of this.namedContent) {\n      if (this.content.indexOf(asOrThrows(value, InkObject)) >= 0) {\n        continue;\n      } else {\n        onlyNamed.set(key, value);\n      }\n    }\n\n    if (onlyNamed.size > 0) {\n      appendIndentation();\n      sb.AppendLine(\"-- named: --\");\n\n      for (let [, value] of onlyNamed) {\n        Debug.AssertType(\n          value,\n          Container,\n          \"Can only print out named Containers\"\n        );\n        let container = value as Container;\n        container.BuildStringOfHierarchy(sb, indentation, pointedObj);\n        sb.AppendLine();\n      }\n    }\n\n    indentation--;\n\n    appendIndentation();\n    sb.Append(\"]\");\n  }\n}\n\nexport namespace Container {\n  export enum CountFlags {\n    Start = 0,\n    Visits = 1,\n    Turns = 2,\n    CountStartOnly = 4,\n  }\n}\n", "import { InkObject } from \"./Object\";\n\nexport class Glue extends InkObject {\n  public toString() {\n    return \"Glue\";\n  }\n}\n", "import { InkObject } from \"./Object\";\n\nexport class ControlCommand extends InkObject {\n  private _commandType: ControlCommand.CommandType;\n\n  get commandType(): ControlCommand.CommandType {\n    return this._commandType;\n  }\n\n  constructor(\n    commandType: ControlCommand.CommandType = ControlCommand.CommandType.NotSet\n  ) {\n    super();\n    this._commandType = commandType;\n  }\n\n  public Copy() {\n    return new ControlCommand(this.commandType);\n  }\n  public static EvalStart() {\n    return new ControlCommand(ControlCommand.CommandType.EvalStart);\n  }\n  public static EvalOutput() {\n    return new ControlCommand(ControlCommand.CommandType.EvalOutput);\n  }\n  public static EvalEnd() {\n    return new ControlCommand(ControlCommand.CommandType.EvalEnd);\n  }\n  public static Duplicate() {\n    return new ControlCommand(ControlCommand.CommandType.Duplicate);\n  }\n  public static PopEvaluatedValue() {\n    return new ControlCommand(ControlCommand.CommandType.PopEvaluatedValue);\n  }\n  public static PopFunction() {\n    return new ControlCommand(ControlCommand.CommandType.PopFunction);\n  }\n  public static PopTunnel() {\n    return new ControlCommand(ControlCommand.CommandType.PopTunnel);\n  }\n  public static BeginString() {\n    return new ControlCommand(ControlCommand.CommandType.BeginString);\n  }\n  public static EndString() {\n    return new ControlCommand(ControlCommand.CommandType.EndString);\n  }\n  public static NoOp() {\n    return new ControlCommand(ControlCommand.CommandType.NoOp);\n  }\n  public static ChoiceCount() {\n    return new ControlCommand(ControlCommand.CommandType.ChoiceCount);\n  }\n  public static Turns() {\n    return new ControlCommand(ControlCommand.CommandType.Turns);\n  }\n  public static TurnsSince() {\n    return new ControlCommand(ControlCommand.CommandType.TurnsSince);\n  }\n  public static ReadCount() {\n    return new ControlCommand(ControlCommand.CommandType.ReadCount);\n  }\n  public static Random() {\n    return new ControlCommand(ControlCommand.CommandType.Random);\n  }\n  public static SeedRandom() {\n    return new ControlCommand(ControlCommand.CommandType.SeedRandom);\n  }\n  public static VisitIndex() {\n    return new ControlCommand(ControlCommand.CommandType.VisitIndex);\n  }\n  public static SequenceShuffleIndex() {\n    return new ControlCommand(ControlCommand.CommandType.SequenceShuffleIndex);\n  }\n  public static StartThread() {\n    return new ControlCommand(ControlCommand.CommandType.StartThread);\n  }\n  public static Done() {\n    return new ControlCommand(ControlCommand.CommandType.Done);\n  }\n  public static End() {\n    return new ControlCommand(ControlCommand.CommandType.End);\n  }\n  public static ListFromInt() {\n    return new ControlCommand(ControlCommand.CommandType.ListFromInt);\n  }\n  public static ListRange() {\n    return new ControlCommand(ControlCommand.CommandType.ListRange);\n  }\n  public static ListRandom() {\n    return new ControlCommand(ControlCommand.CommandType.ListRandom);\n  }\n  public static BeginTag() {\n    return new ControlCommand(ControlCommand.CommandType.BeginTag);\n  }\n  public static EndTag() {\n    return new ControlCommand(ControlCommand.CommandType.EndTag);\n  }\n  public toString() {\n    return \"ControlCommand \" + this.commandType.toString();\n  }\n}\n\nexport namespace ControlCommand {\n  export enum CommandType {\n    NotSet = -1,\n    EvalStart, // 0\n    EvalOutput, // 1\n    EvalEnd, // 2\n    Duplicate, // 3\n    PopEvaluatedValue, // 4\n    PopFunction, // 5\n    PopTunnel, // 6\n    BeginString, // 7\n    EndString, // 8\n    NoOp, // 9\n    ChoiceCount, // 10\n    Turns, // 11\n    TurnsSince, // 12\n    ReadCount, // 13\n    Random, // 14\n    SeedRandom, // 15\n    VisitIndex, // 16\n    SequenceShuffleIndex, // 17\n    StartThread, // 18\n    Done, // 19\n    End, // 20\n    ListFromInt, // 21\n    ListRange, // 22\n    ListRandom, // 23\n    BeginTag, // 24\n    EndTag, // 25\n\n    TOTAL_VALUES,\n  }\n}\n", "import { Path } from \"./Path\";\nimport { Container } from \"./Container\";\nimport { InkObject } from \"./Object\";\n\nexport class Pointer {\n  public container: Container | null = null;\n  public index: number = -1;\n\n  constructor();\n  constructor(container: Container | null, index: number);\n  constructor() {\n    if (arguments.length === 2) {\n      this.container = arguments[0];\n      this.index = arguments[1];\n    }\n  }\n\n  public Resolve(): InkObject | null {\n    if (this.index < 0) return this.container;\n    if (this.container == null) return null;\n    if (this.container.content.length == 0) return this.container;\n    if (this.index >= this.container.content.length) return null;\n\n    return this.container.content[this.index];\n  }\n\n  get isNull(): boolean {\n    return this.container == null;\n  }\n\n  get path(): Path | null {\n    if (this.isNull) return null;\n\n    if (this.index >= 0)\n      return this.container!.path.PathByAppendingComponent(\n        new Path.Component(this.index)\n      );\n    else return this.container!.path;\n  }\n\n  public toString(): string {\n    if (!this.container) return \"Ink Pointer (null)\";\n\n    return (\n      \"Ink Pointer -> \" +\n      this.container.path.toString() +\n      \" -- index \" +\n      this.index\n    );\n  }\n\n  // This method does not exist in the original C# code, but is here to maintain the\n  // value semantics of Pointer.\n  public copy(): Pointer {\n    return new Pointer(this.container, this.index);\n  }\n\n  public static StartOf(container: Container | null): Pointer {\n    return new Pointer(container, 0);\n  }\n\n  public static get Null(): Pointer {\n    return new Pointer(null, -1);\n  }\n}\n", "import { Path } from \"./Path\";\nimport { PushPopType } from \"./PushPop\";\nimport { StringBuilder } from \"./StringBuilder\";\nimport { InkObject } from \"./Object\";\nimport { Pointer } from \"./Pointer\";\nimport { Container } from \"./Container\";\nimport { throwNullException } from \"./NullException\";\n\nexport class Divert extends InkObject {\n  get targetPath() {\n    if (this._targetPath != null && this._targetPath.isRelative) {\n      let targetObj = this.targetPointer.Resolve();\n      if (targetObj) {\n        this._targetPath = targetObj.path;\n      }\n    }\n\n    return this._targetPath;\n  }\n  set targetPath(value: Path | null) {\n    this._targetPath = value;\n    this._targetPointer = Pointer.Null;\n  }\n\n  public _targetPath: Path | null = null;\n\n  get targetPointer() {\n    if (this._targetPointer.isNull) {\n      let targetObj = this.ResolvePath(this._targetPath).obj;\n\n      if (this._targetPath === null)\n        return throwNullException(\"this._targetPath\");\n      if (this._targetPath.lastComponent === null)\n        return throwNullException(\"this._targetPath.lastComponent\");\n\n      if (this._targetPath.lastComponent.isIndex) {\n        if (targetObj === null) return throwNullException(\"targetObj\");\n        this._targetPointer.container =\n          targetObj.parent instanceof Container ? targetObj.parent : null;\n        this._targetPointer.index = this._targetPath.lastComponent.index;\n      } else {\n        this._targetPointer = Pointer.StartOf(\n          targetObj instanceof Container ? targetObj : null\n        );\n      }\n    }\n\n    return this._targetPointer.copy();\n  }\n\n  public _targetPointer: Pointer = Pointer.Null;\n\n  get targetPathString() {\n    if (this.targetPath == null) return null;\n\n    return this.CompactPathString(this.targetPath);\n  }\n  set targetPathString(value: string | null) {\n    if (value == null) {\n      this.targetPath = null;\n    } else {\n      this.targetPath = new Path(value);\n    }\n  }\n\n  public variableDivertName: string | null = null;\n  get hasVariableTarget() {\n    return this.variableDivertName != null;\n  }\n\n  public pushesToStack: boolean = false;\n  public stackPushType: PushPopType = 0;\n\n  public isExternal: boolean = false;\n  public externalArgs: number = 0;\n\n  public isConditional: boolean = false;\n\n  constructor(stackPushType?: PushPopType) {\n    super();\n    this.pushesToStack = false;\n\n    if (typeof stackPushType !== \"undefined\") {\n      this.pushesToStack = true;\n      this.stackPushType = stackPushType;\n    }\n  }\n\n  public Equals(obj: Divert | null) {\n    let otherDivert = obj;\n    if (otherDivert instanceof Divert) {\n      if (this.hasVariableTarget == otherDivert.hasVariableTarget) {\n        if (this.hasVariableTarget) {\n          return this.variableDivertName == otherDivert.variableDivertName;\n        } else {\n          if (this.targetPath === null)\n            return throwNullException(\"this.targetPath\");\n          return this.targetPath.Equals(otherDivert.targetPath);\n        }\n      }\n    }\n    return false;\n  }\n\n  public toString() {\n    if (this.hasVariableTarget) {\n      return \"Divert(variable: \" + this.variableDivertName + \")\";\n    } else if (this.targetPath == null) {\n      return \"Divert(null)\";\n    } else {\n      let sb = new StringBuilder();\n\n      let targetStr = this.targetPath.toString();\n      // int? targetLineNum = DebugLineNumberOfPath (targetPath);\n      let targetLineNum = null;\n      if (targetLineNum != null) {\n        targetStr = \"line \" + targetLineNum;\n      }\n\n      sb.Append(\"Divert\");\n\n      if (this.isConditional) sb.Append(\"?\");\n\n      if (this.pushesToStack) {\n        if (this.stackPushType == PushPopType.Function) {\n          sb.Append(\" function\");\n        } else {\n          sb.Append(\" tunnel\");\n        }\n      }\n\n      sb.Append(\" -> \");\n      sb.Append(this.targetPathString);\n\n      sb.Append(\" (\");\n      sb.Append(targetStr);\n      sb.Append(\")\");\n\n      return sb.toString();\n    }\n  }\n}\n", "import { InkObject } from \"./Object\";\nimport { Path } from \"./Path\";\nimport { Container } from \"./Container\";\nimport { throwNullException } from \"./NullException\";\n\nexport class ChoicePoint extends InkObject {\n  public _pathOnChoice: Path | null = null;\n  public hasCondition: boolean = false;\n  public hasStartContent: boolean = false;\n  public hasChoiceOnlyContent: boolean = false;\n  public isInvisibleDefault: boolean = false;\n  public onceOnly: boolean = true;\n\n  constructor(onceOnly: boolean = true) {\n    super();\n    this.onceOnly = onceOnly;\n  }\n  get pathOnChoice(): Path | null {\n    if (this._pathOnChoice != null && this._pathOnChoice.isRelative) {\n      let choiceTargetObj = this.choiceTarget;\n      if (choiceTargetObj) {\n        this._pathOnChoice = choiceTargetObj.path;\n      }\n    }\n    return this._pathOnChoice;\n  }\n  set pathOnChoice(value: Path | null) {\n    this._pathOnChoice = value;\n  }\n  get choiceTarget(): Container | null {\n    if (this._pathOnChoice === null)\n      return throwNullException(\"ChoicePoint._pathOnChoice\");\n    return this.ResolvePath(this._pathOnChoice).container;\n  }\n  get pathStringOnChoice(): string {\n    if (this.pathOnChoice === null)\n      return throwNullException(\"ChoicePoint.pathOnChoice\");\n    return this.CompactPathString(this.pathOnChoice);\n  }\n  set pathStringOnChoice(value: string) {\n    this.pathOnChoice = new Path(value);\n  }\n  get flags(): number {\n    let flags = 0;\n    if (this.hasCondition) flags |= 1;\n    if (this.hasStartContent) flags |= 2;\n    if (this.hasChoiceOnlyContent) flags |= 4;\n    if (this.isInvisibleDefault) flags |= 8;\n    if (this.onceOnly) flags |= 16;\n    return flags;\n  }\n  set flags(value: number) {\n    this.hasCondition = (value & 1) > 0;\n    this.hasStartContent = (value & 2) > 0;\n    this.hasChoiceOnlyContent = (value & 4) > 0;\n    this.isInvisibleDefault = (value & 8) > 0;\n    this.onceOnly = (value & 16) > 0;\n  }\n  public toString(): string {\n    if (this.pathOnChoice === null)\n      return throwNullException(\"ChoicePoint.pathOnChoice\");\n    // int? targetLineNum = DebugLineNumberOfPath (pathOnChoice);\n    let targetLineNum = null;\n    let targetString = this.pathOnChoice.toString();\n\n    if (targetLineNum != null) {\n      targetString = \" line \" + targetLineNum + \"(\" + targetString + \")\";\n    }\n\n    return \"Choice: -> \" + targetString;\n  }\n}\n", "import { InkObject } from \"./Object\";\nimport { Path } from \"./Path\";\n\nexport class VariableReference extends InkObject {\n  public name: string | null;\n  public pathForCount: Path | null = null;\n\n  get containerForCount() {\n    if (this.pathForCount === null) return null;\n    return this.ResolvePath(this.pathForCount).container;\n  }\n  get pathStringForCount() {\n    if (this.pathForCount === null) return null;\n\n    return this.CompactPathString(this.pathForCount);\n  }\n  set pathStringForCount(value: string | null) {\n    if (value === null) this.pathForCount = null;\n    else this.pathForCount = new Path(value);\n  }\n\n  constructor(name: string | null = null) {\n    super();\n    this.name = name;\n  }\n\n  public toString() {\n    if (this.name != null) {\n      return \"var(\" + this.name + \")\";\n    } else {\n      let pathStr = this.pathStringForCount;\n      return \"read_count(\" + pathStr + \")\";\n    }\n  }\n}\n", "import { InkObject } from \"./Object\";\n\nexport class VariableAssignment extends InkObject {\n  public readonly variableName: string | null;\n  public readonly isNewDeclaration: boolean;\n  public isGlobal: boolean;\n\n  constructor(variableName: string | null, isNewDeclaration: boolean) {\n    super();\n    this.variableName = variableName || null;\n    this.isNewDeclaration = !!isNewDeclaration;\n    this.isGlobal = false;\n  }\n\n  public toString(): string {\n    return \"VarAssign to \" + this.variableName;\n  }\n}\n", "import { InkObject } from \"./Object\";\n\nexport class Void extends InkObject {\n  public toString() {\n    return \"Void\";\n  }\n}\n", "import { Value, ValueType, IntValue, ListValue, BoolValue } from \"./Value\";\nimport { StoryException } from \"./StoryException\";\nimport { Void } from \"./Void\";\nimport { Path } from \"./Path\";\nimport { InkList, InkListItem } from \"./InkList\";\nimport { InkObject } from \"./Object\";\nimport { asOrNull, asOrThrows, asBooleanOrThrows } from \"./TypeAssertion\";\nimport { throwNullException } from \"./NullException\";\n\ntype BinaryOp<T> = (left: T, right: T) => any;\ntype UnaryOp<T> = (val: T) => any;\n\nexport class NativeFunctionCall extends InkObject {\n  public static readonly Add: string = \"+\";\n  public static readonly Subtract: string = \"-\";\n  public static readonly Divide: string = \"/\";\n  public static readonly Multiply: string = \"*\";\n  public static readonly Mod: string = \"%\";\n  public static readonly Negate: string = \"_\";\n  public static readonly Equal: string = \"==\";\n  public static readonly Greater: string = \">\";\n  public static readonly Less: string = \"<\";\n  public static readonly GreaterThanOrEquals: string = \">=\";\n  public static readonly LessThanOrEquals: string = \"<=\";\n  public static readonly NotEquals: string = \"!=\";\n  public static readonly Not: string = \"!\";\n  public static readonly And: string = \"&&\";\n  public static readonly Or: string = \"||\";\n  public static readonly Min: string = \"MIN\";\n  public static readonly Max: string = \"MAX\";\n  public static readonly Pow: string = \"POW\";\n  public static readonly Floor: string = \"FLOOR\";\n  public static readonly Ceiling: string = \"CEILING\";\n  public static readonly Int: string = \"INT\";\n  public static readonly Float: string = \"FLOAT\";\n  public static readonly Has: string = \"?\";\n  public static readonly Hasnt: string = \"!?\";\n  public static readonly Intersect: string = \"^\";\n  public static readonly ListMin: string = \"LIST_MIN\";\n  public static readonly ListMax: string = \"LIST_MAX\";\n  public static readonly All: string = \"LIST_ALL\";\n  public static readonly Count: string = \"LIST_COUNT\";\n  public static readonly ValueOfList: string = \"LIST_VALUE\";\n  public static readonly Invert: string = \"LIST_INVERT\";\n\n  public static CallWithName(functionName: string) {\n    return new NativeFunctionCall(functionName);\n  }\n\n  public static CallExistsWithName(functionName: string) {\n    this.GenerateNativeFunctionsIfNecessary();\n    return this._nativeFunctions!.get(functionName);\n  }\n\n  get name() {\n    if (this._name === null)\n      return throwNullException(\"NativeFunctionCall._name\");\n    return this._name;\n  }\n  set name(value: string) {\n    this._name = value;\n    if (!this._isPrototype) {\n      if (NativeFunctionCall._nativeFunctions === null)\n        throwNullException(\"NativeFunctionCall._nativeFunctions\");\n      else\n        this._prototype =\n          NativeFunctionCall._nativeFunctions.get(this._name) || null;\n    }\n  }\n  public _name: string | null = null;\n\n  get numberOfParameters() {\n    if (this._prototype) {\n      return this._prototype.numberOfParameters;\n    } else {\n      return this._numberOfParameters;\n    }\n  }\n  set numberOfParameters(value: number) {\n    this._numberOfParameters = value;\n  }\n  public _numberOfParameters: number = 0;\n\n  public Call(parameters: InkObject[]): InkObject | null {\n    if (this._prototype) {\n      return this._prototype.Call(parameters);\n    }\n\n    if (this.numberOfParameters != parameters.length) {\n      throw new Error(\"Unexpected number of parameters\");\n    }\n\n    let hasList = false;\n    for (let p of parameters) {\n      if (p instanceof Void)\n        throw new StoryException(\n          \"Attempting to perform \" +\n            this.name +\n            ' on a void value. Did you forget to \"return\" a value from a function you called here?'\n        );\n      if (p instanceof ListValue) hasList = true;\n    }\n\n    if (parameters.length == 2 && hasList) {\n      return this.CallBinaryListOperation(parameters);\n    }\n\n    let coercedParams = this.CoerceValuesToSingleType(parameters);\n    let coercedType = coercedParams[0].valueType;\n\n    if (coercedType == ValueType.Int) {\n      return this.CallType<number>(coercedParams);\n    } else if (coercedType == ValueType.Float) {\n      return this.CallType<number>(coercedParams);\n    } else if (coercedType == ValueType.String) {\n      return this.CallType<string>(coercedParams);\n    } else if (coercedType == ValueType.DivertTarget) {\n      return this.CallType<Path>(coercedParams);\n    } else if (coercedType == ValueType.List) {\n      return this.CallType<InkList>(coercedParams);\n    }\n\n    return null;\n  }\n\n  public CallType<T extends { toString: () => string }>(\n    parametersOfSingleType: Array<Value<T>>\n  ) {\n    let param1 = asOrThrows(parametersOfSingleType[0], Value);\n    let valType = param1.valueType;\n\n    let val1 = param1 as Value<T>;\n\n    let paramCount = parametersOfSingleType.length;\n\n    if (paramCount == 2 || paramCount == 1) {\n      if (this._operationFuncs === null)\n        return throwNullException(\"NativeFunctionCall._operationFuncs\");\n      let opForTypeObj = this._operationFuncs.get(valType);\n      if (!opForTypeObj) {\n        const key = ValueType[valType];\n        throw new StoryException(\n          \"Cannot perform operation \" + this.name + \" on \" + key\n        );\n      }\n\n      if (paramCount == 2) {\n        let param2 = asOrThrows(parametersOfSingleType[1], Value);\n\n        let val2 = param2 as Value<T>;\n\n        let opForType = opForTypeObj as BinaryOp<T>;\n\n        if (val1.value === null || val2.value === null)\n          return throwNullException(\"NativeFunctionCall.Call BinaryOp values\");\n        let resultVal = opForType(val1.value, val2.value);\n\n        return Value.Create(resultVal);\n      } else {\n        let opForType = opForTypeObj as UnaryOp<T>;\n\n        if (val1.value === null)\n          return throwNullException(\"NativeFunctionCall.Call UnaryOp value\");\n        let resultVal = opForType(val1.value);\n\n        // This code is different from upstream. Since JavaScript treats\n        // integers and floats as the same numbers, it's impossible\n        // to force an number to be either an integer or a float.\n        //\n        // It can be useful to force a specific number type\n        // (especially for divisions), so the result of INT() & FLOAT()\n        // is coerced to the the proper value type.\n        //\n        // Note that we also force all other unary operation to\n        // return the same value type, although this is only\n        // meaningful for numbers. See `Value.Create`.\n        if (this.name === NativeFunctionCall.Int) {\n          return Value.Create(resultVal, ValueType.Int);\n        } else if (this.name === NativeFunctionCall.Float) {\n          return Value.Create(resultVal, ValueType.Float);\n        } else {\n          return Value.Create(resultVal, param1.valueType);\n        }\n      }\n    } else {\n      throw new Error(\n        \"Unexpected number of parameters to NativeFunctionCall: \" +\n          parametersOfSingleType.length\n      );\n    }\n  }\n\n  public CallBinaryListOperation(parameters: InkObject[]) {\n    if (\n      (this.name == \"+\" || this.name == \"-\") &&\n      parameters[0] instanceof ListValue &&\n      parameters[1] instanceof IntValue\n    )\n      return this.CallListIncrementOperation(parameters);\n\n    let v1 = asOrThrows(parameters[0], Value);\n    let v2 = asOrThrows(parameters[1], Value);\n\n    if (\n      (this.name == \"&&\" || this.name == \"||\") &&\n      (v1.valueType != ValueType.List || v2.valueType != ValueType.List)\n    ) {\n      if (this._operationFuncs === null)\n        return throwNullException(\"NativeFunctionCall._operationFuncs\");\n      let op = this._operationFuncs.get(ValueType.Int) as BinaryOp<number>;\n      if (op === null)\n        return throwNullException(\n          \"NativeFunctionCall.CallBinaryListOperation op\"\n        );\n      let result = asBooleanOrThrows(\n        op(v1.isTruthy ? 1 : 0, v2.isTruthy ? 1 : 0)\n      );\n      return new BoolValue(result);\n    }\n\n    if (v1.valueType == ValueType.List && v2.valueType == ValueType.List)\n      return this.CallType<InkList>([v1, v2]);\n\n    throw new StoryException(\n      \"Can not call use \" +\n        this.name +\n        \" operation on \" +\n        ValueType[v1.valueType] +\n        \" and \" +\n        ValueType[v2.valueType]\n    );\n  }\n\n  public CallListIncrementOperation(listIntParams: InkObject[]) {\n    let listVal = asOrThrows(listIntParams[0], ListValue);\n    let intVal = asOrThrows(listIntParams[1], IntValue);\n\n    let resultInkList = new InkList();\n\n    if (listVal.value === null)\n      return throwNullException(\n        \"NativeFunctionCall.CallListIncrementOperation listVal.value\"\n      );\n    for (let [listItemKey, listItemValue] of listVal.value) {\n      let listItem = InkListItem.fromSerializedKey(listItemKey);\n\n      if (this._operationFuncs === null)\n        return throwNullException(\"NativeFunctionCall._operationFuncs\");\n      let intOp = this._operationFuncs.get(ValueType.Int) as BinaryOp<number>;\n\n      if (intVal.value === null)\n        return throwNullException(\n          \"NativeFunctionCall.CallListIncrementOperation intVal.value\"\n        );\n      let targetInt = intOp(listItemValue, intVal.value);\n\n      let itemOrigin = null;\n      if (listVal.value.origins === null)\n        return throwNullException(\n          \"NativeFunctionCall.CallListIncrementOperation listVal.value.origins\"\n        );\n      for (let origin of listVal.value.origins) {\n        if (origin.name == listItem.originName) {\n          itemOrigin = origin;\n          break;\n        }\n      }\n      if (itemOrigin != null) {\n        let incrementedItem = itemOrigin.TryGetItemWithValue(\n          targetInt,\n          InkListItem.Null\n        );\n        if (incrementedItem.exists)\n          resultInkList.Add(incrementedItem.result, targetInt);\n      }\n    }\n\n    return new ListValue(resultInkList);\n  }\n\n  public CoerceValuesToSingleType(parametersIn: InkObject[]) {\n    let valType = ValueType.Int;\n\n    let specialCaseList: null | ListValue = null;\n\n    for (let obj of parametersIn) {\n      let val = asOrThrows(obj, Value);\n      if (val.valueType > valType) {\n        valType = val.valueType;\n      }\n\n      if (val.valueType == ValueType.List) {\n        specialCaseList = asOrNull(val, ListValue);\n      }\n    }\n\n    let parametersOut = [];\n\n    if (ValueType[valType] == ValueType[ValueType.List]) {\n      for (let inkObjectVal of parametersIn) {\n        let val = asOrThrows(inkObjectVal, Value);\n        if (val.valueType == ValueType.List) {\n          parametersOut.push(val);\n        } else if (val.valueType == ValueType.Int) {\n          let intVal = parseInt(val.valueObject);\n\n          specialCaseList = asOrThrows(specialCaseList, ListValue);\n          if (specialCaseList.value === null)\n            return throwNullException(\n              \"NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value\"\n            );\n          let list = specialCaseList.value.originOfMaxItem;\n\n          if (list === null)\n            return throwNullException(\n              \"NativeFunctionCall.CoerceValuesToSingleType list\"\n            );\n          let item = list.TryGetItemWithValue(intVal, InkListItem.Null);\n          if (item.exists) {\n            let castedValue = new ListValue(item.result, intVal);\n            parametersOut.push(castedValue);\n          } else\n            throw new StoryException(\n              \"Could not find List item with the value \" +\n                intVal +\n                \" in \" +\n                list.name\n            );\n        } else {\n          const key = ValueType[val.valueType];\n          throw new StoryException(\n            \"Cannot mix Lists and \" + key + \" values in this operation\"\n          );\n        }\n      }\n    } else {\n      for (let inkObjectVal of parametersIn) {\n        let val = asOrThrows(inkObjectVal, Value);\n        let castedValue = val.Cast(valType);\n        parametersOut.push(castedValue);\n      }\n    }\n\n    return parametersOut;\n  }\n\n  constructor(name: string);\n  constructor(name: string, numberOfParameters: number);\n  constructor();\n  constructor() {\n    super();\n\n    if (arguments.length === 0) {\n      NativeFunctionCall.GenerateNativeFunctionsIfNecessary();\n    } else if (arguments.length === 1) {\n      let name = arguments[0];\n      NativeFunctionCall.GenerateNativeFunctionsIfNecessary();\n      this.name = name;\n    } else if (arguments.length === 2) {\n      let name = arguments[0];\n      let numberOfParameters = arguments[1];\n\n      this._isPrototype = true;\n      this.name = name;\n      this.numberOfParameters = numberOfParameters;\n    }\n  }\n\n  public static Identity<T>(t: T): any {\n    return t;\n  }\n\n  public static GenerateNativeFunctionsIfNecessary() {\n    if (this._nativeFunctions == null) {\n      this._nativeFunctions = new Map();\n\n      // Int operations\n      this.AddIntBinaryOp(this.Add, (x, y) => x + y);\n      this.AddIntBinaryOp(this.Subtract, (x, y) => x - y);\n      this.AddIntBinaryOp(this.Multiply, (x, y) => x * y);\n      this.AddIntBinaryOp(this.Divide, (x, y) => Math.floor(x / y));\n      this.AddIntBinaryOp(this.Mod, (x, y) => x % y);\n      this.AddIntUnaryOp(this.Negate, (x) => -x);\n\n      this.AddIntBinaryOp(this.Equal, (x, y) => x == y);\n      this.AddIntBinaryOp(this.Greater, (x, y) => x > y);\n      this.AddIntBinaryOp(this.Less, (x, y) => x < y);\n      this.AddIntBinaryOp(this.GreaterThanOrEquals, (x, y) => x >= y);\n      this.AddIntBinaryOp(this.LessThanOrEquals, (x, y) => x <= y);\n      this.AddIntBinaryOp(this.NotEquals, (x, y) => x != y);\n      this.AddIntUnaryOp(this.Not, (x) => x == 0);\n\n      this.AddIntBinaryOp(this.And, (x, y) => x != 0 && y != 0);\n      this.AddIntBinaryOp(this.Or, (x, y) => x != 0 || y != 0);\n\n      this.AddIntBinaryOp(this.Max, (x, y) => Math.max(x, y));\n      this.AddIntBinaryOp(this.Min, (x, y) => Math.min(x, y));\n\n      this.AddIntBinaryOp(this.Pow, (x, y) => Math.pow(x, y));\n      this.AddIntUnaryOp(this.Floor, NativeFunctionCall.Identity);\n      this.AddIntUnaryOp(this.Ceiling, NativeFunctionCall.Identity);\n      this.AddIntUnaryOp(this.Int, NativeFunctionCall.Identity);\n      this.AddIntUnaryOp(this.Float, (x) => x);\n\n      // Float operations\n      this.AddFloatBinaryOp(this.Add, (x, y) => x + y);\n      this.AddFloatBinaryOp(this.Subtract, (x, y) => x - y);\n      this.AddFloatBinaryOp(this.Multiply, (x, y) => x * y);\n      this.AddFloatBinaryOp(this.Divide, (x, y) => x / y);\n      this.AddFloatBinaryOp(this.Mod, (x, y) => x % y);\n      this.AddFloatUnaryOp(this.Negate, (x) => -x);\n\n      this.AddFloatBinaryOp(this.Equal, (x, y) => x == y);\n      this.AddFloatBinaryOp(this.Greater, (x, y) => x > y);\n      this.AddFloatBinaryOp(this.Less, (x, y) => x < y);\n      this.AddFloatBinaryOp(this.GreaterThanOrEquals, (x, y) => x >= y);\n      this.AddFloatBinaryOp(this.LessThanOrEquals, (x, y) => x <= y);\n      this.AddFloatBinaryOp(this.NotEquals, (x, y) => x != y);\n      this.AddFloatUnaryOp(this.Not, (x) => x == 0.0);\n\n      this.AddFloatBinaryOp(this.And, (x, y) => x != 0.0 && y != 0.0);\n      this.AddFloatBinaryOp(this.Or, (x, y) => x != 0.0 || y != 0.0);\n\n      this.AddFloatBinaryOp(this.Max, (x, y) => Math.max(x, y));\n      this.AddFloatBinaryOp(this.Min, (x, y) => Math.min(x, y));\n\n      this.AddFloatBinaryOp(this.Pow, (x, y) => Math.pow(x, y));\n      this.AddFloatUnaryOp(this.Floor, (x) => Math.floor(x));\n      this.AddFloatUnaryOp(this.Ceiling, (x) => Math.ceil(x));\n      this.AddFloatUnaryOp(this.Int, (x) => Math.floor(x));\n      this.AddFloatUnaryOp(this.Float, NativeFunctionCall.Identity);\n\n      // String operations\n      this.AddStringBinaryOp(this.Add, (x, y) => x + y); // concat\n      this.AddStringBinaryOp(this.Equal, (x, y) => x === y);\n      this.AddStringBinaryOp(this.NotEquals, (x, y) => !(x === y));\n      this.AddStringBinaryOp(this.Has, (x, y) => x.includes(y));\n      this.AddStringBinaryOp(this.Hasnt, (x, y) => !x.includes(y));\n\n      this.AddListBinaryOp(this.Add, (x, y) => x.Union(y));\n      this.AddListBinaryOp(this.Subtract, (x, y) => x.Without(y));\n      this.AddListBinaryOp(this.Has, (x, y) => x.Contains(y));\n      this.AddListBinaryOp(this.Hasnt, (x, y) => !x.Contains(y));\n      this.AddListBinaryOp(this.Intersect, (x, y) => x.Intersect(y));\n\n      this.AddListBinaryOp(this.Equal, (x, y) => x.Equals(y));\n      this.AddListBinaryOp(this.Greater, (x, y) => x.GreaterThan(y));\n      this.AddListBinaryOp(this.Less, (x, y) => x.LessThan(y));\n      this.AddListBinaryOp(this.GreaterThanOrEquals, (x, y) =>\n        x.GreaterThanOrEquals(y)\n      );\n      this.AddListBinaryOp(this.LessThanOrEquals, (x, y) =>\n        x.LessThanOrEquals(y)\n      );\n      this.AddListBinaryOp(this.NotEquals, (x, y) => !x.Equals(y));\n\n      this.AddListBinaryOp(this.And, (x, y) => x.Count > 0 && y.Count > 0);\n      this.AddListBinaryOp(this.Or, (x, y) => x.Count > 0 || y.Count > 0);\n\n      this.AddListUnaryOp(this.Not, (x) => (x.Count == 0 ? 1 : 0));\n\n      this.AddListUnaryOp(this.Invert, (x) => x.inverse);\n      this.AddListUnaryOp(this.All, (x) => x.all);\n      this.AddListUnaryOp(this.ListMin, (x) => x.MinAsList());\n      this.AddListUnaryOp(this.ListMax, (x) => x.MaxAsList());\n      this.AddListUnaryOp(this.Count, (x) => x.Count);\n      this.AddListUnaryOp(this.ValueOfList, (x) => x.maxItem.Value);\n\n      let divertTargetsEqual = (d1: Path, d2: Path) => d1.Equals(d2);\n      let divertTargetsNotEqual = (d1: Path, d2: Path) => !d1.Equals(d2);\n      this.AddOpToNativeFunc(\n        this.Equal,\n        2,\n        ValueType.DivertTarget,\n        divertTargetsEqual\n      );\n      this.AddOpToNativeFunc(\n        this.NotEquals,\n        2,\n        ValueType.DivertTarget,\n        divertTargetsNotEqual\n      );\n    }\n  }\n\n  public AddOpFuncForType(\n    valType: ValueType,\n    op: UnaryOp<number | InkList> | BinaryOp<number | string | InkList | Path>\n  ): void {\n    if (this._operationFuncs == null) {\n      this._operationFuncs = new Map();\n    }\n\n    this._operationFuncs.set(valType, op);\n  }\n\n  public static AddOpToNativeFunc(\n    name: string,\n    args: number,\n    valType: ValueType,\n    op: UnaryOp<any> | BinaryOp<any>\n  ): void {\n    if (this._nativeFunctions === null)\n      return throwNullException(\"NativeFunctionCall._nativeFunctions\");\n    let nativeFunc = this._nativeFunctions.get(name);\n    if (!nativeFunc) {\n      nativeFunc = new NativeFunctionCall(name, args);\n      this._nativeFunctions.set(name, nativeFunc);\n    }\n\n    nativeFunc.AddOpFuncForType(valType, op);\n  }\n\n  public static AddIntBinaryOp(name: string, op: BinaryOp<number>) {\n    this.AddOpToNativeFunc(name, 2, ValueType.Int, op);\n  }\n  public static AddIntUnaryOp(name: string, op: UnaryOp<number>) {\n    this.AddOpToNativeFunc(name, 1, ValueType.Int, op);\n  }\n\n  public static AddFloatBinaryOp(name: string, op: BinaryOp<number>) {\n    this.AddOpToNativeFunc(name, 2, ValueType.Float, op);\n  }\n  public static AddFloatUnaryOp(name: string, op: UnaryOp<number>) {\n    this.AddOpToNativeFunc(name, 1, ValueType.Float, op);\n  }\n\n  public static AddStringBinaryOp(name: string, op: BinaryOp<string>) {\n    this.AddOpToNativeFunc(name, 2, ValueType.String, op);\n  }\n\n  public static AddListBinaryOp(name: string, op: BinaryOp<InkList>) {\n    this.AddOpToNativeFunc(name, 2, ValueType.List, op);\n  }\n  public static AddListUnaryOp(name: string, op: UnaryOp<InkList>) {\n    this.AddOpToNativeFunc(name, 1, ValueType.List, op);\n  }\n\n  public toString() {\n    return 'Native \"' + this.name + '\"';\n  }\n\n  public _prototype: NativeFunctionCall | null = null;\n  public _isPrototype: boolean = false;\n  public _operationFuncs: Map<ValueType, BinaryOp<any> | UnaryOp<any>> | null =\n    null;\n  public static _nativeFunctions: Map<string, NativeFunctionCall> | null = null;\n}\n", "import { InkObject } from \"./Object\";\n\n// New version of tags is dynamic - it constructs the tags\n// at runtime based on BeginTag and EndTag control commands.\n// Plain text that's in the output stream is turned into tags\n// when you do story.currentTags.\n// The only place this is used is when flattening tags down\n// to string in advance, during dynamic string generation if\n// there's a tag embedded in it. See how ControlCommand.EndString\n// is implemented in Story.cs for more details + comment\nexport class Tag extends InkObject {\n  public readonly text: string;\n\n  constructor(tagText: string) {\n    super();\n    this.text = tagText.toString() || \"\";\n  }\n\n  public toString(): string {\n    return \"# \" + this.text;\n  }\n}\n", "import { Path } from \"./Path\";\nimport { CallStack } from \"./CallStack\";\nimport { throwNullException } from \"./NullException\";\nimport { InkObject } from \"./Object\";\n\nexport class Choice extends InkObject {\n  public text: string = \"\";\n  public index: number = 0;\n  public threadAtGeneration: CallStack.Thread | null = null;\n  public sourcePath: string = \"\";\n  public targetPath: Path | null = null;\n  public isInvisibleDefault: boolean = false;\n  public tags: string[] | null = null;\n  public originalThreadIndex: number = 0;\n\n  get pathStringOnChoice(): string {\n    if (this.targetPath === null)\n      return throwNullException(\"Choice.targetPath\");\n    return this.targetPath.toString();\n  }\n  set pathStringOnChoice(value: string) {\n    this.targetPath = new Path(value);\n  }\n\n  public Clone() {\n    let copy = new Choice();\n    copy.text = this.text;\n    copy.sourcePath = this.sourcePath;\n    copy.index = this.index;\n    copy.targetPath = this.targetPath;\n    copy.originalThreadIndex = this.originalThreadIndex;\n    copy.isInvisibleDefault = this.isInvisibleDefault;\n    if (this.threadAtGeneration !== null)\n      copy.threadAtGeneration = this.threadAtGeneration.Copy();\n\n    return copy;\n  }\n}\n", "import { InkListItem, SerializedInkListItem } from \"./InkList\";\nimport { TryGetResult } from \"./TryGetResult\";\n\nexport class ListDefinition {\n  public _name: string;\n  public _items: Map<SerializedInkListItem, number> | null;\n  public _itemNameToValues: Map<string, number>;\n\n  constructor(name: string, items: Map<string, number> | null) {\n    this._name = name || \"\";\n    this._items = null;\n    this._itemNameToValues = items || new Map();\n  }\n  get name() {\n    return this._name;\n  }\n  get items() {\n    if (this._items == null) {\n      this._items = new Map();\n      for (let [key, value] of this._itemNameToValues) {\n        let item = new InkListItem(this.name, key);\n        this._items.set(item.serialized(), value);\n      }\n    }\n\n    return this._items;\n  }\n\n  public ValueForItem(item: InkListItem) {\n    if (!item.itemName) return 0;\n\n    let intVal = this._itemNameToValues.get(item.itemName);\n    if (typeof intVal !== \"undefined\") return intVal;\n    else return 0;\n  }\n  public ContainsItem(item: InkListItem) {\n    if (!item.itemName) return false;\n    if (item.originName != this.name) return false;\n\n    return this._itemNameToValues.has(item.itemName);\n  }\n  public ContainsItemWithName(itemName: string) {\n    return this._itemNameToValues.has(itemName);\n  }\n  public TryGetItemWithValue(\n    val: number,\n    /* out */ item: InkListItem\n  ): TryGetResult<InkListItem> {\n    for (let [key, value] of this._itemNameToValues) {\n      if (value == val) {\n        item = new InkListItem(this.name, key);\n        return { result: item, exists: true };\n      }\n    }\n\n    item = InkListItem.Null;\n    return { result: item, exists: false };\n  }\n\n  public TryGetValueForItem(\n    item: InkListItem,\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    /* out */ intVal: number\n  ): TryGetResult<number> {\n    if (!item.itemName) return { result: 0, exists: false };\n    let value = this._itemNameToValues.get(item.itemName);\n\n    if (!value) return { result: 0, exists: false };\n    return { result: value, exists: true };\n  }\n}\n", "import { InkListItem } from \"./InkList\";\nimport { ListValue } from \"./Value\";\nimport { ListDefinition } from \"./ListDefinition\";\nimport { TryGetResult } from \"./TryGetResult\";\nimport { throwNullException } from \"./NullException\";\n\nexport class ListDefinitionsOrigin {\n  protected _lists: Map<string, ListDefinition>;\n  protected _allUnambiguousListValueCache: Map<string, ListValue>;\n\n  constructor(lists: ListDefinition[]) {\n    this._lists = new Map();\n    this._allUnambiguousListValueCache = new Map();\n\n    for (let list of lists) {\n      this._lists.set(list.name, list);\n\n      for (let [key, val] of list.items) {\n        let item = InkListItem.fromSerializedKey(key);\n        let listValue = new ListValue(item, val);\n\n        if (!item.itemName) {\n          throw new Error(\"item.itemName is null or undefined.\");\n        }\n\n        this._allUnambiguousListValueCache.set(item.itemName, listValue);\n        this._allUnambiguousListValueCache.set(item.fullName, listValue);\n      }\n    }\n  }\n  get lists(): ListDefinition[] {\n    let listOfLists: ListDefinition[] = [];\n\n    for (let [, value] of this._lists) {\n      listOfLists.push(value);\n    }\n\n    return listOfLists;\n  }\n  public TryListGetDefinition(\n    name: string | null,\n    /* out */ def: ListDefinition | null\n  ): TryGetResult<ListDefinition | null> {\n    if (name === null) {\n      return { result: def, exists: false };\n    }\n    // initially, this function returns a boolean and the second parameter is an out.\n    let definition = this._lists.get(name);\n    if (!definition) return { result: def, exists: false };\n\n    return { result: definition, exists: true };\n  }\n  public FindSingleItemListWithName(name: string | null) {\n    if (name === null) {\n      return throwNullException(\"name\");\n    }\n    let val = this._allUnambiguousListValueCache.get(name);\n\n    if (typeof val !== \"undefined\") {\n      return val;\n    }\n\n    return null;\n  }\n}\n", "import { Container } from \"./Container\";\nimport {\n  Value,\n  IntValue,\n  FloatValue,\n  StringValue,\n  DivertTargetValue,\n  VariablePointerValue,\n  ListValue,\n  BoolValue,\n} from \"./Value\";\nimport { Glue } from \"./Glue\";\nimport { ControlCommand } from \"./ControlCommand\";\nimport { PushPopType } from \"./PushPop\";\nimport { Divert } from \"./Divert\";\nimport { ChoicePoint } from \"./ChoicePoint\";\nimport { VariableReference } from \"./VariableReference\";\nimport { VariableAssignment } from \"./VariableAssignment\";\nimport { NativeFunctionCall } from \"./NativeFunctionCall\";\nimport { Void } from \"./Void\";\nimport { Tag } from \"./Tag\";\nimport { Path } from \"./Path\";\nimport { Choice } from \"./Choice\";\nimport { ListDefinition } from \"./ListDefinition\";\nimport { ListDefinitionsOrigin } from \"./ListDefinitionsOrigin\";\nimport { InkListItem, InkList } from \"./InkList\";\nimport { InkObject } from \"./Object\";\nimport { asOrNull } from \"./TypeAssertion\";\nimport { throwNullException } from \"./NullException\";\nimport { SimpleJson } from \"./SimpleJson\";\n\nexport class JsonSerialisation {\n  public static JArrayToRuntimeObjList(\n    jArray: any[],\n    skipLast: boolean = false\n  ) {\n    let count = jArray.length;\n    if (skipLast) count--;\n\n    let list: InkObject[] = [];\n\n    for (let i = 0; i < count; i++) {\n      let jTok = jArray[i];\n      let runtimeObj = this.JTokenToRuntimeObject(jTok);\n      if (runtimeObj === null) {\n        return throwNullException(\"runtimeObj\");\n      }\n      list.push(runtimeObj);\n    }\n\n    return list;\n  }\n\n  public static WriteDictionaryRuntimeObjs(\n    writer: SimpleJson.Writer,\n    dictionary: Map<string, InkObject>\n  ) {\n    writer.WriteObjectStart();\n    for (let [key, value] of dictionary) {\n      writer.WritePropertyStart(key);\n      this.WriteRuntimeObject(writer, value);\n      writer.WritePropertyEnd();\n    }\n    writer.WriteObjectEnd();\n  }\n\n  public static WriteListRuntimeObjs(\n    writer: SimpleJson.Writer,\n    list: InkObject[]\n  ) {\n    writer.WriteArrayStart();\n    for (let value of list) {\n      this.WriteRuntimeObject(writer, value);\n    }\n    writer.WriteArrayEnd();\n  }\n\n  public static WriteIntDictionary(\n    writer: SimpleJson.Writer,\n    dict: Map<string, number>\n  ) {\n    writer.WriteObjectStart();\n    for (let [key, value] of dict) {\n      writer.WriteIntProperty(key, value);\n    }\n    writer.WriteObjectEnd();\n  }\n\n  public static WriteRuntimeObject(\n    writer: SimpleJson.Writer,\n    obj: InkObject\n  ): void {\n    let container = asOrNull(obj, Container);\n    if (container) {\n      this.WriteRuntimeContainer(writer, container);\n      return;\n    }\n\n    let divert = asOrNull(obj, Divert);\n    if (divert) {\n      let divTypeKey = \"->\";\n      if (divert.isExternal) {\n        divTypeKey = \"x()\";\n      } else if (divert.pushesToStack) {\n        if (divert.stackPushType == PushPopType.Function) {\n          divTypeKey = \"f()\";\n        } else if (divert.stackPushType == PushPopType.Tunnel) {\n          divTypeKey = \"->t->\";\n        }\n      }\n\n      let targetStr;\n      if (divert.hasVariableTarget) {\n        targetStr = divert.variableDivertName;\n      } else {\n        targetStr = divert.targetPathString;\n      }\n\n      writer.WriteObjectStart();\n      writer.WriteProperty(divTypeKey, targetStr);\n\n      if (divert.hasVariableTarget) {\n        writer.WriteProperty(\"var\", true);\n      }\n\n      if (divert.isConditional) {\n        writer.WriteProperty(\"c\", true);\n      }\n\n      if (divert.externalArgs > 0) {\n        writer.WriteIntProperty(\"exArgs\", divert.externalArgs);\n      }\n\n      writer.WriteObjectEnd();\n      return;\n    }\n\n    let choicePoint = asOrNull(obj, ChoicePoint);\n    if (choicePoint) {\n      writer.WriteObjectStart();\n      writer.WriteProperty(\"*\", choicePoint.pathStringOnChoice);\n      writer.WriteIntProperty(\"flg\", choicePoint.flags);\n      writer.WriteObjectEnd();\n      return;\n    }\n\n    let boolVal = asOrNull(obj, BoolValue);\n    if (boolVal) {\n      writer.WriteBool(boolVal.value);\n      return;\n    }\n\n    let intVal = asOrNull(obj, IntValue);\n    if (intVal) {\n      writer.WriteInt(intVal.value);\n      return;\n    }\n\n    let floatVal = asOrNull(obj, FloatValue);\n    if (floatVal) {\n      writer.WriteFloat(floatVal.value);\n      return;\n    }\n\n    let strVal = asOrNull(obj, StringValue);\n    if (strVal) {\n      if (strVal.isNewline) {\n        writer.Write(\"\\n\", false);\n      } else {\n        writer.WriteStringStart();\n        writer.WriteStringInner(\"^\");\n        writer.WriteStringInner(strVal.value);\n        writer.WriteStringEnd();\n      }\n      return;\n    }\n\n    let listVal = asOrNull(obj, ListValue);\n    if (listVal) {\n      this.WriteInkList(writer, listVal);\n      return;\n    }\n\n    let divTargetVal = asOrNull(obj, DivertTargetValue);\n    if (divTargetVal) {\n      writer.WriteObjectStart();\n      if (divTargetVal.value === null) {\n        return throwNullException(\"divTargetVal.value\");\n      }\n      writer.WriteProperty(\"^->\", divTargetVal.value.componentsString);\n      writer.WriteObjectEnd();\n\n      return;\n    }\n\n    let varPtrVal = asOrNull(obj, VariablePointerValue);\n    if (varPtrVal) {\n      writer.WriteObjectStart();\n      writer.WriteProperty(\"^var\", varPtrVal.value);\n      writer.WriteIntProperty(\"ci\", varPtrVal.contextIndex);\n      writer.WriteObjectEnd();\n      return;\n    }\n\n    let glue = asOrNull(obj, Glue);\n    if (glue) {\n      writer.Write(\"<>\");\n      return;\n    }\n\n    let controlCmd = asOrNull(obj, ControlCommand);\n    if (controlCmd) {\n      writer.Write(\n        JsonSerialisation._controlCommandNames[controlCmd.commandType]\n      );\n      return;\n    }\n\n    let nativeFunc = asOrNull(obj, NativeFunctionCall);\n    if (nativeFunc) {\n      let name = nativeFunc.name;\n\n      if (name == \"^\") name = \"L^\";\n\n      writer.Write(name);\n      return;\n    }\n\n    let varRef = asOrNull(obj, VariableReference);\n    if (varRef) {\n      writer.WriteObjectStart();\n      let readCountPath = varRef.pathStringForCount;\n      if (readCountPath != null) {\n        writer.WriteProperty(\"CNT?\", readCountPath);\n      } else {\n        writer.WriteProperty(\"VAR?\", varRef.name);\n      }\n\n      writer.WriteObjectEnd();\n      return;\n    }\n\n    let varAss = asOrNull(obj, VariableAssignment);\n    if (varAss) {\n      writer.WriteObjectStart();\n\n      let key = varAss.isGlobal ? \"VAR=\" : \"temp=\";\n      writer.WriteProperty(key, varAss.variableName);\n\n      // Reassignment?\n      if (!varAss.isNewDeclaration) writer.WriteProperty(\"re\", true);\n\n      writer.WriteObjectEnd();\n\n      return;\n    }\n\n    let voidObj = asOrNull(obj, Void);\n    if (voidObj) {\n      writer.Write(\"void\");\n      return;\n    }\n\n    let tag = asOrNull(obj, Tag);\n    if (tag) {\n      writer.WriteObjectStart();\n      writer.WriteProperty(\"#\", tag.text);\n      writer.WriteObjectEnd();\n      return;\n    }\n\n    let choice = asOrNull(obj, Choice);\n    if (choice) {\n      this.WriteChoice(writer, choice);\n      return;\n    }\n\n    throw new Error(\"Failed to convert runtime object to Json token: \" + obj);\n  }\n\n  public static JObjectToDictionaryRuntimeObjs(jObject: Record<string, any>) {\n    let dict: Map<string, InkObject> = new Map();\n\n    for (let key in jObject) {\n      if (jObject.hasOwnProperty(key)) {\n        let inkObject = this.JTokenToRuntimeObject(jObject[key]);\n        if (inkObject === null) {\n          return throwNullException(\"inkObject\");\n        }\n        dict.set(key, inkObject);\n      }\n    }\n\n    return dict;\n  }\n\n  public static JObjectToIntDictionary(jObject: Record<string, any>) {\n    let dict: Map<string, number> = new Map();\n    for (let key in jObject) {\n      if (jObject.hasOwnProperty(key)) {\n        dict.set(key, parseInt(jObject[key]));\n      }\n    }\n    return dict;\n  }\n\n  public static JTokenToRuntimeObject(token: any): InkObject | null {\n    if (\n      (typeof token === \"number\" && !isNaN(token)) ||\n      typeof token === \"boolean\"\n    ) {\n      return Value.Create(token);\n    }\n\n    if (typeof token === \"string\") {\n      let str = token.toString();\n\n      //Explicit float value of the form \"123.00f\"\n      const floatRepresentation = /^([0-9]+.[0-9]+f)$/.exec(str);\n      if (floatRepresentation) {\n        return new FloatValue(parseFloat(floatRepresentation[0]));\n      }\n\n      // String value\n      let firstChar = str[0];\n      if (firstChar == \"^\") return new StringValue(str.substring(1));\n      else if (firstChar == \"\\n\" && str.length == 1)\n        return new StringValue(\"\\n\");\n\n      // Glue\n      if (str == \"<>\") return new Glue();\n\n      // Control commands (would looking up in a hash set be faster?)\n      for (let i = 0; i < JsonSerialisation._controlCommandNames.length; ++i) {\n        let cmdName = JsonSerialisation._controlCommandNames[i];\n        if (str == cmdName) {\n          return new ControlCommand(i);\n        }\n      }\n\n      // Native functions\n      if (str == \"L^\") str = \"^\";\n      if (NativeFunctionCall.CallExistsWithName(str))\n        return NativeFunctionCall.CallWithName(str);\n\n      // Pop\n      if (str == \"->->\") return ControlCommand.PopTunnel();\n      else if (str == \"~ret\") return ControlCommand.PopFunction();\n\n      // Void\n      if (str == \"void\") return new Void();\n    }\n\n    if (typeof token === \"object\" && !Array.isArray(token)) {\n      let obj = token as Record<string, any>;\n      let propValue;\n\n      // Divert target value to path\n      if (obj[\"^->\"]) {\n        propValue = obj[\"^->\"];\n        return new DivertTargetValue(new Path(propValue.toString()));\n      }\n\n      // VariablePointerValue\n      if (obj[\"^var\"]) {\n        propValue = obj[\"^var\"];\n        let varPtr = new VariablePointerValue(propValue.toString());\n        if (\"ci\" in obj) {\n          propValue = obj[\"ci\"];\n          varPtr.contextIndex = parseInt(propValue);\n        }\n        return varPtr;\n      }\n\n      // Divert\n      let isDivert = false;\n      let pushesToStack = false;\n      let divPushType = PushPopType.Function;\n      let external = false;\n      if ((propValue = obj[\"->\"])) {\n        isDivert = true;\n      } else if ((propValue = obj[\"f()\"])) {\n        isDivert = true;\n        pushesToStack = true;\n        divPushType = PushPopType.Function;\n      } else if ((propValue = obj[\"->t->\"])) {\n        isDivert = true;\n        pushesToStack = true;\n        divPushType = PushPopType.Tunnel;\n      } else if ((propValue = obj[\"x()\"])) {\n        isDivert = true;\n        external = true;\n        pushesToStack = false;\n        divPushType = PushPopType.Function;\n      }\n\n      if (isDivert) {\n        let divert = new Divert();\n        divert.pushesToStack = pushesToStack;\n        divert.stackPushType = divPushType;\n        divert.isExternal = external;\n\n        let target = propValue.toString();\n\n        if ((propValue = obj[\"var\"])) divert.variableDivertName = target;\n        else divert.targetPathString = target;\n\n        divert.isConditional = !!obj[\"c\"];\n\n        if (external) {\n          if ((propValue = obj[\"exArgs\"]))\n            divert.externalArgs = parseInt(propValue);\n        }\n\n        return divert;\n      }\n\n      // Choice\n      if ((propValue = obj[\"*\"])) {\n        let choice = new ChoicePoint();\n        choice.pathStringOnChoice = propValue.toString();\n\n        if ((propValue = obj[\"flg\"])) choice.flags = parseInt(propValue);\n\n        return choice;\n      }\n\n      // Variable reference\n      if ((propValue = obj[\"VAR?\"])) {\n        return new VariableReference(propValue.toString());\n      } else if ((propValue = obj[\"CNT?\"])) {\n        let readCountVarRef = new VariableReference();\n        readCountVarRef.pathStringForCount = propValue.toString();\n        return readCountVarRef;\n      }\n\n      // Variable assignment\n      let isVarAss = false;\n      let isGlobalVar = false;\n      if ((propValue = obj[\"VAR=\"])) {\n        isVarAss = true;\n        isGlobalVar = true;\n      } else if ((propValue = obj[\"temp=\"])) {\n        isVarAss = true;\n        isGlobalVar = false;\n      }\n      if (isVarAss) {\n        let varName = propValue.toString();\n        let isNewDecl = !obj[\"re\"];\n        let varAss = new VariableAssignment(varName, isNewDecl);\n        varAss.isGlobal = isGlobalVar;\n        return varAss;\n      }\n      if (obj[\"#\"] !== undefined) {\n        propValue = obj[\"#\"];\n        return new Tag(propValue.toString());\n      }\n\n      // List value\n      if ((propValue = obj[\"list\"])) {\n        // var listContent = (Dictionary<string, object>)propValue;\n        let listContent = propValue as Record<string, any>;\n        let rawList = new InkList();\n        if ((propValue = obj[\"origins\"])) {\n          // var namesAsObjs = (List<object>)propValue;\n          let namesAsObjs = propValue as string[];\n          // rawList.SetInitialOriginNames(namesAsObjs.Cast<string>().ToList());\n          rawList.SetInitialOriginNames(namesAsObjs);\n        }\n\n        for (let key in listContent) {\n          if (listContent.hasOwnProperty(key)) {\n            let nameToVal = listContent[key];\n            let item = new InkListItem(key);\n            let val = parseInt(nameToVal);\n            rawList.Add(item, val);\n          }\n        }\n\n        return new ListValue(rawList);\n      }\n\n      if (obj[\"originalChoicePath\"] != null) return this.JObjectToChoice(obj);\n    }\n\n    // Array is always a Runtime.Container\n    if (Array.isArray(token)) {\n      return this.JArrayToContainer(token);\n    }\n\n    if (token === null || token === undefined) return null;\n\n    throw new Error(\n      \"Failed to convert token to runtime object: \" +\n        this.toJson(token, [\"parent\"])\n    );\n  }\n\n  public static toJson<T>(\n    me: T,\n    removes?: (keyof T)[],\n    space?: number\n  ): string {\n    return JSON.stringify(\n      me,\n      (k, v) => (removes?.some((r) => r === k) ? undefined : v),\n      space\n    );\n  }\n\n  public static WriteRuntimeContainer(\n    writer: SimpleJson.Writer,\n    container: Container | null,\n    withoutName: boolean = false\n  ) {\n    writer.WriteArrayStart();\n    if (container === null) {\n      return throwNullException(\"container\");\n    }\n    for (let c of container.content) this.WriteRuntimeObject(writer, c);\n\n    let namedOnlyContent = container.namedOnlyContent;\n    let countFlags = container.countFlags;\n    let hasNameProperty = container.name != null && !withoutName;\n\n    let hasTerminator =\n      namedOnlyContent != null || countFlags > 0 || hasNameProperty;\n    if (hasTerminator) {\n      writer.WriteObjectStart();\n    }\n\n    if (namedOnlyContent != null) {\n      for (let [key, value] of namedOnlyContent) {\n        let name = key;\n        let namedContainer = asOrNull(value, Container);\n        writer.WritePropertyStart(name);\n        this.WriteRuntimeContainer(writer, namedContainer, true);\n        writer.WritePropertyEnd();\n      }\n    }\n\n    if (countFlags > 0) writer.WriteIntProperty(\"#f\", countFlags);\n\n    if (hasNameProperty) writer.WriteProperty(\"#n\", container.name);\n\n    if (hasTerminator) writer.WriteObjectEnd();\n    else writer.WriteNull();\n\n    writer.WriteArrayEnd();\n  }\n\n  public static JArrayToContainer(jArray: any[]) {\n    let container = new Container();\n    container.content = this.JArrayToRuntimeObjList(jArray, true);\n\n    let terminatingObj = jArray[jArray.length - 1] as Record<string, any>;\n    if (terminatingObj != null) {\n      let namedOnlyContent = new Map();\n\n      for (let key in terminatingObj) {\n        if (key == \"#f\") {\n          container.countFlags = parseInt(terminatingObj[key]);\n        } else if (key == \"#n\") {\n          container.name = terminatingObj[key].toString();\n        } else {\n          let namedContentItem = this.JTokenToRuntimeObject(\n            terminatingObj[key]\n          );\n          // var namedSubContainer = namedContentItem as Container;\n          let namedSubContainer = asOrNull(namedContentItem, Container);\n          if (namedSubContainer) namedSubContainer.name = key;\n          namedOnlyContent.set(key, namedContentItem);\n        }\n      }\n\n      container.namedOnlyContent = namedOnlyContent;\n    }\n\n    return container;\n  }\n\n  public static JObjectToChoice(jObj: Record<string, any>) {\n    let choice = new Choice();\n    choice.text = jObj[\"text\"].toString();\n    choice.index = parseInt(jObj[\"index\"]);\n    choice.sourcePath = jObj[\"originalChoicePath\"].toString();\n    choice.originalThreadIndex = parseInt(jObj[\"originalThreadIndex\"]);\n    choice.pathStringOnChoice = jObj[\"targetPath\"].toString();\n    choice.tags = this.JArrayToTags(jObj);\n    return choice;\n  }\n\n  public static JArrayToTags(jObj: Record<string, any>) {\n    if (jObj[\"tags\"]) {\n      return jObj[\"tags\"];\n    } else {\n      return null;\n    }\n  }\n\n  public static WriteChoice(writer: SimpleJson.Writer, choice: Choice) {\n    writer.WriteObjectStart();\n    writer.WriteProperty(\"text\", choice.text);\n    writer.WriteIntProperty(\"index\", choice.index);\n    writer.WriteProperty(\"originalChoicePath\", choice.sourcePath);\n    writer.WriteIntProperty(\"originalThreadIndex\", choice.originalThreadIndex);\n    writer.WriteProperty(\"targetPath\", choice.pathStringOnChoice);\n    this.WriteChoiceTags(writer, choice);\n    writer.WriteObjectEnd();\n  }\n\n  public static WriteChoiceTags(writer: SimpleJson.Writer, choice: Choice) {\n    if (choice.tags && choice.tags.length > 0) {\n      writer.WritePropertyStart(\"tags\");\n      writer.WriteArrayStart();\n      for (const tag of choice.tags!) {\n        writer.Write(tag);\n      }\n      writer.WriteArrayEnd();\n      writer.WritePropertyEnd();\n    }\n  }\n\n  public static WriteInkList(writer: SimpleJson.Writer, listVal: ListValue) {\n    let rawList = listVal.value;\n    if (rawList === null) {\n      return throwNullException(\"rawList\");\n    }\n\n    writer.WriteObjectStart();\n    writer.WritePropertyStart(\"list\");\n    writer.WriteObjectStart();\n\n    for (let [key, val] of rawList) {\n      let item = InkListItem.fromSerializedKey(key);\n      let itemVal = val;\n\n      if (item.itemName === null) {\n        return throwNullException(\"item.itemName\");\n      }\n\n      writer.WritePropertyNameStart();\n      writer.WritePropertyNameInner(item.originName ? item.originName : \"?\");\n      writer.WritePropertyNameInner(\".\");\n      writer.WritePropertyNameInner(item.itemName);\n      writer.WritePropertyNameEnd();\n\n      writer.Write(itemVal);\n\n      writer.WritePropertyEnd();\n    }\n\n    writer.WriteObjectEnd();\n\n    writer.WritePropertyEnd();\n\n    if (\n      rawList.Count == 0 &&\n      rawList.originNames != null &&\n      rawList.originNames.length > 0\n    ) {\n      writer.WritePropertyStart(\"origins\");\n      writer.WriteArrayStart();\n      for (let name of rawList.originNames) writer.Write(name);\n      writer.WriteArrayEnd();\n      writer.WritePropertyEnd();\n    }\n\n    writer.WriteObjectEnd();\n  }\n\n  public static ListDefinitionsToJToken(origin: ListDefinitionsOrigin) {\n    let result: Record<string, any> = {};\n\n    for (let def of origin.lists) {\n      let listDefJson: Record<string, any> = {};\n\n      for (let [key, val] of def.items) {\n        let item = InkListItem.fromSerializedKey(key);\n        if (item.itemName === null) {\n          return throwNullException(\"item.itemName\");\n        }\n        listDefJson[item.itemName] = val;\n      }\n\n      result[def.name] = listDefJson;\n    }\n\n    return result;\n  }\n\n  public static JTokenToListDefinitions(obj: Record<string, any>) {\n    // var defsObj = (Dictionary<string, object>)obj;\n    let defsObj = obj;\n\n    let allDefs: ListDefinition[] = [];\n\n    for (let key in defsObj) {\n      if (defsObj.hasOwnProperty(key)) {\n        let name = key.toString();\n        // var listDefJson = (Dictionary<string, object>)kv.Value;\n        let listDefJson = defsObj[key] as Record<string, any>;\n\n        // Cast (string, object) to (string, int) for items\n        let items: Map<string, number> = new Map();\n\n        for (let nameValueKey in listDefJson) {\n          if (defsObj.hasOwnProperty(key)) {\n            let nameValue = listDefJson[nameValueKey];\n            items.set(nameValueKey, parseInt(nameValue));\n          }\n        }\n\n        let def = new ListDefinition(name, items);\n        allDefs.push(def);\n      }\n    }\n\n    return new ListDefinitionsOrigin(allDefs);\n  }\n\n  private static _controlCommandNames = (() => {\n    let _controlCommandNames: string[] = [];\n\n    _controlCommandNames[ControlCommand.CommandType.EvalStart] = \"ev\";\n    _controlCommandNames[ControlCommand.CommandType.EvalOutput] = \"out\";\n    _controlCommandNames[ControlCommand.CommandType.EvalEnd] = \"/ev\";\n    _controlCommandNames[ControlCommand.CommandType.Duplicate] = \"du\";\n    _controlCommandNames[ControlCommand.CommandType.PopEvaluatedValue] = \"pop\";\n    _controlCommandNames[ControlCommand.CommandType.PopFunction] = \"~ret\";\n    _controlCommandNames[ControlCommand.CommandType.PopTunnel] = \"->->\";\n    _controlCommandNames[ControlCommand.CommandType.BeginString] = \"str\";\n    _controlCommandNames[ControlCommand.CommandType.EndString] = \"/str\";\n    _controlCommandNames[ControlCommand.CommandType.NoOp] = \"nop\";\n    _controlCommandNames[ControlCommand.CommandType.ChoiceCount] = \"choiceCnt\";\n    _controlCommandNames[ControlCommand.CommandType.Turns] = \"turn\";\n    _controlCommandNames[ControlCommand.CommandType.TurnsSince] = \"turns\";\n    _controlCommandNames[ControlCommand.CommandType.ReadCount] = \"readc\";\n    _controlCommandNames[ControlCommand.CommandType.Random] = \"rnd\";\n    _controlCommandNames[ControlCommand.CommandType.SeedRandom] = \"srnd\";\n    _controlCommandNames[ControlCommand.CommandType.VisitIndex] = \"visit\";\n    _controlCommandNames[ControlCommand.CommandType.SequenceShuffleIndex] =\n      \"seq\";\n    _controlCommandNames[ControlCommand.CommandType.StartThread] = \"thread\";\n    _controlCommandNames[ControlCommand.CommandType.Done] = \"done\";\n    _controlCommandNames[ControlCommand.CommandType.End] = \"end\";\n    _controlCommandNames[ControlCommand.CommandType.ListFromInt] = \"listInt\";\n    _controlCommandNames[ControlCommand.CommandType.ListRange] = \"range\";\n    _controlCommandNames[ControlCommand.CommandType.ListRandom] = \"lrnd\";\n    _controlCommandNames[ControlCommand.CommandType.BeginTag] = \"#\";\n    _controlCommandNames[ControlCommand.CommandType.EndTag] = \"/#\";\n\n    for (let i = 0; i < ControlCommand.CommandType.TOTAL_VALUES; ++i) {\n      if (_controlCommandNames[i] == null)\n        throw new Error(\"Control command not accounted for in serialisation\");\n    }\n\n    return _controlCommandNames;\n  })();\n}\n", "import { PushPopType } from \"./PushPop\";\nimport { Path } from \"./Path\";\nimport { Story } from \"./Story\";\nimport { JsonSerialisation } from \"./JsonSerialisation\";\nimport { ListValue } from \"./Value\";\nimport { StringBuilder } from \"./StringBuilder\";\nimport { Pointer } from \"./Pointer\";\nimport { InkObject } from \"./Object\";\nimport { Debug } from \"./Debug\";\nimport { tryGetValueFromMap } from \"./TryGetResult\";\nimport { throwNullException } from \"./NullException\";\nimport { SimpleJson } from \"./SimpleJson\";\n\nexport class CallStack {\n  get elements() {\n    return this.callStack;\n  }\n\n  get depth() {\n    return this.elements.length;\n  }\n\n  get currentElement() {\n    let thread = this._threads[this._threads.length - 1];\n    let cs = thread.callstack;\n    return cs[cs.length - 1];\n  }\n\n  get currentElementIndex() {\n    return this.callStack.length - 1;\n  }\n\n  get currentThread(): CallStack.Thread {\n    return this._threads[this._threads.length - 1];\n  }\n  set currentThread(value: CallStack.Thread) {\n    Debug.Assert(\n      this._threads.length == 1,\n      \"Shouldn't be directly setting the current thread when we have a stack of them\"\n    );\n\n    this._threads.length = 0;\n    this._threads.push(value);\n  }\n\n  get canPop() {\n    return this.callStack.length > 1;\n  }\n\n  constructor(storyContext: Story);\n  constructor(toCopy: CallStack);\n  constructor() {\n    if (arguments[0] instanceof Story) {\n      let storyContext = arguments[0] as Story;\n\n      this._startOfRoot = Pointer.StartOf(storyContext.rootContentContainer);\n      this.Reset();\n    } else {\n      let toCopy = arguments[0] as CallStack;\n\n      this._threads = [];\n      for (let otherThread of toCopy._threads) {\n        this._threads.push(otherThread.Copy());\n      }\n      this._threadCounter = toCopy._threadCounter;\n      this._startOfRoot = toCopy._startOfRoot.copy();\n    }\n  }\n\n  public Reset() {\n    this._threads = [];\n    this._threads.push(new CallStack.Thread());\n\n    this._threads[0].callstack.push(\n      new CallStack.Element(PushPopType.Tunnel, this._startOfRoot)\n    );\n  }\n\n  public SetJsonToken(jObject: Record<string, any>, storyContext: Story) {\n    this._threads.length = 0;\n\n    // TODO: (List<object>) jObject [\"threads\"];\n    let jThreads: any[] = jObject[\"threads\"];\n\n    for (let jThreadTok of jThreads) {\n      // TODO: var jThreadObj = (Dictionary<string, object>)jThreadTok;\n      let jThreadObj = jThreadTok;\n      let thread = new CallStack.Thread(jThreadObj, storyContext);\n      this._threads.push(thread);\n    }\n\n    // TODO: (int)jObject [\"threadCounter\"];\n    this._threadCounter = parseInt(jObject[\"threadCounter\"]);\n    this._startOfRoot = Pointer.StartOf(storyContext.rootContentContainer);\n  }\n  public WriteJson(w: SimpleJson.Writer) {\n    w.WriteObject((writer) => {\n      writer.WritePropertyStart(\"threads\");\n      writer.WriteArrayStart();\n\n      for (let thread of this._threads) {\n        thread.WriteJson(writer);\n      }\n\n      writer.WriteArrayEnd();\n      writer.WritePropertyEnd();\n\n      writer.WritePropertyStart(\"threadCounter\");\n      writer.WriteInt(this._threadCounter);\n      writer.WritePropertyEnd();\n    });\n  }\n\n  public PushThread() {\n    let newThread = this.currentThread.Copy();\n    this._threadCounter++;\n    newThread.threadIndex = this._threadCounter;\n    this._threads.push(newThread);\n  }\n\n  public ForkThread() {\n    let forkedThread = this.currentThread.Copy();\n    this._threadCounter++;\n    forkedThread.threadIndex = this._threadCounter;\n    return forkedThread;\n  }\n\n  public PopThread() {\n    if (this.canPopThread) {\n      this._threads.splice(this._threads.indexOf(this.currentThread), 1); // should be equivalent to a pop()\n    } else {\n      throw new Error(\"Can't pop thread\");\n    }\n  }\n\n  get canPopThread() {\n    return this._threads.length > 1 && !this.elementIsEvaluateFromGame;\n  }\n\n  get elementIsEvaluateFromGame() {\n    return this.currentElement.type == PushPopType.FunctionEvaluationFromGame;\n  }\n\n  public Push(\n    type: PushPopType,\n    externalEvaluationStackHeight: number = 0,\n    outputStreamLengthWithPushed: number = 0\n  ) {\n    let element = new CallStack.Element(\n      type,\n      this.currentElement.currentPointer,\n      false\n    );\n\n    element.evaluationStackHeightWhenPushed = externalEvaluationStackHeight;\n    element.functionStartInOutputStream = outputStreamLengthWithPushed;\n\n    this.callStack.push(element);\n  }\n\n  public CanPop(type: PushPopType | null = null) {\n    if (!this.canPop) return false;\n\n    if (type == null) return true;\n\n    return this.currentElement.type == type;\n  }\n\n  public Pop(type: PushPopType | null = null) {\n    if (this.CanPop(type)) {\n      this.callStack.pop();\n      return;\n    } else {\n      throw new Error(\"Mismatched push/pop in Callstack\");\n    }\n  }\n\n  public GetTemporaryVariableWithName(\n    name: string | null,\n    contextIndex: number = -1\n  ) {\n    // contextIndex 0 means global, so index is actually 1-based\n    if (contextIndex == -1) contextIndex = this.currentElementIndex + 1;\n\n    let contextElement = this.callStack[contextIndex - 1];\n\n    let varValue = tryGetValueFromMap(\n      contextElement.temporaryVariables,\n      name,\n      null\n    );\n    if (varValue.exists) {\n      return varValue.result;\n    } else {\n      return null;\n    }\n  }\n\n  public SetTemporaryVariable(\n    name: string,\n    value: any,\n    declareNew: boolean,\n    contextIndex: number = -1\n  ) {\n    if (contextIndex == -1) contextIndex = this.currentElementIndex + 1;\n\n    let contextElement = this.callStack[contextIndex - 1];\n\n    if (!declareNew && !contextElement.temporaryVariables.get(name)) {\n      throw new Error(\"Could not find temporary variable to set: \" + name);\n    }\n\n    let oldValue = tryGetValueFromMap(\n      contextElement.temporaryVariables,\n      name,\n      null\n    );\n    if (oldValue.exists)\n      ListValue.RetainListOriginsForAssignment(oldValue.result, value);\n\n    contextElement.temporaryVariables.set(name, value);\n  }\n\n  public ContextForVariableNamed(name: string) {\n    if (this.currentElement.temporaryVariables.get(name)) {\n      return this.currentElementIndex + 1;\n    } else {\n      return 0;\n    }\n  }\n\n  public ThreadWithIndex(index: number) {\n    let filtered = this._threads.filter((t) => {\n      if (t.threadIndex == index) return t;\n    });\n\n    return filtered.length > 0 ? filtered[0] : null;\n  }\n\n  get callStack() {\n    return this.currentThread.callstack;\n  }\n\n  get callStackTrace() {\n    let sb = new StringBuilder();\n\n    for (let t = 0; t < this._threads.length; t++) {\n      let thread = this._threads[t];\n      let isCurrent = t == this._threads.length - 1;\n      sb.AppendFormat(\n        \"=== THREAD {0}/{1} {2}===\\n\",\n        t + 1,\n        this._threads.length,\n        isCurrent ? \"(current) \" : \"\"\n      );\n\n      for (let i = 0; i < thread.callstack.length; i++) {\n        if (thread.callstack[i].type == PushPopType.Function)\n          sb.Append(\"  [FUNCTION] \");\n        else sb.Append(\"  [TUNNEL] \");\n\n        let pointer = thread.callstack[i].currentPointer;\n        if (!pointer.isNull) {\n          sb.Append(\"<SOMEWHERE IN \");\n          if (pointer.container === null) {\n            return throwNullException(\"pointer.container\");\n          }\n          sb.Append(pointer.container.path.toString());\n          sb.AppendLine(\">\");\n        }\n      }\n    }\n\n    return sb.toString();\n  }\n\n  public _threads!: CallStack.Thread[]; // Banged because it's initialized in Reset().\n  public _threadCounter: number = 0;\n  public _startOfRoot: Pointer = Pointer.Null;\n}\n\nexport namespace CallStack {\n  export class Element {\n    public currentPointer: Pointer;\n    public inExpressionEvaluation: boolean;\n    public temporaryVariables: Map<string, InkObject>;\n    public type: PushPopType;\n\n    public evaluationStackHeightWhenPushed: number = 0;\n    public functionStartInOutputStream: number = 0;\n\n    constructor(\n      type: PushPopType,\n      pointer: Pointer,\n      inExpressionEvaluation: boolean = false\n    ) {\n      this.currentPointer = pointer.copy();\n      this.inExpressionEvaluation = inExpressionEvaluation;\n      this.temporaryVariables = new Map();\n      this.type = type;\n    }\n\n    public Copy() {\n      let copy = new Element(\n        this.type,\n        this.currentPointer,\n        this.inExpressionEvaluation\n      );\n      copy.temporaryVariables = new Map(this.temporaryVariables);\n      copy.evaluationStackHeightWhenPushed =\n        this.evaluationStackHeightWhenPushed;\n      copy.functionStartInOutputStream = this.functionStartInOutputStream;\n      return copy;\n    }\n  }\n\n  export class Thread {\n    public callstack: Element[];\n    public threadIndex: number = 0;\n    public previousPointer: Pointer = Pointer.Null;\n\n    constructor();\n    constructor(jThreadObj: any, storyContext: Story);\n    constructor() {\n      this.callstack = [];\n\n      if (arguments[0] && arguments[1]) {\n        let jThreadObj = arguments[0];\n        let storyContext = arguments[1];\n\n        // TODO: (int) jThreadObj['threadIndex'] can raise;\n        this.threadIndex = parseInt(jThreadObj[\"threadIndex\"]);\n\n        let jThreadCallstack = jThreadObj[\"callstack\"];\n\n        for (let jElTok of jThreadCallstack) {\n          let jElementObj = jElTok;\n\n          // TODO: (int) jElementObj['type'] can raise;\n          let pushPopType: PushPopType = parseInt(jElementObj[\"type\"]);\n\n          let pointer = Pointer.Null;\n\n          let currentContainerPathStr: string;\n          // TODO: jElementObj.TryGetValue (\"cPath\", out currentContainerPathStrToken);\n          let currentContainerPathStrToken = jElementObj[\"cPath\"];\n          if (typeof currentContainerPathStrToken !== \"undefined\") {\n            currentContainerPathStr = currentContainerPathStrToken.toString();\n\n            let threadPointerResult = storyContext.ContentAtPath(\n              new Path(currentContainerPathStr)\n            );\n            pointer.container = threadPointerResult.container;\n            pointer.index = parseInt(jElementObj[\"idx\"]);\n\n            if (threadPointerResult.obj == null)\n              throw new Error(\n                \"When loading state, internal story location couldn't be found: \" +\n                  currentContainerPathStr +\n                  \". Has the story changed since this save data was created?\"\n              );\n            else if (threadPointerResult.approximate) {\n              if (pointer.container !== null) {\n                storyContext.Warning(\n                  \"When loading state, exact internal story location couldn't be found: '\" +\n                    currentContainerPathStr +\n                    \"', so it was approximated to '\" +\n                    pointer.container.path.toString() +\n                    \"' to recover. Has the story changed since this save data was created?\"\n                );\n              } else {\n                storyContext.Warning(\n                  \"When loading state, exact internal story location couldn't be found: '\" +\n                    currentContainerPathStr +\n                    \"' and it may not be recoverable. Has the story changed since this save data was created?\"\n                );\n              }\n            }\n          }\n\n          let inExpressionEvaluation = !!jElementObj[\"exp\"];\n\n          let el = new Element(pushPopType, pointer, inExpressionEvaluation);\n\n          let temps = jElementObj[\"temp\"];\n          if (typeof temps !== \"undefined\") {\n            el.temporaryVariables =\n              JsonSerialisation.JObjectToDictionaryRuntimeObjs(temps);\n          } else {\n            el.temporaryVariables.clear();\n          }\n\n          this.callstack.push(el);\n        }\n\n        let prevContentObjPath = jThreadObj[\"previousContentObject\"];\n        if (typeof prevContentObjPath !== \"undefined\") {\n          let prevPath = new Path(prevContentObjPath.toString());\n          this.previousPointer = storyContext.PointerAtPath(prevPath);\n        }\n      }\n    }\n\n    public Copy() {\n      let copy = new Thread();\n      copy.threadIndex = this.threadIndex;\n      for (let e of this.callstack) {\n        copy.callstack.push(e.Copy());\n      }\n      copy.previousPointer = this.previousPointer.copy();\n      return copy;\n    }\n\n    public WriteJson(writer: SimpleJson.Writer) {\n      writer.WriteObjectStart();\n\n      writer.WritePropertyStart(\"callstack\");\n      writer.WriteArrayStart();\n      for (let el of this.callstack) {\n        writer.WriteObjectStart();\n        if (!el.currentPointer.isNull) {\n          if (el.currentPointer.container === null) {\n            return throwNullException(\"el.currentPointer.container\");\n          }\n          writer.WriteProperty(\n            \"cPath\",\n            el.currentPointer.container.path.componentsString\n          );\n          writer.WriteIntProperty(\"idx\", el.currentPointer.index);\n        }\n\n        writer.WriteProperty(\"exp\", el.inExpressionEvaluation);\n        writer.WriteIntProperty(\"type\", el.type);\n\n        if (el.temporaryVariables.size > 0) {\n          writer.WritePropertyStart(\"temp\");\n          JsonSerialisation.WriteDictionaryRuntimeObjs(\n            writer,\n            el.temporaryVariables\n          );\n          writer.WritePropertyEnd();\n        }\n\n        writer.WriteObjectEnd();\n      }\n      writer.WriteArrayEnd();\n      writer.WritePropertyEnd();\n\n      writer.WriteIntProperty(\"threadIndex\", this.threadIndex);\n\n      if (!this.previousPointer.isNull) {\n        let resolvedPointer = this.previousPointer.Resolve();\n        if (resolvedPointer === null) {\n          return throwNullException(\"this.previousPointer.Resolve()\");\n        }\n        writer.WriteProperty(\n          \"previousContentObject\",\n          resolvedPointer.path.toString()\n        );\n      }\n\n      writer.WriteObjectEnd();\n    }\n  }\n}\n", "import {\n  AbstractValue,\n  Value,\n  VariablePointerValue,\n  ListValue,\n  IntValue,\n  FloatValue,\n  BoolValue,\n} from \"./Value\";\nimport { VariableAssignment } from \"./VariableAssignment\";\nimport { InkObject } from \"./Object\";\nimport { ListDefinitionsOrigin } from \"./ListDefinitionsOrigin\";\nimport { StoryException } from \"./StoryException\";\nimport { JsonSerialisation } from \"./JsonSerialisation\";\nimport { asOrThrows, asOrNull, isEquatable } from \"./TypeAssertion\";\nimport { tryGetValueFromMap } from \"./TryGetResult\";\nimport { throwNullException } from \"./NullException\";\nimport { CallStack } from \"./CallStack\";\nimport { StatePatch } from \"./StatePatch\";\nimport { SimpleJson } from \"./SimpleJson\";\nimport { InkList } from \"./Story\";\nimport { Path } from \"./Path\";\n\n// Fake class wrapper around VariableState to have correct typing\n// when using the Proxy syntax in typescript\nfunction VariablesStateAccessor<T>(): new () => Pick<T, keyof T> {\n  return class {} as any;\n}\n\ntype VariableStateValue = boolean | string | number | InkList | Path | null;\n\nexport class VariablesState extends VariablesStateAccessor<\n  Record<string, any>\n>() {\n  // The way variableChangedEvent is a bit different than the reference implementation.\n  // Originally it uses the C# += operator to add delegates, but in js we need to maintain\n  // an actual collection of delegates (ie. callbacks) to register a new one, there is a\n  // special ObserveVariableChange method below.\n  public variableChangedEventCallbacks: Array<\n    (variableName: string, newValue: InkObject) => void\n  > = [];\n  public variableChangedEvent(variableName: string, newValue: InkObject): void {\n    for (let callback of this.variableChangedEventCallbacks) {\n      callback(variableName, newValue);\n    }\n  }\n\n  public patch: StatePatch | null = null;\n\n  public StartVariableObservation() {\n    this._batchObservingVariableChanges = true;\n    this._changedVariablesForBatchObs = new Set();\n  }\n\n  public CompleteVariableObservation(): Map<string, any> {\n    this._batchObservingVariableChanges = false;\n    let changedVars = new Map<string, any>();\n    if (this._changedVariablesForBatchObs != null) {\n      for (let variableName of this._changedVariablesForBatchObs) {\n        let currentValue = this._globalVariables.get(variableName) as InkObject;\n        this.variableChangedEvent(variableName, currentValue);\n      }\n    }\n    // Patch may still be active - e.g. if we were in the middle of a background save\n    if (this.patch != null) {\n      for (let variableName of this.patch.changedVariables) {\n        let patchedVal = this.patch.TryGetGlobal(variableName, null);\n        if (patchedVal.exists) changedVars.set(variableName, patchedVal);\n      }\n    }\n    this._changedVariablesForBatchObs = null;\n    return changedVars;\n  }\n\n  public NotifyObservers(changedVars: Map<string, any>) {\n    for (const [key, value] of changedVars) {\n      this.variableChangedEvent(key, value);\n    }\n  }\n\n  get callStack() {\n    return this._callStack;\n  }\n  set callStack(callStack) {\n    this._callStack = callStack;\n  }\n\n  // the original code uses a magic getter and setter for global variables,\n  // allowing things like variableState['varname]. This is not quite possible\n  // in js without a Proxy, so it is replaced with this $ function.\n  public $(variableName: string): VariableStateValue;\n  public $(variableName: string, value: VariableStateValue): void;\n  public $(variableName: string, value?: any) {\n    if (typeof value === \"undefined\") {\n      let varContents = null;\n\n      if (this.patch !== null) {\n        varContents = this.patch.TryGetGlobal(variableName, null);\n        if (varContents.exists)\n          return (varContents.result as AbstractValue).valueObject;\n      }\n\n      varContents = this._globalVariables.get(variableName);\n\n      if (typeof varContents === \"undefined\") {\n        varContents = this._defaultGlobalVariables.get(variableName);\n      }\n\n      if (typeof varContents !== \"undefined\")\n        return (varContents as AbstractValue).valueObject;\n      else return null;\n    } else {\n      if (typeof this._defaultGlobalVariables.get(variableName) === \"undefined\")\n        throw new StoryException(\n          \"Cannot assign to a variable (\" +\n            variableName +\n            \") that hasn't been declared in the story\"\n        );\n\n      let val = Value.Create(value);\n      if (val == null) {\n        if (value == null) {\n          throw new Error(\"Cannot pass null to VariableState\");\n        } else {\n          throw new Error(\n            \"Invalid value passed to VariableState: \" + value.toString()\n          );\n        }\n      }\n\n      this.SetGlobal(variableName, val);\n    }\n  }\n\n  constructor(\n    callStack: CallStack,\n    listDefsOrigin: ListDefinitionsOrigin | null\n  ) {\n    super();\n    this._globalVariables = new Map();\n    this._callStack = callStack;\n    this._listDefsOrigin = listDefsOrigin;\n\n    // if es6 proxies are available, use them.\n    try {\n      // the proxy is used to allow direct manipulation of global variables.\n      // It first tries to access the objects own property, and if none is\n      // found it delegates the call to the $ method, defined below\n      let p = new Proxy(this, {\n        get(target: any, name) {\n          return name in target ? target[name] : target.$(name);\n        },\n        set(target: any, name, value) {\n          if (name in target) target[name] = value;\n          else target.$(name, value);\n          return true; // returning a falsy value make the trap fail\n        },\n        ownKeys(target: any) {\n          return [\n            ...new Set([\n              ...target._defaultGlobalVariables.keys(),\n              ...target._globalVariables.keys(),\n            ]),\n          ];\n        },\n        getOwnPropertyDescriptor(target, name) {\n          // called for every property\n          return {\n            enumerable: true,\n            configurable: true,\n            value: target.$(name),\n          };\n        },\n      });\n\n      return p;\n    } catch (e) {\n      // the proxy object is not available in this context. we should warn the\n      // dev but writing to the console feels a bit intrusive.\n      // console.log(\"ES6 Proxy not available - direct manipulation of global variables can't work, use $() instead.\");\n    }\n  }\n\n  public ApplyPatch() {\n    if (this.patch === null) {\n      return throwNullException(\"this.patch\");\n    }\n\n    for (let [namedVarKey, namedVarValue] of this.patch.globals) {\n      this._globalVariables.set(namedVarKey, namedVarValue);\n    }\n\n    if (this._changedVariablesForBatchObs !== null) {\n      for (let name of this.patch.changedVariables) {\n        this._changedVariablesForBatchObs.add(name);\n      }\n    }\n\n    this.patch = null;\n  }\n\n  public SetJsonToken(jToken: Record<string, any>) {\n    this._globalVariables.clear();\n\n    for (let [varValKey, varValValue] of this._defaultGlobalVariables) {\n      let loadedToken = jToken[varValKey];\n      if (typeof loadedToken !== \"undefined\") {\n        let tokenInkObject =\n          JsonSerialisation.JTokenToRuntimeObject(loadedToken);\n        if (tokenInkObject === null) {\n          return throwNullException(\"tokenInkObject\");\n        }\n        this._globalVariables.set(varValKey, tokenInkObject);\n      } else {\n        this._globalVariables.set(varValKey, varValValue);\n      }\n    }\n  }\n\n  public static dontSaveDefaultValues: boolean = true;\n\n  public WriteJson(writer: SimpleJson.Writer) {\n    writer.WriteObjectStart();\n    for (let [keyValKey, keyValValue] of this._globalVariables) {\n      let name = keyValKey;\n      let val = keyValValue;\n\n      if (VariablesState.dontSaveDefaultValues) {\n        if (this._defaultGlobalVariables.has(name)) {\n          let defaultVal = this._defaultGlobalVariables.get(name)!;\n          if (this.RuntimeObjectsEqual(val, defaultVal)) continue;\n        }\n      }\n\n      writer.WritePropertyStart(name);\n      JsonSerialisation.WriteRuntimeObject(writer, val);\n      writer.WritePropertyEnd();\n    }\n    writer.WriteObjectEnd();\n  }\n\n  public RuntimeObjectsEqual(\n    obj1: InkObject | null,\n    obj2: InkObject | null\n  ): boolean {\n    if (obj1 === null) {\n      return throwNullException(\"obj1\");\n    }\n    if (obj2 === null) {\n      return throwNullException(\"obj2\");\n    }\n\n    if (obj1.constructor !== obj2.constructor) return false;\n\n    let boolVal = asOrNull(obj1, BoolValue);\n    if (boolVal !== null) {\n      return boolVal.value === asOrThrows(obj2, BoolValue).value;\n    }\n\n    let intVal = asOrNull(obj1, IntValue);\n    if (intVal !== null) {\n      return intVal.value === asOrThrows(obj2, IntValue).value;\n    }\n\n    let floatVal = asOrNull(obj1, FloatValue);\n    if (floatVal !== null) {\n      return floatVal.value === asOrThrows(obj2, FloatValue).value;\n    }\n\n    let val1 = asOrNull(obj1, Value);\n    let val2 = asOrNull(obj2, Value);\n    if (val1 !== null && val2 !== null) {\n      if (isEquatable(val1.valueObject) && isEquatable(val2.valueObject)) {\n        return val1.valueObject.Equals(val2.valueObject);\n      } else {\n        return val1.valueObject === val2.valueObject;\n      }\n    }\n\n    throw new Error(\n      \"FastRoughDefinitelyEquals: Unsupported runtime object type: \" +\n        obj1.constructor.name\n    );\n  }\n\n  public GetVariableWithName(\n    name: string | null,\n    contextIndex: number = -1\n  ): InkObject | null {\n    let varValue = this.GetRawVariableWithName(name, contextIndex);\n\n    // var varPointer = varValue as VariablePointerValue;\n    let varPointer = asOrNull(varValue, VariablePointerValue);\n    if (varPointer !== null) {\n      varValue = this.ValueAtVariablePointer(varPointer);\n    }\n\n    return varValue;\n  }\n\n  public TryGetDefaultVariableValue(name: string | null): InkObject | null {\n    let val = tryGetValueFromMap(this._defaultGlobalVariables, name, null);\n    return val.exists ? val.result : null;\n  }\n\n  public GlobalVariableExistsWithName(name: string) {\n    return (\n      this._globalVariables.has(name) ||\n      (this._defaultGlobalVariables !== null &&\n        this._defaultGlobalVariables.has(name))\n    );\n  }\n\n  public GetRawVariableWithName(name: string | null, contextIndex: number) {\n    let varValue: InkObject | null = null;\n\n    if (contextIndex == 0 || contextIndex == -1) {\n      let variableValue = null;\n      if (this.patch !== null) {\n        variableValue = this.patch.TryGetGlobal(name, null);\n        if (variableValue.exists) return variableValue.result!;\n      }\n\n      // this is a conditional assignment\n      variableValue = tryGetValueFromMap(this._globalVariables, name, null);\n      if (variableValue.exists) return variableValue.result;\n\n      if (this._defaultGlobalVariables !== null) {\n        variableValue = tryGetValueFromMap(\n          this._defaultGlobalVariables,\n          name,\n          null\n        );\n        if (variableValue.exists) return variableValue.result;\n      }\n\n      if (this._listDefsOrigin === null)\n        return throwNullException(\"VariablesState._listDefsOrigin\");\n      let listItemValue = this._listDefsOrigin.FindSingleItemListWithName(name);\n      if (listItemValue) return listItemValue;\n    }\n\n    varValue = this._callStack.GetTemporaryVariableWithName(name, contextIndex);\n\n    return varValue;\n  }\n\n  public ValueAtVariablePointer(pointer: VariablePointerValue) {\n    return this.GetVariableWithName(pointer.variableName, pointer.contextIndex);\n  }\n\n  public Assign(varAss: VariableAssignment, value: InkObject) {\n    let name = varAss.variableName;\n    if (name === null) {\n      return throwNullException(\"name\");\n    }\n    let contextIndex = -1;\n\n    let setGlobal = false;\n    if (varAss.isNewDeclaration) {\n      setGlobal = varAss.isGlobal;\n    } else {\n      setGlobal = this.GlobalVariableExistsWithName(name);\n    }\n\n    if (varAss.isNewDeclaration) {\n      // var varPointer = value as VariablePointerValue;\n      let varPointer = asOrNull(value, VariablePointerValue);\n      if (varPointer !== null) {\n        let fullyResolvedVariablePointer =\n          this.ResolveVariablePointer(varPointer);\n        value = fullyResolvedVariablePointer;\n      }\n    } else {\n      let existingPointer = null;\n      do {\n        // existingPointer = GetRawVariableWithName (name, contextIndex) as VariablePointerValue;\n        existingPointer = asOrNull(\n          this.GetRawVariableWithName(name, contextIndex),\n          VariablePointerValue\n        );\n        if (existingPointer != null) {\n          name = existingPointer.variableName;\n          contextIndex = existingPointer.contextIndex;\n          setGlobal = contextIndex == 0;\n        }\n      } while (existingPointer != null);\n    }\n\n    if (setGlobal) {\n      this.SetGlobal(name, value);\n    } else {\n      this._callStack.SetTemporaryVariable(\n        name,\n        value,\n        varAss.isNewDeclaration,\n        contextIndex\n      );\n    }\n  }\n\n  public SnapshotDefaultGlobals() {\n    this._defaultGlobalVariables = new Map(this._globalVariables);\n  }\n\n  public RetainListOriginsForAssignment(\n    oldValue: InkObject,\n    newValue: InkObject\n  ) {\n    let oldList = asOrThrows(oldValue, ListValue);\n    let newList = asOrThrows(newValue, ListValue);\n\n    if (oldList.value && newList.value && newList.value.Count == 0) {\n      newList.value.SetInitialOriginNames(oldList.value.originNames);\n    }\n  }\n\n  public SetGlobal(variableName: string | null, value: InkObject) {\n    let oldValue = null;\n\n    if (this.patch === null) {\n      oldValue = tryGetValueFromMap(this._globalVariables, variableName, null);\n    }\n\n    if (this.patch !== null) {\n      oldValue = this.patch.TryGetGlobal(variableName, null);\n      if (!oldValue.exists) {\n        oldValue = tryGetValueFromMap(\n          this._globalVariables,\n          variableName,\n          null\n        );\n      }\n    }\n\n    ListValue.RetainListOriginsForAssignment(oldValue!.result!, value);\n\n    if (variableName === null) {\n      return throwNullException(\"variableName\");\n    }\n\n    if (this.patch !== null) {\n      this.patch.SetGlobal(variableName, value);\n    } else {\n      this._globalVariables.set(variableName, value);\n    }\n\n    // TODO: Not sure !== is equivalent to !value.Equals(oldValue)\n    if (\n      this.variableChangedEvent !== null &&\n      oldValue !== null &&\n      value !== oldValue.result\n    ) {\n      if (this._batchObservingVariableChanges) {\n        if (this._changedVariablesForBatchObs === null) {\n          return throwNullException(\"this._changedVariablesForBatchObs\");\n        }\n\n        if (this.patch !== null) {\n          this.patch.AddChangedVariable(variableName);\n        } else if (this._changedVariablesForBatchObs !== null) {\n          this._changedVariablesForBatchObs.add(variableName);\n        }\n      } else {\n        this.variableChangedEvent(variableName, value);\n      }\n    }\n  }\n\n  public ResolveVariablePointer(varPointer: VariablePointerValue) {\n    let contextIndex = varPointer.contextIndex;\n\n    if (contextIndex == -1)\n      contextIndex = this.GetContextIndexOfVariableNamed(\n        varPointer.variableName\n      );\n\n    let valueOfVariablePointedTo = this.GetRawVariableWithName(\n      varPointer.variableName,\n      contextIndex\n    );\n\n    // var doubleRedirectionPointer = valueOfVariablePointedTo as VariablePointerValue;\n    let doubleRedirectionPointer = asOrNull(\n      valueOfVariablePointedTo,\n      VariablePointerValue\n    );\n    if (doubleRedirectionPointer != null) {\n      return doubleRedirectionPointer;\n    } else {\n      return new VariablePointerValue(varPointer.variableName, contextIndex);\n    }\n  }\n\n  public GetContextIndexOfVariableNamed(varName: string) {\n    if (this.GlobalVariableExistsWithName(varName)) return 0;\n\n    return this._callStack.currentElementIndex;\n  }\n\n  /**\n   * This function is specific to the js version of ink. It allows to register a\n   * callback that will be called when a variable changes. The original code uses\n   * `state.variableChangedEvent += callback` instead.\n   *\n   * @param {function} callback\n   */\n  public ObserveVariableChange(\n    callback: (variableName: string, newValue: InkObject) => void\n  ) {\n    this.variableChangedEventCallbacks.push(callback);\n  }\n\n  private _globalVariables: Map<string, InkObject>;\n  private _defaultGlobalVariables: Map<string, InkObject> = new Map();\n\n  private _callStack: CallStack;\n  private _changedVariablesForBatchObs: Set<string> | null = new Set();\n  private _listDefsOrigin: ListDefinitionsOrigin | null;\n\n  private _batchObservingVariableChanges: boolean = false;\n}\n", "// Taken from https://gist.github.com/blixt/f17b47c62508be59987b\n// Ink uses a seedable PRNG of which there is none in native javascript.\nexport class PRNG {\n  private seed: number;\n\n  constructor(seed: number) {\n    this.seed = seed % 2147483647;\n    if (this.seed <= 0) this.seed += 2147483646;\n  }\n  public next(): number {\n    return (this.seed = (this.seed * 48271) % 2147483647);\n  }\n  public nextFloat(): number {\n    return (this.next() - 1) / 2147483646;\n  }\n}\n", "import { InkObject } from \"./Object\";\nimport { Container } from \"./Container\";\n\nexport class StatePatch {\n  get globals() {\n    return this._globals;\n  }\n  get changedVariables() {\n    return this._changedVariables;\n  }\n  get visitCounts() {\n    return this._visitCounts;\n  }\n  get turnIndices() {\n    return this._turnIndices;\n  }\n\n  constructor();\n  constructor(toCopy: StatePatch | null);\n  constructor() {\n    if (arguments.length === 1 && arguments[0] !== null) {\n      let toCopy = arguments[0] as StatePatch;\n      this._globals = new Map(toCopy._globals);\n      this._changedVariables = new Set(toCopy._changedVariables);\n      this._visitCounts = new Map(toCopy._visitCounts);\n      this._turnIndices = new Map(toCopy._turnIndices);\n    } else {\n      this._globals = new Map();\n      this._changedVariables = new Set();\n      this._visitCounts = new Map();\n      this._turnIndices = new Map();\n    }\n  }\n\n  public TryGetGlobal(name: string | null, /* out */ value: InkObject | null) {\n    if (name !== null && this._globals.has(name)) {\n      return { result: this._globals.get(name), exists: true };\n    }\n\n    return { result: value, exists: false };\n  }\n\n  public SetGlobal(name: string, value: InkObject) {\n    this._globals.set(name, value);\n  }\n\n  public AddChangedVariable(name: string) {\n    return this._changedVariables.add(name);\n  }\n\n  public TryGetVisitCount(container: Container, /* out */ count: number) {\n    if (this._visitCounts.has(container)) {\n      return { result: this._visitCounts.get(container), exists: true };\n    }\n\n    return { result: count, exists: false };\n  }\n\n  public SetVisitCount(container: Container, count: number) {\n    this._visitCounts.set(container, count);\n  }\n\n  public SetTurnIndex(container: Container, index: number) {\n    this._turnIndices.set(container, index);\n  }\n\n  public TryGetTurnIndex(container: Container, /* out */ index: number) {\n    if (this._turnIndices.has(container)) {\n      return { result: this._turnIndices.get(container), exists: true };\n    }\n\n    return { result: index, exists: false };\n  }\n\n  private _globals: Map<string, InkObject>;\n  private _changedVariables: Set<string> = new Set();\n  private _visitCounts: Map<Container, number> = new Map();\n  private _turnIndices: Map<Container, number> = new Map();\n}\n", "export class SimpleJson {\n  public static TextToDictionary(text: string) {\n    return new SimpleJson.Reader(text).ToDictionary();\n  }\n\n  public static TextToArray(text: string) {\n    return new SimpleJson.Reader(text).ToArray();\n  }\n}\n\nexport namespace SimpleJson {\n  export class Reader {\n    constructor(text: string) {\n      // Before parsing the JSON, all floats of the form \"123.0\" are transformed into \"123.0f\"\n      // so that they are recognized as FLOAT in the ink runtime\n      const nativeFloatParsing = JSON.parse(\n        \"0\",\n        // @ts-expect-error : typing\n        (_, __, context) => context != null\n      );\n\n      if (!nativeFloatParsing) {\n        // When the nativeFloatParsing argument is false,\n        // we aggressively replace using a regexp\n        // At time of writing : only happen for Safari iOS and Mac\n        const jsonWithExplicitFloat = text.replace(\n          /(,\\s*)([0-9]+\\.[0]+)([,]*)/g,\n          '$1\"$2f\"$3'\n        );\n        this._rootObject = JSON.parse(jsonWithExplicitFloat);\n      } else {\n        // @ts-expect-error : typing\n        const explicitFloatReviver = (_, value, context) => {\n          // When the nativeFloatParsing argument is true,\n          // we use a custom reviver function\n          //see https://github.com/y-lohse/inkjs/pull/1100#issuecomment-2733148441\n          if (Number.isInteger(value) && context.source.endsWith(\".0\")) {\n            return context.source + \"f\";\n          }\n          return value;\n        };\n        // @ts-expect-error : typing\n        this._rootObject = JSON.parse(text, explicitFloatReviver);\n      }\n    }\n\n    public ToDictionary() {\n      return this._rootObject as Record<string, any>;\n    }\n\n    public ToArray() {\n      return this._rootObject as any[];\n    }\n\n    private _rootObject: any[] | Record<string, any>;\n  }\n\n  // In C#, this class writes json tokens directly to a StringWriter or\n  // another stream. Here, a temporary hierarchy is created in the form\n  // of a javascript object, which is serialised in the `toString` method.\n  // See individual methods and properties for more information.\n  export class Writer {\n    public WriteObject(inner: (w: Writer) => void) {\n      this.WriteObjectStart();\n      inner(this);\n      this.WriteObjectEnd();\n    }\n\n    // Add a new object.\n    public WriteObjectStart() {\n      this.StartNewObject(true);\n\n      let newObject: Record<string, any> = {};\n\n      if (this.state === SimpleJson.Writer.State.Property) {\n        // This object is created as the value of a property,\n        // inside an other object.\n        this.Assert(this.currentCollection !== null);\n        this.Assert(this.currentPropertyName !== null);\n\n        let propertyName = this._propertyNameStack.pop();\n        this.currentCollection![propertyName!] = newObject;\n        this._collectionStack.push(newObject);\n      } else if (this.state === SimpleJson.Writer.State.Array) {\n        // This object is created as the child of an array.\n        this.Assert(this.currentCollection !== null);\n\n        this.currentCollection!.push(newObject);\n        this._collectionStack.push(newObject);\n      } else {\n        // This object is the root object.\n        this.Assert(this.state === SimpleJson.Writer.State.None);\n        this._jsonObject = newObject;\n        this._collectionStack.push(newObject);\n      }\n\n      this._stateStack.push(\n        new SimpleJson.Writer.StateElement(SimpleJson.Writer.State.Object)\n      );\n    }\n\n    public WriteObjectEnd() {\n      this.Assert(this.state === SimpleJson.Writer.State.Object);\n      this._collectionStack.pop();\n      this._stateStack.pop();\n    }\n\n    // Write a property name / value pair to the current object.\n    public WriteProperty(\n      name: any,\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      innerOrContent: ((w: Writer) => void) | string | boolean | null\n    ) {\n      this.WritePropertyStart(name);\n      if (arguments[1] instanceof Function) {\n        let inner = arguments[1];\n        inner(this);\n      } else {\n        let content: string | boolean | null = arguments[1];\n        this.Write(content);\n      }\n      this.WritePropertyEnd();\n    }\n\n    // Int and Float are separate calls, since there both are\n    // numbers in JavaScript, but need to be handled differently.\n\n    public WriteIntProperty(name: any, content: number) {\n      this.WritePropertyStart(name);\n      this.WriteInt(content);\n      this.WritePropertyEnd();\n    }\n\n    public WriteFloatProperty(name: any, content: number) {\n      this.WritePropertyStart(name);\n      this.WriteFloat(content);\n      this.WritePropertyEnd();\n    }\n\n    // Prepare a new property name, which will be use to add the\n    // new object when calling _addToCurrentObject() from a Write\n    // method.\n    public WritePropertyStart(name: any) {\n      this.Assert(this.state === SimpleJson.Writer.State.Object);\n      this._propertyNameStack.push(name);\n\n      this.IncrementChildCount();\n\n      this._stateStack.push(\n        new SimpleJson.Writer.StateElement(SimpleJson.Writer.State.Property)\n      );\n    }\n\n    public WritePropertyEnd() {\n      this.Assert(this.state === SimpleJson.Writer.State.Property);\n      this.Assert(this.childCount === 1);\n      this._stateStack.pop();\n    }\n\n    // Prepare a new property name, except this time, the property name\n    // will be created by concatenating all the strings passed to\n    // WritePropertyNameInner.\n    public WritePropertyNameStart() {\n      this.Assert(this.state === SimpleJson.Writer.State.Object);\n      this.IncrementChildCount();\n\n      this._currentPropertyName = \"\";\n\n      this._stateStack.push(\n        new SimpleJson.Writer.StateElement(SimpleJson.Writer.State.Property)\n      );\n      this._stateStack.push(\n        new SimpleJson.Writer.StateElement(SimpleJson.Writer.State.PropertyName)\n      );\n    }\n\n    public WritePropertyNameEnd() {\n      this.Assert(this.state === SimpleJson.Writer.State.PropertyName);\n      this.Assert(this._currentPropertyName !== null);\n      this._propertyNameStack.push(this._currentPropertyName!);\n      this._currentPropertyName = null;\n      this._stateStack.pop();\n    }\n\n    public WritePropertyNameInner(str: string) {\n      this.Assert(this.state === SimpleJson.Writer.State.PropertyName);\n      this.Assert(this._currentPropertyName !== null);\n      this._currentPropertyName += str;\n    }\n\n    // Add a new array.\n    public WriteArrayStart() {\n      this.StartNewObject(true);\n\n      let newObject: any[] = [];\n\n      if (this.state === SimpleJson.Writer.State.Property) {\n        // This array is created as the value of a property,\n        // inside an object.\n        this.Assert(this.currentCollection !== null);\n        this.Assert(this.currentPropertyName !== null);\n\n        let propertyName = this._propertyNameStack.pop();\n        this.currentCollection![propertyName!] = newObject;\n        this._collectionStack.push(newObject);\n      } else if (this.state === SimpleJson.Writer.State.Array) {\n        // This array is created as the child of another array.\n        this.Assert(this.currentCollection !== null);\n\n        this.currentCollection!.push(newObject);\n        this._collectionStack.push(newObject);\n      } else {\n        // This array is the root object.\n        this.Assert(this.state === SimpleJson.Writer.State.None);\n        this._jsonObject = newObject;\n        this._collectionStack.push(newObject);\n      }\n\n      this._stateStack.push(\n        new SimpleJson.Writer.StateElement(SimpleJson.Writer.State.Array)\n      );\n    }\n\n    public WriteArrayEnd() {\n      this.Assert(this.state === SimpleJson.Writer.State.Array);\n      this._collectionStack.pop();\n      this._stateStack.pop();\n    }\n\n    // Add the value to the appropriate collection (array / object), given the current\n    // context.\n    public Write(\n      value: number | string | boolean | null,\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      escape: boolean = true\n    ) {\n      if (value === null) {\n        console.error(\"Warning: trying to write a null value\");\n        return;\n      }\n\n      this.StartNewObject(false);\n      this._addToCurrentObject(value);\n    }\n\n    public WriteBool(value: boolean | null) {\n      if (value === null) {\n        return;\n      }\n\n      this.StartNewObject(false);\n      this._addToCurrentObject(value);\n    }\n\n    public WriteInt(value: number | null) {\n      if (value === null) {\n        return;\n      }\n\n      this.StartNewObject(false);\n\n      // Math.floor is used as a precaution:\n      //     1. to ensure that the value is written as an integer\n      //        (without a fractional part -> 1 instead of 1.0), even\n      //        though it should be the default behaviour of\n      //        JSON.serialize;\n      //     2. to ensure that if a floating number is passed\n      //        accidentally, it's converted to an integer.\n      //\n      // This guarantees savegame compatibility with the reference\n      // implementation.\n      this._addToCurrentObject(Math.floor(value));\n    }\n\n    // Since JSON doesn't support NaN and Infinity, these values\n    // are converted here.\n    public WriteFloat(value: number | null) {\n      if (value === null) {\n        return;\n      }\n\n      this.StartNewObject(false);\n      if (value == Number.POSITIVE_INFINITY) {\n        this._addToCurrentObject(3.4e38);\n      } else if (value == Number.NEGATIVE_INFINITY) {\n        this._addToCurrentObject(-3.4e38);\n      } else if (isNaN(value)) {\n        this._addToCurrentObject(0.0);\n      } else {\n        this._addToCurrentObject(value);\n      }\n    }\n\n    public WriteNull() {\n      this.StartNewObject(false);\n      this._addToCurrentObject(null);\n    }\n\n    // Prepare a string before adding it to the current collection in\n    // WriteStringEnd(). The string will be a concatenation of all the\n    // strings passed to WriteStringInner.\n    public WriteStringStart() {\n      this.StartNewObject(false);\n      this._currentString = \"\";\n      this._stateStack.push(\n        new SimpleJson.Writer.StateElement(SimpleJson.Writer.State.String)\n      );\n    }\n\n    public WriteStringEnd() {\n      this.Assert(this.state == SimpleJson.Writer.State.String);\n      this._stateStack.pop();\n      this._addToCurrentObject(this._currentString);\n      this._currentString = null;\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    public WriteStringInner(str: string | null, escape: boolean = true) {\n      this.Assert(this.state === SimpleJson.Writer.State.String);\n\n      if (str === null) {\n        console.error(\"Warning: trying to write a null string\");\n        return;\n      }\n\n      this._currentString += str;\n    }\n\n    // Serialise the root object into a JSON string.\n    public toString() {\n      if (this._jsonObject === null) {\n        return \"\";\n      }\n\n      return JSON.stringify(this._jsonObject);\n    }\n\n    // Prepare the state stack when adding new objects / values.\n    private StartNewObject(container: boolean) {\n      if (container) {\n        this.Assert(\n          this.state === SimpleJson.Writer.State.None ||\n            this.state === SimpleJson.Writer.State.Property ||\n            this.state === SimpleJson.Writer.State.Array\n        );\n      } else {\n        this.Assert(\n          this.state === SimpleJson.Writer.State.Property ||\n            this.state === SimpleJson.Writer.State.Array\n        );\n      }\n\n      if (this.state === SimpleJson.Writer.State.Property) {\n        this.Assert(this.childCount === 0);\n      }\n\n      if (\n        this.state === SimpleJson.Writer.State.Array ||\n        this.state === SimpleJson.Writer.State.Property\n      ) {\n        this.IncrementChildCount();\n      }\n    }\n\n    // These getters peek all the different stacks.\n\n    private get state() {\n      if (this._stateStack.length > 0) {\n        return this._stateStack[this._stateStack.length - 1].type;\n      } else {\n        return SimpleJson.Writer.State.None;\n      }\n    }\n\n    private get childCount() {\n      if (this._stateStack.length > 0) {\n        return this._stateStack[this._stateStack.length - 1].childCount;\n      } else {\n        return 0;\n      }\n    }\n\n    private get currentCollection(): Record<string, any> | null {\n      if (this._collectionStack.length > 0) {\n        return this._collectionStack[this._collectionStack.length - 1];\n      } else {\n        return null;\n      }\n    }\n\n    private get currentPropertyName() {\n      if (this._propertyNameStack.length > 0) {\n        return this._propertyNameStack[this._propertyNameStack.length - 1];\n      } else {\n        return null;\n      }\n    }\n\n    private IncrementChildCount() {\n      this.Assert(this._stateStack.length > 0);\n      let currEl = this._stateStack.pop()!;\n      currEl.childCount++;\n      this._stateStack.push(currEl);\n    }\n\n    private Assert(condition: boolean) {\n      if (!condition) throw Error(\"Assert failed while writing JSON\");\n    }\n\n    // This method did not exist in the original C# code. It adds\n    // the given value to the current collection (used by Write methods).\n    private _addToCurrentObject(value: number | string | boolean | null) {\n      this.Assert(this.currentCollection !== null);\n      if (this.state === SimpleJson.Writer.State.Array) {\n        this.Assert(Array.isArray(this.currentCollection));\n        (this.currentCollection as any[]).push(value);\n      } else if (this.state === SimpleJson.Writer.State.Property) {\n        this.Assert(!Array.isArray(this.currentCollection));\n        this.Assert(this.currentPropertyName !== null);\n        (this.currentCollection as Record<string, any>)[\n          this.currentPropertyName!\n        ] = value;\n        this._propertyNameStack.pop();\n      }\n    }\n\n    // In addition to `_stateStack` present in the original code,\n    // this implementation of SimpleJson use two other stacks and two\n    // temporary variables holding the current context.\n\n    // Used to keep track of the current property name being built\n    // with `WritePropertyNameStart`, `WritePropertyNameInner` and\n    // `WritePropertyNameEnd`.\n    private _currentPropertyName: string | null = null;\n\n    // Used to keep track of the current string value being built\n    // with `WriteStringStart`, `WriteStringInner` and\n    // `WriteStringEnd`.\n    private _currentString: string | null = null;\n\n    private _stateStack: SimpleJson.Writer.StateElement[] = [];\n\n    // Keep track of the current collection being built (either an array\n    // or an object). For instance, at the '?' step during the hiarchy\n    // creation, this hierarchy:\n    // [3, {a: [b, ?]}] will have this corresponding stack:\n    // (bottom) [Array, Object, Array] (top)\n    private _collectionStack: Array<any[] | Record<string, any>> = [];\n\n    // Keep track of the current property being assigned. For instance, at\n    // the '?' step during the hiarchy creation, this hierarchy:\n    // [3, {a: [b, {c: ?}]}] will have this corresponding stack:\n    // (bottom) [a, c] (top)\n    private _propertyNameStack: string[] = [];\n\n    // Object containing the entire hiearchy.\n    private _jsonObject: Record<string, any> | any[] | null = null;\n  }\n\n  export namespace Writer {\n    export enum State {\n      None,\n      Object,\n      Array,\n      Property,\n      PropertyName,\n      String,\n    }\n\n    export class StateElement {\n      public type: SimpleJson.Writer.State = SimpleJson.Writer.State.None;\n      public childCount: number = 0;\n\n      constructor(type: SimpleJson.Writer.State) {\n        this.type = type;\n      }\n    }\n  }\n}\n", "import { CallStack } from \"./CallStack\";\nimport { Choice } from \"./Choice\";\nimport { JsonSerialisation } from \"./JsonSerialisation\";\nimport { InkObject } from \"./Object\";\nimport { SimpleJson } from \"./SimpleJson\";\nimport { Story } from \"./Story\";\nimport { throwNullException } from \"./NullException\";\n\nexport class Flow {\n  public name: string;\n  public callStack: CallStack;\n  public outputStream: InkObject[];\n  public currentChoices: Choice[];\n\n  constructor(name: String, story: Story);\n  constructor(name: String, story: Story, jObject: Record<string, any>);\n  constructor() {\n    let name = arguments[0] as string;\n    let story = arguments[1] as Story;\n\n    this.name = name;\n    this.callStack = new CallStack(story);\n\n    if (arguments[2]) {\n      let jObject = arguments[2] as Record<string, any>;\n\n      this.callStack.SetJsonToken(jObject[\"callstack\"], story);\n      this.outputStream = JsonSerialisation.JArrayToRuntimeObjList(\n        jObject[\"outputStream\"]\n      );\n      this.currentChoices = JsonSerialisation.JArrayToRuntimeObjList(\n        jObject[\"currentChoices\"]\n      ) as Choice[];\n\n      let jChoiceThreadsObj = jObject[\"choiceThreads\"];\n      if (typeof jChoiceThreadsObj !== \"undefined\") {\n        this.LoadFlowChoiceThreads(jChoiceThreadsObj, story);\n      }\n    } else {\n      this.outputStream = [];\n      this.currentChoices = [];\n    }\n  }\n\n  public WriteJson(writer: SimpleJson.Writer) {\n    writer.WriteObjectStart();\n\n    writer.WriteProperty(\"callstack\", (w) => this.callStack.WriteJson(w));\n    writer.WriteProperty(\"outputStream\", (w) =>\n      JsonSerialisation.WriteListRuntimeObjs(w, this.outputStream)\n    );\n\n    let hasChoiceThreads = false;\n    for (let c of this.currentChoices) {\n      if (c.threadAtGeneration === null)\n        return throwNullException(\"c.threadAtGeneration\");\n\n      c.originalThreadIndex = c.threadAtGeneration.threadIndex;\n\n      if (this.callStack.ThreadWithIndex(c.originalThreadIndex) === null) {\n        if (!hasChoiceThreads) {\n          hasChoiceThreads = true;\n          writer.WritePropertyStart(\"choiceThreads\");\n          writer.WriteObjectStart();\n        }\n\n        writer.WritePropertyStart(c.originalThreadIndex);\n        c.threadAtGeneration.WriteJson(writer);\n        writer.WritePropertyEnd();\n      }\n    }\n\n    if (hasChoiceThreads) {\n      writer.WriteObjectEnd();\n      writer.WritePropertyEnd();\n    }\n\n    writer.WriteProperty(\"currentChoices\", (w) => {\n      w.WriteArrayStart();\n      for (let c of this.currentChoices) {\n        JsonSerialisation.WriteChoice(w, c);\n      }\n      w.WriteArrayEnd();\n    });\n\n    writer.WriteObjectEnd();\n  }\n\n  public LoadFlowChoiceThreads(\n    jChoiceThreads: Record<string, any>,\n    story: Story\n  ) {\n    for (let choice of this.currentChoices) {\n      let foundActiveThread = this.callStack.ThreadWithIndex(\n        choice.originalThreadIndex\n      );\n      if (foundActiveThread !== null) {\n        choice.threadAtGeneration = foundActiveThread.Copy();\n      } else {\n        let jSavedChoiceThread =\n          jChoiceThreads[`${choice.originalThreadIndex}`];\n        choice.threadAtGeneration = new CallStack.Thread(\n          jSavedChoiceThread,\n          story\n        );\n      }\n    }\n  }\n}\n", "import { CallStack } from \"./CallStack\";\nimport { VariablesState } from \"./VariablesState\";\nimport { ValueType, Value, StringValue, ListValue } from \"./Value\";\nimport { PushPopType } from \"./PushPop\";\nimport { Tag } from \"./Tag\";\nimport { Glue } from \"./Glue\";\nimport { Path } from \"./Path\";\nimport { ControlCommand } from \"./ControlCommand\";\nimport { StringBuilder } from \"./StringBuilder\";\nimport { JsonSerialisation } from \"./JsonSerialisation\";\nimport { PRNG } from \"./PRNG\";\nimport { Void } from \"./Void\";\nimport { Pointer } from \"./Pointer\";\nimport { tryGetValueFromMap } from \"./TryGetResult\";\nimport { Choice } from \"./Choice\";\nimport { asOrNull, asOrThrows, nullIfUndefined } from \"./TypeAssertion\";\nimport { Debug } from \"./Debug\";\nimport { Container } from \"./Container\";\nimport { InkObject } from \"./Object\";\nimport { throwNullException } from \"./NullException\";\nimport { Story } from \"./Story\";\nimport { StatePatch } from \"./StatePatch\";\nimport { SimpleJson } from \"./SimpleJson\";\nimport { Flow } from \"./Flow\";\nimport { InkList } from \"./InkList\";\n\nexport class StoryState {\n  // Backward compatible changes since v8:\n  // v10: dynamic tags\n  // v9:  multi-flows\n  public readonly kInkSaveStateVersion = 10;\n  public readonly kMinCompatibleLoadVersion = 8;\n\n  public onDidLoadState: (() => void) | null = null;\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  public ToJson(indented: boolean = false) {\n    let writer = new SimpleJson.Writer();\n    this.WriteJson(writer);\n    return writer.toString();\n  }\n  public toJson(indented: boolean = false) {\n    return this.ToJson(indented);\n  }\n\n  public LoadJson(json: string) {\n    let jObject = SimpleJson.TextToDictionary(json);\n    this.LoadJsonObj(jObject);\n    if (this.onDidLoadState !== null) this.onDidLoadState();\n  }\n\n  public VisitCountAtPathString(pathString: string) {\n    let visitCountOut;\n\n    if (this._patch !== null) {\n      let container = this.story.ContentAtPath(new Path(pathString)).container;\n      if (container === null)\n        throw new Error(\"Content at path not found: \" + pathString);\n\n      visitCountOut = this._patch.TryGetVisitCount(container, 0);\n      if (visitCountOut.exists) return visitCountOut.result;\n    }\n\n    visitCountOut = tryGetValueFromMap(this._visitCounts, pathString, null);\n    if (visitCountOut.exists) return visitCountOut.result;\n\n    return 0;\n  }\n\n  public VisitCountForContainer(container: Container | null): number {\n    if (container === null) {\n      return throwNullException(\"container\");\n    }\n    if (!container.visitsShouldBeCounted) {\n      this.story.Error(\n        \"Read count for target (\" +\n          container.name +\n          \" - on \" +\n          container.debugMetadata +\n          \") unknown. The story may need to be compiled with countAllVisits flag (-c).\"\n      );\n      return 0;\n    }\n\n    if (this._patch !== null) {\n      let count = this._patch.TryGetVisitCount(container, 0);\n      if (count.exists) {\n        return count.result!;\n      }\n    }\n\n    let containerPathStr = container.path.toString();\n    let count2 = tryGetValueFromMap(this._visitCounts, containerPathStr, null);\n    if (count2.exists) {\n      return count2.result!;\n    }\n\n    return 0;\n  }\n\n  public IncrementVisitCountForContainer(container: Container) {\n    if (this._patch !== null) {\n      let currCount = this.VisitCountForContainer(container);\n      currCount++;\n      this._patch.SetVisitCount(container, currCount);\n      return;\n    }\n\n    let containerPathStr = container.path.toString();\n    let count = tryGetValueFromMap(this._visitCounts, containerPathStr, null);\n    if (count.exists) {\n      this._visitCounts.set(containerPathStr, count.result! + 1);\n    } else {\n      this._visitCounts.set(containerPathStr, 1);\n    }\n  }\n\n  public RecordTurnIndexVisitToContainer(container: Container) {\n    if (this._patch !== null) {\n      this._patch.SetTurnIndex(container, this.currentTurnIndex);\n      return;\n    }\n\n    let containerPathStr = container.path.toString();\n    this._turnIndices.set(containerPathStr, this.currentTurnIndex);\n  }\n\n  public TurnsSinceForContainer(container: Container) {\n    if (!container.turnIndexShouldBeCounted) {\n      this.story.Error(\n        \"TURNS_SINCE() for target (\" +\n          container.name +\n          \" - on \" +\n          container.debugMetadata +\n          \") unknown. The story may need to be compiled with countAllVisits flag (-c).\"\n      );\n    }\n\n    if (this._patch !== null) {\n      let index = this._patch.TryGetTurnIndex(container, 0);\n      if (index.exists) {\n        return this.currentTurnIndex - index.result!;\n      }\n    }\n\n    let containerPathStr = container.path.toString();\n    let index2 = tryGetValueFromMap(this._turnIndices, containerPathStr, 0);\n    if (index2.exists) {\n      return this.currentTurnIndex - index2.result!;\n    } else {\n      return -1;\n    }\n  }\n\n  get callstackDepth() {\n    return this.callStack.depth;\n  }\n\n  get outputStream() {\n    return this._currentFlow.outputStream;\n  }\n\n  get currentChoices() {\n    // If we can continue generating text content rather than choices,\n    // then we reflect the choice list as being empty, since choices\n    // should always come at the end.\n    if (this.canContinue) return [];\n    return this._currentFlow.currentChoices;\n  }\n\n  get generatedChoices() {\n    return this._currentFlow.currentChoices;\n  }\n\n  get currentErrors() {\n    return this._currentErrors;\n  }\n  private _currentErrors: string[] | null = null;\n\n  get currentWarnings() {\n    return this._currentWarnings;\n  }\n  private _currentWarnings: string[] | null = null;\n\n  get variablesState() {\n    return this._variablesState;\n  }\n  set variablesState(value) {\n    this._variablesState = value;\n  }\n  private _variablesState: VariablesState;\n\n  get callStack() {\n    return this._currentFlow.callStack;\n  }\n\n  get evaluationStack() {\n    return this._evaluationStack;\n  }\n  private _evaluationStack: InkObject[];\n\n  public divertedPointer: Pointer = Pointer.Null;\n\n  get currentTurnIndex() {\n    return this._currentTurnIndex;\n  }\n  set currentTurnIndex(value) {\n    this._currentTurnIndex = value;\n  }\n  private _currentTurnIndex: number = 0;\n\n  public storySeed: number = 0;\n  public previousRandom: number = 0;\n  public didSafeExit: boolean = false;\n\n  public story: Story;\n\n  get currentPathString() {\n    let pointer = this.currentPointer;\n    if (pointer.isNull) {\n      return null;\n    } else {\n      if (pointer.path === null) {\n        return throwNullException(\"pointer.path\");\n      }\n      return pointer.path.toString();\n    }\n  }\n\n  get previousPathString() {\n    let pointer = this.previousPointer;\n    if (pointer.isNull) {\n      return null;\n    } else {\n      if (pointer.path === null) {\n        return throwNullException(\"previousPointer.path\");\n      }\n      return pointer.path.toString();\n    }\n  }\n\n  get currentPointer() {\n    return this.callStack.currentElement.currentPointer.copy();\n  }\n\n  set currentPointer(value) {\n    this.callStack.currentElement.currentPointer = value.copy();\n  }\n\n  get previousPointer() {\n    return this.callStack.currentThread.previousPointer.copy();\n  }\n\n  set previousPointer(value) {\n    this.callStack.currentThread.previousPointer = value.copy();\n  }\n\n  get canContinue() {\n    return !this.currentPointer.isNull && !this.hasError;\n  }\n\n  get hasError() {\n    return this.currentErrors != null && this.currentErrors.length > 0;\n  }\n\n  get hasWarning() {\n    return this.currentWarnings != null && this.currentWarnings.length > 0;\n  }\n\n  get currentText() {\n    if (this._outputStreamTextDirty) {\n      let sb = new StringBuilder();\n\n      let inTag: boolean = false;\n\n      for (let outputObj of this.outputStream) {\n        // var textContent = outputObj as StringValue;\n        let textContent = asOrNull(outputObj, StringValue);\n        if (!inTag && textContent !== null) {\n          sb.Append(textContent.value);\n        } else {\n          let controlCommand = asOrNull(outputObj, ControlCommand);\n          if (controlCommand !== null) {\n            if (\n              controlCommand.commandType == ControlCommand.CommandType.BeginTag\n            ) {\n              inTag = true;\n            } else if (\n              controlCommand.commandType == ControlCommand.CommandType.EndTag\n            ) {\n              inTag = false;\n            }\n          }\n        }\n      }\n\n      this._currentText = this.CleanOutputWhitespace(sb.toString());\n      this._outputStreamTextDirty = false;\n    }\n\n    return this._currentText;\n  }\n  private _currentText: string | null = null;\n\n  public CleanOutputWhitespace(str: string) {\n    let sb = new StringBuilder();\n\n    let currentWhitespaceStart = -1;\n    let startOfLine = 0;\n\n    for (let i = 0; i < str.length; i++) {\n      let c = str.charAt(i);\n\n      let isInlineWhitespace = c == \" \" || c == \"\\t\";\n\n      if (isInlineWhitespace && currentWhitespaceStart == -1)\n        currentWhitespaceStart = i;\n\n      if (!isInlineWhitespace) {\n        if (\n          c != \"\\n\" &&\n          currentWhitespaceStart > 0 &&\n          currentWhitespaceStart != startOfLine\n        ) {\n          sb.Append(\" \");\n        }\n        currentWhitespaceStart = -1;\n      }\n\n      if (c == \"\\n\") startOfLine = i + 1;\n\n      if (!isInlineWhitespace) sb.Append(c);\n    }\n\n    return sb.toString();\n  }\n\n  get currentTags() {\n    if (this._outputStreamTagsDirty) {\n      this._currentTags = [];\n      let inTag: boolean = false;\n      let sb = new StringBuilder();\n\n      for (let outputObj of this.outputStream) {\n        let controlCommand = asOrNull(outputObj, ControlCommand);\n        if (controlCommand != null) {\n          if (\n            controlCommand.commandType == ControlCommand.CommandType.BeginTag\n          ) {\n            if (inTag && sb.Length > 0) {\n              let txt = this.CleanOutputWhitespace(sb.toString());\n              this._currentTags.push(txt);\n              sb.Clear();\n            }\n            inTag = true;\n          } else if (\n            controlCommand.commandType == ControlCommand.CommandType.EndTag\n          ) {\n            if (sb.Length > 0) {\n              let txt = this.CleanOutputWhitespace(sb.toString());\n              this._currentTags.push(txt);\n              sb.Clear();\n            }\n            inTag = false;\n          }\n        } else if (inTag) {\n          let strVal = asOrNull(outputObj, StringValue);\n          if (strVal !== null) {\n            sb.Append(strVal.value);\n          }\n        } else {\n          let tag = asOrNull(outputObj, Tag);\n          if (tag != null && tag.text != null && tag.text.length > 0) {\n            this._currentTags.push(tag.text); // tag.text has whitespae already cleaned\n          }\n        }\n      }\n\n      if (sb.Length > 0) {\n        let txt = this.CleanOutputWhitespace(sb.toString());\n        this._currentTags.push(txt);\n        sb.Clear();\n      }\n\n      this._outputStreamTagsDirty = false;\n    }\n\n    return this._currentTags;\n  }\n  private _currentTags: string[] | null = null;\n\n  get currentFlowName() {\n    return this._currentFlow.name;\n  }\n\n  get currentFlowIsDefaultFlow() {\n    return this._currentFlow.name == this.kDefaultFlowName;\n  }\n\n  get aliveFlowNames() {\n    if (this._aliveFlowNamesDirty) {\n      this._aliveFlowNames = [];\n\n      if (this._namedFlows != null) {\n        for (let flowName of this._namedFlows.keys()) {\n          if (flowName != this.kDefaultFlowName) {\n            this._aliveFlowNames.push(flowName);\n          }\n        }\n      }\n\n      this._aliveFlowNamesDirty = false;\n    }\n\n    return this._aliveFlowNames;\n  }\n\n  get inExpressionEvaluation() {\n    return this.callStack.currentElement.inExpressionEvaluation;\n  }\n  set inExpressionEvaluation(value) {\n    this.callStack.currentElement.inExpressionEvaluation = value;\n  }\n\n  constructor(story: Story) {\n    this.story = story;\n\n    this._currentFlow = new Flow(this.kDefaultFlowName, story);\n    this.OutputStreamDirty();\n\n    this._aliveFlowNamesDirty = true;\n    this._evaluationStack = [];\n\n    this._variablesState = new VariablesState(\n      this.callStack,\n      story.listDefinitions\n    );\n\n    this._visitCounts = new Map();\n    this._turnIndices = new Map();\n    this.currentTurnIndex = -1;\n\n    let timeSeed = new Date().getTime();\n    this.storySeed = new PRNG(timeSeed).next() % 100;\n    this.previousRandom = 0;\n\n    this.GoToStart();\n  }\n\n  public GoToStart() {\n    this.callStack.currentElement.currentPointer = Pointer.StartOf(\n      this.story.mainContentContainer\n    );\n  }\n\n  public SwitchFlow_Internal(flowName: string | null) {\n    if (flowName === null)\n      throw new Error(\"Must pass a non-null string to Story.SwitchFlow\");\n\n    if (this._namedFlows === null) {\n      this._namedFlows = new Map();\n      this._namedFlows.set(this.kDefaultFlowName, this._currentFlow);\n    }\n\n    if (flowName === this._currentFlow.name) {\n      return;\n    }\n\n    let flow: Flow;\n    let content = tryGetValueFromMap(this._namedFlows, flowName, null);\n    if (content.exists) {\n      flow = content.result!;\n    } else {\n      flow = new Flow(flowName, this.story);\n      this._namedFlows.set(flowName, flow);\n      this._aliveFlowNamesDirty = true;\n    }\n\n    this._currentFlow = flow;\n    this.variablesState.callStack = this._currentFlow.callStack;\n\n    this.OutputStreamDirty();\n  }\n\n  public SwitchToDefaultFlow_Internal() {\n    if (this._namedFlows === null) return;\n    this.SwitchFlow_Internal(this.kDefaultFlowName);\n  }\n\n  public RemoveFlow_Internal(flowName: string | null) {\n    if (flowName === null)\n      throw new Error(\"Must pass a non-null string to Story.DestroyFlow\");\n    if (flowName === this.kDefaultFlowName)\n      throw new Error(\"Cannot destroy default flow\");\n\n    if (this._currentFlow.name === flowName) {\n      this.SwitchToDefaultFlow_Internal();\n    }\n\n    if (this._namedFlows === null)\n      return throwNullException(\"this._namedFlows\");\n    this._namedFlows.delete(flowName);\n    this._aliveFlowNamesDirty = true;\n  }\n\n  public CopyAndStartPatching(forBackgroundSave: boolean) {\n    let copy = new StoryState(this.story);\n\n    copy._patch = new StatePatch(this._patch);\n\n    copy._currentFlow.name = this._currentFlow.name;\n    copy._currentFlow.callStack = new CallStack(this._currentFlow.callStack);\n    copy._currentFlow.outputStream.push(...this._currentFlow.outputStream);\n    copy.OutputStreamDirty();\n\n    // When background saving we need to make copies of choices since they each have\n    // a snapshot of the thread at the time of generation since the game could progress\n    // significantly and threads modified during the save process.\n    // However, when doing internal saving and restoring of snapshots this isn't an issue,\n    // and we can simply ref-copy the choices with their existing threads.\n\n    if (forBackgroundSave) {\n      for (let choice of this._currentFlow.currentChoices) {\n        copy._currentFlow.currentChoices.push(choice.Clone());\n      }\n    } else {\n      copy._currentFlow.currentChoices.push(\n        ...this._currentFlow.currentChoices\n      );\n    }\n\n    if (this._namedFlows !== null) {\n      copy._namedFlows = new Map();\n      for (let [namedFlowKey, namedFlowValue] of this._namedFlows) {\n        copy._namedFlows.set(namedFlowKey, namedFlowValue);\n        copy._aliveFlowNamesDirty = true;\n      }\n      copy._namedFlows.set(this._currentFlow.name, copy._currentFlow);\n    }\n\n    if (this.hasError) {\n      copy._currentErrors = [];\n      copy._currentErrors.push(...(this.currentErrors || []));\n    }\n\n    if (this.hasWarning) {\n      copy._currentWarnings = [];\n      copy._currentWarnings.push(...(this.currentWarnings || []));\n    }\n\n    copy.variablesState = this.variablesState;\n    copy.variablesState.callStack = copy.callStack;\n    copy.variablesState.patch = copy._patch;\n\n    copy.evaluationStack.push(...this.evaluationStack);\n\n    if (!this.divertedPointer.isNull)\n      copy.divertedPointer = this.divertedPointer.copy();\n\n    copy.previousPointer = this.previousPointer.copy();\n\n    copy._visitCounts = this._visitCounts;\n    copy._turnIndices = this._turnIndices;\n\n    copy.currentTurnIndex = this.currentTurnIndex;\n    copy.storySeed = this.storySeed;\n    copy.previousRandom = this.previousRandom;\n\n    copy.didSafeExit = this.didSafeExit;\n\n    return copy;\n  }\n\n  public RestoreAfterPatch() {\n    this.variablesState.callStack = this.callStack;\n    this.variablesState.patch = this._patch;\n  }\n\n  public ApplyAnyPatch() {\n    if (this._patch === null) return;\n\n    this.variablesState.ApplyPatch();\n\n    for (let [key, value] of this._patch.visitCounts)\n      this.ApplyCountChanges(key, value, true);\n\n    for (let [key, value] of this._patch.turnIndices)\n      this.ApplyCountChanges(key, value, false);\n\n    this._patch = null;\n  }\n\n  public ApplyCountChanges(\n    container: Container,\n    newCount: number,\n    isVisit: boolean\n  ) {\n    let counts = isVisit ? this._visitCounts : this._turnIndices;\n    counts.set(container.path.toString(), newCount);\n  }\n\n  public WriteJson(writer: SimpleJson.Writer) {\n    writer.WriteObjectStart();\n\n    writer.WritePropertyStart(\"flows\");\n    writer.WriteObjectStart();\n\n    // NOTE: Never pass `WriteJson` directly as an argument to `WriteProperty`.\n    // Call it inside a function to make sure `this` is correctly bound\n    // and passed down the call hierarchy.\n\n    if (this._namedFlows !== null) {\n      for (let [namedFlowKey, namedFlowValue] of this._namedFlows) {\n        writer.WriteProperty(namedFlowKey, (w) => namedFlowValue.WriteJson(w));\n      }\n    } else {\n      writer.WriteProperty(this._currentFlow.name, (w) =>\n        this._currentFlow.WriteJson(w)\n      );\n    }\n\n    writer.WriteObjectEnd();\n    writer.WritePropertyEnd();\n\n    writer.WriteProperty(\"currentFlowName\", this._currentFlow.name);\n\n    writer.WriteProperty(\"variablesState\", (w) =>\n      this.variablesState.WriteJson(w)\n    );\n\n    writer.WriteProperty(\"evalStack\", (w) =>\n      JsonSerialisation.WriteListRuntimeObjs(w, this.evaluationStack)\n    );\n\n    if (!this.divertedPointer.isNull) {\n      if (this.divertedPointer.path === null) {\n        return throwNullException(\"divertedPointer\");\n      }\n      writer.WriteProperty(\n        \"currentDivertTarget\",\n        this.divertedPointer.path.componentsString\n      );\n    }\n\n    writer.WriteProperty(\"visitCounts\", (w) =>\n      JsonSerialisation.WriteIntDictionary(w, this._visitCounts)\n    );\n    writer.WriteProperty(\"turnIndices\", (w) =>\n      JsonSerialisation.WriteIntDictionary(w, this._turnIndices)\n    );\n\n    writer.WriteIntProperty(\"turnIdx\", this.currentTurnIndex);\n    writer.WriteIntProperty(\"storySeed\", this.storySeed);\n    writer.WriteIntProperty(\"previousRandom\", this.previousRandom);\n\n    writer.WriteIntProperty(\"inkSaveVersion\", this.kInkSaveStateVersion);\n\n    writer.WriteIntProperty(\"inkFormatVersion\", Story.inkVersionCurrent);\n\n    writer.WriteObjectEnd();\n  }\n\n  public LoadJsonObj(value: Record<string, any>) {\n    let jObject = value;\n\n    let jSaveVersion = jObject[\"inkSaveVersion\"];\n    if (jSaveVersion == null) {\n      throw new Error(\"ink save format incorrect, can't load.\");\n    } else if (parseInt(jSaveVersion) < this.kMinCompatibleLoadVersion) {\n      throw new Error(\n        \"Ink save format isn't compatible with the current version (saw '\" +\n          jSaveVersion +\n          \"', but minimum is \" +\n          this.kMinCompatibleLoadVersion +\n          \"), so can't load.\"\n      );\n    }\n\n    let flowsObj = jObject[\"flows\"];\n    if (flowsObj != null) {\n      let flowsObjDict = flowsObj as Record<string, any>;\n\n      // Single default flow\n      if (Object.keys(flowsObjDict).length === 1) {\n        this._namedFlows = null;\n      } else if (this._namedFlows === null) {\n        this._namedFlows = new Map();\n      } else {\n        this._namedFlows.clear();\n      }\n\n      let flowsObjDictEntries = Object.entries(flowsObjDict);\n      for (let [namedFlowObjKey, namedFlowObjValue] of flowsObjDictEntries) {\n        let name = namedFlowObjKey;\n        let flowObj = namedFlowObjValue as Record<string, any>;\n\n        let flow = new Flow(name, this.story, flowObj);\n\n        if (Object.keys(flowsObjDict).length === 1) {\n          this._currentFlow = new Flow(name, this.story, flowObj);\n        } else {\n          if (this._namedFlows === null)\n            return throwNullException(\"this._namedFlows\");\n          this._namedFlows.set(name, flow);\n        }\n      }\n\n      if (this._namedFlows != null && this._namedFlows.size > 1) {\n        let currFlowName = jObject[\"currentFlowName\"] as string;\n        // Adding a bang at the end, because we're trusting the save, as\n        // done in upstream.  If the save is corrupted, the execution\n        // is undefined.\n        this._currentFlow = this._namedFlows.get(currFlowName)!;\n      }\n    } else {\n      this._namedFlows = null;\n      this._currentFlow.name = this.kDefaultFlowName;\n      this._currentFlow.callStack.SetJsonToken(\n        jObject[\"callstackThreads\"] as Record<string, any>,\n        this.story\n      );\n      this._currentFlow.outputStream = JsonSerialisation.JArrayToRuntimeObjList(\n        jObject[\"outputStream\"] as any[]\n      );\n      this._currentFlow.currentChoices =\n        JsonSerialisation.JArrayToRuntimeObjList(\n          jObject[\"currentChoices\"] as any[]\n        ) as Choice[];\n\n      let jChoiceThreadsObj = jObject[\"choiceThreads\"];\n      this._currentFlow.LoadFlowChoiceThreads(jChoiceThreadsObj, this.story);\n    }\n\n    this.OutputStreamDirty();\n    this._aliveFlowNamesDirty = true;\n\n    this.variablesState.SetJsonToken(jObject[\"variablesState\"]);\n    this.variablesState.callStack = this._currentFlow.callStack;\n\n    this._evaluationStack = JsonSerialisation.JArrayToRuntimeObjList(\n      jObject[\"evalStack\"]\n    );\n\n    let currentDivertTargetPath = jObject[\"currentDivertTarget\"];\n    if (currentDivertTargetPath != null) {\n      let divertPath = new Path(currentDivertTargetPath.toString());\n      this.divertedPointer = this.story.PointerAtPath(divertPath);\n    }\n\n    this._visitCounts = JsonSerialisation.JObjectToIntDictionary(\n      jObject[\"visitCounts\"]\n    );\n    this._turnIndices = JsonSerialisation.JObjectToIntDictionary(\n      jObject[\"turnIndices\"]\n    );\n    this.currentTurnIndex = parseInt(jObject[\"turnIdx\"]);\n    this.storySeed = parseInt(jObject[\"storySeed\"]);\n    this.previousRandom = parseInt(jObject[\"previousRandom\"]);\n  }\n\n  public ResetErrors() {\n    this._currentErrors = null;\n    this._currentWarnings = null;\n  }\n  public ResetOutput(objs: InkObject[] | null = null) {\n    this.outputStream.length = 0;\n    if (objs !== null) this.outputStream.push(...objs);\n    this.OutputStreamDirty();\n  }\n\n  public PushToOutputStream(obj: InkObject | null) {\n    // var text = obj as StringValue;\n    let text = asOrNull(obj, StringValue);\n    if (text !== null) {\n      let listText = this.TrySplittingHeadTailWhitespace(text);\n      if (listText !== null) {\n        for (let textObj of listText) {\n          this.PushToOutputStreamIndividual(textObj);\n        }\n        this.OutputStreamDirty();\n        return;\n      }\n    }\n\n    this.PushToOutputStreamIndividual(obj);\n    this.OutputStreamDirty();\n  }\n\n  public PopFromOutputStream(count: number) {\n    this.outputStream.splice(this.outputStream.length - count, count);\n    this.OutputStreamDirty();\n  }\n\n  public TrySplittingHeadTailWhitespace(single: StringValue) {\n    let str = single.value;\n    if (str === null) {\n      return throwNullException(\"single.value\");\n    }\n\n    let headFirstNewlineIdx = -1;\n    let headLastNewlineIdx = -1;\n    for (let i = 0; i < str.length; i++) {\n      let c = str[i];\n      if (c == \"\\n\") {\n        if (headFirstNewlineIdx == -1) headFirstNewlineIdx = i;\n        headLastNewlineIdx = i;\n      } else if (c == \" \" || c == \"\\t\") continue;\n      else break;\n    }\n\n    let tailLastNewlineIdx = -1;\n    let tailFirstNewlineIdx = -1;\n    for (let i = str.length - 1; i >= 0; i--) {\n      let c = str[i];\n      if (c == \"\\n\") {\n        if (tailLastNewlineIdx == -1) tailLastNewlineIdx = i;\n        tailFirstNewlineIdx = i;\n      } else if (c == \" \" || c == \"\\t\") continue;\n      else break;\n    }\n\n    // No splitting to be done?\n    if (headFirstNewlineIdx == -1 && tailLastNewlineIdx == -1) return null;\n\n    let listTexts: StringValue[] = [];\n    let innerStrStart = 0;\n    let innerStrEnd = str.length;\n\n    if (headFirstNewlineIdx != -1) {\n      if (headFirstNewlineIdx > 0) {\n        let leadingSpaces = new StringValue(\n          str.substring(0, headFirstNewlineIdx)\n        );\n        listTexts.push(leadingSpaces);\n      }\n      listTexts.push(new StringValue(\"\\n\"));\n      innerStrStart = headLastNewlineIdx + 1;\n    }\n\n    if (tailLastNewlineIdx != -1) {\n      innerStrEnd = tailFirstNewlineIdx;\n    }\n\n    if (innerStrEnd > innerStrStart) {\n      let innerStrText = str.substring(innerStrStart, innerStrEnd);\n      listTexts.push(new StringValue(innerStrText));\n    }\n\n    if (tailLastNewlineIdx != -1 && tailFirstNewlineIdx > headLastNewlineIdx) {\n      listTexts.push(new StringValue(\"\\n\"));\n      if (tailLastNewlineIdx < str.length - 1) {\n        let numSpaces = str.length - tailLastNewlineIdx - 1;\n        let trailingSpaces = new StringValue(\n          str.substring(\n            tailLastNewlineIdx + 1,\n            tailLastNewlineIdx + 1 + numSpaces\n          )\n        );\n        listTexts.push(trailingSpaces);\n      }\n    }\n\n    return listTexts;\n  }\n\n  public PushToOutputStreamIndividual(obj: InkObject | null) {\n    let glue = asOrNull(obj, Glue);\n    let text = asOrNull(obj, StringValue);\n\n    let includeInOutput = true;\n\n    if (glue) {\n      this.TrimNewlinesFromOutputStream();\n      includeInOutput = true;\n    } else if (text) {\n      let functionTrimIndex = -1;\n      let currEl = this.callStack.currentElement;\n      if (currEl.type == PushPopType.Function) {\n        functionTrimIndex = currEl.functionStartInOutputStream;\n      }\n\n      let glueTrimIndex = -1;\n      for (let i = this.outputStream.length - 1; i >= 0; i--) {\n        let o = this.outputStream[i];\n        let c = o instanceof ControlCommand ? o : null;\n        let g = o instanceof Glue ? o : null;\n\n        if (g != null) {\n          glueTrimIndex = i;\n          break;\n        } else if (\n          c != null &&\n          c.commandType == ControlCommand.CommandType.BeginString\n        ) {\n          if (i >= functionTrimIndex) {\n            functionTrimIndex = -1;\n          }\n          break;\n        }\n      }\n\n      let trimIndex = -1;\n      if (glueTrimIndex != -1 && functionTrimIndex != -1)\n        trimIndex = Math.min(functionTrimIndex, glueTrimIndex);\n      else if (glueTrimIndex != -1) trimIndex = glueTrimIndex;\n      else trimIndex = functionTrimIndex;\n\n      if (trimIndex != -1) {\n        if (text.isNewline) {\n          includeInOutput = false;\n        } else if (text.isNonWhitespace) {\n          if (glueTrimIndex > -1) this.RemoveExistingGlue();\n\n          if (functionTrimIndex > -1) {\n            let callStackElements = this.callStack.elements;\n            for (let i = callStackElements.length - 1; i >= 0; i--) {\n              let el = callStackElements[i];\n              if (el.type == PushPopType.Function) {\n                el.functionStartInOutputStream = -1;\n              } else {\n                break;\n              }\n            }\n          }\n        }\n      } else if (text.isNewline) {\n        if (this.outputStreamEndsInNewline || !this.outputStreamContainsContent)\n          includeInOutput = false;\n      }\n    }\n\n    if (includeInOutput) {\n      if (obj === null) {\n        return throwNullException(\"obj\");\n      }\n      this.outputStream.push(obj);\n      this.OutputStreamDirty();\n    }\n  }\n\n  public TrimNewlinesFromOutputStream() {\n    let removeWhitespaceFrom = -1;\n\n    let i = this.outputStream.length - 1;\n    while (i >= 0) {\n      let obj = this.outputStream[i];\n      let cmd = asOrNull(obj, ControlCommand);\n      let txt = asOrNull(obj, StringValue);\n\n      if (cmd != null || (txt != null && txt.isNonWhitespace)) {\n        break;\n      } else if (txt != null && txt.isNewline) {\n        removeWhitespaceFrom = i;\n      }\n      i--;\n    }\n\n    // Remove the whitespace\n    if (removeWhitespaceFrom >= 0) {\n      i = removeWhitespaceFrom;\n      while (i < this.outputStream.length) {\n        let text = asOrNull(this.outputStream[i], StringValue);\n        if (text) {\n          this.outputStream.splice(i, 1);\n        } else {\n          i++;\n        }\n      }\n    }\n\n    this.OutputStreamDirty();\n  }\n\n  public RemoveExistingGlue() {\n    for (let i = this.outputStream.length - 1; i >= 0; i--) {\n      let c = this.outputStream[i];\n      if (c instanceof Glue) {\n        this.outputStream.splice(i, 1);\n      } else if (c instanceof ControlCommand) {\n        break;\n      }\n    }\n\n    this.OutputStreamDirty();\n  }\n\n  get outputStreamEndsInNewline() {\n    if (this.outputStream.length > 0) {\n      for (let i = this.outputStream.length - 1; i >= 0; i--) {\n        let obj = this.outputStream[i];\n        if (obj instanceof ControlCommand) break;\n        let text = this.outputStream[i];\n        if (text instanceof StringValue) {\n          if (text.isNewline) return true;\n          else if (text.isNonWhitespace) break;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  get outputStreamContainsContent() {\n    for (let content of this.outputStream) {\n      if (content instanceof StringValue) return true;\n    }\n    return false;\n  }\n\n  get inStringEvaluation() {\n    for (let i = this.outputStream.length - 1; i >= 0; i--) {\n      let cmd = asOrNull(this.outputStream[i], ControlCommand);\n      if (\n        cmd instanceof ControlCommand &&\n        cmd.commandType == ControlCommand.CommandType.BeginString\n      ) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  public PushEvaluationStack(obj: InkObject | null) {\n    // var listValue = obj as ListValue;\n    let listValue = asOrNull(obj, ListValue);\n    if (listValue) {\n      // Update origin when list is has something to indicate the list origin\n      let rawList = listValue.value;\n      if (rawList === null) {\n        return throwNullException(\"rawList\");\n      }\n\n      if (rawList.originNames != null) {\n        if (!rawList.origins) rawList.origins = [];\n        rawList.origins.length = 0;\n\n        for (let n of rawList.originNames) {\n          if (this.story.listDefinitions === null)\n            return throwNullException(\"StoryState.story.listDefinitions\");\n          let def = this.story.listDefinitions.TryListGetDefinition(n, null);\n          if (def.result === null)\n            return throwNullException(\"StoryState def.result\");\n          if (rawList.origins.indexOf(def.result) < 0)\n            rawList.origins.push(def.result);\n        }\n      }\n    }\n\n    if (obj === null) {\n      return throwNullException(\"obj\");\n    }\n    this.evaluationStack.push(obj);\n  }\n\n  public PopEvaluationStack(): InkObject;\n  public PopEvaluationStack(numberOfObjects: number): InkObject[];\n  public PopEvaluationStack(numberOfObjects?: number) {\n    if (typeof numberOfObjects === \"undefined\") {\n      let obj = this.evaluationStack.pop();\n      return nullIfUndefined(obj);\n    } else {\n      if (numberOfObjects > this.evaluationStack.length) {\n        throw new Error(\"trying to pop too many objects\");\n      }\n\n      let popped = this.evaluationStack.splice(\n        this.evaluationStack.length - numberOfObjects,\n        numberOfObjects\n      );\n      return nullIfUndefined(popped);\n    }\n  }\n\n  public PeekEvaluationStack() {\n    return this.evaluationStack[this.evaluationStack.length - 1];\n  }\n\n  public ForceEnd() {\n    this.callStack.Reset();\n\n    this._currentFlow.currentChoices.length = 0;\n\n    this.currentPointer = Pointer.Null;\n    this.previousPointer = Pointer.Null;\n\n    this.didSafeExit = true;\n  }\n\n  public TrimWhitespaceFromFunctionEnd() {\n    Debug.Assert(this.callStack.currentElement.type == PushPopType.Function);\n    let functionStartPoint =\n      this.callStack.currentElement.functionStartInOutputStream;\n\n    if (functionStartPoint == -1) {\n      functionStartPoint = 0;\n    }\n\n    for (let i = this.outputStream.length - 1; i >= functionStartPoint; i--) {\n      let obj = this.outputStream[i];\n      let txt = asOrNull(obj, StringValue);\n      let cmd = asOrNull(obj, ControlCommand);\n\n      if (txt == null) continue;\n      if (cmd) break;\n\n      if (txt.isNewline || txt.isInlineWhitespace) {\n        this.outputStream.splice(i, 1);\n        this.OutputStreamDirty();\n      } else {\n        break;\n      }\n    }\n  }\n\n  public PopCallStack(popType: PushPopType | null = null) {\n    if (this.callStack.currentElement.type == PushPopType.Function)\n      this.TrimWhitespaceFromFunctionEnd();\n\n    this.callStack.Pop(popType);\n  }\n\n  public SetChosenPath(path: Path, incrementingTurnIndex: boolean) {\n    // Changing direction, assume we need to clear current set of choices\n    this._currentFlow.currentChoices.length = 0;\n\n    let newPointer = this.story.PointerAtPath(path);\n    if (!newPointer.isNull && newPointer.index == -1) newPointer.index = 0;\n\n    this.currentPointer = newPointer;\n\n    if (incrementingTurnIndex) {\n      this.currentTurnIndex++;\n    }\n  }\n\n  public StartFunctionEvaluationFromGame(\n    funcContainer: Container,\n    args: any[]\n  ) {\n    this.callStack.Push(\n      PushPopType.FunctionEvaluationFromGame,\n      this.evaluationStack.length\n    );\n    this.callStack.currentElement.currentPointer =\n      Pointer.StartOf(funcContainer);\n\n    this.PassArgumentsToEvaluationStack(args);\n  }\n\n  public PassArgumentsToEvaluationStack(args: any[] | null) {\n    if (args !== null) {\n      for (let i = 0; i < args.length; i++) {\n        if (\n          !(\n            typeof args[i] === \"number\" ||\n            typeof args[i] === \"string\" ||\n            typeof args[i] === \"boolean\" ||\n            args[i] instanceof InkList\n          )\n        ) {\n          throw new Error(\n            \"ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters must be\" +\n              \"number, string, bool or InkList. Argument was \" +\n              (nullIfUndefined(args[i]) === null\n                ? \"null\"\n                : args[i].constructor.name)\n          );\n        }\n\n        this.PushEvaluationStack(Value.Create(args[i]));\n      }\n    }\n  }\n\n  public TryExitFunctionEvaluationFromGame() {\n    if (\n      this.callStack.currentElement.type ==\n      PushPopType.FunctionEvaluationFromGame\n    ) {\n      this.currentPointer = Pointer.Null;\n      this.didSafeExit = true;\n      return true;\n    }\n\n    return false;\n  }\n\n  public CompleteFunctionEvaluationFromGame() {\n    if (\n      this.callStack.currentElement.type !=\n      PushPopType.FunctionEvaluationFromGame\n    ) {\n      throw new Error(\n        \"Expected external function evaluation to be complete. Stack trace: \" +\n          this.callStack.callStackTrace\n      );\n    }\n\n    let originalEvaluationStackHeight =\n      this.callStack.currentElement.evaluationStackHeightWhenPushed;\n\n    let returnedObj: InkObject | null = null;\n    while (this.evaluationStack.length > originalEvaluationStackHeight) {\n      let poppedObj = this.PopEvaluationStack();\n      if (returnedObj === null) returnedObj = poppedObj;\n    }\n\n    this.PopCallStack(PushPopType.FunctionEvaluationFromGame);\n\n    if (returnedObj) {\n      if (returnedObj instanceof Void) return null;\n\n      // Some kind of value, if not void\n      // var returnVal = returnedObj as Runtime.Value;\n      let returnVal = asOrThrows(returnedObj, Value);\n\n      // DivertTargets get returned as the string of components\n      // (rather than a Path, which isn't public)\n      if (returnVal.valueType == ValueType.DivertTarget) {\n        return \"-> \" + returnVal.valueObject.toString();\n      }\n\n      // Other types can just have their exact object type:\n      // int, float, string. VariablePointers get returned as strings.\n      return returnVal.valueObject;\n    }\n\n    return null;\n  }\n\n  public AddError(message: string, isWarning: boolean) {\n    if (!isWarning) {\n      if (this._currentErrors == null) this._currentErrors = [];\n      this._currentErrors.push(message);\n    } else {\n      if (this._currentWarnings == null) this._currentWarnings = [];\n      this._currentWarnings.push(message);\n    }\n  }\n\n  public OutputStreamDirty() {\n    this._outputStreamTextDirty = true;\n    this._outputStreamTagsDirty = true;\n  }\n\n  private _visitCounts: Map<string, number>;\n  private _turnIndices: Map<string, number>;\n\n  private _outputStreamTextDirty = true;\n  private _outputStreamTagsDirty = true;\n\n  private _patch: StatePatch | null = null;\n\n  private _currentFlow: Flow;\n  private _aliveFlowNames: string[] | null = null;\n  private _namedFlows: Map<string, Flow> | null = null;\n  private readonly kDefaultFlowName = \"DEFAULT_FLOW\";\n  private _aliveFlowNamesDirty: boolean = true;\n}\n", "// This is simple replacement of the Stopwatch class from the .NET Framework.\n// The original class can count time with much more accuracy than the Javascript version.\n// It might be worth considering using `window.performance` in the browser\n// or `process.hrtime()` in node.\nexport class Stopwatch {\n  private startTime: number | undefined;\n\n  constructor() {\n    this.startTime = undefined;\n  }\n\n  get ElapsedMilliseconds(): number {\n    if (typeof this.startTime === \"undefined\") {\n      return 0;\n    }\n    return new Date().getTime() - this.startTime;\n  }\n\n  public Start() {\n    this.startTime = new Date().getTime();\n  }\n  public Stop() {\n    this.startTime = undefined;\n  }\n}\n", "import { Container } from \"./Container\";\nimport { InkObject } from \"./Object\";\nimport { JsonSerialisation } from \"./JsonSerialisation\";\nimport { StoryState } from \"./StoryState\";\nimport { ControlCommand } from \"./ControlCommand\";\nimport { PushPopType } from \"./PushPop\";\nimport { ChoicePoint } from \"./ChoicePoint\";\nimport { Choice } from \"./Choice\";\nimport { Divert } from \"./Divert\";\nimport {\n  Value,\n  StringValue,\n  IntValue,\n  DivertTargetValue,\n  VariablePointerValue,\n  ListValue,\n} from \"./Value\";\nimport { Path } from \"./Path\";\nimport { Void } from \"./Void\";\nimport { Tag } from \"./Tag\";\nimport { VariableAssignment } from \"./VariableAssignment\";\nimport { VariableReference } from \"./VariableReference\";\nimport { NativeFunctionCall } from \"./NativeFunctionCall\";\nimport { StoryException } from \"./StoryException\";\nimport { PRNG } from \"./PRNG\";\nimport { StringBuilder } from \"./StringBuilder\";\nimport { ListDefinitionsOrigin } from \"./ListDefinitionsOrigin\";\nimport { ListDefinition } from \"./ListDefinition\";\nimport { Stopwatch } from \"./StopWatch\";\nimport { Pointer } from \"./Pointer\";\nimport { InkList, InkListItem, KeyValuePair } from \"./InkList\";\nimport { asOrNull, asOrThrows } from \"./TypeAssertion\";\nimport { DebugMetadata } from \"./DebugMetadata\";\nimport { throwNullException } from \"./NullException\";\nimport { SimpleJson } from \"./SimpleJson\";\nimport { ErrorHandler, ErrorType } from \"./Error\";\n\nexport { InkList } from \"./InkList\";\n\nif (!Number.isInteger) {\n  Number.isInteger = function isInteger(nVal: any) {\n    return (\n      typeof nVal === \"number\" &&\n      isFinite(nVal) &&\n      nVal > -9007199254740992 &&\n      nVal < 9007199254740992 &&\n      Math.floor(nVal) === nVal\n    );\n  };\n}\n\nexport class Story extends InkObject {\n  public static inkVersionCurrent = 21;\n\n  public inkVersionMinimumCompatible = 18;\n\n  get currentChoices() {\n    let choices: Choice[] = [];\n\n    if (this._state === null) {\n      return throwNullException(\"this._state\");\n    }\n    for (let c of this._state.currentChoices) {\n      if (!c.isInvisibleDefault) {\n        c.index = choices.length;\n        choices.push(c);\n      }\n    }\n\n    return choices;\n  }\n\n  get currentText() {\n    this.IfAsyncWeCant(\"call currentText since it's a work in progress\");\n    return this.state.currentText;\n  }\n\n  get currentTags() {\n    this.IfAsyncWeCant(\"call currentTags since it's a work in progress\");\n    return this.state.currentTags;\n  }\n\n  get currentErrors() {\n    return this.state.currentErrors;\n  }\n\n  get currentWarnings() {\n    return this.state.currentWarnings;\n  }\n\n  get currentFlowName() {\n    return this.state.currentFlowName;\n  }\n\n  get currentFlowIsDefaultFlow() {\n    return this.state.currentFlowIsDefaultFlow;\n  }\n\n  get aliveFlowNames() {\n    return this.state.aliveFlowNames;\n  }\n\n  get hasError() {\n    return this.state.hasError;\n  }\n\n  get hasWarning() {\n    return this.state.hasWarning;\n  }\n\n  get variablesState() {\n    return this.state.variablesState;\n  }\n\n  get listDefinitions() {\n    return this._listDefinitions;\n  }\n\n  get state() {\n    return this._state;\n  }\n\n  public onError: ErrorHandler | null = null;\n\n  public onDidContinue: (() => void) | null = null;\n\n  public onMakeChoice: ((arg1: Choice) => void) | null = null;\n\n  public onEvaluateFunction: ((arg1: string, arg2: any[]) => void) | null =\n    null;\n\n  public onCompleteEvaluateFunction:\n    | ((arg1: string, arg2: any[], arg3: string, arg4: any) => void)\n    | null = null;\n\n  public onChoosePathString: ((arg1: string, arg2: any[]) => void) | null =\n    null;\n\n  // TODO: Implement Profiler\n  public StartProfiling() {\n    /* */\n  }\n  public EndProfiling() {\n    /* */\n  }\n\n  constructor(contentContainer: Container, lists: ListDefinition[] | null);\n  constructor(jsonString: string);\n  constructor(json: Record<string, any>);\n  constructor() {\n    super();\n\n    // Discrimination between constructors\n    let contentContainer: Container;\n    let lists: ListDefinition[] | null = null;\n    let json: Record<string, any> | null = null;\n\n    if (arguments[0] instanceof Container) {\n      contentContainer = arguments[0] as Container;\n\n      if (typeof arguments[1] !== \"undefined\") {\n        lists = arguments[1] as ListDefinition[];\n      }\n\n      // ------ Story (Container contentContainer, List<Runtime.ListDefinition> lists = null)\n      this._mainContentContainer = contentContainer;\n      // ------\n    } else {\n      if (typeof arguments[0] === \"string\") {\n        let jsonString = arguments[0] as string;\n\n        json = SimpleJson.TextToDictionary(jsonString);\n      } else {\n        json = arguments[0] as Record<string, any>;\n      }\n    }\n\n    // ------ Story (Container contentContainer, List<Runtime.ListDefinition> lists = null)\n    if (lists != null) this._listDefinitions = new ListDefinitionsOrigin(lists);\n\n    this._externals = new Map();\n    // ------\n\n    // ------ Story(string jsonString) : this((Container)null)\n    if (json !== null) {\n      let rootObject: Record<string, any> = json;\n\n      let versionObj = rootObject[\"inkVersion\"];\n      if (versionObj == null)\n        throw new Error(\n          \"ink version number not found. Are you sure it's a valid .ink.json file?\"\n        );\n\n      let formatFromFile = parseInt(versionObj);\n      if (formatFromFile > Story.inkVersionCurrent) {\n        throw new Error(\n          \"Version of ink used to build story was newer than the current version of the engine\"\n        );\n      } else if (formatFromFile < this.inkVersionMinimumCompatible) {\n        throw new Error(\n          \"Version of ink used to build story is too old to be loaded by this version of the engine\"\n        );\n      } else if (formatFromFile != Story.inkVersionCurrent) {\n        console.warn(\n          `WARNING: Version of ink ${Story.inkVersionCurrent} used to build story doesn't match current version of engine (${formatFromFile}). Non-critical, but recommend synchronising.`\n        );\n      }\n\n      let rootToken = rootObject[\"root\"];\n      if (rootToken == null)\n        throw new Error(\n          \"Root node for ink not found. Are you sure it's a valid .ink.json file?\"\n        );\n\n      let listDefsObj;\n      if ((listDefsObj = rootObject[\"listDefs\"])) {\n        this._listDefinitions =\n          JsonSerialisation.JTokenToListDefinitions(listDefsObj);\n      }\n\n      this._mainContentContainer = asOrThrows(\n        JsonSerialisation.JTokenToRuntimeObject(rootToken),\n        Container\n      );\n\n      this.ResetState();\n    }\n    // ------\n  }\n\n  // Merge together `public string ToJson()` and `void ToJson(SimpleJson.Writer writer)`.\n  // Will only return a value if writer was not provided.\n  public ToJson(writer?: SimpleJson.Writer): string | void {\n    let shouldReturn = false;\n\n    if (!writer) {\n      shouldReturn = true;\n      writer = new SimpleJson.Writer();\n    }\n\n    writer.WriteObjectStart();\n\n    writer.WriteIntProperty(\"inkVersion\", Story.inkVersionCurrent);\n\n    writer.WriteProperty(\"root\", (w) =>\n      JsonSerialisation.WriteRuntimeContainer(w, this._mainContentContainer)\n    );\n\n    if (this._listDefinitions != null) {\n      writer.WritePropertyStart(\"listDefs\");\n      writer.WriteObjectStart();\n\n      for (let def of this._listDefinitions.lists) {\n        writer.WritePropertyStart(def.name);\n        writer.WriteObjectStart();\n\n        for (let [key, value] of def.items) {\n          let item = InkListItem.fromSerializedKey(key);\n          let val = value;\n          writer.WriteIntProperty(item.itemName, val);\n        }\n\n        writer.WriteObjectEnd();\n        writer.WritePropertyEnd();\n      }\n\n      writer.WriteObjectEnd();\n      writer.WritePropertyEnd();\n    }\n\n    writer.WriteObjectEnd();\n\n    if (shouldReturn) return writer.toString();\n  }\n\n  public ResetState() {\n    this.IfAsyncWeCant(\"ResetState\");\n\n    this._state = new StoryState(this);\n    this._state.variablesState.ObserveVariableChange(\n      this.VariableStateDidChangeEvent.bind(this)\n    );\n\n    this.ResetGlobals();\n  }\n\n  public ResetErrors() {\n    if (this._state === null) {\n      return throwNullException(\"this._state\");\n    }\n    this._state.ResetErrors();\n  }\n\n  public ResetCallstack() {\n    this.IfAsyncWeCant(\"ResetCallstack\");\n    if (this._state === null) {\n      return throwNullException(\"this._state\");\n    }\n    this._state.ForceEnd();\n  }\n\n  public ResetGlobals() {\n    if (this._mainContentContainer.namedContent.get(\"global decl\")) {\n      let originalPointer = this.state.currentPointer.copy();\n\n      this.ChoosePath(new Path(\"global decl\"), false);\n\n      this.ContinueInternal();\n\n      this.state.currentPointer = originalPointer;\n    }\n\n    this.state.variablesState.SnapshotDefaultGlobals();\n  }\n\n  public SwitchFlow(flowName: string) {\n    this.IfAsyncWeCant(\"switch flow\");\n    if (this._asyncSaving) {\n      throw new Error(\n        \"Story is already in background saving mode, can't switch flow to \" +\n          flowName\n      );\n    }\n\n    this.state.SwitchFlow_Internal(flowName);\n  }\n\n  public RemoveFlow(flowName: string) {\n    this.state.RemoveFlow_Internal(flowName);\n  }\n\n  public SwitchToDefaultFlow() {\n    this.state.SwitchToDefaultFlow_Internal();\n  }\n\n  public Continue() {\n    this.ContinueAsync(0);\n    return this.currentText;\n  }\n\n  get canContinue() {\n    return this.state.canContinue;\n  }\n\n  get asyncContinueComplete() {\n    return !this._asyncContinueActive;\n  }\n\n  public ContinueAsync(millisecsLimitAsync: number) {\n    if (!this._hasValidatedExternals) this.ValidateExternalBindings();\n\n    this.ContinueInternal(millisecsLimitAsync);\n  }\n\n  public ContinueInternal(millisecsLimitAsync = 0) {\n    if (this._profiler != null) this._profiler.PreContinue();\n\n    let isAsyncTimeLimited = millisecsLimitAsync > 0;\n    this._recursiveContinueCount++;\n\n    if (!this._asyncContinueActive) {\n      this._asyncContinueActive = isAsyncTimeLimited;\n\n      if (!this.canContinue) {\n        throw new Error(\n          \"Can't continue - should check canContinue before calling Continue\"\n        );\n      }\n\n      this._state.didSafeExit = false;\n      this._state.ResetOutput();\n\n      if (this._recursiveContinueCount == 1)\n        this._state.variablesState.StartVariableObservation();\n    } else if (this._asyncContinueActive && !isAsyncTimeLimited) {\n      this._asyncContinueActive = false;\n    }\n\n    let durationStopwatch = new Stopwatch();\n    durationStopwatch.Start();\n\n    let outputStreamEndsInNewline = false;\n    this._sawLookaheadUnsafeFunctionAfterNewline = false;\n    do {\n      try {\n        outputStreamEndsInNewline = this.ContinueSingleStep();\n      } catch (e) {\n        if (!(e instanceof StoryException)) throw e;\n\n        this.AddError(e.message, undefined, e.useEndLineNumber);\n        break;\n      }\n\n      if (outputStreamEndsInNewline) break;\n\n      if (\n        this._asyncContinueActive &&\n        durationStopwatch.ElapsedMilliseconds > millisecsLimitAsync\n      ) {\n        break;\n      }\n    } while (this.canContinue);\n\n    durationStopwatch.Stop();\n\n    let changedVariablesToObserve: Map<string, any> | null = null;\n\n    if (outputStreamEndsInNewline || !this.canContinue) {\n      if (this._stateSnapshotAtLastNewline !== null) {\n        this.RestoreStateSnapshot();\n      }\n\n      if (!this.canContinue) {\n        if (this.state.callStack.canPopThread)\n          this.AddError(\n            \"Thread available to pop, threads should always be flat by the end of evaluation?\"\n          );\n\n        if (\n          this.state.generatedChoices.length == 0 &&\n          !this.state.didSafeExit &&\n          this._temporaryEvaluationContainer == null\n        ) {\n          if (this.state.callStack.CanPop(PushPopType.Tunnel))\n            this.AddError(\n              \"unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?\"\n            );\n          else if (this.state.callStack.CanPop(PushPopType.Function))\n            this.AddError(\n              \"unexpectedly reached end of content. Do you need a '~ return'?\"\n            );\n          else if (!this.state.callStack.canPop)\n            this.AddError(\n              \"ran out of content. Do you need a '-> DONE' or '-> END'?\"\n            );\n          else\n            this.AddError(\n              \"unexpectedly reached end of content for unknown reason. Please debug compiler!\"\n            );\n        }\n      }\n\n      this.state.didSafeExit = false;\n      this._sawLookaheadUnsafeFunctionAfterNewline = false;\n\n      if (this._recursiveContinueCount == 1)\n        changedVariablesToObserve =\n          this._state.variablesState.CompleteVariableObservation();\n\n      this._asyncContinueActive = false;\n      if (this.onDidContinue !== null) this.onDidContinue();\n    }\n\n    this._recursiveContinueCount--;\n\n    if (this._profiler != null) this._profiler.PostContinue();\n\n    // In the following code, we're masking a lot of non-null assertion,\n    // because testing for against `hasError` or `hasWarning` makes sure\n    // the arrays are present and contain at least one element.\n    if (this.state.hasError || this.state.hasWarning) {\n      if (this.onError !== null) {\n        if (this.state.hasError) {\n          for (let err of this.state.currentErrors!) {\n            this.onError(err, ErrorType.Error);\n          }\n        }\n        if (this.state.hasWarning) {\n          for (let err of this.state.currentWarnings!) {\n            this.onError(err, ErrorType.Warning);\n          }\n        }\n        this.ResetErrors();\n      } else {\n        let sb = new StringBuilder();\n        sb.Append(\"Ink had \");\n        if (this.state.hasError) {\n          sb.Append(`${this.state.currentErrors!.length}`);\n          sb.Append(\n            this.state.currentErrors!.length == 1 ? \" error\" : \" errors\"\n          );\n          if (this.state.hasWarning) sb.Append(\" and \");\n        }\n        if (this.state.hasWarning) {\n          sb.Append(`${this.state.currentWarnings!.length}`);\n          sb.Append(\n            this.state.currentWarnings!.length == 1 ? \" warning\" : \" warnings\"\n          );\n          if (this.state.hasWarning) sb.Append(\" and \");\n        }\n        sb.Append(\n          \". It is strongly suggested that you assign an error handler to story.onError. The first issue was: \"\n        );\n        sb.Append(\n          this.state.hasError\n            ? this.state.currentErrors![0]\n            : this.state.currentWarnings![0]\n        );\n\n        throw new StoryException(sb.toString());\n      }\n    }\n    if (\n      changedVariablesToObserve != null &&\n      Object.keys(changedVariablesToObserve).length > 0\n    ) {\n      this._state.variablesState.NotifyObservers(changedVariablesToObserve);\n    }\n  }\n\n  public ContinueSingleStep() {\n    if (this._profiler != null) this._profiler.PreStep();\n\n    this.Step();\n\n    if (this._profiler != null) this._profiler.PostStep();\n\n    if (!this.canContinue && !this.state.callStack.elementIsEvaluateFromGame) {\n      this.TryFollowDefaultInvisibleChoice();\n    }\n\n    if (this._profiler != null) this._profiler.PreSnapshot();\n\n    if (!this.state.inStringEvaluation) {\n      if (this._stateSnapshotAtLastNewline !== null) {\n        if (this._stateSnapshotAtLastNewline.currentTags === null) {\n          return throwNullException(\"this._stateAtLastNewline.currentTags\");\n        }\n        if (this.state.currentTags === null) {\n          return throwNullException(\"this.state.currentTags\");\n        }\n\n        let change = this.CalculateNewlineOutputStateChange(\n          this._stateSnapshotAtLastNewline.currentText,\n          this.state.currentText,\n          this._stateSnapshotAtLastNewline.currentTags.length,\n          this.state.currentTags.length\n        );\n\n        if (\n          change == Story.OutputStateChange.ExtendedBeyondNewline ||\n          this._sawLookaheadUnsafeFunctionAfterNewline\n        ) {\n          this.RestoreStateSnapshot();\n\n          return true;\n        } else if (change == Story.OutputStateChange.NewlineRemoved) {\n          this.DiscardSnapshot();\n        }\n      }\n\n      if (this.state.outputStreamEndsInNewline) {\n        if (this.canContinue) {\n          if (this._stateSnapshotAtLastNewline == null) this.StateSnapshot();\n        } else {\n          this.DiscardSnapshot();\n        }\n      }\n    }\n\n    if (this._profiler != null) this._profiler.PostSnapshot();\n\n    return false;\n  }\n\n  public CalculateNewlineOutputStateChange(\n    prevText: string | null,\n    currText: string | null,\n    prevTagCount: number,\n    currTagCount: number\n  ) {\n    if (prevText === null) {\n      return throwNullException(\"prevText\");\n    }\n    if (currText === null) {\n      return throwNullException(\"currText\");\n    }\n\n    let newlineStillExists =\n      currText.length >= prevText.length &&\n      prevText.length > 0 &&\n      currText.charAt(prevText.length - 1) == \"\\n\";\n    if (\n      prevTagCount == currTagCount &&\n      prevText.length == currText.length &&\n      newlineStillExists\n    )\n      return Story.OutputStateChange.NoChange;\n\n    if (!newlineStillExists) {\n      return Story.OutputStateChange.NewlineRemoved;\n    }\n\n    if (currTagCount > prevTagCount)\n      return Story.OutputStateChange.ExtendedBeyondNewline;\n\n    for (let i = prevText.length; i < currText.length; i++) {\n      let c = currText.charAt(i);\n      if (c != \" \" && c != \"\\t\") {\n        return Story.OutputStateChange.ExtendedBeyondNewline;\n      }\n    }\n\n    return Story.OutputStateChange.NoChange;\n  }\n\n  public ContinueMaximally() {\n    this.IfAsyncWeCant(\"ContinueMaximally\");\n\n    let sb = new StringBuilder();\n\n    while (this.canContinue) {\n      sb.Append(this.Continue());\n    }\n\n    return sb.toString();\n  }\n\n  public ContentAtPath(path: Path) {\n    return this.mainContentContainer.ContentAtPath(path);\n  }\n\n  public KnotContainerWithName(name: string) {\n    let namedContainer = this.mainContentContainer.namedContent.get(name);\n    if (namedContainer instanceof Container) return namedContainer;\n    else return null;\n  }\n\n  public PointerAtPath(path: Path) {\n    if (path.length == 0) return Pointer.Null;\n\n    let p = new Pointer();\n\n    let pathLengthToUse = path.length;\n\n    let result = null;\n    if (path.lastComponent === null) {\n      return throwNullException(\"path.lastComponent\");\n    }\n\n    if (path.lastComponent.isIndex) {\n      pathLengthToUse = path.length - 1;\n      result = this.mainContentContainer.ContentAtPath(\n        path,\n        undefined,\n        pathLengthToUse\n      );\n      p.container = result.container;\n      p.index = path.lastComponent.index;\n    } else {\n      result = this.mainContentContainer.ContentAtPath(path);\n      p.container = result.container;\n      p.index = -1;\n    }\n\n    if (\n      result.obj == null ||\n      (result.obj == this.mainContentContainer && pathLengthToUse > 0)\n    ) {\n      this.Error(\n        \"Failed to find content at path '\" +\n          path +\n          \"', and no approximation of it was possible.\"\n      );\n    } else if (result.approximate)\n      this.Warning(\n        \"Failed to find content at path '\" +\n          path +\n          \"', so it was approximated to: '\" +\n          result.obj.path +\n          \"'.\"\n      );\n\n    return p;\n  }\n\n  public StateSnapshot() {\n    this._stateSnapshotAtLastNewline = this._state;\n    this._state = this._state.CopyAndStartPatching(false);\n  }\n\n  public RestoreStateSnapshot() {\n    if (this._stateSnapshotAtLastNewline === null) {\n      throwNullException(\"_stateSnapshotAtLastNewline\");\n    }\n    this._stateSnapshotAtLastNewline.RestoreAfterPatch();\n\n    this._state = this._stateSnapshotAtLastNewline;\n    this._stateSnapshotAtLastNewline = null;\n\n    if (!this._asyncSaving) {\n      this._state.ApplyAnyPatch();\n    }\n  }\n\n  public DiscardSnapshot() {\n    if (!this._asyncSaving) this._state.ApplyAnyPatch();\n\n    this._stateSnapshotAtLastNewline = null;\n  }\n\n  public CopyStateForBackgroundThreadSave() {\n    this.IfAsyncWeCant(\"start saving on a background thread\");\n\n    if (this._asyncSaving)\n      throw new Error(\n        \"Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!\"\n      );\n\n    let stateToSave = this._state;\n    this._state = this._state.CopyAndStartPatching(true);\n    this._asyncSaving = true;\n    return stateToSave;\n  }\n\n  public BackgroundSaveComplete() {\n    if (this._stateSnapshotAtLastNewline === null) {\n      this._state.ApplyAnyPatch();\n    }\n\n    this._asyncSaving = false;\n  }\n\n  public Step() {\n    let shouldAddToStream = true;\n\n    let pointer = this.state.currentPointer.copy();\n    if (pointer.isNull) {\n      return;\n    }\n\n    // Container containerToEnter = pointer.Resolve () as Container;\n    let containerToEnter = asOrNull(pointer.Resolve(), Container);\n\n    while (containerToEnter) {\n      this.VisitContainer(containerToEnter, true);\n\n      // No content? the most we can do is step past it\n      if (containerToEnter.content.length == 0) {\n        break;\n      }\n\n      pointer = Pointer.StartOf(containerToEnter);\n      // containerToEnter = pointer.Resolve() as Container;\n      containerToEnter = asOrNull(pointer.Resolve(), Container);\n    }\n\n    this.state.currentPointer = pointer.copy();\n\n    if (this._profiler != null) this._profiler.Step(this.state.callStack);\n\n    // Is the current content object:\n    //  - Normal content\n    //  - Or a logic/flow statement - if so, do it\n    // Stop flow if we hit a stack pop when we're unable to pop (e.g. return/done statement in knot\n    // that was diverted to rather than called as a function)\n    let currentContentObj = pointer.Resolve();\n    let isLogicOrFlowControl =\n      this.PerformLogicAndFlowControl(currentContentObj);\n\n    // Has flow been forced to end by flow control above?\n    if (this.state.currentPointer.isNull) {\n      return;\n    }\n\n    if (isLogicOrFlowControl) {\n      shouldAddToStream = false;\n    }\n\n    // Choice with condition?\n    // var choicePoint = currentContentObj as ChoicePoint;\n    let choicePoint = asOrNull(currentContentObj, ChoicePoint);\n    if (choicePoint) {\n      let choice = this.ProcessChoice(choicePoint);\n      if (choice) {\n        this.state.generatedChoices.push(choice);\n      }\n\n      currentContentObj = null;\n      shouldAddToStream = false;\n    }\n\n    // If the container has no content, then it will be\n    // the \"content\" itself, but we skip over it.\n    if (currentContentObj instanceof Container) {\n      shouldAddToStream = false;\n    }\n\n    // Content to add to evaluation stack or the output stream\n    if (shouldAddToStream) {\n      // If we're pushing a variable pointer onto the evaluation stack, ensure that it's specific\n      // to our current (possibly temporary) context index. And make a copy of the pointer\n      // so that we're not editing the original runtime object.\n      // var varPointer = currentContentObj as VariablePointerValue;\n      let varPointer = asOrNull(currentContentObj, VariablePointerValue);\n      if (varPointer && varPointer.contextIndex == -1) {\n        // Create new object so we're not overwriting the story's own data\n        let contextIdx = this.state.callStack.ContextForVariableNamed(\n          varPointer.variableName\n        );\n        currentContentObj = new VariablePointerValue(\n          varPointer.variableName,\n          contextIdx\n        );\n      }\n\n      // Expression evaluation content\n      if (this.state.inExpressionEvaluation) {\n        this.state.PushEvaluationStack(currentContentObj);\n      }\n      // Output stream content (i.e. not expression evaluation)\n      else {\n        this.state.PushToOutputStream(currentContentObj);\n      }\n    }\n\n    // Increment the content pointer, following diverts if necessary\n    this.NextContent();\n\n    // Starting a thread should be done after the increment to the content pointer,\n    // so that when returning from the thread, it returns to the content after this instruction.\n    // var controlCmd = currentContentObj as ;\n    let controlCmd = asOrNull(currentContentObj, ControlCommand);\n    if (\n      controlCmd &&\n      controlCmd.commandType == ControlCommand.CommandType.StartThread\n    ) {\n      this.state.callStack.PushThread();\n    }\n  }\n\n  public VisitContainer(container: Container, atStart: boolean) {\n    if (!container.countingAtStartOnly || atStart) {\n      if (container.visitsShouldBeCounted)\n        this.state.IncrementVisitCountForContainer(container);\n\n      if (container.turnIndexShouldBeCounted)\n        this.state.RecordTurnIndexVisitToContainer(container);\n    }\n  }\n\n  private _prevContainers: Container[] = [];\n  public VisitChangedContainersDueToDivert() {\n    let previousPointer = this.state.previousPointer.copy();\n    let pointer = this.state.currentPointer.copy();\n\n    if (pointer.isNull || pointer.index == -1) return;\n\n    this._prevContainers.length = 0;\n    if (!previousPointer.isNull) {\n      // Container prevAncestor = previousPointer.Resolve() as Container ?? previousPointer.container as Container;\n      let resolvedPreviousAncestor = previousPointer.Resolve();\n      let prevAncestor =\n        asOrNull(resolvedPreviousAncestor, Container) ||\n        asOrNull(previousPointer.container, Container);\n      while (prevAncestor) {\n        this._prevContainers.push(prevAncestor);\n        // prevAncestor = prevAncestor.parent as Container;\n        prevAncestor = asOrNull(prevAncestor.parent, Container);\n      }\n    }\n\n    let currentChildOfContainer = pointer.Resolve();\n\n    if (currentChildOfContainer == null) return;\n\n    // Container currentContainerAncestor = currentChildOfContainer.parent as Container;\n    let currentContainerAncestor = asOrNull(\n      currentChildOfContainer.parent,\n      Container\n    );\n    let allChildrenEnteredAtStart = true;\n    while (\n      currentContainerAncestor &&\n      (this._prevContainers.indexOf(currentContainerAncestor) < 0 ||\n        currentContainerAncestor.countingAtStartOnly)\n    ) {\n      // Check whether this ancestor container is being entered at the start,\n      // by checking whether the child object is the first.\n      let enteringAtStart =\n        currentContainerAncestor.content.length > 0 &&\n        currentChildOfContainer == currentContainerAncestor.content[0] &&\n        allChildrenEnteredAtStart;\n\n      if (!enteringAtStart) allChildrenEnteredAtStart = false;\n\n      // Mark a visit to this container\n      this.VisitContainer(currentContainerAncestor, enteringAtStart);\n\n      currentChildOfContainer = currentContainerAncestor;\n      // currentContainerAncestor = currentContainerAncestor.parent as Container;\n      currentContainerAncestor = asOrNull(\n        currentContainerAncestor.parent,\n        Container\n      );\n    }\n  }\n\n  public PopChoiceStringAndTags(tags: string[]) {\n    let choiceOnlyStrVal = asOrThrows(\n      this.state.PopEvaluationStack(),\n      StringValue\n    );\n\n    while (\n      this.state.evaluationStack.length > 0 &&\n      asOrNull(this.state.PeekEvaluationStack(), Tag) != null\n    ) {\n      let tag = asOrNull(this.state.PopEvaluationStack(), Tag);\n      if (tag) tags.push(tag.text);\n    }\n    return choiceOnlyStrVal.value;\n  }\n\n  public ProcessChoice(choicePoint: ChoicePoint) {\n    let showChoice = true;\n\n    // Don't create choice if choice point doesn't pass conditional\n    if (choicePoint.hasCondition) {\n      let conditionValue = this.state.PopEvaluationStack();\n      if (!this.IsTruthy(conditionValue)) {\n        showChoice = false;\n      }\n    }\n\n    let startText = \"\";\n    let choiceOnlyText = \"\";\n    let tags: string[] = [];\n\n    if (choicePoint.hasChoiceOnlyContent) {\n      choiceOnlyText = this.PopChoiceStringAndTags(tags) || \"\";\n    }\n\n    if (choicePoint.hasStartContent) {\n      startText = this.PopChoiceStringAndTags(tags) || \"\";\n    }\n\n    // Don't create choice if player has already read this content\n    if (choicePoint.onceOnly) {\n      let visitCount = this.state.VisitCountForContainer(\n        choicePoint.choiceTarget\n      );\n      if (visitCount > 0) {\n        showChoice = false;\n      }\n    }\n\n    // We go through the full process of creating the choice above so\n    // that we consume the content for it, since otherwise it'll\n    // be shown on the output stream.\n    if (!showChoice) {\n      return null;\n    }\n\n    let choice = new Choice();\n    choice.targetPath = choicePoint.pathOnChoice;\n    choice.sourcePath = choicePoint.path.toString();\n    choice.isInvisibleDefault = choicePoint.isInvisibleDefault;\n    choice.threadAtGeneration = this.state.callStack.ForkThread();\n    choice.tags = tags.reverse(); //C# is a stack\n    choice.text = (startText + choiceOnlyText).replace(/^[ \\t]+|[ \\t]+$/g, \"\");\n\n    return choice;\n  }\n\n  public IsTruthy(obj: InkObject) {\n    let truthy = false;\n    if (obj instanceof Value) {\n      let val = obj;\n\n      if (val instanceof DivertTargetValue) {\n        let divTarget = val;\n        this.Error(\n          \"Shouldn't use a divert target (to \" +\n            divTarget.targetPath +\n            \") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)\"\n        );\n        return false;\n      }\n\n      return val.isTruthy;\n    }\n    return truthy;\n  }\n\n  public PerformLogicAndFlowControl(contentObj: InkObject | null) {\n    if (contentObj == null) {\n      return false;\n    }\n\n    // Divert\n    if (contentObj instanceof Divert) {\n      let currentDivert = contentObj;\n\n      if (currentDivert.isConditional) {\n        let conditionValue = this.state.PopEvaluationStack();\n\n        // False conditional? Cancel divert\n        if (!this.IsTruthy(conditionValue)) return true;\n      }\n\n      if (currentDivert.hasVariableTarget) {\n        let varName = currentDivert.variableDivertName;\n\n        let varContents =\n          this.state.variablesState.GetVariableWithName(varName);\n\n        if (varContents == null) {\n          this.Error(\n            \"Tried to divert using a target from a variable that could not be found (\" +\n              varName +\n              \")\"\n          );\n        } else if (!(varContents instanceof DivertTargetValue)) {\n          // var intContent = varContents as IntValue;\n          let intContent = asOrNull(varContents, IntValue);\n\n          let errorMessage =\n            \"Tried to divert to a target from a variable, but the variable (\" +\n            varName +\n            \") didn't contain a divert target, it \";\n          if (intContent instanceof IntValue && intContent.value == 0) {\n            errorMessage += \"was empty/null (the value 0).\";\n          } else {\n            errorMessage += \"contained '\" + varContents + \"'.\";\n          }\n\n          this.Error(errorMessage);\n        }\n\n        let target = asOrThrows(varContents, DivertTargetValue);\n        this.state.divertedPointer = this.PointerAtPath(target.targetPath);\n      } else if (currentDivert.isExternal) {\n        this.CallExternalFunction(\n          currentDivert.targetPathString,\n          currentDivert.externalArgs\n        );\n        return true;\n      } else {\n        this.state.divertedPointer = currentDivert.targetPointer.copy();\n      }\n\n      if (currentDivert.pushesToStack) {\n        this.state.callStack.Push(\n          currentDivert.stackPushType,\n          undefined,\n          this.state.outputStream.length\n        );\n      }\n\n      if (this.state.divertedPointer.isNull && !currentDivert.isExternal) {\n        if (\n          currentDivert &&\n          currentDivert.debugMetadata &&\n          currentDivert.debugMetadata.sourceName != null\n        ) {\n          this.Error(\n            \"Divert target doesn't exist: \" +\n              currentDivert.debugMetadata.sourceName\n          );\n        } else {\n          this.Error(\"Divert resolution failed: \" + currentDivert);\n        }\n      }\n\n      return true;\n    }\n\n    // Start/end an expression evaluation? Or print out the result?\n    else if (contentObj instanceof ControlCommand) {\n      let evalCommand = contentObj;\n\n      switch (evalCommand.commandType) {\n        case ControlCommand.CommandType.EvalStart:\n          this.Assert(\n            this.state.inExpressionEvaluation === false,\n            \"Already in expression evaluation?\"\n          );\n          this.state.inExpressionEvaluation = true;\n          break;\n\n        case ControlCommand.CommandType.EvalEnd:\n          this.Assert(\n            this.state.inExpressionEvaluation === true,\n            \"Not in expression evaluation mode\"\n          );\n          this.state.inExpressionEvaluation = false;\n          break;\n\n        case ControlCommand.CommandType.EvalOutput:\n          // If the expression turned out to be empty, there may not be anything on the stack\n          if (this.state.evaluationStack.length > 0) {\n            let output = this.state.PopEvaluationStack();\n\n            // Functions may evaluate to Void, in which case we skip output\n            if (!(output instanceof Void)) {\n              // TODO: Should we really always blanket convert to string?\n              // It would be okay to have numbers in the output stream the\n              // only problem is when exporting text for viewing, it skips over numbers etc.\n              let text = new StringValue(output.toString());\n\n              this.state.PushToOutputStream(text);\n            }\n          }\n          break;\n\n        case ControlCommand.CommandType.NoOp:\n          break;\n\n        case ControlCommand.CommandType.Duplicate:\n          this.state.PushEvaluationStack(this.state.PeekEvaluationStack());\n          break;\n\n        case ControlCommand.CommandType.PopEvaluatedValue:\n          this.state.PopEvaluationStack();\n          break;\n\n        case ControlCommand.CommandType.PopFunction:\n        case ControlCommand.CommandType.PopTunnel:\n          let popType =\n            evalCommand.commandType == ControlCommand.CommandType.PopFunction\n              ? PushPopType.Function\n              : PushPopType.Tunnel;\n\n          let overrideTunnelReturnTarget: DivertTargetValue | null = null;\n          if (popType == PushPopType.Tunnel) {\n            let popped = this.state.PopEvaluationStack();\n            // overrideTunnelReturnTarget = popped as DivertTargetValue;\n            overrideTunnelReturnTarget = asOrNull(popped, DivertTargetValue);\n            if (overrideTunnelReturnTarget === null) {\n              this.Assert(\n                popped instanceof Void,\n                \"Expected void if ->-> doesn't override target\"\n              );\n            }\n          }\n\n          if (this.state.TryExitFunctionEvaluationFromGame()) {\n            break;\n          } else if (\n            this.state.callStack.currentElement.type != popType ||\n            !this.state.callStack.canPop\n          ) {\n            let names: Map<PushPopType, string> = new Map();\n            names.set(\n              PushPopType.Function,\n              \"function return statement (~ return)\"\n            );\n            names.set(PushPopType.Tunnel, \"tunnel onwards statement (->->)\");\n\n            let expected = names.get(this.state.callStack.currentElement.type);\n            if (!this.state.callStack.canPop) {\n              expected = \"end of flow (-> END or choice)\";\n            }\n\n            let errorMsg =\n              \"Found \" + names.get(popType) + \", when expected \" + expected;\n\n            this.Error(errorMsg);\n          } else {\n            this.state.PopCallStack();\n\n            if (overrideTunnelReturnTarget)\n              this.state.divertedPointer = this.PointerAtPath(\n                overrideTunnelReturnTarget.targetPath\n              );\n          }\n          break;\n\n        case ControlCommand.CommandType.BeginString:\n          this.state.PushToOutputStream(evalCommand);\n\n          this.Assert(\n            this.state.inExpressionEvaluation === true,\n            \"Expected to be in an expression when evaluating a string\"\n          );\n          this.state.inExpressionEvaluation = false;\n          break;\n\n        // Leave it to story.currentText and story.currentTags to sort out the text from the tags\n        // This is mostly because we can't always rely on the existence of EndTag, and we don't want\n        // to try and flatten dynamic tags to strings every time \\n is pushed to output\n        case ControlCommand.CommandType.BeginTag:\n          this.state.PushToOutputStream(evalCommand);\n          break;\n\n        // EndTag has 2 modes:\n        //  - When in string evaluation (for choices)\n        //  - Normal\n        //\n        // The only way you could have an EndTag in the middle of\n        // string evaluation is if we're currently generating text for a\n        // choice, such as:\n        //\n        //   + choice # tag\n        //\n        // In the above case, the ink will be run twice:\n        //  - First, to generate the choice text. String evaluation\n        //    will be on, and the final string will be pushed to the\n        //    evaluation stack, ready to be popped to make a Choice\n        //    object.\n        //  - Second, when ink generates text after choosing the choice.\n        //    On this ocassion, it's not in string evaluation mode.\n        //\n        // On the writing side, we disallow manually putting tags within\n        // strings like this:\n        //\n        //   {\"hello # world\"}\n        //\n        // So we know that the tag must be being generated as part of\n        // choice content. Therefore, when the tag has been generated,\n        // we push it onto the evaluation stack in the exact same way\n        // as the string for the choice content.\n        case ControlCommand.CommandType.EndTag: {\n          if (this.state.inStringEvaluation) {\n            let contentStackForTag: InkObject[] = [];\n            let outputCountConsumed = 0;\n            for (let i = this.state.outputStream.length - 1; i >= 0; --i) {\n              let obj = this.state.outputStream[i];\n              outputCountConsumed++;\n\n              // var command = obj as ControlCommand;\n              let command = asOrNull(obj, ControlCommand);\n              if (command != null) {\n                if (\n                  command.commandType == ControlCommand.CommandType.BeginTag\n                ) {\n                  break;\n                } else {\n                  this.Error(\n                    \"Unexpected ControlCommand while extracting tag from choice\"\n                  );\n                  break;\n                }\n              }\n              if (obj instanceof StringValue) {\n                contentStackForTag.push(obj);\n              }\n            }\n\n            // Consume the content that was produced for this string\n            this.state.PopFromOutputStream(outputCountConsumed);\n            // Build string out of the content we collected\n            let sb = new StringBuilder();\n            for (let strVal of contentStackForTag.reverse()) {\n              sb.Append(strVal.toString());\n            }\n            let choiceTag = new Tag(\n              this.state.CleanOutputWhitespace(sb.toString())\n            );\n            // Pushing to the evaluation stack means it gets picked up\n            // when a Choice is generated from the next Choice Point.\n            this.state.PushEvaluationStack(choiceTag);\n          } else {\n            // Otherwise! Simply push EndTag, so that in the output stream we\n            // have a structure of: [BeginTag, \"the tag content\", EndTag]\n            this.state.PushToOutputStream(evalCommand);\n          }\n          break;\n        }\n\n        case ControlCommand.CommandType.EndString: {\n          let contentStackForString: InkObject[] = [];\n          let contentToRetain: InkObject[] = [];\n\n          let outputCountConsumed = 0;\n          for (let i = this.state.outputStream.length - 1; i >= 0; --i) {\n            let obj = this.state.outputStream[i];\n\n            outputCountConsumed++;\n\n            // var command = obj as ControlCommand;\n            let command = asOrNull(obj, ControlCommand);\n            if (\n              command &&\n              command.commandType == ControlCommand.CommandType.BeginString\n            ) {\n              break;\n            }\n            if (obj instanceof Tag) {\n              contentToRetain.push(obj);\n            }\n            if (obj instanceof StringValue) {\n              contentStackForString.push(obj);\n            }\n          }\n\n          // Consume the content that was produced for this string\n          this.state.PopFromOutputStream(outputCountConsumed);\n\n          // Rescue the tags that we want actually to keep on the output stack\n          // rather than consume as part of the string we're building.\n          // At the time of writing, this only applies to Tag objects generated\n          // by choices, which are pushed to the stack during string generation.\n          for (let rescuedTag of contentToRetain)\n            this.state.PushToOutputStream(rescuedTag);\n\n          // The C# version uses a Stack for contentStackForString, but we're\n          // using a simple array, so we need to reverse it before using it\n          contentStackForString = contentStackForString.reverse();\n\n          // Build string out of the content we collected\n          let sb = new StringBuilder();\n          for (let c of contentStackForString) {\n            sb.Append(c.toString());\n          }\n\n          // Return to expression evaluation (from content mode)\n          this.state.inExpressionEvaluation = true;\n          this.state.PushEvaluationStack(new StringValue(sb.toString()));\n          break;\n        }\n\n        case ControlCommand.CommandType.ChoiceCount:\n          let choiceCount = this.state.generatedChoices.length;\n          this.state.PushEvaluationStack(new IntValue(choiceCount));\n          break;\n\n        case ControlCommand.CommandType.Turns:\n          this.state.PushEvaluationStack(\n            new IntValue(this.state.currentTurnIndex + 1)\n          );\n          break;\n\n        case ControlCommand.CommandType.TurnsSince:\n        case ControlCommand.CommandType.ReadCount:\n          let target = this.state.PopEvaluationStack();\n          if (!(target instanceof DivertTargetValue)) {\n            let extraNote = \"\";\n            if (target instanceof IntValue)\n              extraNote =\n                \". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?\";\n            this.Error(\n              \"TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw \" +\n                target +\n                extraNote\n            );\n            break;\n          }\n\n          // var divertTarget = target as DivertTargetValue;\n          let divertTarget = asOrThrows(target, DivertTargetValue);\n          // var container = ContentAtPath (divertTarget.targetPath).correctObj as Container;\n          let container = asOrNull(\n            this.ContentAtPath(divertTarget.targetPath).correctObj,\n            Container\n          );\n\n          let eitherCount;\n          if (container != null) {\n            if (\n              evalCommand.commandType == ControlCommand.CommandType.TurnsSince\n            )\n              eitherCount = this.state.TurnsSinceForContainer(container);\n            else eitherCount = this.state.VisitCountForContainer(container);\n          } else {\n            if (\n              evalCommand.commandType == ControlCommand.CommandType.TurnsSince\n            )\n              eitherCount = -1;\n            else eitherCount = 0;\n\n            this.Warning(\n              \"Failed to find container for \" +\n                evalCommand.toString() +\n                \" lookup at \" +\n                divertTarget.targetPath.toString()\n            );\n          }\n\n          this.state.PushEvaluationStack(new IntValue(eitherCount));\n          break;\n\n        case ControlCommand.CommandType.Random: {\n          let maxInt = asOrNull(this.state.PopEvaluationStack(), IntValue);\n          let minInt = asOrNull(this.state.PopEvaluationStack(), IntValue);\n\n          if (minInt == null || minInt instanceof IntValue === false)\n            return this.Error(\n              \"Invalid value for minimum parameter of RANDOM(min, max)\"\n            );\n\n          if (maxInt == null || maxInt instanceof IntValue === false)\n            return this.Error(\n              \"Invalid value for maximum parameter of RANDOM(min, max)\"\n            );\n\n          // Originally a primitive type, but here, can be null.\n          // TODO: Replace by default value?\n          if (maxInt.value === null) {\n            return throwNullException(\"maxInt.value\");\n          }\n          if (minInt.value === null) {\n            return throwNullException(\"minInt.value\");\n          }\n\n          // This code is differs a bit from the reference implementation, since\n          // JavaScript has no true integers. Hence integer arithmetics and\n          // interger overflows don't apply here. A loss of precision can\n          // happen with big numbers however.\n          //\n          // The case where 'randomRange' is lower than zero is handled below,\n          // so there's no need to test against Number.MIN_SAFE_INTEGER.\n          let randomRange = maxInt.value - minInt.value + 1;\n          if (!isFinite(randomRange) || randomRange > Number.MAX_SAFE_INTEGER) {\n            randomRange = Number.MAX_SAFE_INTEGER;\n            this.Error(\n              \"RANDOM was called with a range that exceeds the size that ink numbers can use.\"\n            );\n          }\n          if (randomRange <= 0)\n            this.Error(\n              \"RANDOM was called with minimum as \" +\n                minInt.value +\n                \" and maximum as \" +\n                maxInt.value +\n                \". The maximum must be larger\"\n            );\n\n          let resultSeed = this.state.storySeed + this.state.previousRandom;\n          let random = new PRNG(resultSeed);\n\n          let nextRandom = random.next();\n          let chosenValue = (nextRandom % randomRange) + minInt.value;\n          this.state.PushEvaluationStack(new IntValue(chosenValue));\n\n          // Next random number (rather than keeping the Random object around)\n          this.state.previousRandom = nextRandom;\n          break;\n        }\n\n        case ControlCommand.CommandType.SeedRandom:\n          let seed = asOrNull(this.state.PopEvaluationStack(), IntValue);\n          if (seed == null || seed instanceof IntValue === false)\n            return this.Error(\"Invalid value passed to SEED_RANDOM\");\n\n          // Originally a primitive type, but here, can be null.\n          // TODO: Replace by default value?\n          if (seed.value === null) {\n            return throwNullException(\"minInt.value\");\n          }\n\n          this.state.storySeed = seed.value;\n          this.state.previousRandom = 0;\n\n          this.state.PushEvaluationStack(new Void());\n          break;\n\n        case ControlCommand.CommandType.VisitIndex:\n          let count =\n            this.state.VisitCountForContainer(\n              this.state.currentPointer.container\n            ) - 1; // index not count\n          this.state.PushEvaluationStack(new IntValue(count));\n          break;\n\n        case ControlCommand.CommandType.SequenceShuffleIndex:\n          let shuffleIndex = this.NextSequenceShuffleIndex();\n          this.state.PushEvaluationStack(new IntValue(shuffleIndex));\n          break;\n\n        case ControlCommand.CommandType.StartThread:\n          // Handled in main step function\n          break;\n\n        case ControlCommand.CommandType.Done:\n          // We may exist in the context of the initial\n          // act of creating the thread, or in the context of\n          // evaluating the content.\n          if (this.state.callStack.canPopThread) {\n            this.state.callStack.PopThread();\n          }\n\n          // In normal flow - allow safe exit without warning\n          else {\n            this.state.didSafeExit = true;\n\n            // Stop flow in current thread\n            this.state.currentPointer = Pointer.Null;\n          }\n\n          break;\n\n        // Force flow to end completely\n        case ControlCommand.CommandType.End:\n          this.state.ForceEnd();\n          break;\n\n        case ControlCommand.CommandType.ListFromInt:\n          // var intVal = state.PopEvaluationStack () as IntValue;\n          let intVal = asOrNull(this.state.PopEvaluationStack(), IntValue);\n          // var listNameVal = state.PopEvaluationStack () as StringValue;\n          let listNameVal = asOrThrows(\n            this.state.PopEvaluationStack(),\n            StringValue\n          );\n\n          if (intVal === null) {\n            throw new StoryException(\n              \"Passed non-integer when creating a list element from a numerical value.\"\n            );\n          }\n\n          let generatedListValue = null;\n\n          if (this.listDefinitions === null) {\n            return throwNullException(\"this.listDefinitions\");\n          }\n          let foundListDef = this.listDefinitions.TryListGetDefinition(\n            listNameVal.value,\n            null\n          );\n          if (foundListDef.exists) {\n            // Originally a primitive type, but here, can be null.\n            // TODO: Replace by default value?\n            if (intVal.value === null) {\n              return throwNullException(\"minInt.value\");\n            }\n\n            let foundItem = foundListDef.result!.TryGetItemWithValue(\n              intVal.value,\n              InkListItem.Null\n            );\n            if (foundItem.exists) {\n              generatedListValue = new ListValue(\n                foundItem.result!,\n                intVal.value\n              );\n            }\n          } else {\n            throw new StoryException(\n              \"Failed to find LIST called \" + listNameVal.value\n            );\n          }\n\n          if (generatedListValue == null) generatedListValue = new ListValue();\n\n          this.state.PushEvaluationStack(generatedListValue);\n          break;\n\n        case ControlCommand.CommandType.ListRange:\n          let max = asOrNull(this.state.PopEvaluationStack(), Value);\n          let min = asOrNull(this.state.PopEvaluationStack(), Value);\n\n          // var targetList = state.PopEvaluationStack () as ListValue;\n          let targetList = asOrNull(this.state.PopEvaluationStack(), ListValue);\n\n          if (targetList === null || min === null || max === null)\n            throw new StoryException(\n              \"Expected list, minimum and maximum for LIST_RANGE\"\n            );\n\n          if (targetList.value === null) {\n            return throwNullException(\"targetList.value\");\n          }\n          let result = targetList.value.ListWithSubRange(\n            min.valueObject,\n            max.valueObject\n          );\n\n          this.state.PushEvaluationStack(new ListValue(result));\n          break;\n\n        case ControlCommand.CommandType.ListRandom: {\n          let listVal = this.state.PopEvaluationStack() as ListValue;\n          if (listVal === null)\n            throw new StoryException(\"Expected list for LIST_RANDOM\");\n\n          let list = listVal.value;\n\n          let newList: InkList | null = null;\n\n          if (list === null) {\n            throw throwNullException(\"list\");\n          }\n          if (list.Count == 0) {\n            newList = new InkList();\n          } else {\n            // Generate a random index for the element to take\n            let resultSeed = this.state.storySeed + this.state.previousRandom;\n            let random = new PRNG(resultSeed);\n\n            let nextRandom = random.next();\n            let listItemIndex = nextRandom % list.Count;\n\n            // This bit is a little different from the original\n            // C# code, since iterators do not work in the same way.\n            // First, we iterate listItemIndex - 1 times, calling next().\n            // The listItemIndex-th time is made outside of the loop,\n            // in order to retrieve the value.\n            let listEnumerator = list.entries();\n            for (let i = 0; i <= listItemIndex - 1; i++) {\n              listEnumerator.next();\n            }\n            let value = listEnumerator.next().value;\n            let randomItem: KeyValuePair<InkListItem, number> = {\n              Key: InkListItem.fromSerializedKey(value[0]),\n              Value: value[1],\n            };\n\n            // Origin list is simply the origin of the one element\n            if (randomItem.Key.originName === null) {\n              return throwNullException(\"randomItem.Key.originName\");\n            }\n            newList = new InkList(randomItem.Key.originName, this);\n            newList.Add(randomItem.Key, randomItem.Value);\n\n            this.state.previousRandom = nextRandom;\n          }\n\n          this.state.PushEvaluationStack(new ListValue(newList));\n          break;\n        }\n\n        default:\n          this.Error(\"unhandled ControlCommand: \" + evalCommand);\n          break;\n      }\n\n      return true;\n    }\n\n    // Variable assignment\n    else if (contentObj instanceof VariableAssignment) {\n      let varAss = contentObj;\n      let assignedVal = this.state.PopEvaluationStack();\n\n      this.state.variablesState.Assign(varAss, assignedVal);\n\n      return true;\n    }\n\n    // Variable reference\n    else if (contentObj instanceof VariableReference) {\n      let varRef = contentObj;\n      let foundValue = null;\n\n      // Explicit read count value\n      if (varRef.pathForCount != null) {\n        let container = varRef.containerForCount;\n        let count = this.state.VisitCountForContainer(container);\n        foundValue = new IntValue(count);\n      }\n\n      // Normal variable reference\n      else {\n        foundValue = this.state.variablesState.GetVariableWithName(varRef.name);\n\n        if (foundValue == null) {\n          this.Warning(\n            \"Variable not found: '\" +\n              varRef.name +\n              \"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state.\"\n          );\n          foundValue = new IntValue(0);\n        }\n      }\n\n      this.state.PushEvaluationStack(foundValue);\n\n      return true;\n    }\n\n    // Native function call\n    else if (contentObj instanceof NativeFunctionCall) {\n      let func = contentObj;\n      let funcParams = this.state.PopEvaluationStack(func.numberOfParameters);\n      let result = func.Call(funcParams);\n      this.state.PushEvaluationStack(result);\n      return true;\n    }\n\n    // No control content, must be ordinary content\n    return false;\n  }\n\n  public ChoosePathString(\n    path: string,\n    resetCallstack = true,\n    args: any[] = []\n  ) {\n    this.IfAsyncWeCant(\"call ChoosePathString right now\");\n    if (this.onChoosePathString !== null) this.onChoosePathString(path, args);\n\n    if (resetCallstack) {\n      this.ResetCallstack();\n    } else {\n      if (this.state.callStack.currentElement.type == PushPopType.Function) {\n        let funcDetail = \"\";\n        let container =\n          this.state.callStack.currentElement.currentPointer.container;\n        if (container != null) {\n          funcDetail = \"(\" + container.path.toString() + \") \";\n        }\n        throw new Error(\n          \"Story was running a function \" +\n            funcDetail +\n            \"when you called ChoosePathString(\" +\n            path +\n            \") - this is almost certainly not not what you want! Full stack trace: \\n\" +\n            this.state.callStack.callStackTrace\n        );\n      }\n    }\n\n    this.state.PassArgumentsToEvaluationStack(args);\n    this.ChoosePath(new Path(path));\n  }\n\n  public IfAsyncWeCant(activityStr: string) {\n    if (this._asyncContinueActive)\n      throw new Error(\n        \"Can't \" +\n          activityStr +\n          \". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.\"\n      );\n  }\n\n  public ChoosePath(p: Path, incrementingTurnIndex: boolean = true) {\n    this.state.SetChosenPath(p, incrementingTurnIndex);\n\n    // Take a note of newly visited containers for read counts etc\n    this.VisitChangedContainersDueToDivert();\n  }\n\n  public ChooseChoiceIndex(choiceIdx: number) {\n    choiceIdx = choiceIdx;\n    let choices = this.currentChoices;\n    this.Assert(\n      choiceIdx >= 0 && choiceIdx < choices.length,\n      \"choice out of range\"\n    );\n\n    let choiceToChoose = choices[choiceIdx];\n    if (this.onMakeChoice !== null) this.onMakeChoice(choiceToChoose);\n\n    if (choiceToChoose.threadAtGeneration === null) {\n      return throwNullException(\"choiceToChoose.threadAtGeneration\");\n    }\n    if (choiceToChoose.targetPath === null) {\n      return throwNullException(\"choiceToChoose.targetPath\");\n    }\n\n    this.state.callStack.currentThread = choiceToChoose.threadAtGeneration;\n\n    this.ChoosePath(choiceToChoose.targetPath);\n  }\n\n  public HasFunction(functionName: string) {\n    try {\n      return this.KnotContainerWithName(functionName) != null;\n    } catch (e) {\n      return false;\n    }\n  }\n\n  public EvaluateFunction(\n    functionName: string,\n    args: any[] = [],\n    returnTextOutput: boolean = false\n  ): Story.EvaluateFunctionTextOutput | any {\n    // EvaluateFunction behaves slightly differently than the C# version.\n    // In C#, you can pass a (second) parameter `out textOutput` to get the\n    // text outputted by the function. This is not possible in js. Instead,\n    // we maintain the regular signature (functionName, args), plus an\n    // optional third parameter returnTextOutput. If set to true, we will\n    // return both the textOutput and the returned value, as an object.\n\n    if (this.onEvaluateFunction !== null)\n      this.onEvaluateFunction(functionName, args);\n\n    this.IfAsyncWeCant(\"evaluate a function\");\n\n    if (functionName == null) {\n      throw new Error(\"Function is null\");\n    } else if (functionName == \"\" || functionName.trim() == \"\") {\n      throw new Error(\"Function is empty or white space.\");\n    }\n\n    let funcContainer = this.KnotContainerWithName(functionName);\n    if (funcContainer == null) {\n      throw new Error(\"Function doesn't exist: '\" + functionName + \"'\");\n    }\n\n    let outputStreamBefore: InkObject[] = [];\n    outputStreamBefore.push(...this.state.outputStream);\n    this._state.ResetOutput();\n\n    this.state.StartFunctionEvaluationFromGame(funcContainer, args);\n\n    // Evaluate the function, and collect the string output\n    let stringOutput = new StringBuilder();\n    while (this.canContinue) {\n      stringOutput.Append(this.Continue());\n    }\n    let textOutput = stringOutput.toString();\n\n    this._state.ResetOutput(outputStreamBefore);\n\n    let result = this.state.CompleteFunctionEvaluationFromGame();\n    if (this.onCompleteEvaluateFunction != null)\n      this.onCompleteEvaluateFunction(functionName, args, textOutput, result);\n\n    return returnTextOutput ? { returned: result, output: textOutput } : result;\n  }\n\n  public EvaluateExpression(exprContainer: Container) {\n    let startCallStackHeight = this.state.callStack.elements.length;\n\n    this.state.callStack.Push(PushPopType.Tunnel);\n\n    this._temporaryEvaluationContainer = exprContainer;\n\n    this.state.GoToStart();\n\n    let evalStackHeight = this.state.evaluationStack.length;\n\n    this.Continue();\n\n    this._temporaryEvaluationContainer = null;\n\n    // Should have fallen off the end of the Container, which should\n    // have auto-popped, but just in case we didn't for some reason,\n    // manually pop to restore the state (including currentPath).\n    if (this.state.callStack.elements.length > startCallStackHeight) {\n      this.state.PopCallStack();\n    }\n\n    let endStackHeight = this.state.evaluationStack.length;\n    if (endStackHeight > evalStackHeight) {\n      return this.state.PopEvaluationStack();\n    } else {\n      return null;\n    }\n  }\n\n  public allowExternalFunctionFallbacks: boolean = false;\n\n  public CallExternalFunction(\n    funcName: string | null,\n    numberOfArguments: number\n  ) {\n    if (funcName === null) {\n      return throwNullException(\"funcName\");\n    }\n    let funcDef = this._externals.get(funcName);\n    let fallbackFunctionContainer = null;\n\n    let foundExternal = typeof funcDef !== \"undefined\";\n\n    if (\n      foundExternal &&\n      !funcDef!.lookAheadSafe &&\n      this._state.inStringEvaluation\n    ) {\n      this.Error(\n        \"External function \" +\n          funcName +\n          ' could not be called because 1) it wasn\\'t marked as lookaheadSafe when BindExternalFunction was called and 2) the story is in the middle of string generation, either because choice text is being generated, or because you have ink like \"hello {func()}\". You can work around this by generating the result of your function into a temporary variable before the string or choice gets generated: ~ temp x = ' +\n          funcName +\n          \"()\"\n      );\n    }\n\n    if (\n      foundExternal &&\n      !funcDef!.lookAheadSafe &&\n      this._stateSnapshotAtLastNewline !== null\n    ) {\n      this._sawLookaheadUnsafeFunctionAfterNewline = true;\n      return;\n    }\n\n    if (!foundExternal) {\n      if (this.allowExternalFunctionFallbacks) {\n        fallbackFunctionContainer = this.KnotContainerWithName(funcName);\n        this.Assert(\n          fallbackFunctionContainer !== null,\n          \"Trying to call EXTERNAL function '\" +\n            funcName +\n            \"' which has not been bound, and fallback ink function could not be found.\"\n        );\n\n        // Divert direct into fallback function and we're done\n        this.state.callStack.Push(\n          PushPopType.Function,\n          undefined,\n          this.state.outputStream.length\n        );\n        this.state.divertedPointer = Pointer.StartOf(fallbackFunctionContainer);\n        return;\n      } else {\n        this.Assert(\n          false,\n          \"Trying to call EXTERNAL function '\" +\n            funcName +\n            \"' which has not been bound (and ink fallbacks disabled).\"\n        );\n      }\n    }\n\n    // Pop arguments\n    let args: any[] = [];\n    for (let i = 0; i < numberOfArguments; ++i) {\n      // var poppedObj = state.PopEvaluationStack () as Value;\n      let poppedObj = asOrThrows(this.state.PopEvaluationStack(), Value);\n      let valueObj = poppedObj.valueObject;\n      args.push(valueObj);\n    }\n\n    // Reverse arguments from the order they were popped,\n    // so they're the right way round again.\n    args.reverse();\n\n    // Run the function!\n    let funcResult = funcDef!.function(args);\n\n    // Convert return value (if any) to the a type that the ink engine can use\n    let returnObj = null;\n    if (funcResult != null) {\n      returnObj = Value.Create(funcResult);\n      this.Assert(\n        returnObj !== null,\n        \"Could not create ink value from returned object of type \" +\n          typeof funcResult\n      );\n    } else {\n      returnObj = new Void();\n    }\n\n    this.state.PushEvaluationStack(returnObj);\n  }\n\n  public BindExternalFunctionGeneral(\n    funcName: string,\n    func: Story.ExternalFunction,\n    lookaheadSafe: boolean = true\n  ) {\n    this.IfAsyncWeCant(\"bind an external function\");\n    this.Assert(\n      !this._externals.has(funcName),\n      \"Function '\" + funcName + \"' has already been bound.\"\n    );\n    this._externals.set(funcName, {\n      function: func,\n      lookAheadSafe: lookaheadSafe,\n    });\n  }\n\n  public TryCoerce(value: any) {\n    // We're skipping type coercition in this implementation. First of, js\n    // is loosely typed, so it's not that important. Secondly, there is no\n    // clean way (AFAIK) for the user to describe what type of parameters\n    // they expect.\n    return value;\n  }\n\n  public BindExternalFunction(\n    funcName: string,\n    func: Story.ExternalFunction,\n    lookaheadSafe: boolean = false\n  ) {\n    this.Assert(func != null, \"Can't bind a null function\");\n\n    this.BindExternalFunctionGeneral(\n      funcName,\n      (args: any) => {\n        this.Assert(\n          args.length >= func.length,\n          \"External function expected \" + func.length + \" arguments\"\n        );\n\n        let coercedArgs = [];\n        for (let i = 0, l = args.length; i < l; i++) {\n          coercedArgs[i] = this.TryCoerce(args[i]);\n        }\n        return func.apply(null, coercedArgs);\n      },\n      lookaheadSafe\n    );\n  }\n\n  public UnbindExternalFunction(funcName: string) {\n    this.IfAsyncWeCant(\"unbind an external a function\");\n    this.Assert(\n      this._externals.has(funcName),\n      \"Function '\" + funcName + \"' has not been bound.\"\n    );\n    this._externals.delete(funcName);\n  }\n\n  public ValidateExternalBindings(): void;\n  public ValidateExternalBindings(\n    c: Container | null,\n    missingExternals: Set<string>\n  ): void;\n  public ValidateExternalBindings(\n    o: InkObject | null,\n    missingExternals: Set<string>\n  ): void;\n  public ValidateExternalBindings() {\n    let c: Container | null = null;\n    let o: InkObject | null = null;\n    let missingExternals: Set<string> = arguments[1] || new Set();\n\n    if (arguments[0] instanceof Container) {\n      c = arguments[0];\n    }\n\n    if (arguments[0] instanceof InkObject) {\n      o = arguments[0];\n    }\n\n    if (c === null && o === null) {\n      this.ValidateExternalBindings(\n        this._mainContentContainer,\n        missingExternals\n      );\n      this._hasValidatedExternals = true;\n\n      // No problem! Validation complete\n      if (missingExternals.size == 0) {\n        this._hasValidatedExternals = true;\n      } else {\n        let message = \"Error: Missing function binding for external\";\n        message += missingExternals.size > 1 ? \"s\" : \"\";\n        message += \": '\";\n        message += Array.from(missingExternals).join(\"', '\");\n        message += \"' \";\n        message += this.allowExternalFunctionFallbacks\n          ? \", and no fallback ink function found.\"\n          : \" (ink fallbacks disabled)\";\n\n        this.Error(message);\n      }\n    } else if (c != null) {\n      for (let innerContent of c.content) {\n        let container = innerContent as Container;\n        if (container == null || !container.hasValidName)\n          this.ValidateExternalBindings(innerContent, missingExternals);\n      }\n      for (let [, value] of c.namedContent) {\n        this.ValidateExternalBindings(\n          asOrNull(value, InkObject),\n          missingExternals\n        );\n      }\n    } else if (o != null) {\n      let divert = asOrNull(o, Divert);\n      if (divert && divert.isExternal) {\n        let name = divert.targetPathString;\n        if (name === null) {\n          return throwNullException(\"name\");\n        }\n        if (!this._externals.has(name)) {\n          if (this.allowExternalFunctionFallbacks) {\n            let fallbackFound =\n              this.mainContentContainer.namedContent.has(name);\n            if (!fallbackFound) {\n              missingExternals.add(name);\n            }\n          } else {\n            missingExternals.add(name);\n          }\n        }\n      }\n    }\n  }\n\n  public ObserveVariable(\n    variableName: string,\n    observer: Story.VariableObserver\n  ) {\n    this.IfAsyncWeCant(\"observe a new variable\");\n\n    if (this._variableObservers === null) this._variableObservers = new Map();\n\n    if (!this.state.variablesState.GlobalVariableExistsWithName(variableName))\n      throw new Error(\n        \"Cannot observe variable '\" +\n          variableName +\n          \"' because it wasn't declared in the ink story.\"\n      );\n\n    if (this._variableObservers.has(variableName)) {\n      this._variableObservers.get(variableName)!.push(observer);\n    } else {\n      this._variableObservers.set(variableName, [observer]);\n    }\n  }\n\n  public ObserveVariables(\n    variableNames: string[],\n    observers: Story.VariableObserver[]\n  ) {\n    for (let i = 0, l = variableNames.length; i < l; i++) {\n      this.ObserveVariable(variableNames[i], observers[i]);\n    }\n  }\n\n  public RemoveVariableObserver(\n    observer?: Story.VariableObserver,\n    specificVariableName?: string\n  ) {\n    // A couple of things to know about this method:\n    //\n    // 1. Since `RemoveVariableObserver` is exposed to the JavaScript world,\n    //    optionality is marked as `undefined` rather than `null`.\n    //    To keep things simple, null-checks are performed using regular\n    //    equality operators, where undefined == null.\n    //\n    // 2. Since C# delegates are translated to arrays of functions,\n    //    -= becomes a call to splice and null-checks are replaced by\n    //    emptiness-checks.\n    //\n    this.IfAsyncWeCant(\"remove a variable observer\");\n\n    if (this._variableObservers === null) return;\n\n    if (specificVariableName != null) {\n      if (this._variableObservers.has(specificVariableName)) {\n        if (observer != null) {\n          let variableObservers =\n            this._variableObservers.get(specificVariableName);\n          if (variableObservers != null) {\n            variableObservers.splice(variableObservers.indexOf(observer), 1);\n            if (variableObservers.length === 0) {\n              this._variableObservers.delete(specificVariableName);\n            }\n          }\n        } else {\n          this._variableObservers.delete(specificVariableName);\n        }\n      }\n    } else if (observer != null) {\n      let keys = this._variableObservers.keys();\n      for (let varName of keys) {\n        let variableObservers = this._variableObservers.get(varName);\n        if (variableObservers != null) {\n          variableObservers.splice(variableObservers.indexOf(observer), 1);\n          if (variableObservers.length === 0) {\n            this._variableObservers.delete(varName);\n          }\n        }\n      }\n    }\n  }\n\n  public VariableStateDidChangeEvent(\n    variableName: string,\n    newValueObj: InkObject\n  ) {\n    if (this._variableObservers === null) return;\n\n    let observers = this._variableObservers.get(variableName);\n    if (typeof observers !== \"undefined\") {\n      if (!(newValueObj instanceof Value)) {\n        throw new Error(\n          \"Tried to get the value of a variable that isn't a standard type\"\n        );\n      }\n      // var val = newValueObj as Value;\n      let val = asOrThrows(newValueObj, Value);\n\n      for (let observer of observers) {\n        observer(variableName, val.valueObject);\n      }\n    }\n  }\n\n  get globalTags() {\n    return this.TagsAtStartOfFlowContainerWithPathString(\"\");\n  }\n\n  public TagsForContentAtPath(path: string) {\n    return this.TagsAtStartOfFlowContainerWithPathString(path);\n  }\n\n  public TagsAtStartOfFlowContainerWithPathString(pathString: string) {\n    let path = new Path(pathString);\n\n    let flowContainer = this.ContentAtPath(path).container;\n    if (flowContainer === null) {\n      return throwNullException(\"flowContainer\");\n    }\n    while (true) {\n      let firstContent: InkObject = flowContainer.content[0];\n      if (firstContent instanceof Container) flowContainer = firstContent;\n      else break;\n    }\n\n    let inTag = false;\n    let tags: string[] | null = null;\n\n    for (let c of flowContainer.content) {\n      // var tag = c as Runtime.Tag;\n      let command = asOrNull(c, ControlCommand);\n\n      if (command != null) {\n        if (command.commandType == ControlCommand.CommandType.BeginTag) {\n          inTag = true;\n        } else if (command.commandType == ControlCommand.CommandType.EndTag) {\n          inTag = false;\n        }\n      } else if (inTag) {\n        let str = asOrNull(c, StringValue);\n        if (str !== null) {\n          if (tags === null) tags = [];\n          if (str.value !== null) tags.push(str.value);\n        } else {\n          this.Error(\n            \"Tag contained non-text content. Only plain text is allowed when using globalTags or TagsAtContentPath. If you want to evaluate dynamic content, you need to use story.Continue().\"\n          );\n        }\n      } else {\n        break;\n      }\n    }\n\n    return tags;\n  }\n\n  public BuildStringOfHierarchy() {\n    let sb = new StringBuilder();\n\n    this.mainContentContainer.BuildStringOfHierarchy(\n      sb,\n      0,\n      this.state.currentPointer.Resolve()\n    );\n\n    return sb.toString();\n  }\n\n  public BuildStringOfContainer(container: Container) {\n    let sb = new StringBuilder();\n    container.BuildStringOfHierarchy(\n      sb,\n      0,\n      this.state.currentPointer.Resolve()\n    );\n    return sb.toString();\n  }\n\n  public NextContent() {\n    this.state.previousPointer = this.state.currentPointer.copy();\n\n    if (!this.state.divertedPointer.isNull) {\n      this.state.currentPointer = this.state.divertedPointer.copy();\n      this.state.divertedPointer = Pointer.Null;\n\n      this.VisitChangedContainersDueToDivert();\n\n      if (!this.state.currentPointer.isNull) {\n        return;\n      }\n    }\n\n    let successfulPointerIncrement = this.IncrementContentPointer();\n\n    if (!successfulPointerIncrement) {\n      let didPop = false;\n\n      if (this.state.callStack.CanPop(PushPopType.Function)) {\n        this.state.PopCallStack(PushPopType.Function);\n\n        if (this.state.inExpressionEvaluation) {\n          this.state.PushEvaluationStack(new Void());\n        }\n\n        didPop = true;\n      } else if (this.state.callStack.canPopThread) {\n        this.state.callStack.PopThread();\n\n        didPop = true;\n      } else {\n        this.state.TryExitFunctionEvaluationFromGame();\n      }\n\n      if (didPop && !this.state.currentPointer.isNull) {\n        this.NextContent();\n      }\n    }\n  }\n\n  public IncrementContentPointer() {\n    let successfulIncrement = true;\n\n    let pointer = this.state.callStack.currentElement.currentPointer.copy();\n    pointer.index++;\n\n    if (pointer.container === null) {\n      return throwNullException(\"pointer.container\");\n    }\n    while (pointer.index >= pointer.container.content.length) {\n      successfulIncrement = false;\n\n      // Container nextAncestor = pointer.container.parent as Container;\n      let nextAncestor = asOrNull(pointer.container.parent, Container);\n      if (nextAncestor instanceof Container === false) {\n        break;\n      }\n\n      let indexInAncestor = nextAncestor!.content.indexOf(pointer.container);\n      if (indexInAncestor == -1) {\n        break;\n      }\n\n      pointer = new Pointer(nextAncestor, indexInAncestor);\n\n      pointer.index++;\n\n      successfulIncrement = true;\n      if (pointer.container === null) {\n        return throwNullException(\"pointer.container\");\n      }\n    }\n\n    if (!successfulIncrement) pointer = Pointer.Null;\n\n    this.state.callStack.currentElement.currentPointer = pointer.copy();\n\n    return successfulIncrement;\n  }\n\n  public TryFollowDefaultInvisibleChoice() {\n    let allChoices = this._state.currentChoices;\n\n    let invisibleChoices = allChoices.filter((c) => c.isInvisibleDefault);\n\n    if (\n      invisibleChoices.length == 0 ||\n      allChoices.length > invisibleChoices.length\n    )\n      return false;\n\n    let choice = invisibleChoices[0];\n\n    if (choice.targetPath === null) {\n      return throwNullException(\"choice.targetPath\");\n    }\n\n    if (choice.threadAtGeneration === null) {\n      return throwNullException(\"choice.threadAtGeneration\");\n    }\n\n    this.state.callStack.currentThread = choice.threadAtGeneration;\n\n    if (this._stateSnapshotAtLastNewline !== null) {\n      this.state.callStack.currentThread = this.state.callStack.ForkThread();\n    }\n\n    this.ChoosePath(choice.targetPath, false);\n\n    return true;\n  }\n\n  public NextSequenceShuffleIndex() {\n    // var numElementsIntVal = state.PopEvaluationStack () as IntValue;\n    let numElementsIntVal = asOrNull(this.state.PopEvaluationStack(), IntValue);\n    if (!(numElementsIntVal instanceof IntValue)) {\n      this.Error(\"expected number of elements in sequence for shuffle index\");\n      return 0;\n    }\n\n    let seqContainer = this.state.currentPointer.container;\n    if (seqContainer === null) {\n      return throwNullException(\"seqContainer\");\n    }\n\n    // Originally a primitive type, but here, can be null.\n    // TODO: Replace by default value?\n    if (numElementsIntVal.value === null) {\n      return throwNullException(\"numElementsIntVal.value\");\n    }\n    let numElements = numElementsIntVal.value;\n\n    // var seqCountVal = state.PopEvaluationStack () as IntValue;\n    let seqCountVal = asOrThrows(this.state.PopEvaluationStack(), IntValue);\n    let seqCount = seqCountVal.value;\n\n    // Originally a primitive type, but here, can be null.\n    // TODO: Replace by default value?\n    if (seqCount === null) {\n      return throwNullException(\"seqCount\");\n    }\n\n    let loopIndex = seqCount / numElements;\n    let iterationIndex = seqCount % numElements;\n\n    let seqPathStr = seqContainer.path.toString();\n    let sequenceHash = 0;\n    for (let i = 0, l = seqPathStr.length; i < l; i++) {\n      sequenceHash += seqPathStr.charCodeAt(i) || 0;\n    }\n    let randomSeed = sequenceHash + loopIndex + this.state.storySeed;\n    let random = new PRNG(Math.floor(randomSeed));\n\n    let unpickedIndices = [];\n    for (let i = 0; i < numElements; ++i) {\n      unpickedIndices.push(i);\n    }\n\n    for (let i = 0; i <= iterationIndex; ++i) {\n      let chosen = random.next() % unpickedIndices.length;\n      let chosenIndex = unpickedIndices[chosen];\n      unpickedIndices.splice(chosen, 1);\n\n      if (i == iterationIndex) {\n        return chosenIndex;\n      }\n    }\n\n    throw new Error(\"Should never reach here\");\n  }\n\n  public Error(message: string, useEndLineNumber = false): never {\n    let e = new StoryException(message);\n    e.useEndLineNumber = useEndLineNumber;\n    throw e;\n  }\n\n  public Warning(message: string) {\n    this.AddError(message, true);\n  }\n\n  public AddError(\n    message: string,\n    isWarning = false,\n    useEndLineNumber = false\n  ) {\n    let dm = this.currentDebugMetadata;\n\n    let errorTypeStr = isWarning ? \"WARNING\" : \"ERROR\";\n\n    if (dm != null) {\n      let lineNum = useEndLineNumber ? dm.endLineNumber : dm.startLineNumber;\n      message =\n        \"RUNTIME \" +\n        errorTypeStr +\n        \": '\" +\n        dm.fileName +\n        \"' line \" +\n        lineNum +\n        \": \" +\n        message;\n    } else if (!this.state.currentPointer.isNull) {\n      message =\n        \"RUNTIME \" +\n        errorTypeStr +\n        \": (\" +\n        this.state.currentPointer +\n        \"): \" +\n        message;\n    } else {\n      message = \"RUNTIME \" + errorTypeStr + \": \" + message;\n    }\n\n    this.state.AddError(message, isWarning);\n\n    // In a broken state don't need to know about any other errors.\n    if (!isWarning) this.state.ForceEnd();\n  }\n\n  public Assert(condition: boolean, message: string | null = null) {\n    if (condition == false) {\n      if (message == null) {\n        message = \"Story assert\";\n      }\n\n      throw new Error(message + \" \" + this.currentDebugMetadata);\n    }\n  }\n\n  get currentDebugMetadata(): DebugMetadata | null {\n    let dm: DebugMetadata | null;\n\n    let pointer = this.state.currentPointer;\n    if (!pointer.isNull && pointer.Resolve() !== null) {\n      dm = pointer.Resolve()!.debugMetadata;\n      if (dm !== null) {\n        return dm;\n      }\n    }\n\n    for (let i = this.state.callStack.elements.length - 1; i >= 0; --i) {\n      pointer = this.state.callStack.elements[i].currentPointer;\n      if (!pointer.isNull && pointer.Resolve() !== null) {\n        dm = pointer.Resolve()!.debugMetadata;\n        if (dm !== null) {\n          return dm;\n        }\n      }\n    }\n\n    for (let i = this.state.outputStream.length - 1; i >= 0; --i) {\n      let outputObj = this.state.outputStream[i];\n      dm = outputObj.debugMetadata;\n      if (dm !== null) {\n        return dm;\n      }\n    }\n\n    return null;\n  }\n\n  get mainContentContainer() {\n    if (this._temporaryEvaluationContainer) {\n      return this._temporaryEvaluationContainer;\n    } else {\n      return this._mainContentContainer;\n    }\n  }\n\n  /**\n   * `_mainContentContainer` is almost guaranteed to be set in the\n   * constructor, unless the json is malformed.\n   */\n  private _mainContentContainer!: Container;\n  private _listDefinitions: ListDefinitionsOrigin | null = null;\n\n  private _externals: Map<string, Story.ExternalFunctionDef>;\n  private _variableObservers: Map<string, Story.VariableObserver[]> | null =\n    null;\n  private _hasValidatedExternals: boolean = false;\n\n  private _temporaryEvaluationContainer: Container | null = null;\n\n  /**\n   * `state` is almost guaranteed to be set in the constructor, unless\n   * using the compiler-specific constructor which will likely not be used in\n   * the real world.\n   */\n  private _state!: StoryState;\n\n  private _asyncContinueActive: boolean = false;\n  private _stateSnapshotAtLastNewline: StoryState | null = null;\n  private _sawLookaheadUnsafeFunctionAfterNewline: boolean = false;\n\n  private _recursiveContinueCount: number = 0;\n\n  private _asyncSaving: boolean = false;\n\n  private _profiler: any | null = null; // TODO: Profiler\n}\n\nexport namespace Story {\n  export enum OutputStateChange {\n    NoChange = 0,\n    ExtendedBeyondNewline = 1,\n    NewlineRemoved = 2,\n  }\n\n  export interface EvaluateFunctionTextOutput {\n    returned: any;\n    output: string;\n  }\n\n  export interface ExternalFunctionDef {\n    function: ExternalFunction;\n    lookAheadSafe: boolean;\n  }\n\n  export type VariableObserver = (variableName: string, newValue: any) => void;\n  export type ExternalFunction = (...args: any) => any;\n}\n", "/**\n * Manages toast-style notifications with support for multiple types,\n * positioning, auto-dismiss, and accessibility features.\n * Uses console.warn directly to avoid circular dependency with ErrorManager.\n */\nclass NotificationManager {\n  // Note: Uses console.warn directly to avoid circular dependency with ErrorManager\n\n  /**\n   * Creates the notification manager with optional configuration.\n   * @param {Object} [options={}]\n   * @param {string} [options.position='bottom-right'] - Position: top-left, top-right, bottom-left, bottom-right, top-center, bottom-center\n   * @param {number} [options.maxNotifications=5] - Maximum visible notifications\n   * @param {number} [options.defaultDuration=4000] - Default auto-dismiss time in ms\n   * @param {number} [options.spacing=10] - Gap between notifications in px\n   * @param {number} [options.zIndex=2000] - CSS z-index for container\n   */\n  constructor(options = {}) {\n    this.config = {\n      position: \"bottom-right\", // top-left, top-right, bottom-left, bottom-right, top-center, bottom-center\n      maxNotifications: 5,\n      defaultDuration: 4000,\n      spacing: 10,\n      zIndex: 2000,\n      ...options,\n    };\n\n    this.notifications = [];\n    this.container = null;\n    this.init();\n  }\n\n  /**\n   * Initializes the notification system by creating the container and adding styles.\n   * @private\n   */\n  init() {\n    this.createContainer();\n    this.addStyles();\n  }\n\n  /**\n   * Creates the notification container element and appends it to the document body.\n   * @private\n   */\n  createContainer() {\n    this.container = document.createElement(\"div\");\n    this.container.className = \"notification-container\";\n    this.container.setAttribute(\"data-position\", this.config.position);\n    this.container.setAttribute(\"aria-live\", \"polite\");\n    this.container.setAttribute(\"role\", \"status\");\n\n    // Position the container\n    this.setContainerPosition();\n\n    document.body.appendChild(this.container);\n  }\n\n  /**\n   * Applies CSS positioning to the container based on config.position.\n   * @private\n   */\n  setContainerPosition() {\n    const positions = {\n      \"top-left\": { top: \"20px\", left: \"20px\" },\n      \"top-right\": { top: \"20px\", right: \"20px\" },\n      \"top-center\": { top: \"20px\", left: \"50%\", transform: \"translateX(-50%)\" },\n      \"bottom-left\": { bottom: \"20px\", left: \"20px\" },\n      \"bottom-right\": { bottom: \"20px\", right: \"20px\" },\n      \"bottom-center\": {\n        bottom: \"20px\",\n        left: \"50%\",\n        transform: \"translateX(-50%)\",\n      },\n    };\n\n    const pos = positions[this.config.position] || positions[\"bottom-right\"];\n    Object.assign(this.container.style, {\n      position: \"fixed\",\n      zIndex: this.config.zIndex,\n      pointerEvents: \"none\",\n      ...pos,\n    });\n  }\n\n  /**\n   * Sets CSS custom properties for notification styling.\n   * @private\n   */\n  addStyles() {\n    const root = document.documentElement;\n    root.style.setProperty(\n      \"--notification-spacing\",\n      `${this.config.spacing}px`\n    );\n  }\n\n  /**\n   * Show a notification\n   * @param {string} message - The message to display\n   * @param {Object} options - Notification options\n   * @returns {Object} Notification object with remove method\n   */\n  show(message, options = {}) {\n    const config = {\n      type: \"info\", // success, error, warning, info, critical\n      duration: this.config.defaultDuration,\n      closable: true,\n      icon: null, // Auto-determined if null\n      showProgress: false,\n      onClick: null,\n      onClose: null,\n      ...options,\n    };\n\n    if (!config.icon) {\n      const icons = {\n        success: \"\u2713\",\n        error: \"\u2715\",\n        warning: \"\u26A0\",\n        info: \"\u24D8\",\n        critical: \"\uD83D\uDEA8\",\n      };\n      config.icon = icons[config.type] || \"\u24D8\";\n    }\n\n    const notification = this.createNotificationElement(message, config);\n    this.enforceMaxNotifications();\n\n    this.container.appendChild(notification);\n    const notificationObj = { element: notification, config };\n    this.notifications.push(notificationObj);\n\n    requestAnimationFrame(() => {\n      notification.classList.add(\"notification-visible\");\n    });\n\n    if (config.duration > 0 && config.type !== \"critical\") {\n      setTimeout(() => {\n        this.remove(notificationObj);\n      }, config.duration);\n    }\n\n    return {\n      remove: () => this.remove(notificationObj),\n      element: notification,\n    };\n  }\n\n  /**\n   * Shows a success notification (green/checkmark style).\n   * @param {string} message - The message to display\n   * @param {Object} [options={}] - Additional notification options\n   * @returns {Object} Notification object with remove method\n   */\n  success(message, options = {}) {\n    return this.show(message, { ...options, type: \"success\" });\n  }\n\n  /**\n   * Shows an error notification (red/X style).\n   * @param {string} message - The message to display\n   * @param {Object} [options={}] - Additional notification options\n   * @returns {Object} Notification object with remove method\n   */\n  error(message, options = {}) {\n    return this.show(message, { ...options, type: \"error\" });\n  }\n\n  /**\n   * Shows a warning notification (yellow/warning style).\n   * @param {string} message - The message to display\n   * @param {Object} [options={}] - Additional notification options\n   * @returns {Object} Notification object with remove method\n   */\n  warning(message, options = {}) {\n    return this.show(message, { ...options, type: \"warning\" });\n  }\n\n  /**\n   * Shows an info notification (neutral/info style).\n   * @param {string} message - The message to display\n   * @param {Object} [options={}] - Additional notification options\n   * @returns {Object} Notification object with remove method\n   */\n  info(message, options = {}) {\n    return this.show(message, { ...options, type: \"info\" });\n  }\n\n  /**\n   * Shows a critical notification (solid red background, no auto-dismiss).\n   * @param {string} message - The message to display\n   * @param {Object} [options={}] - Additional notification options\n   * @returns {Object} Notification object with remove method\n   */\n  critical(message, options = {}) {\n    return this.show(message, {\n      ...options,\n      type: \"critical\",\n      duration: 0, // Critical notifications don't auto-dismiss\n      closable: true,\n    });\n  }\n\n  /**\n   * Removes a notification with exit animation.\n   * @param {Object} notificationObj - The notification object returned by show()\n   * @param {HTMLElement} notificationObj.element - The notification DOM element\n   * @param {Object} notificationObj.config - The notification configuration\n   */\n  remove(notificationObj) {\n    if (!notificationObj || !notificationObj.element) return;\n\n    const { element, config } = notificationObj;\n\n    if (config.onClose) {\n      try {\n        config.onClose();\n      } catch (error) {\n        console.warn(\"Notification onClose callback failed:\", error);\n      }\n    }\n\n    const index = this.notifications.indexOf(notificationObj);\n    if (index > -1) {\n      this.notifications.splice(index, 1);\n    }\n\n    element.style.transform = this.getExitTransform();\n    element.style.opacity = \"0\";\n\n    setTimeout(() => {\n      if (element.parentNode) {\n        element.parentNode.removeChild(element);\n      }\n    }, 300);\n  }\n\n  /**\n   * Removes all active notifications.\n   */\n  clearAll() {\n    const notificationsToRemove = [...this.notifications];\n    notificationsToRemove.forEach((notification) => {\n      this.remove(notification);\n    });\n  }\n\n  /**\n   * Creates the DOM element for a notification.\n   * @param {string} message - The message to display\n   * @param {Object} config - Notification configuration\n   * @returns {HTMLElement} The notification element\n   * @private\n   */\n  createNotificationElement(message, config) {\n    const notification = document.createElement(\"div\");\n    notification.className = `notification-item notification-${config.type}`;\n\n    if (config.type === \"error\" || config.type === \"critical\") {\n      notification.setAttribute(\"role\", \"alert\");\n    }\n\n    const content = document.createElement(\"div\");\n    content.className = \"notification-content\";\n\n    const iconSpan = document.createElement(\"span\");\n    iconSpan.className = \"notification-icon\";\n    iconSpan.textContent = config.icon;\n    iconSpan.setAttribute(\"aria-hidden\", \"true\");\n\n    content.appendChild(iconSpan);\n\n    const messageSpan = document.createElement(\"span\");\n    messageSpan.textContent = message;\n    content.appendChild(messageSpan);\n\n    notification.appendChild(content);\n\n    if (config.closable) {\n      const closeBtn = document.createElement(\"button\");\n      closeBtn.type = \"button\";\n      closeBtn.className = \"notification-close\";\n      closeBtn.innerHTML = '<span aria-hidden=\"true\">\u00D7</span>';\n      closeBtn.setAttribute(\"aria-label\", \"Dismiss notification\");\n      closeBtn.addEventListener(\"click\", (e) => {\n        e.stopPropagation();\n        this.remove({ element: notification, config });\n      });\n      notification.appendChild(closeBtn);\n    }\n\n    if (config.showProgress && config.duration > 0) {\n      const progress = document.createElement(\"div\");\n      progress.className = \"notification-progress\";\n      progress.style.width = \"100%\";\n      notification.appendChild(progress);\n\n      requestAnimationFrame(() => {\n        progress.style.width = \"0%\";\n        progress.style.transitionDuration = `${config.duration}ms`;\n      });\n    }\n\n    if (config.onClick) {\n      notification.style.cursor = \"pointer\";\n      notification.addEventListener(\"click\", config.onClick);\n    }\n\n    return notification;\n  }\n\n  /**\n   * Returns the CSS transform for the exit animation based on position.\n   * @returns {string} CSS transform value (e.g., 'translateX(100%)')\n   * @private\n   */\n  getExitTransform() {\n    const isRight = this.config.position.includes(\"right\");\n    const isLeft = this.config.position.includes(\"left\");\n\n    if (isRight) return \"translateX(100%)\";\n    if (isLeft) return \"translateX(-100%)\";\n    return \"translateY(-100%)\"; // center positions\n  }\n\n  /**\n   * Removes oldest notifications if count exceeds maxNotifications.\n   * @private\n   */\n  enforceMaxNotifications() {\n    while (this.notifications.length >= this.config.maxNotifications) {\n      const oldest = this.notifications[0];\n      this.remove(oldest);\n    }\n  }\n\n  /**\n   * Updates the notification manager configuration.\n   * @param {Object} newConfig - Configuration options to merge\n   */\n  updateConfig(newConfig) {\n    this.config = { ...this.config, ...newConfig };\n\n    if (newConfig.position) {\n      this.setContainerPosition();\n      this.container.setAttribute(\"data-position\", this.config.position);\n    }\n  }\n\n  /**\n   * Returns diagnostic information about the notification system.\n   * @returns {{activeNotifications: number, maxNotifications: number, position: string, hasContainer: boolean}}\n   */\n  getStats() {\n    return {\n      activeNotifications: this.notifications.length,\n      maxNotifications: this.config.maxNotifications,\n      position: this.config.position,\n      hasContainer: !!this.container,\n    };\n  }\n\n  /**\n   * Cleans up the notification system, removing all notifications and the container.\n   */\n  destroy() {\n    this.clearAll();\n\n    if (this.container && this.container.parentNode) {\n      this.container.parentNode.removeChild(this.container);\n    }\n\n    const styles = document.getElementById(\"notification-styles\");\n    if (styles) {\n      styles.remove();\n    }\n\n    this.container = null;\n    this.notifications = [];\n  }\n}\n\nconst notificationManager = new NotificationManager();\nexport { notificationManager };\n", "/**\n * Provides external functions that extend Ink's built-in capabilities.\n * Includes string manipulation, math utilities, fairmath operations, and time formatting.\n * All methods are static - call InkFunctions.bindAll(story) to register all functions.\n */\nclass InkFunctions {\n  /**\n   * Bind all utility functions to an ink story\n   * @param {Story} story - The inkjs Story instance\n   */\n  static bindAll(story) {\n    this.bindStringFunctions(story);\n    this.bindMathFunctions(story);\n    this.bindFairMathFunctions(story);\n    this.bindTimeFunctions(story);\n  }\n\n  /**\n   * Binds string manipulation functions to the story.\n   * Functions: UPPERCASE, LOWERCASE, CAPITALIZE, TRIM, LENGTH,\n   * CONTAINS, STARTS_WITH, ENDS_WITH, REPLACE, REPLACE_ALL\n   * @param {Story} story - The inkjs Story instance\n   * @private\n   */\n  static bindStringFunctions(story) {\n    story.BindExternalFunction(\"UPPERCASE\", (str) => String(str).toUpperCase());\n    story.BindExternalFunction(\"LOWERCASE\", (str) => String(str).toLowerCase());\n    story.BindExternalFunction(\n      \"CAPITALIZE\",\n      (str) => String(str).charAt(0).toUpperCase() + String(str).slice(1)\n    );\n    story.BindExternalFunction(\"TRIM\", (str) => String(str).trim());\n    story.BindExternalFunction(\"LENGTH\", (str) => String(str).length);\n    story.BindExternalFunction(\"CONTAINS\", (str, search) =>\n      String(str).includes(String(search))\n    );\n    story.BindExternalFunction(\"STARTS_WITH\", (str, search) =>\n      String(str).startsWith(String(search))\n    );\n    story.BindExternalFunction(\"ENDS_WITH\", (str, search) =>\n      String(str).endsWith(String(search))\n    );\n    story.BindExternalFunction(\"REPLACE\", (str, search, replacement) =>\n      String(str).replace(String(search), String(replacement))\n    );\n    story.BindExternalFunction(\"REPLACE_ALL\", (str, search, replacement) =>\n      String(str).replaceAll(String(search), String(replacement))\n    );\n  }\n\n  /**\n   * Binds math utility functions to the story.\n   * Functions: ROUND, CLAMP, ABS, PERCENT\n   *\n   * Note: Ink has these built-in, so we don't duplicate them:\n   * MIN, MAX, FLOOR, CEILING, INT, FLOAT, POW, RANDOM, SEED_RANDOM\n   * @param {Story} story - The inkjs Story instance\n   * @private\n   */\n  static bindMathFunctions(story) {\n    story.BindExternalFunction(\"ROUND\", (value) => Math.round(value));\n    story.BindExternalFunction(\"CLAMP\", (value, min, max) =>\n      Math.min(Math.max(value, min), max)\n    );\n    story.BindExternalFunction(\"ABS\", (value) => Math.abs(value));\n    story.BindExternalFunction(\"PERCENT\", (value, total) =>\n      total === 0 ? 0 : Math.round((value / total) * 100)\n    );\n  }\n\n  /**\n   * Binds fairmath functions for balanced stat progression.\n   * FAIRADD increases stats with diminishing returns near 100.\n   * FAIRSUB decreases stats with diminishing returns near 0.\n   * Useful for RPG-style stats that shouldn't easily hit extremes.\n   * @param {Story} story - The inkjs Story instance\n   * @private\n   */\n  static bindFairMathFunctions(story) {\n    story.BindExternalFunction(\"FAIRADD\", (stat, percent) => {\n      const result = stat + (100 - stat) * (percent / 100);\n      return Math.round(Math.min(100, Math.max(0, result)));\n    });\n\n    story.BindExternalFunction(\"FAIRSUB\", (stat, percent) => {\n      const result = stat - stat * (percent / 100);\n      return Math.round(Math.min(100, Math.max(0, result)));\n    });\n  }\n\n  /**\n   * Binds time and date formatting functions to the story.\n   * Functions: NOW, TIME_AGO, FORMAT_DATE, FORMAT_TIME, FORMAT_DATETIME, OFFSET_DATE\n   * All timestamps are Unix timestamps (seconds since epoch).\n   * Formatting functions support locale strings (e.g., \"en-US\", \"fr-FR\").\n   * @param {Story} story - The inkjs Story instance\n   * @private\n   */\n  static bindTimeFunctions(story) {\n    story.BindExternalFunction(\"NOW\", () => Math.floor(Date.now() / 1000));\n\n    story.BindExternalFunction(\n      \"SECONDS_SINCE\",\n      (start) => Math.floor(Date.now() / 1000) - start\n    );\n\n    story.BindExternalFunction(\"MINUTES_SINCE\", (start) =>\n      Math.floor((Date.now() / 1000 - start) / 60)\n    );\n\n    story.BindExternalFunction(\"TIME_SINCE\", (start) => {\n      const seconds = Math.floor(Date.now() / 1000) - start;\n\n      if (seconds < 60) {\n        return seconds === 1 ? \"1 second\" : `${seconds} seconds`;\n      }\n\n      const minutes = Math.floor(seconds / 60);\n      if (minutes < 60) {\n        return minutes === 1 ? \"1 minute\" : `${minutes} minutes`;\n      }\n\n      const hours = Math.floor(minutes / 60);\n      if (hours < 24) {\n        return hours === 1 ? \"1 hour\" : `${hours} hours`;\n      }\n\n      const days = Math.floor(hours / 24);\n      return days === 1 ? \"1 day\" : `${days} days`;\n    });\n\n    story.BindExternalFunction(\"FORMAT_DATE\", (timestamp, locale) => {\n      const date = new Date(timestamp * 1000);\n      const options = {\n        year: \"numeric\",\n        month: \"long\",\n        day: \"numeric\",\n      };\n      try {\n        return date.toLocaleDateString(locale || \"en-US\", options);\n      } catch {\n        console.warn(`Invalid locale \"${locale}\", falling back to en-US`);\n        return date.toLocaleDateString(\"en-US\", options);\n      }\n    });\n\n    story.BindExternalFunction(\"FORMAT_TIME\", (timestamp, locale) => {\n      const date = new Date(timestamp * 1000);\n      const options = {\n        hour: \"numeric\",\n        minute: \"2-digit\",\n      };\n      try {\n        return date.toLocaleTimeString(locale || \"en-US\", options);\n      } catch {\n        console.warn(`Invalid locale \"${locale}\", falling back to en-US`);\n        return date.toLocaleTimeString(\"en-US\", options);\n      }\n    });\n\n    story.BindExternalFunction(\"FORMAT_DATETIME\", (timestamp, locale) => {\n      const date = new Date(timestamp * 1000);\n      const options = {\n        year: \"numeric\",\n        month: \"long\",\n        day: \"numeric\",\n        hour: \"numeric\",\n        minute: \"2-digit\",\n      };\n      try {\n        return date.toLocaleString(locale || \"en-US\", options);\n      } catch {\n        console.warn(`Invalid locale \"${locale}\", falling back to en-US`);\n        return date.toLocaleString(\"en-US\", options);\n      }\n    });\n\n    story.BindExternalFunction(\n      \"OFFSET_DATE\",\n      (timestamp, years, months, days, hours, minutes) => {\n        const date = new Date(timestamp * 1000);\n        date.setFullYear(date.getFullYear() + years);\n        date.setMonth(date.getMonth() + months);\n        date.setDate(date.getDate() + days);\n        date.setHours(date.getHours() + hours);\n        date.setMinutes(date.getMinutes() + minutes);\n        return Math.floor(date.getTime() / 1000);\n      }\n    );\n  }\n}\n\nexport { InkFunctions };\n", "import { notificationManager } from \"./notification-manager.js\";\n\n/**\n * Centralized error handling with logging, notifications, and automatic recovery.\n * Provides source-bound loggers for consistent error reporting across modules.\n */\nclass ErrorManager {\n  /**\n   * Predefined source identifiers for error categorization.\n   * Use these constants when logging errors to ensure consistent source names.\n   * @type {Object.<string, string>}\n   */\n  static SOURCES = {\n    CHOICE_MANAGER: \"Choice Manager\",\n    CONTENT_PROCESSOR: \"Content Processor\",\n    DISPLAY_MANAGER: \"Display Manager\",\n    DOM_HELPERS: \"DOM Helpers\",\n    KEYBOARD_HELP: \"Keyboard Help\",\n    KEYBOARD_SHORTCUTS: \"Keyboard Shortcuts\",\n    MODAL: \"Modal\",\n    MARKDOWN: \"Markdown Processor\",\n    NAVIGATION_MANAGER: \"Navigation Manager\",\n    PAGE_MANAGER: \"Page Manager\",\n    SAVES_MODAL: \"Saves Modal\",\n    SAVE_SYSTEM: \"Save System\",\n    SETTINGS_MANAGER: \"Settings Manager\",\n    STORY_MANAGER: \"Story Manager\",\n    SYSTEM: \"System\",\n    TAG_PROCESSOR: \"Tag Processor\",\n  };\n\n  /**\n   * Creates the ErrorManager and sets up global error handlers.\n   */\n  constructor() {\n    this.setupGlobalHandlers();\n  }\n\n  /**\n   * Registers global handlers for uncaught errors and unhandled promise rejections.\n   * @private\n   */\n  setupGlobalHandlers() {\n    window.addEventListener(\"error\", (event) => {\n      this.handleError(\n        \"Uncaught Error\",\n        event.error,\n        ErrorManager.SOURCES.SYSTEM\n      );\n    });\n\n    window.addEventListener(\"unhandledrejection\", (event) => {\n      this.handleError(\n        \"Unhandled Promise\",\n        event.reason,\n        ErrorManager.SOURCES.SYSTEM\n      );\n      event.preventDefault();\n    });\n  }\n\n  /**\n   * Create a logger bound to a specific source\n   * @param {string} source - Source identifier (use ErrorManager.SOURCES)\n   * @returns {Object} Object with error, warning, critical methods\n   */\n  forSource(source) {\n    return {\n      error: (message, error = null) => this.error(message, error, source),\n      warning: (message, error = null) => this.warning(message, error, source),\n      critical: (message, error = null) =>\n        this.critical(message, error, source),\n    };\n  }\n\n  /**\n   * Logs a critical error that may trigger recovery attempts.\n   * @param {string} message - Error description\n   * @param {Error|*} error - Error object or details\n   * @param {string} source - Error source (use ErrorManager.SOURCES)\n   */\n  critical(message, error, source) {\n    this.handleError(message, error, source, \"critical\");\n  }\n\n  /**\n   * Logs an error and shows a notification to the user.\n   * @param {string} message - Error description\n   * @param {Error|*} error - Error object or details\n   * @param {string} source - Error source (use ErrorManager.SOURCES)\n   */\n  error(message, error, source) {\n    this.handleError(message, error, source, \"error\");\n  }\n\n  /**\n   * Logs a warning without showing a notification.\n   * @param {string} message - Warning description\n   * @param {Error|*} error - Error object or details\n   * @param {string} source - Warning source (use ErrorManager.SOURCES)\n   */\n  warning(message, error, source) {\n    this.handleError(message, error, source, \"warning\");\n  }\n\n  /**\n   * Execute a function safely, catching any errors\n   * @param {Function} func - Function to execute\n   * @param {*} [fallback=null] - Value to return if function throws\n   * @returns {*} Function result or fallback\n   */\n  safely(func, fallback = null) {\n    try {\n      return func();\n    } catch (error) {\n      this.handleError(\n        \"Safe execution failed\",\n        error,\n        ErrorManager.SOURCES.SYSTEM\n      );\n      return fallback;\n    }\n  }\n\n  /**\n   * Execute an async function safely, catching any errors\n   * @param {Function} func - Async function to execute\n   * @param {*} [fallback=null] - Value to return if function throws\n   * @returns {Promise<*>} Function result or fallback\n   */\n  async safelyAsync(func, fallback = null) {\n    try {\n      return await func();\n    } catch (error) {\n      this.handleError(\n        \"Safe async execution failed\",\n        error,\n        ErrorManager.SOURCES.SYSTEM\n      );\n      return fallback;\n    }\n  }\n\n  /**\n   * Core error handling with logging, notifications, and recovery\n   * @param {string} message - Error message\n   * @param {Error|*} error - Error object or details\n   * @param {string} [source='unknown'] - Error source (use ErrorManager.SOURCES)\n   * @param {string} [severity='error'] - 'warning', 'error', or 'critical'\n   */\n  handleError(message, error, source = \"unknown\", severity = \"error\") {\n    const prefix = `[${severity.toUpperCase()}] [${source}]`;\n    console.group(`${prefix} ${message}`);\n    console[severity === \"warning\" ? \"warn\" : \"error\"](\"Message:\", message);\n    console[severity === \"warning\" ? \"warn\" : \"error\"](\"Source:\", source);\n\n    if (error) {\n      const errorDetails = error instanceof Error ? error.message : error;\n      console[severity === \"warning\" ? \"warn\" : \"error\"](\n        \"Details:\",\n        errorDetails\n      );\n      if (error.stack) {\n        console[severity === \"warning\" ? \"warn\" : \"error\"](\n          \"Stack:\",\n          error.stack\n        );\n      }\n    }\n\n    console[severity === \"warning\" ? \"warn\" : \"error\"](\n      \"Time:\",\n      new Date().toISOString()\n    );\n    console.groupEnd();\n\n    if (severity === \"error\" || severity === \"critical\") {\n      this.showNotification(message, severity);\n    }\n\n    if (severity === \"critical\") {\n      this.attemptRecovery(source);\n    }\n  }\n\n  /**\n   * Displays an error notification to the user.\n   * @param {string} message - Message to display\n   * @param {string} severity - 'error' or 'critical'\n   * @private\n   */\n  showNotification(message, severity) {\n    const type = severity === \"critical\" ? \"critical\" : \"error\";\n    notificationManager.show(message, { type });\n  }\n\n  /**\n   * Attempts automatic recovery based on the error source.\n   * Recovery actions include restarting the story, clearing display, or disabling autosave.\n   * @param {string} source - The error source that triggered recovery\n   * @private\n   */\n  attemptRecovery(source) {\n    console.log(`[RECOVERY] Attempting recovery for ${source} error`);\n    const storyManager = window.InkTemplate?.storyManager;\n\n    switch (source) {\n      case ErrorManager.SOURCES.STORY_MANAGER:\n        if (storyManager) {\n          try {\n            storyManager.restart();\n            console.log(\"[RECOVERY] Story restarted successfully\");\n          } catch (recoveryError) {\n            console.error(\"[RECOVERY] Failed to restart story:\", recoveryError);\n          }\n        }\n        break;\n\n      case ErrorManager.SOURCES.DISPLAY_MANAGER:\n        if (storyManager?.display) {\n          try {\n            storyManager.display.clear();\n            console.log(\"[RECOVERY] Display cleared\");\n          } catch (recoveryError) {\n            console.error(\"[RECOVERY] Failed to clear display:\", recoveryError);\n          }\n        }\n        break;\n\n      case ErrorManager.SOURCES.SAVE_SYSTEM:\n        if (storyManager?.settings) {\n          try {\n            storyManager.settings.setSetting(\"autoSave\", false);\n            console.log(\n              \"[RECOVERY] Autosave disabled due to save system error\"\n            );\n          } catch (recoveryError) {\n            console.error(\n              \"[RECOVERY] Failed to disable autosave:\",\n              recoveryError\n            );\n          }\n        }\n        break;\n      default:\n        console.error(\"[RECOVERY] Critical error: Failed to recover\");\n    }\n  }\n}\n\nconst errorManager = new ErrorManager();\nconst ERROR_SOURCES = ErrorManager.SOURCES;\nexport { errorManager, ERROR_SOURCES };\n", "import { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\nimport { notificationManager } from \"./notification-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.MODAL);\n\n/**\n * Reusable modal dialog component with accessibility support.\n * Handles backdrop, keyboard navigation, focus trapping, and animations.\n * Used as the foundation for SavesModal, SettingsModal, and confirmation dialogs.\n */\nclass BaseModal {\n  static instances = new Set();\n\n  /**\n   * Creates the BaseModal with defaults\n   * @param {Object} options\n   * @param {string} [options.title='Modal'] - Modal title\n   * @param {string} [options.className='base-modal'] - CSS class prefix\n   * @param {string} [options.maxWidth='500px'] - Maximum width\n   * @param {string} [options.width='90%'] - Width\n   * @param {string} [options.maxHeight='80vh'] - Maximum height\n   * @param {boolean} [options.closeOnBackdrop=true] - Close when clicking backdrop\n   * @param {boolean} [options.closeOnEscape=true] - Close on Escape key\n   * @param {boolean} [options.showCloseButton=true] - Show X button\n   * @param {boolean} [options.showFooter=true] - Show footer section\n   * @param {Function} [options.onShow] - Callback when modal shows\n   * @param {Function} [options.onHide] - Callback when modal hides\n   */\n  constructor(options = {}) {\n    this.config = {\n      maxWidth: \"500px\",\n      width: \"90%\",\n      maxHeight: \"80vh\",\n      className: \"base-modal\",\n      title: \"Modal\",\n      closeOnBackdrop: true,\n      closeOnEscape: true,\n      showCloseButton: true,\n      showFooter: true,\n      size: \"normal\", // 'small', 'normal', 'large', 'wide'\n      ...options,\n    };\n\n    this.modalElement = null;\n    this.isVisible = false;\n    this.onShow = options.onShow || null;\n    this.onHide = options.onHide || null;\n    this.previouslyFocusedElement = null;\n\n    this.init();\n  }\n\n  /**\n   * Initializes the modal by creating DOM elements and setting up event listeners.\n   * Called automatically by the constructor.\n   * @private\n   */\n  init() {\n    this.createModal();\n    this.setupEventListeners();\n    BaseModal.instances.add(this);\n  }\n\n  /**\n   * Creates the modal DOM structure (backdrop and content container)\n   * and appends it to the document body.\n   * @private\n   */\n  createModal() {\n    const modalBackdrop = document.createElement(\"div\");\n    modalBackdrop.className = `base-modal-backdrop ${this.config.className}-backdrop`;\n    modalBackdrop.setAttribute(\"role\", \"presentation\");\n\n    const modalContent = document.createElement(\"div\");\n    const sizeClass = this.getSizeClass();\n    modalContent.className = `base-modal-content ${this.config.className}-content ${sizeClass}`;\n\n    modalContent.setAttribute(\"role\", \"dialog\");\n    modalContent.setAttribute(\"aria-modal\", \"true\");\n    modalContent.setAttribute(\n      \"aria-labelledby\",\n      `${this.config.className}-title`\n    );\n    modalContent.setAttribute(\"tabindex\", \"-1\");\n\n    modalContent.innerHTML = this.getModalHTML();\n    modalBackdrop.appendChild(modalContent);\n\n    if (!document.body) {\n      log.error(\"Cannot create modal - document.body not available\");\n      return;\n    }\n\n    document.body.appendChild(modalBackdrop);\n    this.modalElement = modalBackdrop;\n  }\n\n  /**\n   * Generates the inner HTML structure for the modal (header, body, footer).\n   * @returns {string} HTML string for modal contents\n   * @private\n   */\n  getModalHTML() {\n    return `\n      <div class=\"modal-header\">\n        <h2 id=\"${this.config.className}-title\" tabindex=\"-1\">${this.config.title}</h2>\n        ${\n          this.config.showCloseButton\n            ? `<button class=\"modal-close\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>`\n            : \"\"\n        }\n      </div>\n      <div class=\"modal-body\">\n        <!-- Content will be injected here -->\n      </div>\n      ${this.config.showFooter ? `<div class=\"modal-footer\"></div>` : \"\"}\n    `;\n  }\n\n  /**\n   * Sets up keyboard and click event listeners for modal interactions\n   * including focus trapping, backdrop clicks, and escape key handling.\n   * @private\n   */\n  setupEventListeners() {\n    if (!this.modalElement) return;\n\n    this.focusTrapHandler = (e) => {\n      if (e.key !== \"Tab\" || !this.isVisible) return;\n\n      const content = this.modalElement.querySelector(\n        `.${this.config.className}-content`\n      );\n      const focusable = content?.querySelectorAll(\n        'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\n      );\n      if (!focusable?.length) return;\n\n      const first = focusable[0];\n      const last = focusable[focusable.length - 1];\n\n      if (e.shiftKey && document.activeElement === first) {\n        e.preventDefault();\n        last.focus();\n      } else if (!e.shiftKey && document.activeElement === last) {\n        e.preventDefault();\n        first.focus();\n      }\n    };\n    document.addEventListener(\"keydown\", this.focusTrapHandler);\n\n    const closeBtn = this.modalElement.querySelector(\".modal-close\");\n    if (closeBtn) {\n      closeBtn.addEventListener(\"click\", () => this.hide());\n    }\n\n    if (this.config.closeOnBackdrop) {\n      this.modalElement.addEventListener(\"click\", (e) => {\n        if (e.target === this.modalElement) {\n          this.hide();\n        }\n      });\n    }\n\n    if (this.config.closeOnEscape) {\n      this.escapeHandler = (e) => {\n        if (e.key === \"Escape\" && this.isVisible) {\n          this.hide();\n        }\n      };\n      document.addEventListener(\"keydown\", this.escapeHandler);\n    }\n  }\n\n  /**\n   * Displays the modal with animation. Closes any other open modals first.\n   * Manages focus by storing the previously focused element and trapping\n   * focus within the modal while visible.\n   * @param {Function} [contentCallback] - Called with modal instance to populate content before showing\n   */\n  show(contentCallback = null) {\n    BaseModal.closeAll(this);\n    if (!this.modalElement) {\n      log.error(\"Cannot show modal - modal element not available\");\n      return;\n    }\n\n    this.previouslyFocusedElement = document.activeElement;\n\n    // Hide background content from screen readers so they don't go off script!\n    const mainContent = document.getElementById(\"main-content\");\n    const topNav = document.querySelector(\".top-nav\");\n    const skipLink = document.querySelector(\".skip-link\");\n    if (mainContent) mainContent.setAttribute(\"aria-hidden\", \"true\");\n    if (topNav) topNav.setAttribute(\"aria-hidden\", \"true\");\n    if (skipLink) skipLink.setAttribute(\"aria-hidden\", \"true\");\n\n    if (contentCallback && typeof contentCallback === \"function\") {\n      try {\n        contentCallback(this);\n      } catch (error) {\n        log.error(\"Failed to populate modal content\", error);\n      }\n    }\n\n    this.modalElement.style.display = \"block\";\n    this.isVisible = true;\n\n    requestAnimationFrame(() => {\n      if (this.modalElement) {\n        this.modalElement.style.opacity = \"1\";\n        const content = this.modalElement.querySelector(\n          `.${this.config.className}-content`\n        );\n        if (content) {\n          content.classList.add(\"modal-open\");\n        }\n        // Focus the heading first, or fall back to the dialog itself\n        const heading = content?.querySelector(\"h2\");\n        if (heading) {\n          heading.setAttribute(\"tabindex\", \"-1\");\n          heading.focus();\n        } else {\n          content?.focus();\n        }\n      }\n    });\n\n    if (this.onShow && typeof this.onShow === \"function\") {\n      try {\n        this.onShow();\n      } catch (error) {\n        log.warning(\"Modal onShow callback failed\", error);\n      }\n    }\n  }\n\n  /**\n   * Hides the modal with a fade-out animation.\n   * Restores focus to the previously focused element.\n   */\n  hide() {\n    if (!this.modalElement) return;\n\n    this.modalElement.style.opacity = \"0\";\n    const content = this.modalElement.querySelector(\n      `.${this.config.className}-content`\n    );\n\n    if (content) {\n      content.classList.remove(\"modal-open\");\n    }\n\n    setTimeout(() => {\n      if (this.modalElement) {\n        this.modalElement.style.display = \"none\";\n        this.isVisible = false;\n\n        // Restore background content to screen readers\n        const mainContent = document.getElementById(\"main-content\");\n        const topNav = document.querySelector(\".top-nav\");\n        const skipLink = document.querySelector(\".skip-link\");\n        if (mainContent) mainContent.removeAttribute(\"aria-hidden\");\n        if (topNav) topNav.removeAttribute(\"aria-hidden\");\n        if (skipLink) skipLink.removeAttribute(\"aria-hidden\");\n\n        this.previouslyFocusedElement?.focus();\n      }\n    }, 300);\n\n    if (this.onHide && typeof this.onHide === \"function\") {\n      try {\n        this.onHide();\n      } catch (error) {\n        log.warning(\"Modal onHide callback failed\", error);\n      }\n    }\n  }\n\n  /**\n   * Toggles the modal visibility (shows if hidden, hides if visible).\n   */\n  toggle() {\n    if (this.isVisible) {\n      this.hide();\n    } else {\n      this.show();\n    }\n  }\n\n  /**\n   * Display a confirmation dialog with customizable buttons\n   * @param {string} message - Confirmation message\n   * @param {Function} onConfirm - Called when confirmed\n   * @param {Function} [onCancel] - Called when cancelled\n   * @param {Object} [options]\n   * @param {string} [options.title] - Override modal title\n   * @param {string} [options.confirmText='Confirm'] - Confirm button text\n   * @param {string} [options.cancelText='Cancel'] - Cancel button text\n   * @param {string} [options.confirmVariant='danger'] - Confirm button style variant\n   */\n  showConfirmation(message, onConfirm, onCancel, options = {}) {\n    const defaults = {\n      title: \"Confirm\",\n      confirmText: \"Yes\",\n      cancelText: \"Cancel\",\n      confirmVariant: \"danger\",\n    };\n\n    const settings = { ...defaults, ...options };\n    const originalConfig = { ...this.config };\n\n    this.config.title = settings.title;\n    this.config.closeOnBackdrop = false;\n    this.config.closeOnEscape = true;\n\n    this.show((modal) => {\n      modal.setContent(\n        `<p style=\"margin: 0; color: var(--color-text-primary);\">${message}</p>`\n      );\n\n      const footer = modal.getFooter();\n      if (footer) {\n        footer.innerHTML = \"\";\n        footer.className = \"modal-footer modal-footer-right\";\n\n        const cancelBtn = modal.createButton(settings.cancelText, {\n          variant: \"secondary\",\n          onClick: () => {\n            modal.hide();\n            if (onCancel) onCancel();\n            Object.assign(this.config, originalConfig);\n          },\n        });\n\n        const confirmBtn = modal.createButton(settings.confirmText, {\n          variant: settings.confirmVariant,\n          onClick: () => {\n            modal.hide();\n            if (onConfirm) onConfirm();\n            Object.assign(this.config, originalConfig);\n          },\n        });\n\n        footer.appendChild(cancelBtn);\n        footer.appendChild(confirmBtn);\n      }\n    });\n\n    if (this.escapeHandler) {\n      document.removeEventListener(\"keydown\", this.escapeHandler);\n    }\n    this.escapeHandler = (e) => {\n      if (e.key === \"Escape\" && this.isVisible) {\n        this.hide();\n        if (onCancel) onCancel();\n        Object.assign(this.config, originalConfig);\n      }\n    };\n    document.addEventListener(\"keydown\", this.escapeHandler);\n  }\n\n  /**\n   * Sets the HTML content of the modal body.\n   * @param {string} html - HTML string to insert into the modal body\n   */\n  setContent(html) {\n    const body = this.modalElement?.querySelector(\".modal-body\");\n    if (body) {\n      body.innerHTML = html;\n    }\n  }\n\n  /**\n   * Sets the HTML content of the modal footer.\n   * @param {string} html - HTML string to insert into the modal footer\n   */\n  setFooter(html) {\n    const footer = this.modalElement?.querySelector(\".modal-footer\");\n    if (footer) {\n      footer.innerHTML = html;\n    }\n  }\n\n  /**\n   * Returns the modal body element for direct manipulation.\n   * @returns {HTMLElement|null} The modal body element, or null if not found\n   */\n  getBody() {\n    return this.modalElement?.querySelector(\".modal-body\");\n  }\n\n  /**\n   * Returns the modal footer element for direct manipulation.\n   * @returns {HTMLElement|null} The modal footer element, or null if not found\n   */\n  getFooter() {\n    return this.modalElement?.querySelector(\".modal-footer\");\n  }\n\n  /**\n   * Returns the appropriate size class based on config.maxWidth\n   * @returns {string} CSS class name for modal size\n   * @private\n   */\n  getSizeClass() {\n    const sizeMap = {\n      \"400px\": \"modal-small\",\n      \"500px\": \"modal-medium\",\n      \"600px\": \"modal-large\",\n      \"700px\": \"modal-wide\",\n    };\n    return sizeMap[this.config.maxWidth] || \"modal-medium\";\n  }\n\n  /**\n   * Attach event listeners to elements within the modal body\n   * @param {string} selector - CSS selector for target elements\n   * @param {string} event - Event type (e.g., 'click')\n   * @param {Function} handler - Event handler\n   */\n  addBodyEventListener(selector, event, handler) {\n    if (!this.modalElement) return;\n\n    const elements = this.modalElement.querySelectorAll(selector);\n    elements.forEach((element) => {\n      element.addEventListener(event, handler);\n    });\n  }\n\n  /**\n   * @param {string} text - Button label\n   * @param {Object} [options]\n   * @param {string} [options.variant='primary'] - Style variant: 'primary', 'secondary', 'danger'\n   * @param {Function} [options.onClick] - Click handler\n   * @param {Object} [options.styles] - Additional inline styles\n   * @returns {HTMLButtonElement}\n   */\n  createButton(text, options = {}) {\n    const button = document.createElement(\"button\");\n    button.textContent = text;\n\n    button.className = `modal-button modal-button-${options.variant || \"primary\"}`;\n\n    if (options.onClick && typeof options.onClick === \"function\") {\n      button.addEventListener(\"click\", options.onClick);\n    }\n\n    if (options.styles) {\n      Object.entries(options.styles).forEach(([property, value]) => {\n        button.style[property] = value;\n      });\n    }\n\n    return button;\n  }\n\n  /**\n   * Displays a toast notification using the global notification manager.\n   * @param {string} message - The message to display\n   * @param {boolean} [isError=false] - Whether this is an error notification\n   * @param {number} [duration=4000] - How long to show the notification in milliseconds\n   */\n  showNotification(message, isError = false, duration = 4000) {\n    const type = isError ? \"error\" : \"success\";\n    notificationManager.show(message, { type, duration });\n  }\n\n  /**\n   * Checks whether the modal is ready to be shown.\n   * @returns {boolean} True if the modal element exists and document.body is available\n   */\n  isReady() {\n    return !!(this.modalElement && document.body);\n  }\n\n  /**\n   * Returns diagnostic information about the modal's current state.\n   * Useful for debugging.\n   * @returns {{hasModalElement: boolean, isVisible: boolean, className: string, hasEscapeHandler: boolean, size: string}}\n   */\n  getStats() {\n    return {\n      hasModalElement: !!this.modalElement,\n      isVisible: this.isVisible,\n      className: this.config.className,\n      hasEscapeHandler: !!this.escapeHandler,\n      size: this.config.size,\n    };\n  }\n\n  /**\n   * Cleans up the modal by removing event listeners, removing the DOM element,\n   * and unregistering from the static instances set. Call this when you're done\n   * with a modal to prevent memory leaks.\n   */\n  destroy() {\n    try {\n      BaseModal.instances.delete(this);\n      if (this.escapeHandler) {\n        document.removeEventListener(\"keydown\", this.escapeHandler);\n        this.escapeHandler = null;\n      }\n      if (this.focusTrapHandler) {\n        document.removeEventListener(\"keydown\", this.focusTrapHandler);\n        this.focusTrapHandler = null;\n      }\n\n      // Restore background content to screen readers\n      const mainContent = document.getElementById(\"main-content\");\n      const topNav = document.querySelector(\".top-nav\");\n      const skipLink = document.querySelector(\".skip-link\");\n      if (mainContent) mainContent.removeAttribute(\"aria-hidden\");\n      if (topNav) topNav.removeAttribute(\"aria-hidden\");\n      if (skipLink) skipLink.removeAttribute(\"aria-hidden\");\n\n      // Restore focus before removing element\n      this.previouslyFocusedElement?.focus();\n\n      if (this.modalElement && this.modalElement.parentNode) {\n        this.modalElement.parentNode.removeChild(this.modalElement);\n      }\n\n      this.modalElement = null;\n      this.isVisible = false;\n    } catch (error) {\n      log.warning(\"Failed to destroy modal\", error);\n    }\n  }\n\n  /**\n   * Close all currently visible modals\n   * @param {BaseModal} except - Optional modal to skip (don't close this one)\n   */\n  static closeAll(except = null) {\n    for (const modal of BaseModal.instances) {\n      if (modal !== except && modal.isVisible) {\n        modal.hide();\n      }\n    }\n  }\n\n  /**\n   * Checks if any modal instance is currently visible.\n   * @returns {boolean} True if at least one modal is visible\n   */\n  static hasVisibleModal() {\n    for (const modal of BaseModal.instances) {\n      if (modal.isVisible) return true;\n    }\n    return false;\n  }\n\n  /**\n   * Static helper for one-off confirmation dialogs. Creates a temporary modal and cleans up after.\n   * @param {Object} options\n   * @param {string} options.title - Dialog title\n   * @param {string} options.message - Confirmation message\n   * @param {string} [options.confirmText='Yes'] - Confirm button text\n   * @param {string} [options.cancelText='Cancel'] - Cancel button text\n   * @param {string} [options.confirmVariant='danger'] - Confirm button style\n   * @param {Function} [options.onConfirm] - Called when confirmed\n   * @param {Function} [options.onCancel] - Called when cancelled\n   */\n  static confirm({\n    title,\n    message,\n    confirmText = \"Yes\",\n    cancelText = \"Cancel\",\n    confirmVariant = \"danger\",\n    onConfirm,\n    onCancel,\n  }) {\n    const modal = new BaseModal({\n      title: title || \"Confirm\",\n      className: \"confirm-modal\",\n      maxWidth: \"400px\",\n      showFooter: true,\n    });\n\n    modal.showConfirmation(\n      message,\n      () => {\n        onConfirm?.();\n        modal.destroy();\n      },\n      () => {\n        onCancel?.();\n        modal.destroy();\n      },\n      { title, confirmText, cancelText, confirmVariant }\n    );\n  }\n}\n\nexport { BaseModal };\n", "import { Story } from \"inkjs\";\nimport { notificationManager } from \"./notification-manager.js\";\nimport { InkFunctions } from \"./ink-functions.js\";\nimport { BaseModal } from \"./base-modal.js\";\nimport { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.STORY_MANAGER);\n\n/**\n * Central coordinator for the ink story engine.\n * Manages story state, content generation, choices, saves, and special pages.\n * Dependencies are injected via constructor and wired by main.js.\n */\nclass StoryManager {\n  /**\n   * Creates the story manager with injected dependencies.\n   * @param {Object} storyContent - Compiled ink story JSON\n   * @param {Object} options - Injected dependencies\n   * @param {Object} options.display - DisplayManager instance\n   * @param {Object} options.settings - SettingsManager instance\n   * @param {Object} options.contentProcessor - ContentProcessor instance\n   */\n  constructor(storyContent, { display, settings, contentProcessor }) {\n    try {\n      this.story = new Story(storyContent);\n      InkFunctions.bindAll(this.story);\n\n      this.savePoint = \"\";\n      this.display = display;\n      this.settings = settings;\n      this.contentProcessor = contentProcessor;\n\n      // Wired by main.js after construction\n      this.pages = null;\n      this.choices = null;\n      this.navigation = null;\n      this.saves = null;\n    } catch (error) {\n      log.critical(\"Failed to initialize story\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * Starts the story after all dependencies have been wired.\n   * Detects special pages, processes global tags, and begins content generation.\n   * @throws {Error} If required dependencies are not wired\n   */\n  start() {\n    const required = {\n      display: this.display,\n      settings: this.settings,\n      contentProcessor: this.contentProcessor,\n      pages: this.pages,\n      choices: this.choices,\n      navigation: this.navigation,\n      saves: this.saves,\n    };\n\n    const missing = Object.entries(required)\n      .filter(([_, value]) => !value)\n      .map(([key]) => key);\n\n    if (missing.length > 0) {\n      throw new Error(\n        `StoryManager.start() called before wiring dependencies: ${missing.join(\", \")}`\n      );\n    }\n\n    this.pages.detectSpecialPages();\n\n    try {\n      // Process global tags for theme, metadata, and menu order\n      this.settings.processGlobalTags(this.story.globalTags);\n      this.pages.processMenuOrderTag(this.story.globalTags);\n      this.navigation.updateVisibility(\n        this.pages.availablePages,\n        this.pages.pageMenuOrder\n      );\n      // Set initial save point and start\n      this.savePoint = this.story.state.ToJson();\n      this.continue(true);\n    } catch (error) {\n      log.error(\"Failed to setup initial state\", error);\n    }\n  }\n\n  /**\n   * Continues the story, generating and rendering new content.\n   * Clears display (unless first time), processes content, and creates choices.\n   * @param {boolean} [isFirstTime=false] - Whether this is the initial story load\n   */\n  continue(isFirstTime = false) {\n    try {\n      if (this.pages?.isViewingSpecialPage()) return;\n\n      if (!isFirstTime) {\n        this.display?.clear?.();\n        this.display?.scrollToTop?.();\n      }\n\n      const {\n        content: storyContent,\n        stoppedForUserInput,\n        stateBeforeUserInput,\n      } = this.generateContent();\n\n      if (storyContent.length > 0) {\n        this.display?.render?.(storyContent);\n        document.dispatchEvent(\n          new CustomEvent(\"story:content\", {\n            detail: { content: storyContent },\n          })\n        );\n\n        // Focus story container for screen readers (not on initial load)\n        if (!isFirstTime) {\n          this.display?.container?.focus();\n        }\n      }\n\n      // Fire start event on first load\n      // Use setTimeout to ensure window.InkTemplate.storyManager is assigned\n      if (isFirstTime) {\n        setTimeout(\n          () => document.dispatchEvent(new CustomEvent(\"story:start\")),\n          0\n        );\n      }\n\n      // Store state for user input restoration\n      if (stoppedForUserInput && stateBeforeUserInput) {\n        this.stateBeforeUserInput = stateBeforeUserInput;\n      }\n\n      // Only generate choices if we didn't stop for user input\n      if (!stoppedForUserInput) {\n        this.createChoices();\n      }\n\n      if (!stoppedForUserInput && this.hasEnded()) {\n        document.dispatchEvent(new CustomEvent(\"story:end\"));\n      }\n\n      // Update save point after generating new content\n      this.savePoint = this.story.state.ToJson();\n    } catch (error) {\n      log.error(\"Failed to continue story\", error);\n    }\n  }\n\n  /**\n   * Continues the story without clearing the display.\n   * Used after user input submission to append new content.\n   */\n  continueWithoutClearing() {\n    try {\n      if (this.pages?.isViewingSpecialPage()) return;\n\n      const { content: storyContent } = this.generateContent();\n      if (storyContent.length > 0) {\n        this.display?.render?.(storyContent);\n      }\n\n      this.createChoices();\n\n      // Update save point after generating new content\n      this.savePoint = this.story.state.ToJson();\n    } catch (error) {\n      log.error(\"Failed to continue story without clearing\", error);\n    }\n  }\n\n  /**\n   * Generates and renders the current story choices.\n   * @private\n   */\n  createChoices() {\n    try {\n      if (this.story.currentChoices?.length > 0) {\n        const choices = this.choices?.generate?.(this.story.currentChoices);\n        if (choices) {\n          // Always include hints in HTML - CSS handles visibility via container class\n          this.display?.renderChoices?.(choices, true);\n        }\n      }\n    } catch (error) {\n      log.error(\"Failed to create choices\", error, \"choices\");\n    }\n  }\n\n  /**\n   * Selects a choice by index and continues the story.\n   * Removes existing choices, advances the story, triggers autosave.\n   * @param {number} choiceIndex - Index of the choice to select\n   */\n  selectChoice(choiceIndex) {\n    try {\n      if (\n        typeof choiceIndex !== \"number\" ||\n        choiceIndex < 0 ||\n        choiceIndex >= this.story.currentChoices.length\n      ) {\n        throw new Error(`Invalid choice index: ${choiceIndex}`);\n      }\n\n      this.display?.container\n        ?.querySelectorAll?.(\".choice\")\n        .forEach((choice) => {\n          choice.remove();\n        });\n\n      this.story.ChooseChoiceIndex(choiceIndex);\n      document.dispatchEvent(\n        new CustomEvent(\"story:choice\", {\n          detail: { index: choiceIndex },\n        })\n      );\n\n      this.savePoint = this.story.state.ToJson();\n\n      this.continue();\n      this.saves?.autosave?.();\n    } catch (error) {\n      log.error(\"Failed to select choice\", error, \"navigation\");\n    }\n  }\n\n  /**\n   * Restarts the story from the beginning.\n   * Resets story state, display, and page manager.\n   */\n  restart() {\n    try {\n      document.dispatchEvent(new CustomEvent(\"story:restart\"));\n      this.story.ResetState();\n      this.display?.reset?.();\n      this.pages?.reset?.();\n      this.savePoint = this.story.state.ToJson();\n      this.continue(true);\n      this.display?.scrollToTop?.();\n\n      notificationManager.success?.(\"Story restarted from the beginning\");\n    } catch (error) {\n      log.error(\"Failed to restart story\", error);\n    }\n  }\n\n  /**\n   * Show confirmation dialog before restarting\n   * Called by all restart entry points (keyboard, button, title, tag)\n   */\n  confirmRestart() {\n    BaseModal.confirm({\n      title: \"Restart Story\",\n      message:\n        \"Are you sure you want to restart the story from the beginning? Any unsaved progress will be lost.\",\n      confirmText: \"Restart\",\n      cancelText: \"Cancel\",\n      confirmVariant: \"primary\",\n      onConfirm: () => this.restart(),\n    });\n  }\n\n  /**\n   * Generates content by advancing the story until choices or user input.\n   * @returns {{content: Array, stoppedForUserInput: boolean, stateBeforeUserInput: string|null}}\n   * @private\n   */\n  generateContent() {\n    const content = [];\n    let stoppedForUserInput = false;\n\n    // Save state once at start \u2014 used to replay after user input\n    const stateAtStart = this.story.state.ToJson();\n\n    try {\n      while (this.story.canContinue) {\n        const text = this.story.Continue();\n        const tags = this.story.currentTags || [];\n\n        if (text.trim().length === 0 && tags.length === 0) continue;\n\n        const processedContent = this.contentProcessor?.process?.(text, tags);\n        if (processedContent) {\n          if (Array.isArray(processedContent)) {\n            content.push(...processedContent);\n            if (processedContent.some((item) => item.type === \"user-input\")) {\n              stoppedForUserInput = true;\n              break;\n            }\n          } else {\n            content.push(processedContent);\n            if (processedContent.type === \"user-input\") {\n              stoppedForUserInput = true;\n              break;\n            }\n          }\n        }\n\n        if (processedContent?.hasSpecialAction) {\n          const shouldContinue = this.handleSpecialAction(\n            processedContent.action\n          );\n          if (!shouldContinue) {\n            break;\n          }\n        }\n      }\n    } catch (error) {\n      log.error(\"Error generating story content\", error);\n    }\n\n    return {\n      content,\n      stoppedForUserInput,\n      stateBeforeUserInput: stoppedForUserInput ? stateAtStart : null,\n    };\n  }\n\n  /**\n   * Handles special actions like CLEAR and RESTART from content tags.\n   * @param {string} actionResult - The action to handle\n   * @returns {boolean} True if story should continue processing, false to stop\n   * @private\n   */\n  handleSpecialAction(actionResult) {\n    try {\n      if (typeof actionResult === \"string\") {\n        switch (actionResult) {\n          case \"CLEAR\":\n            this.display?.clear?.();\n            this.display?.hideHeader?.();\n            return true;\n          case \"RESTART\":\n            this.confirmRestart();\n            return false;\n          default:\n            return true;\n        }\n      }\n      return true;\n    } catch (error) {\n      log.error(\"Failed to handle special action\", error);\n      return true;\n    }\n  }\n\n  /**\n   * Gets the complete current state for saving.\n   * @returns {{gameState: string, displayState: Object|null, currentPage: string|null, savePoint: string, timestamp: number}}\n   */\n  getCurrentState() {\n    try {\n      return {\n        gameState: this.story.state.ToJson(),\n        displayState: this.display?.getState?.() || null,\n        currentPage: this.pages?.currentPage,\n        savePoint: this.savePoint,\n        timestamp: Date.now(),\n      };\n    } catch (error) {\n      log.error(\"Failed to get current state\", error);\n      return {};\n    }\n  }\n\n  /**\n   * Loads a previously saved state.\n   * Restores story state, display, and recreates choices.\n   * @param {Object} state - The saved state object\n   * @param {string} state.gameState - Serialized ink story state\n   * @param {Object} [state.displayState] - Saved display history\n   * @param {string} [state.currentPage] - Current special page knot name\n   * @param {string} [state.savePoint] - Serialized save point state\n   */\n  loadState(state) {\n    try {\n      if (!state?.gameState) {\n        throw new Error(\"Invalid save state\");\n      }\n\n      const testStory = this.createTempStory();\n      testStory.state.LoadJson(state.gameState);\n\n      this.story.state.LoadJson(state.gameState);\n      this.pages.currentPage = state.currentPage || null;\n      this.savePoint = state.savePoint || this.story.state.ToJson();\n\n      this.pages?.reset?.();\n\n      // Restore stateBeforeUserInput if it was saved\n      this.stateBeforeUserInput = state.stateBeforeUserInput || null;\n\n      let hasUserInput = false;\n\n      if (state.displayState) {\n        this.display?.restoreState?.(state.displayState);\n\n        // Check if the restored state has a pending user-input\n        hasUserInput = state.displayState.history?.some(\n          (item) => item.type === \"user-input\"\n        );\n      } else {\n        this.display?.clear?.();\n        this.regenerateCurrentDisplay();\n      }\n\n      // Only create choices if there's no pending user input\n      if (!hasUserInput) {\n        this.createChoices();\n      }\n\n      this.display?.scrollToTop?.();\n    } catch (error) {\n      log.error(\"Failed to load state\", error, \"save-system\");\n    }\n  }\n\n  /**\n   * Regenerates display from current story text (fallback recovery).\n   * @private\n   */\n  regenerateCurrentDisplay() {\n    try {\n      const currentText = this.story.state.currentText;\n\n      if (currentText?.trim?.().length > 0) {\n        const content = [\n          {\n            text: currentText,\n            classes: [],\n          },\n        ];\n        this.display?.render?.(content);\n      }\n    } catch (error) {\n      log.error(\"Failed to regenerate display\", error, \"display\");\n    }\n  }\n\n  /**\n   * Checks if the story can continue (has more content to generate).\n   * @returns {boolean} True if story.canContinue is true\n   */\n  canContinue() {\n    try {\n      return this.story.canContinue;\n    } catch (error) {\n      log.warning(\"Failed to check canContinue\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Checks if the story currently has choices available.\n   * @returns {boolean} True if there are current choices\n   */\n  hasChoices() {\n    try {\n      return this.story.currentChoices?.length > 0;\n    } catch (error) {\n      log.warning(\"Failed to check hasChoices\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Checks if the story has ended (no more content or choices).\n   * @returns {boolean} True if story cannot continue and has no choices\n   */\n  hasEnded() {\n    return !this.canContinue() && !this.hasChoices();\n  }\n\n  /**\n   * Create a temporary story instance with external functions bound\n   * @returns {Story} A new story instance with functions bound\n   */\n  createTempStory() {\n    const tempStory = new Story(this.story.ToJson());\n    InkFunctions.bindAll(tempStory);\n    return tempStory;\n  }\n\n  /**\n   * Returns diagnostic information about the story state.\n   * @returns {{currentTurnIndex: number, hasEnded: boolean, canContinue: boolean, hasChoices: boolean, currentPage: string|null, displayLength: number, specialPagesFound: number}}\n   */\n  getStats() {\n    try {\n      return {\n        currentTurnIndex: this.story.state.currentTurnIndex,\n        hasEnded: this.hasEnded(),\n        canContinue: this.canContinue(),\n        hasChoices: this.hasChoices(),\n        currentPage: this.pages?.currentPage,\n        displayLength: this.display?.getHistoryLength?.() || 0,\n        specialPagesFound: Object.keys(this.pages?.availablePages || {}).length,\n      };\n    } catch (error) {\n      log.warning(\"Failed to get stats\", error);\n      return {};\n    }\n  }\n\n  /**\n   * Returns information about available story features.\n   * @returns {{availablePages: Object, hasGlobalTags: boolean, hasCurrentTags: boolean, specialPageCount: number}}\n   */\n  getFeatureInfo() {\n    return {\n      availablePages: { ...this.pages?.availablePages },\n      hasGlobalTags: this.story.globalTags?.length > 0,\n      hasCurrentTags: this.story.currentTags?.length > 0,\n      specialPageCount: Object.keys(this.pages?.availablePages || {}).length,\n    };\n  }\n\n  /**\n   * Cleans up resources when the story manager is disposed.\n   */\n  cleanup() {\n    try {\n      this.saves?.cleanup?.();\n      this.settings?.cleanup?.();\n      this.pages?.reset?.();\n    } catch (error) {\n      log.warning(\"Failed to cleanup\", error, \"system\");\n    }\n  }\n}\n\nexport { StoryManager };\n", "/**\n * Phases when tags are processed.\n * @enum {string}\n */\nconst TAG_PHASE = {\n  GLOBAL: \"global\", // Processed once at story init (settings.js)\n  DISCOVERY: \"discovery\", // Processed during page/knot scanning (story-manager.js)\n  CONTENT: \"content\", // Determines content type per-line (content-processor.js)\n  EFFECT: \"effect\", // Side effects per-line (tags.js)\n};\n\n/**\n * Whether a tag requires, optionally accepts, or rejects a value.\n * @enum {string}\n */\nconst TAG_VALUE = {\n  REQUIRED: \"required\", // Must have value: `TAG: value`\n  OPTIONAL: \"optional\", // Can be `TAG` or `TAG: value`\n  NONE: \"none\", // Never has value: just `TAG`\n};\n\n/**\n * Registry of all known ink tags with their aliases, phases, value requirements, and descriptions.\n * Each tag definition has: names (array of aliases), phase, value requirement, and description.\n * @type {Object.<string, {names: string[], phase: string, value: string, description: string}>}\n */\nconst TAGS = {\n  // ============================================\n  // GLOBAL TAGS (settings.js) - processed at init\n  // ============================================\n  THEME: {\n    names: [\"THEME\"],\n    phase: TAG_PHASE.GLOBAL,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Set default theme (light/dark)\",\n  },\n  AUTHOR: {\n    names: [\"AUTHOR\"],\n    phase: TAG_PHASE.GLOBAL,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Story author name\",\n  },\n  TITLE: {\n    names: [\"TITLE\"],\n    phase: TAG_PHASE.GLOBAL,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Story title\",\n  },\n  TONE: {\n    names: [\"TONE\"],\n    phase: TAG_PHASE.GLOBAL,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Define tone indicator (e.g., TONE: flirty \uD83D\uDD25)\",\n  },\n  TONE_INDICATORS: {\n    names: [\"TONE_INDICATORS\", \"SHOW_TONES\"],\n    phase: TAG_PHASE.GLOBAL,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Enable tone indicators (on/off)\",\n  },\n  TONE_TRAILING: {\n    names: [\"TONE_TRAILING\", \"TRAILING_TONES\"],\n    phase: TAG_PHASE.GLOBAL,\n    value: TAG_VALUE.NONE,\n    description: \"Show all tone icons after choice text\",\n  },\n  CHOICE_NUMBERS: {\n    names: [\"CHOICE_NUMBERS\", \"CHOICE_NUMBERING\", \"KEYBOARD_HINTS\"],\n    phase: TAG_PHASE.GLOBAL,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Choice numbering mode (auto/on/off)\",\n  },\n  PAGE_MENU: {\n    names: [\n      \"PAGE_MENU\",\n      \"MENU\",\n      \"MENU_ORDER\",\n      \"PAGE_ORDER\",\n      \"SPECIAL_PAGE_ORDER\",\n    ],\n    phase: TAG_PHASE.GLOBAL,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Define page menu order\",\n  },\n\n  // ============================================\n  // DISCOVERY TAGS (story-manager.js) - page scanning\n  // ============================================\n  SPECIAL_PAGE: {\n    names: [\"SPECIAL_PAGE\", \"PAGE\"],\n    phase: TAG_PHASE.DISCOVERY,\n    value: TAG_VALUE.OPTIONAL,\n    description: \"Mark knot as special page, optionally with display name\",\n  },\n\n  // ============================================\n  // CONTENT TAGS (content-processor.js) - determine content type\n  // ============================================\n  IMAGE: {\n    names: [\"IMAGE\", \"IMG\", \"PICTURE\", \"PIC\"],\n    phase: TAG_PHASE.CONTENT,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Display image (src, alignment, width, alt)\",\n  },\n  STATBAR: {\n    names: [\"STATBAR\", \"STAT_BAR\", \"PROGRESSBAR\", \"PROGRESS_BAR\"],\n    phase: TAG_PHASE.CONTENT,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Display stat bar (variable, min, max, labels)\",\n  },\n  USER_INPUT: {\n    names: [\"USER_INPUT\", \"INPUT\", \"PROMPT\", \"TEXT_INPUT\"],\n    phase: TAG_PHASE.CONTENT,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Text input field (variable, placeholder)\",\n  },\n\n  // ============================================\n  // EFFECT TAGS (tags.js) - side effects and styling\n  // ============================================\n  AUDIO: {\n    names: [\"AUDIO\", \"SOUND\", \"SFX\", \"SOUND_EFFECT\"],\n    phase: TAG_PHASE.EFFECT,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Play one-shot audio file\",\n  },\n  AUDIOLOOP: {\n    names: [\"AUDIOLOOP\", \"AUDIO_LOOP\", \"MUSIC\", \"BACKGROUND_MUSIC\", \"BGM\"],\n    phase: TAG_PHASE.EFFECT,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Play looping audio (or 'none' to stop)\",\n  },\n  BACKGROUND: {\n    names: [\"BACKGROUND\", \"BG\", \"BACKGROUND_IMAGE\"],\n    phase: TAG_PHASE.EFFECT,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Set background image (or 'none' to remove)\",\n  },\n  NOTIFICATION: {\n    names: [\"NOTIFICATION\", \"NOTIFY\", \"MESSAGE\", \"INFO\"],\n    phase: TAG_PHASE.EFFECT,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Show info notification\",\n  },\n  ACHIEVEMENT: {\n    names: [\"ACHIEVEMENT\", \"SUCCESS\"],\n    phase: TAG_PHASE.EFFECT,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Show success notification (6s duration)\",\n  },\n  WARNING: {\n    names: [\"WARNING\", \"WARN\"],\n    phase: TAG_PHASE.EFFECT,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Show warning notification\",\n  },\n  ERROR: {\n    names: [\"ERROR\", \"ERR\"],\n    phase: TAG_PHASE.EFFECT,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Show error notification\",\n  },\n  CLASS: {\n    names: [\"CLASS\", \"CSS\", \"CSS_CLASS\", \"STYLE\"],\n    phase: TAG_PHASE.EFFECT,\n    value: TAG_VALUE.REQUIRED,\n    description: \"Add CSS class to element\",\n  },\n  CLEAR: {\n    names: [\"CLEAR\"],\n    phase: TAG_PHASE.EFFECT,\n    value: TAG_VALUE.NONE,\n    description: \"Clear story content\",\n  },\n  RESTART: {\n    names: [\"RESTART\", \"RESET\", \"NEW_GAME\"],\n    phase: TAG_PHASE.EFFECT,\n    value: TAG_VALUE.NONE,\n    description: \"Restart story from beginning\",\n  },\n  UNCLICKABLE: {\n    names: [\"UNCLICKABLE\", \"DISABLED\", \"DISABLE\"],\n    phase: TAG_PHASE.EFFECT,\n    value: TAG_VALUE.NONE,\n    description: \"Make choice visible but not clickable\",\n  },\n};\n\n// Ensure each tag has a \"names\" array.\n// If absent, default to [tagKey].\nfor (const key in TAGS) {\n  if (!TAGS[key].names) {\n    TAGS[key].names = [key];\n  }\n}\n\n/**\n * Reverse lookup map from tag name/alias (uppercase) to canonical TAGS key.\n * Built automatically from TAGS definitions.\n * @type {Object.<string, string>}\n */\nconst TAG_LOOKUP = {};\n\nfor (const key in TAGS) {\n  for (const name of TAGS[key].names) {\n    const upper = name.toUpperCase();\n\n    if (TAG_LOOKUP[upper]) {\n      console.warn(\n        `Duplicate tag alias \"${upper}\" used by both \"${TAG_LOOKUP[upper]}\" and \"${key}\"`\n      );\n    }\n\n    TAG_LOOKUP[upper] = key;\n  }\n}\n\n/**\n * Gets all tags for a specific phase\n * @param {string} phase - TAG_PHASE value\n * @returns {string[]} Array of tag names\n */\nfunction getTagsByPhase(phase) {\n  return Object.keys(TAGS).filter((tag) => TAGS[tag].phase === phase);\n}\n\n/**\n * Checks if a tag name is a known registered tag.\n * @param {string} tagName - Tag name to check (case-insensitive)\n * @returns {boolean} True if tag is known\n */\nfunction isKnownTag(tagName) {\n  if (!tagName || typeof tagName !== \"string\") return false;\n  return TAG_LOOKUP[tagName.toUpperCase()] !== undefined;\n}\n\n/**\n * Gets a tag definition\n * @param {string} tagName - Tag name (case-insensitive)\n * @returns {Object|null} Tag definition or null\n */\nfunction getTagDef(tagName) {\n  if (!tagName || typeof tagName !== \"string\") return null;\n  const key = TAG_LOOKUP[tagName.toUpperCase()];\n  return key ? TAGS[key] : null;\n}\n\n/**\n * Validate tag value against its requirements\n * @param {Object} tagDef - Tag definition from TAGS\n * @param {string} tagValue - The parsed value\n * @returns {{valid: boolean, error: string|null}}\n */\nfunction validateTagValue(tagDef, tagValue) {\n  if (!tagDef) return { valid: true, error: null };\n\n  const hasValue = tagValue && tagValue.trim() !== \"\";\n  const tagName = tagDef.names[0];\n\n  if (tagDef.value === TAG_VALUE.REQUIRED && !hasValue) {\n    return {\n      valid: false,\n      error: `Tag \"${tagName}\" requires a value (use # ${tagName}: value)`,\n    };\n  }\n  if (tagDef.value === TAG_VALUE.NONE && hasValue) {\n    return {\n      valid: false,\n      error: `Tag \"${tagName}\" should not have a value (use # ${tagName} alone)`,\n    };\n  }\n  return { valid: true, error: null };\n}\n\n/**\n * Central registry for ink tag definitions and utilities.\n * Provides tag parsing, validation, tone indicator management, and lookup functions.\n */\nconst TagRegistry = {\n  TAG_PHASE,\n  TAG_VALUE,\n  TAGS,\n  TAG_LOOKUP,\n  getTagsByPhase,\n  isKnownTag,\n  getTagDef,\n  validateTagValue,\n\n  /**\n   * Parses a tag string into its definition and value.\n   * Validates that required tags have values and none-value tags don't.\n   * @param {string} tag - The raw tag string (e.g., \"IMAGE: hero.png\" or \"CLEAR\")\n   * @returns {{tagDef: Object|null, tagValue: string, invalid: boolean, error: string|null}}\n   */\n  parseTag(tag) {\n    if (!tag || typeof tag !== \"string\") {\n      return { tagDef: null, tagValue: \"\", invalid: false, error: null };\n    }\n\n    const splitTag = this.splitPropertyTag(tag);\n    const tagName = splitTag ? splitTag.property : tag.trim();\n    const tagValue = splitTag?.val || \"\";\n    const tagDef = this.getTagDef(tagName);\n\n    if (tagDef) {\n      const validation = this.validateTagValue(tagDef, tagValue);\n      if (!validation.valid) {\n        return { tagDef, tagValue, invalid: true, error: validation.error };\n      }\n    }\n\n    return { tagDef, tagValue, invalid: false, error: null };\n  },\n\n  /**\n   * Splits a property-style tag into property name and value.\n   * @param {string} tag - Tag string to split\n   * @returns {{property: string, val: string}|null} Split result, or null if no colon\n   */\n  splitPropertyTag(tag) {\n    if (!tag || typeof tag !== \"string\") return null;\n\n    const colonIdx = tag.indexOf(\":\");\n    if (colonIdx === -1) return null;\n\n    return {\n      property: tag.slice(0, colonIdx).trim(),\n      val: tag.slice(colonIdx + 1).trim(),\n    };\n  },\n\n  /**\n   * Checks if an array of tags contains the SPECIAL_PAGE tag.\n   * @param {string[]} tags - Array of tag strings\n   * @returns {boolean} True if SPECIAL_PAGE tag is present\n   */\n  hasSpecialPageTag(tags) {\n    if (!Array.isArray(tags)) return false;\n\n    return tags.some((tag) => {\n      if (typeof tag !== \"string\") return false;\n      const { tagDef } = this.parseTag(tag);\n      return tagDef === TAGS.SPECIAL_PAGE;\n    });\n  },\n\n  // Tone indicator registry (populated from # TONE: tags)\n  toneMap: {},\n\n  /**\n   * Registers a tone indicator with its icon.\n   * Called when processing global # TONE: tags.\n   * @param {string} label - The tone label (e.g., \"flirty\")\n   * @param {string} icon - The icon (emoji or material icon name)\n   */\n  registerTone(label, icon) {\n    if (!label || typeof label !== \"string\") return;\n    this.toneMap[label.toLowerCase()] = icon;\n  },\n\n  /**\n   * Gets the icon for a registered tone.\n   * @param {string} label - The tone label (case-insensitive)\n   * @returns {string|null} The icon, or null if not registered\n   */\n  getToneIcon(label) {\n    if (!label || typeof label !== \"string\") return null;\n    return this.toneMap[label.toLowerCase()] || null;\n  },\n\n  /**\n   * Checks if a tag name is a registered tone indicator.\n   * @param {string} tagName - The tag name to check (case-insensitive)\n   * @returns {boolean} True if this is a registered tone\n   */\n  isRegisteredToneTag(tagName) {\n    if (!tagName || typeof tagName !== \"string\") return false;\n    return tagName.toLowerCase() in this.toneMap;\n  },\n\n  /**\n   * Clears all registered tone indicators.\n   * Used primarily for testing.\n   */\n  clearTones() {\n    this.toneMap = {};\n  },\n};\n\n/**\n * Detects which optional features a story uses by scanning the compiled JSON.\n * Used to conditionally show UI elements (e.g., audio settings tab).\n */\nconst StoryFeatures = {\n  hasAudio: false,\n\n  /**\n   * Scans compiled story JSON to detect feature usage.\n   * Sets feature flags like hasAudio based on tag presence.\n   * @param {Object} storyContent - The compiled ink story JSON\n   * @returns {StoryFeatures} Returns this for chaining\n   */\n  scan(storyContent) {\n    const content = JSON.stringify(storyContent);\n\n    const usesAnyTag = (...tagDefs) => {\n      const names = tagDefs.flatMap((def) => def?.names || []);\n      if (!names.length) return false;\n      return new RegExp(`\"\\\\^(${names.join(\"|\")})\\\\s*:`, \"i\").test(content);\n    };\n\n    this.hasAudio = usesAnyTag(TAGS.AUDIO, TAGS.AUDIOLOOP);\n\n    return this;\n  },\n};\n\nexport { TAG_PHASE, TAG_VALUE, TAGS, TAG_LOOKUP, TagRegistry, StoryFeatures };\n", "/**\n * Static utility functions for platform detection, string formatting, and algorithms.\n */\nconst Utils = {\n  /**\n   * Detects if the device is mobile based on pointer capabilities.\n   * Returns true for touch-only devices, false for devices with fine pointers (mouse).\n   * @returns {boolean} True if device appears to be mobile\n   */\n  isMobile() {\n    return (\n      window.matchMedia(\"(pointer: coarse)\").matches &&\n      !window.matchMedia(\"(pointer: fine)\").matches\n    );\n  },\n\n  /**\n   * Detects if the operating system is macOS.\n   * Used to show correct modifier key labels (Cmd vs Ctrl).\n   * @returns {boolean} True if running on macOS\n   */\n  isMac() {\n    return (\n      navigator.userAgentData?.platform === \"macOS\" ||\n      navigator.platform.toUpperCase().includes(\"MAC\")\n    );\n  },\n\n  /**\n   * Format Ink knot names for display (fallback when no display name is specified)\n   * @param {string} knotName - Raw knot name\n   * @returns {string} Formatted display name\n   */\n  formatKnotName(knotName) {\n    return knotName\n      .replace(/([a-z])([A-Z])/g, \"$1 $2\") // camelCase to words\n      .replace(/([A-Z]+)([A-Z][a-z])/g, \"$1 $2\") // multiple caps NPCDialogue -> NPC Dialogue\n      .replace(/_/g, \" \") // snake_case to words\n      .toLowerCase()\n      .split(\" \")\n      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))\n      .join(\" \");\n  },\n\n  /**\n   * Calculates the Levenshtein (edit) distance between two strings.\n   * Used for suggesting similar tag names when unknown tags are encountered.\n   * @param {string} a - First string\n   * @param {string} b - Second string\n   * @returns {number} The minimum number of single-character edits needed\n   */\n  levenshteinDistance(a, b) {\n    if (a.length === 0) return b.length;\n    if (b.length === 0) return a.length;\n\n    const matrix = [];\n    for (let i = 0; i <= b.length; i++) matrix[i] = [i];\n    for (let j = 0; j <= a.length; j++) matrix[0][j] = j;\n\n    for (let i = 1; i <= b.length; i++) {\n      for (let j = 1; j <= a.length; j++) {\n        const cost = a[j - 1] === b[i - 1] ? 0 : 1;\n        matrix[i][j] = Math.min(\n          matrix[i - 1][j] + 1,\n          matrix[i][j - 1] + 1,\n          matrix[i - 1][j - 1] + cost\n        );\n      }\n    }\n    return matrix[b.length][a.length];\n  },\n};\n\nexport { Utils };\n", "import { Utils } from \"./utils.js\";\nimport { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.KEYBOARD_SHORTCUTS);\n\nconst SMALL_SCROLL_PERCENT = 0.15; // ~15% of viewport\nconst LARGE_SCROLL_PERCENT = 0.8; // ~80% of viewport\n\n/**\n * Handles keyboard input for story navigation, choice selection, and scrolling.\n * Automatically disabled on mobile devices. Can be toggled via settings.\n */\nclass KeyboardShortcuts {\n  /**\n   * Creates the keyboard shortcuts handler (disabled by default on mobile).\n   */\n  constructor() {\n    this.enabled = !Utils.isMobile();\n    this.storyManager = null; // Wired by main.js\n    this.keyboardHelpModal = null; // Wired by main.js\n    this.init();\n  }\n\n  /**\n   * Registers the global keydown event listener.\n   * @private\n   */\n  init() {\n    document.addEventListener(\"keydown\", (event) => this.handleKeyDown(event));\n  }\n\n  /**\n   * Enables keyboard shortcut handling.\n   */\n  enable() {\n    this.enabled = true;\n  }\n\n  /**\n   * Disables keyboard shortcut handling.\n   */\n  disable() {\n    this.enabled = false;\n  }\n\n  /**\n   * Main keydown event handler. Routes to appropriate sub-handlers based on key pressed.\n   * @param {KeyboardEvent} event - The keyboard event\n   * @private\n   */\n  handleKeyDown(event) {\n    if (!this.storyManager || !this.enabled) return;\n\n    // Ignore Alt key combinations (used by browser/OS)\n    if (event.altKey) return;\n\n    if (this.isTypingInInput(event)) return;\n\n    if (event.ctrlKey || event.metaKey) {\n      this.handleModifierShortcuts(event);\n      return;\n    }\n\n    if (event.key === \"Escape\") {\n      this.handleEscape();\n      return;\n    }\n\n    if (this.handleScrolling(event)) return;\n\n    this.handleChoiceSelection(event);\n  }\n\n  /**\n   * Handles Ctrl/Cmd shortcuts for menus and actions.\n   * Ctrl+S: saves, Ctrl+R: restart, Ctrl+,: settings, Ctrl+H: help\n   * @param {KeyboardEvent} event - The keyboard event\n   * @private\n   */\n  handleModifierShortcuts(event) {\n    try {\n      switch (event.key) {\n        case \"s\":\n          event.preventDefault();\n          this.storyManager.saves?.showSaveDialog?.();\n          break;\n        case \"r\":\n          event.preventDefault();\n          this.storyManager.confirmRestart();\n          break;\n        case \",\":\n          event.preventDefault();\n          this.storyManager.settings?.showSettings?.();\n          break;\n        case \"h\":\n          event.preventDefault();\n          this.keyboardHelpModal?.show?.();\n          break;\n      }\n    } catch (error) {\n      log.error(\"Keyboard shortcut failed\", error);\n    }\n  }\n\n  /**\n   * Handles Escape key to return from special pages.\n   * @private\n   */\n  handleEscape() {\n    if (this.storyManager.pages?.isViewingSpecialPage?.()) {\n      try {\n        this.storyManager.pages.returnToStory();\n      } catch (error) {\n        log.error(\"Failed to return from special page\", error);\n      }\n    }\n  }\n\n  /**\n   * Handles arrow keys, Page Up/Down, Home/End for scrolling.\n   * @param {KeyboardEvent} event - The keyboard event\n   * @returns {boolean} True if the event was handled, false otherwise\n   * @private\n   */\n  handleScrolling(event) {\n    if (!this.isInStoryArea()) return false;\n    const scrollContainer = document.querySelector(\".outerContainer\");\n    if (!scrollContainer) return false;\n\n    const smallScroll = window.innerHeight * SMALL_SCROLL_PERCENT;\n    const largeScroll = window.innerHeight * LARGE_SCROLL_PERCENT;\n\n    switch (event.key) {\n      case \"ArrowUp\":\n        event.preventDefault();\n        scrollContainer.scrollBy({ top: -smallScroll, behavior: \"smooth\" });\n        return true;\n      case \"ArrowDown\":\n        event.preventDefault();\n        scrollContainer.scrollBy({ top: smallScroll, behavior: \"smooth\" });\n        return true;\n      case \"PageUp\":\n        event.preventDefault();\n        scrollContainer.scrollBy({ top: -largeScroll, behavior: \"smooth\" });\n        return true;\n      case \"PageDown\":\n        event.preventDefault();\n        scrollContainer.scrollBy({ top: largeScroll, behavior: \"smooth\" });\n        return true;\n      case \"Home\":\n        event.preventDefault();\n        scrollContainer.scrollTo({ top: 0, behavior: \"smooth\" });\n        return true;\n      case \"End\":\n        event.preventDefault();\n        scrollContainer.scrollTo({\n          top: scrollContainer.scrollHeight,\n          behavior: \"smooth\",\n        });\n        return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Handles 1-9 and A-Z keys for selecting story choices.\n   * 1-9 select choices 1-9, A-Z select choices 10-35.\n   * @param {KeyboardEvent} event - The keyboard event\n   * @private\n   */\n  handleChoiceSelection(event) {\n    if (!this.isInStoryArea()) return;\n\n    const choices = this.storyManager.story?.currentChoices;\n    if (!choices || choices.length === 0) return;\n\n    const key = event.key.toLowerCase();\n    let choiceIndex = null;\n\n    if (key >= \"1\" && key <= \"9\") {\n      choiceIndex = parseInt(key) - 1;\n    } else if (key >= \"a\" && key <= \"z\") {\n      // Check for a-z (for choices 10+)\n      choiceIndex = 9 + (key.charCodeAt(0) - 97);\n    }\n\n    if (choiceIndex !== null && choiceIndex < choices.length) {\n      event.preventDefault();\n      this.storyManager.selectChoice(choiceIndex);\n    }\n  }\n\n  /**\n   * Checks if the user is currently typing in an input or textarea.\n   * @param {KeyboardEvent} event - The keyboard event\n   * @returns {boolean} True if focus is on an input element\n   * @private\n   */\n  isTypingInInput(event) {\n    return (\n      event.target.tagName === \"INPUT\" || event.target.tagName === \"TEXTAREA\"\n    );\n  }\n\n  /**\n   * Checks if focus is within the story area (not in a modal or other UI).\n   * @returns {boolean} True if the story area is active\n   * @private\n   */\n  isInStoryArea() {\n    const active = document.activeElement;\n    const outerContainer = document.querySelector(\".outerContainer\");\n\n    return active === document.body || outerContainer?.contains(active);\n  }\n}\n\nexport { KeyboardShortcuts };\n", "import { BaseModal } from \"./base-modal.js\";\nimport { Utils } from \"./utils.js\";\nimport { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.KEYBOARD_HELP);\n\n/**\n * Displays a modal with keyboard shortcut documentation.\n * Automatically disabled on mobile devices where keyboard shortcuts aren't available.\n */\nclass KeyboardHelpModal {\n  /**\n   * Creates the keyboard help modal (skipped on mobile devices).\n   */\n  constructor() {\n    this.modal = null;\n    this.isMac = Utils.isMac();\n    this.isMobile = Utils.isMobile();\n    this.init();\n  }\n\n  /**\n   * Initializes the modal if not on a mobile device.\n   * @private\n   */\n  init() {\n    if (this.isMobile) return;\n    this.createModal();\n  }\n\n  /**\n   * Creates the underlying BaseModal instance.\n   * @private\n   */\n  createModal() {\n    this.modal = new BaseModal({\n      title: \"Keyboard Shortcuts\",\n      className: \"keyboard-help-modal\",\n      maxWidth: \"500px\",\n      showFooter: true,\n    });\n  }\n\n  /**\n   * Displays the keyboard shortcuts help modal.\n   * Does nothing on mobile devices.\n   */\n  show() {\n    if (this.isMobile) return;\n\n    if (!this.modal?.isReady()) {\n      log.error(\"Cannot show keyboard help - modal not available\");\n      return;\n    }\n\n    this.modal.show((modal) => {\n      modal.setContent(this.getHelpHTML());\n\n      const footer = modal.getFooter();\n      if (footer) {\n        footer.innerHTML = \"\";\n        footer.className = \"modal-footer modal-footer-right\";\n\n        const closeBtn = modal.createButton(\"Close\", {\n          variant: \"primary\",\n          onClick: () => this.hide(),\n        });\n\n        footer.appendChild(closeBtn);\n      }\n    });\n  }\n\n  /**\n   * Hides the keyboard shortcuts help modal.\n   */\n  hide() {\n    this.modal?.hide();\n  }\n\n  /**\n   * Checks if keyboard help is available (not on mobile).\n   * @returns {boolean} True if keyboard shortcuts are supported on this device\n   */\n  isAvailable() {\n    return !this.isMobile;\n  }\n\n  /**\n   * Checks if the modal is ready to be shown.\n   * @returns {boolean} True if not on mobile and modal is initialized\n   */\n  isReady() {\n    return !this.isMobile && this.modal?.isReady();\n  }\n\n  /**\n   * Returns the platform-appropriate modifier key name.\n   * @returns {string} \"Cmd\" on Mac, \"Ctrl\" on other platforms\n   * @private\n   */\n  getModifierKey() {\n    return this.isMac ? \"Cmd\" : \"Ctrl\";\n  }\n\n  /**\n   * Generates the HTML content for the keyboard shortcuts reference.\n   * @returns {string} HTML string with shortcut tables\n   * @private\n   */\n  getHelpHTML() {\n    const mod = this.getModifierKey();\n\n    return `\n      <div class=\"keyboard-help-section\">\n        <h3>Choice Selection</h3>\n        <table class=\"keyboard-help-table\">\n          <tr>\n            <td class=\"shortcut-key\"><kbd>1</kbd> - <kbd>9</kbd></td>\n            <td>Select choice 1-9</td>\n          </tr>\n          <tr>\n            <td class=\"shortcut-key\"><kbd>A</kbd> - <kbd>Z</kbd></td>\n            <td>Select choice 10+ (A=10, B=11, etc.)</td>\n          </tr>\n        </table>\n      </div>\n\n      <div class=\"keyboard-help-section\">\n        <h3>Scrolling</h3>\n        <table class=\"keyboard-help-table\">\n          <tr>\n            <td class=\"shortcut-key\"><kbd>\u2191</kbd> / <kbd>\u2193</kbd></td>\n            <td>Scroll up/down (small)</td>\n          </tr>\n          <tr>\n            <td class=\"shortcut-key\"><kbd>PgUp</kbd> / <kbd>PgDn</kbd></td>\n            <td>Scroll up/down (large)</td>\n          </tr>\n          <tr>\n            <td class=\"shortcut-key\"><kbd>Home</kbd> / <kbd>End</kbd></td>\n            <td>Jump to top/bottom</td>\n          </tr>\n        </table>\n      </div>\n\n      <div class=\"keyboard-help-section\">\n        <h3>Menus</h3>\n        <table class=\"keyboard-help-table\">\n          <tr>\n            <td class=\"shortcut-key\"><kbd>${mod}</kbd>+<kbd>S</kbd></td>\n            <td>Open save menu</td>\n          </tr>\n          <tr>\n            <td class=\"shortcut-key\"><kbd>${mod}</kbd>+<kbd>,</kbd></td>\n            <td>Open settings</td>\n          </tr>\n          <tr>\n            <td class=\"shortcut-key\"><kbd>${mod}</kbd>+<kbd>H</kbd></td>\n            <td>Show this help</td>\n          </tr>\n          <tr>\n            <td class=\"shortcut-key\"><kbd>${mod}</kbd>+<kbd>R</kbd></td>\n            <td>Restart story</td>\n          </tr>\n          <tr>\n            <td class=\"shortcut-key\"><kbd>Esc</kbd></td>\n            <td>Close menu / Return to story</td>\n          </tr>\n        </table>\n      </div>\n    `;\n  }\n}\n\nexport { KeyboardHelpModal };\n", "import { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.MARKDOWN);\n\n/**\n * Converts custom markdown-like syntax to HTML.\n * Supports headings, bold, italic, links, inline classes, code blocks,\n * blockquotes, lists, horizontal rules, and escape sequences.\n * All methods are static.\n */\nclass MarkdownProcessor {\n  /**\n   * Regex patterns for markdown conversion, organized by processing stage.\n   * - escape: Convert %x escape sequences to HTML entities\n   * - block: Convert block-level elements (headings, hr, blockquotes, lists)\n   * - inline: Convert inline formatting (bold, italic, links, line breaks)\n   * @type {{escape: Array, block: Array, inline: Array}}\n   */\n  static patterns = {\n    escape: [\n      [/%\\*/g, \"&#42;\"],\n      [/%_/g, \"&#95;\"],\n      [/%`/g, \"&#96;\"],\n      [/%:/g, \"&#58;\"],\n      [/%\\[/g, \"&#91;\"],\n      [/%\\]/g, \"&#93;\"],\n      [/%\\(/g, \"&#40;\"],\n      [/%\\)/g, \"&#41;\"],\n      [/%%/g, \"&#37;\"],\n    ],\n    block: [\n      [/^::: (.*$)/gm, \"<h4>$1</h4>\"],\n      [/^:: (.*$)/gm, \"<h3>$1</h3>\"],\n      [/^: (.*$)/gm, \"<h2>$1</h2>\"],\n      [/^\\[---+\\]$/gm, \"<hr>\"],\n      [/^>> (.+)$/gm, \"<blockquote>$1</blockquote>\"],\n      [/^> (.+)$/gm, \"<li>$1</li>\"],\n    ],\n    inline: [\n      [/___([^_\\n]+?)___/g, \"<strong><em>$1</em></strong>\"],\n      [/__([^_\\n]+?)__/g, \"<strong>$1</strong>\"],\n      [/(?<!_)_([^_\\n]+?)_(?!_)/g, \"<em>$1</em>\"],\n      [\n        /\\[(.*?)\\]\\(([^)]+)\\)/g,\n        (match, text, target) => {\n          return MarkdownProcessor.processLinkOrClass(text, target);\n        },\n      ],\n      [/  $/gm, \"<br>\"],\n    ],\n  };\n\n  /**\n   * Converts markdown-like syntax to HTML.\n   * Lines starting with % skip all processing (raw output).\n   * @param {string} text - Text to process\n   * @returns {string} HTML string\n   */\n  static process(text) {\n    if (!text || typeof text !== \"string\") return \"\";\n\n    if (text.trim().startsWith(\"%\")) {\n      return text.trim().substring(1);\n    }\n\n    try {\n      for (const [pattern, replacement] of this.patterns.escape) {\n        text = text.replace(pattern, replacement);\n      }\n\n      for (const [pattern, replacement] of this.patterns.block) {\n        text = text.replace(pattern, replacement);\n      }\n\n      text = text.replace(\n        /(<li>.*?<\\/li>(?:\\s*<li>.*?<\\/li>)*)/gs,\n        \"<ul>$1</ul>\"\n      );\n\n      text = this.processInlineWithCodeBlocks(text);\n\n      return text;\n    } catch (error) {\n      log.warning(\"Markdown processing failed\", error);\n      return text;\n    }\n  }\n\n  /**\n   * Processes inline markdown while protecting code blocks from transformation.\n   * @param {string} text - Text to process\n   * @returns {string} Processed HTML string\n   * @private\n   */\n  static processInlineWithCodeBlocks(text) {\n    const tokens = this.tokenize(text);\n    let result = \"\";\n\n    for (const token of tokens) {\n      if (token.type === \"code\") {\n        result += `<code>${token.content}</code>`;\n      } else if (token.type === \"text\") {\n        result += this.processInlineMarkdown(token.content);\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Splits text into tokens, separating code blocks from regular text.\n   * @param {string} text - Text to tokenize\n   * @returns {Array<{type: 'code'|'text', content: string}>} Array of tokens\n   * @private\n   */\n  static tokenize(text) {\n    const tokens = [];\n    let current = \"\";\n    let i = 0;\n\n    while (i < text.length) {\n      if (text[i] === \"`\") {\n        if (current) {\n          tokens.push({ type: \"text\", content: current });\n          current = \"\";\n        }\n\n        // Find the closing backtick\n        i++; // skip opening backtick\n        let codeContent = \"\";\n        while (i < text.length && text[i] !== \"`\") {\n          codeContent += text[i];\n          i++;\n        }\n\n        tokens.push({ type: \"code\", content: codeContent });\n        i++; // skip closing backtick\n      } else {\n        current += text[i];\n        i++;\n      }\n    }\n\n    if (current) {\n      tokens.push({ type: \"text\", content: current });\n    }\n\n    return tokens;\n  }\n\n  /**\n   * Applies inline markdown patterns (bold, italic, links, etc.) to text.\n   * @param {string} text - Text to process (should not contain code blocks)\n   * @returns {string} Processed HTML string\n   * @private\n   */\n  static processInlineMarkdown(text) {\n    try {\n      for (const [pattern, replacement] of this.patterns.inline) {\n        text = text.replace(pattern, replacement);\n      }\n      return text;\n    } catch (error) {\n      log.warning(\"Inline markdown processing failed\", error);\n      return text;\n    }\n  }\n\n  /**\n   * Processes [text](target) syntax, converting to either a link or styled span.\n   *\n   * If target looks like a URL (http://, domain.com, /path, #anchor, mailto:, tel:):\n   * - Creates an `<a>` tag\n   * - Adds https:// to bare domains (e.g., \"example.com\" \u2192 \"https://example.com\")\n   * - External links get target=\"_blank\", rel=\"noopener noreferrer\", and SR text\n   * - Internal links (starting with / or #) open in same tab\n   *\n   * If target is not a URL (e.g., \"highlight\", \"warning\"):\n   * - Creates a `<span class=\"inline-{target}\">` for custom styling\n   *\n   * @param {string} text - The link/span text content\n   * @param {string} target - URL or class name\n   * @returns {string} HTML string for either an anchor or span element\n   */\n  static processLinkOrClass(text, target) {\n    if (this.isURL(target)) {\n      let href = target;\n      if (\n        /^[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}(\\/.*)?$/.test(target) ||\n        /^www\\./i.test(target)\n      ) {\n        href = \"https://\" + target;\n      }\n\n      const isExternal = this.isExternalURL(href);\n      const externalAttr = isExternal\n        ? ' target=\"_blank\" rel=\"noopener noreferrer\"'\n        : \"\";\n      const srText = isExternal // For screen readers, invisible\n        ? '<span class=\"sr-only\"> (opens in new tab)</span>'\n        : \"\";\n      return `<a href=\"${href}\"${externalAttr}>${text}${srText}</a>`;\n    } else {\n      return `<span class=\"inline-${target}\">${text}</span>`;\n    }\n  }\n\n  /**\n   * Checks if a string looks like a URL (http, mailto, tel, relative paths, domains).\n   * @param {string} str - String to check\n   * @returns {boolean} True if string appears to be a URL\n   * @private\n   */\n  static isURL(str) {\n    const urlPatterns = [\n      /^https?:\\/\\//i, // http:// or https://\n      /^\\/\\//i, // Protocol-relative URLs\n      /^mailto:/i, // Email links\n      /^tel:/i, // Phone links\n      /^#/, // Hash/anchor links\n      /^\\//, // Relative URLs starting with /\n      /^[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}(\\/.*)?$/, // Domain names like example.com or example.com/path\n      /^www\\./i, // URLs starting with www.\n    ];\n\n    return urlPatterns.some((pattern) => pattern.test(str));\n  }\n\n  /**\n   * Checks if a URL points to an external site (should open in new tab).\n   * Internal URLs start with / or #. Mailto and tel links are treated as external.\n   * @param {string} href - URL to check\n   * @returns {boolean} True if URL is external\n   * @private\n   */\n  static isExternalURL(url) {\n    try {\n      if (url.startsWith(\"/\") || url.startsWith(\"#\")) {\n        return false;\n      }\n\n      if (url.startsWith(\"//\")) {\n        url = \"https:\" + url;\n      }\n\n      if (\n        /^[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}(\\/.*)?$/.test(url) ||\n        /^www\\./i.test(url)\n      ) {\n        url = \"https://\" + url;\n      }\n\n      const urlObj = new URL(url, window.location.origin);\n      return urlObj.hostname !== window.location.hostname;\n    } catch {\n      return true;\n    }\n  }\n\n  /**\n   * Returns diagnostic information about the processor's configuration.\n   * @returns {{patternCount: {escape: number, block: number, inline: number}, supportsLinks: boolean, supportsInlineClasses: boolean, timestamp: string}}\n   */\n  static getStats() {\n    return {\n      patternCount: {\n        escape: this.patterns.escape.length,\n        block: this.patterns.block.length,\n        inline: this.patterns.inline.length,\n      },\n      supportsLinks: true,\n      supportsInlineClasses: true,\n      timestamp: new Date().toISOString(),\n    };\n  }\n}\n\nexport { MarkdownProcessor };\n", "import { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.DOM_HELPERS);\n\n/**\n * DOM manipulation utilities scoped to a container element.\n * Provides methods for creating, querying, and removing elements\n * with consistent patterns used throughout the UI.\n */\nclass DOMHelpers {\n  /**\n   * Creates the DOMHelpers with dependencies\n   * @param {HTMLElement} storyContainer - The container element for story content\n   * @param {Object} [settings=null] - Settings object for configuration (e.g., tone indicator placement)\n   */\n  constructor(storyContainer, settings = null) {\n    if (!storyContainer || !(storyContainer instanceof Element)) {\n      log.critical(\n        \"Invalid story container provided to DOM helpers\",\n        new Error(\"Invalid story container\")\n      );\n      return;\n    }\n\n    this.settings = settings;\n    this.storyContainer = storyContainer;\n  }\n\n  /**\n   * Creates and appends a paragraph element to the story container.\n   * @param {string} text - HTML content for the paragraph\n   * @param {string[]} [customClasses=[]] - CSS classes to apply\n   * @returns {HTMLElement|null} The created paragraph element, or null on failure\n   */\n  createParagraph(text, customClasses = []) {\n    if (!text || typeof text !== \"string\" || !text.trim()) {\n      log.warning(\"Invalid text passed to createParagraph\");\n      return null;\n    }\n\n    if (!Array.isArray(customClasses)) {\n      log.warning(\n        \"Invalid customClasses passed to createParagraph - using empty array\"\n      );\n      customClasses = [];\n    }\n\n    try {\n      const paragraphElement = document.createElement(\"p\");\n      paragraphElement.innerHTML = text;\n\n      for (const className of customClasses) {\n        if (className && typeof className === \"string\") {\n          paragraphElement.classList.add(className);\n        }\n      }\n\n      this.storyContainer.appendChild(paragraphElement);\n      return paragraphElement;\n    } catch (error) {\n      log.error(\"Failed to create paragraph\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Create a choice element with optional key hint and tone indicators\n   * @param {string} choiceText - Choice display text\n   * @param {string[]} [customClasses] - Additional CSS classes\n   * @param {boolean} [isClickable=true] - Whether choice is clickable\n   * @param {string|null} [keyHint] - Keyboard shortcut hint (e.g., \"1\", \"a\")\n   * @param {boolean} [showHint=true] - Whether to display the key hint\n   * @param {Array} [toneIndicators] - Array of {icon, label} objects\n   * @returns {HTMLElement|null}\n   */\n  createChoice(\n    choiceText,\n    customClasses = [],\n    isClickable = true,\n    keyHint = null,\n    showHint = true,\n    toneIndicators = [],\n    choiceIndex = null,\n    totalChoices = null,\n    container = null\n  ) {\n    if (!choiceText || typeof choiceText !== \"string\") {\n      log.warning(\"Invalid choiceText passed to createChoice\");\n      choiceText = \"[Invalid Choice]\";\n    }\n\n    if (!Array.isArray(customClasses)) {\n      log.warning(\n        \"Invalid customClasses passed to createChoice - using empty array\"\n      );\n      customClasses = [];\n    }\n\n    try {\n      const choiceElement = document.createElement(\"button\");\n      choiceElement.type = \"button\";\n      choiceElement.classList.add(\"choice\");\n\n      for (const className of customClasses) {\n        if (className && typeof className === \"string\") {\n          choiceElement.classList.add(className);\n        }\n      }\n\n      if (!isClickable) {\n        choiceElement.classList.add(\"unclickable\");\n        choiceElement.setAttribute(\"aria-disabled\", \"true\");\n        // Don't set the button as disabled otherwise screen readers skip over it\n        // choiceElement.disabled = true;\n      }\n\n      let leadingToneHTML = \"\";\n      let trailingToneHTML = \"\";\n      let srOnlyLabels = \"\";\n\n      if (toneIndicators.length > 0) {\n        const labelList = toneIndicators.map((ind) => ind.label).join(\", \");\n        srOnlyLabels = `<span class=\"sr-only\"> (${labelList})</span>`;\n\n        const buildIconSpan = (indicator) => {\n          const { icon } = indicator;\n          const isMaterialIcon = /^[a-z_]+$/.test(icon);\n          return isMaterialIcon\n            ? `<span class=\"material-icons tone-icon\" aria-hidden=\"true\">${icon}</span>`\n            : `<span class=\"tone-icon\" aria-hidden=\"true\">${icon}</span>`;\n        };\n\n        const allTrailing = this.settings?.toneIndicatorsTrailing;\n\n        if (allTrailing) {\n          const trailingSpans = toneIndicators.map(buildIconSpan).join(\"\");\n          trailingToneHTML = `<span class=\"tone-indicator-trailing\" aria-hidden=\"true\">${trailingSpans}</span>`;\n        } else {\n          leadingToneHTML = `<span class=\"tone-indicator-leading\" aria-hidden=\"true\">${buildIconSpan(toneIndicators[0])}</span>`;\n\n          if (toneIndicators.length > 1) {\n            const trailingSpans = toneIndicators\n              .slice(1)\n              .map(buildIconSpan)\n              .join(\"\");\n            trailingToneHTML = `<span class=\"tone-indicator-trailing\" aria-hidden=\"true\">${trailingSpans}</span>`;\n          }\n        }\n      }\n\n      const hintPrefix =\n        keyHint && showHint\n          ? `<span class=\"choice-key-hint\" aria-hidden=\"true\">${keyHint}.</span> `\n          : \"\";\n\n      const choicePosition =\n        choiceIndex !== null && totalChoices !== null\n          ? ` ${choiceIndex} of ${totalChoices}: `\n          : \": \";\n\n      const srChoicePrefix = isClickable\n        ? `<span class=\"sr-only\">Choice${choicePosition}</span>`\n        : `<span class=\"sr-only\">Unavailable choice${choicePosition}</span>`;\n\n      choiceElement.innerHTML = `${srChoicePrefix}${leadingToneHTML}${hintPrefix}${choiceText}${trailingToneHTML}${srOnlyLabels}`;\n\n      const targetContainer = container || this.storyContainer;\n      targetContainer.appendChild(choiceElement);\n      return choiceElement;\n    } catch (error) {\n      log.error(\"Failed to create choice\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Attaches a click event handler to a choice element's anchor.\n   * @param {HTMLElement} choiceElement - The choice paragraph element containing an anchor\n   * @param {Function} callback - Function to call when the choice is clicked\n   */\n  addChoiceClickHandler(choiceElement, callback) {\n    if (!choiceElement || !(choiceElement instanceof Element)) {\n      log.warning(\"Invalid choiceElement passed to addChoiceClickHandler\");\n      return;\n    }\n\n    if (!callback || typeof callback !== \"function\") {\n      log.warning(\"Invalid callback passed to addChoiceClickHandler\");\n      return;\n    }\n\n    choiceElement.addEventListener(\"click\", function (event) {\n      try {\n        event.preventDefault();\n        callback();\n      } catch (error) {\n        log.error(\"Choice click handler failed\", error);\n      }\n    });\n  }\n\n  /**\n   * Merges consecutive elements of the same type (ul, blockquote) into single elements.\n   * Called after rendering to fix lists/quotes that were processed line-by-line.\n   */\n  mergeConsecutiveElements() {\n    this.mergeElementsByTag(\"ul\");\n    this.mergeElementsByTag(\"blockquote\");\n  }\n\n  /**\n   * Merges consecutive elements of a given tag into the first one.\n   * @param {string} tagName - The tag name to merge (e.g., 'ul', 'blockquote')\n   * @private\n   */\n  mergeElementsByTag(tagName) {\n    const elements = this.storyContainer.querySelectorAll(tagName);\n\n    for (let i = elements.length - 1; i >= 0; i--) {\n      const current = elements[i];\n      const next = current.nextElementSibling;\n\n      if (next && next.tagName.toLowerCase() === tagName.toLowerCase()) {\n        // Move all children from next into current\n        while (next.firstChild) {\n          current.appendChild(next.firstChild);\n        }\n        next.remove();\n      }\n    }\n  }\n\n  /**\n   * Removes all elements matching a selector from the story container.\n   * @param {string} selector - CSS selector for elements to remove\n   */\n  removeAll(selector) {\n    if (!selector || typeof selector !== \"string\") {\n      log.warning(\"Invalid selector passed to removeAll\");\n      return;\n    }\n\n    const allElements = this.storyContainer.querySelectorAll(selector);\n\n    for (let i = 0; i < allElements.length; i++) {\n      const el = allElements[i];\n      try {\n        if (el?.parentNode) {\n          el.parentNode.removeChild(el);\n        }\n      } catch (error) {\n        log.warning(`Failed to remove element at index ${i}`, error);\n      }\n    }\n  }\n\n  /**\n   * Sets visibility of elements by adding/removing the 'invisible' class.\n   * @param {string} selector - CSS selector for target elements\n   * @param {boolean} visible - Whether elements should be visible\n   */\n  setVisible(selector, visible) {\n    if (!selector || typeof selector !== \"string\") {\n      log.warning(\"Invalid selector passed to setVisible\");\n      return;\n    }\n\n    const allElements = this.storyContainer.querySelectorAll(selector);\n\n    for (let i = 0; i < allElements.length; i++) {\n      const el = allElements[i];\n      try {\n        if (!el?.classList) continue;\n\n        if (!visible) {\n          el.classList.add(\"invisible\");\n        } else {\n          el.classList.remove(\"invisible\");\n        }\n      } catch (error) {\n        log.warning(\n          `Failed to set visibility for element at index ${i}`,\n          error\n        );\n      }\n    }\n  }\n\n  /**\n   * Removes all story content elements (paragraphs, images, figures, stat bars, inputs).\n   */\n  clearStoryContent() {\n    this.removeAll(\"p\");\n    this.removeAll(\"h2\");\n    this.removeAll(\"h3\");\n    this.removeAll(\"h4\");\n    this.removeAll(\"ul\");\n    this.removeAll(\"blockquote\");\n    this.removeAll(\"hr\");\n    this.removeAll(\"img\");\n    this.removeAll(\"figure\");\n    this.removeAll(\".stat-bar-container\");\n    this.removeAll(\".user-input-inline-container\");\n    this.removeAll(\".choices-container\");\n  }\n\n  /**\n   * Scrolls a container element to the top.\n   * @param {HTMLElement} container - The scrollable container element\n   */\n  scrollToTop(container) {\n    if (!container || !(container instanceof Element)) {\n      log.warning(\"Invalid container passed to scrollToTop\");\n      return;\n    }\n\n    try {\n      if (typeof container.scrollTo === \"function\") {\n        container.scrollTo(0, 0);\n      } else if (typeof container.scrollTop !== \"undefined\") {\n        container.scrollTop = 0;\n        container.scrollLeft = 0;\n      } else {\n        log.warning(\"Container does not support scrolling operations\");\n      }\n    } catch (error) {\n      log.warning(\"Failed to scroll to top\", error);\n    }\n  }\n\n  /**\n   * Attempts to recover the story container reference if it was lost.\n   * Useful after dynamic DOM changes or errors.\n   */\n  recover() {\n    if (!this.storyContainer?.parentNode) {\n      const newContainer = document.querySelector(\"#story\");\n      if (newContainer) {\n        this.storyContainer = newContainer;\n        log.warning(\"DOM helpers recovered by finding new story container\");\n      } else {\n        log.error(\"DOM helpers recovery failed - no story container found\");\n      }\n    }\n  }\n\n  /**\n   * Checks whether the DOM helper is ready for use.\n   * @returns {boolean} True if the story container exists and is attached to the DOM\n   */\n  isReady() {\n    return !!this.storyContainer?.parentNode;\n  }\n\n  /**\n   * Returns diagnostic information about the story container's state.\n   * @returns {{hasContainer: boolean, containerTagName?: string, containerChildren?: number, containerText?: number, paragraphCount?: number, choiceCount?: number, imageCount?: number}}\n   */\n  getStats() {\n    if (!this.storyContainer) {\n      return { hasContainer: false };\n    }\n\n    return {\n      hasContainer: true,\n      containerTagName: this.storyContainer.tagName,\n      containerChildren: this.storyContainer.children.length,\n      containerText: this.storyContainer.textContent.length,\n      paragraphCount: this.storyContainer.querySelectorAll(\"p\").length,\n      choiceCount: this.storyContainer.querySelectorAll(\".choice\").length,\n      imageCount: this.storyContainer.querySelectorAll(\"img\").length,\n    };\n  }\n}\n\nexport { DOMHelpers };\n", "import { MarkdownProcessor } from \"./markdown-processor.js\";\nimport { DOMHelpers } from \"./dom-helpers.js\";\nimport { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.DISPLAY_MANAGER);\n\n/**\n * Manages the story display area including content rendering,\n * choice presentation, animations, and scroll behavior.\n * Maintains display history for save/restore functionality.\n */\nclass DisplayManager {\n  /**\n   * Creates the DisplayManager with dependencies\n   * @param {Object} settings - SettingsManager instance for animation preferences\n   */\n  constructor(settings) {\n    if (!settings) {\n      log.warning(\n        \"DisplayManager created without settings: animations will default to on\"\n      );\n    }\n    this.settings = settings;\n    this.storyManager = null; // Wired by main.js after StoryManager is created\n    this.container = document.querySelector(\"#story\");\n    this.scrollContainer = document.querySelector(\".outerContainer\");\n    this.history = [];\n\n    if (!this.container) {\n      log.critical(\n        \"Story container element not found\",\n        new Error(\"Missing #story element\")\n      );\n      return;\n    }\n\n    this.domHelpers = new DOMHelpers(this.container, this.settings);\n  }\n\n  /**\n   * Render an array of content items to the display\n   * @param {Array} content - Array of content objects with text, classes, etc.\n   */\n  render(content) {\n    if (!Array.isArray(content)) {\n      log.warning(\"Invalid content passed to render - expected array\");\n      return;\n    }\n\n    content.forEach((item, index) => {\n      try {\n        let element;\n\n        switch (item.type) {\n          case \"statbar\":\n            element = this.createStatBar(item);\n            break;\n          case \"image\":\n            element = this.createImage(item);\n            break;\n          case \"user-input\":\n            element = this.createUserInput(item);\n            break;\n          case \"paragraph\":\n          default:\n            element = this.createElement(item);\n            break;\n        }\n        if (element) {\n          this.trackInHistory(item);\n          if (this.shouldAnimateContent()) {\n            this.fadeInElement(element);\n          }\n        }\n      } catch (error) {\n        log.error(`Failed to render content item at index ${index}`, error);\n      }\n    });\n\n    // Merge consecutive lists and blockquotes that were processed separately\n    this.domHelpers?.mergeConsecutiveElements?.();\n  }\n\n  /**\n   * Render an array of choice objects\n   * @param {Array} choices - Array of choice objects with text, classes, onClick\n   */\n  renderChoices(choices, showNumbers = true) {\n    if (!Array.isArray(choices)) {\n      log.warning(\"Invalid choices passed to renderChoices - expected array\");\n      return;\n    }\n\n    const totalChoices = choices.length;\n\n    const choicesContainer = document.createElement(\"div\");\n    choicesContainer.className = \"choices-container\";\n    choicesContainer.setAttribute(\"role\", \"region\");\n    choicesContainer.setAttribute(\n      \"aria-label\",\n      `${totalChoices} choices available`\n    );\n    this.container.appendChild(choicesContainer);\n\n    choices.forEach((choice, index) => {\n      try {\n        const element = this.domHelpers.createChoice(\n          choice.text || \"\",\n          choice.classes || [],\n          choice.isClickable !== false,\n          choice.keyHint,\n          showNumbers,\n          choice.toneIndicators || [],\n          index + 1,\n          totalChoices,\n          choicesContainer\n        );\n\n        if (choice.isClickable !== false && choice.onClick) {\n          if (typeof choice.onClick === \"function\") {\n            this.domHelpers.addChoiceClickHandler(element, choice.onClick);\n          } else {\n            log.warning(`Choice at index ${index} has invalid onClick handler`);\n          }\n        }\n\n        if (element && this.shouldAnimateContent()) {\n          this.fadeInElement(element);\n        }\n      } catch (error) {\n        log.error(`Failed to render choice at index ${index}`, error);\n      }\n    });\n  }\n\n  /**\n   * Creates and appends an element from content data.\n   * Processes markdown and applies CSS classes from tags.\n   * Handles block elements (headers, lists, etc.) without wrapping in <p>.\n   * @param {Object} content - Content object with text and classes\n   * @param {string} content.text - The paragraph text (may contain markdown)\n   * @param {string[]} [content.classes] - CSS classes to apply\n   * @returns {HTMLElement|null} The created element, or null on failure\n   * @private\n   */\n  createElement(content) {\n    if (!content?.text || typeof content.text !== \"string\") {\n      log.warning(\"createElement called with invalid content\");\n      return null;\n    }\n\n    if (!this.domHelpers) {\n      log.error(\"Cannot create element - DOM helpers not available\");\n      return null;\n    }\n\n    try {\n      const processedText = MarkdownProcessor.process(content.text);\n\n      // Check if the processed text starts with a block-level element\n      const blockElementPattern = /^<(h[2-4]|ul|blockquote|hr)/i;\n      const isBlockElement = blockElementPattern.test(processedText.trim());\n\n      let element;\n      if (isBlockElement) {\n        // Insert block elements directly without <p> wrapper\n        const wrapper = document.createElement(\"div\");\n        wrapper.innerHTML = processedText;\n        element = wrapper.firstElementChild;\n\n        // Apply custom classes if any\n        if (content.classes?.length) {\n          for (const className of content.classes) {\n            if (className && typeof className === \"string\") {\n              element.classList.add(className);\n            }\n          }\n        }\n\n        this.domHelpers.storyContainer.appendChild(element);\n      } else {\n        // Regular paragraph content\n        element = this.domHelpers.createParagraph(\n          processedText,\n          content.classes || []\n        );\n      }\n\n      if (element && this.shouldAnimateContent()) {\n        this.fadeInElement(element);\n      }\n\n      return element;\n    } catch (error) {\n      log.error(\"Failed to create element\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Creates and appends an image element, optionally wrapped in a figure with caption.\n   * @param {Object} item - Image content object\n   * @param {string} item.src - Image source URL\n   * @param {string} [item.altText] - Alt text for accessibility\n   * @param {string} [item.alignment] - 'left', 'right', or 'center'\n   * @param {string} [item.width] - CSS width value (e.g., '50%', '200px')\n   * @param {boolean} [item.showCaption] - Whether to display altText as a caption\n   * @returns {HTMLElement} The created image or figure element\n   * @private\n   */\n  createImage(item) {\n    const imageElement = document.createElement(\"img\");\n    imageElement.src = item.src;\n    imageElement.className = \"story-image\";\n\n    if (item.altText) {\n      imageElement.alt = item.altText;\n    } else {\n      imageElement.alt = \"\";\n    }\n\n    if (item.alignment) {\n      imageElement.classList.add(`image-${item.alignment}`);\n    }\n\n    if (item.width) {\n      imageElement.style.width = item.width;\n    }\n\n    imageElement.onerror = () => {\n      log.warning(`Failed to load image: ${item.src}`);\n    };\n\n    let elementToInsert;\n\n    if (item.showCaption && item.altText) {\n      const figure = document.createElement(\"figure\");\n      figure.className = \"story-figure\";\n\n      if (item.alignment) {\n        figure.classList.add(`figure-${item.alignment}`);\n        imageElement.classList.remove(`image-${item.alignment}`);\n      }\n\n      if (item.width) {\n        figure.style.width = item.width;\n        imageElement.style.width = \"100%\";\n      }\n\n      const figcaption = document.createElement(\"figcaption\");\n      figcaption.className = \"story-caption\";\n      figcaption.textContent = item.altText;\n\n      figure.appendChild(imageElement);\n      figure.appendChild(figcaption);\n      elementToInsert = figure;\n    } else {\n      elementToInsert = imageElement;\n    }\n\n    this.container.appendChild(elementToInsert);\n\n    return elementToInsert;\n  }\n\n  /**\n   * Creates and appends a stat bar element (simple or opposed).\n   * @param {Object} item - Stat bar content object\n   * @param {string} item.variableName - Ink variable name to display\n   * @param {number} item.min - Minimum value for the bar\n   * @param {number} item.max - Maximum value for the bar\n   * @param {boolean} [item.isOpposed] - Whether to render as opposed bar (two labels)\n   * @param {string} [item.leftLabel] - Label for left side / bar name\n   * @param {string} [item.rightLabel] - Label for right side (opposed bars only)\n   * @param {boolean} [item.clamp] - Whether to clamp displayed value to min/max\n   * @returns {HTMLElement} The created stat bar container element\n   * @private\n   */\n  createStatBar(item) {\n    const value = this.getStatValue(item.variableName);\n    const calculations = this.calculateStatBarMetrics(item, value);\n\n    const element = item.isOpposed\n      ? this.renderOpposedStatBar(item, calculations)\n      : this.renderSimpleStatBar(item, calculations);\n\n    this.container.appendChild(element);\n    return element;\n  }\n\n  /**\n   * Creates and appends a user text input field with submit button.\n   * Handles input submission and updates the ink variable.\n   * @param {Object} item - User input content object\n   * @param {string} item.variableName - Ink variable name to set with user's input\n   * @param {string} [item.placeholder] - Placeholder text for the input field\n   * @returns {HTMLElement} The created input container element\n   * @private\n   */\n  createUserInput(item) {\n    const container = document.createElement(\"div\");\n    container.className = \"user-input-inline-container\";\n\n    const placeholder = item.placeholder || \"Type your answer here...\";\n\n    container.innerHTML = `\n    <div class=\"user-input-prompt\">\n      <input type=\"text\" class=\"user-input-inline-field\" \n             placeholder=\"${placeholder}\" \n             maxlength=\"100\" autocomplete=\"off\">\n      <button class=\"user-input-submit-btn\">Submit</button>\n    </div>\n    <div class=\"user-input-help\">Press Enter or click Submit to continue</div>\n  `;\n\n    this.container.appendChild(container);\n\n    const inputField = container.querySelector(\".user-input-inline-field\");\n    const submitBtn = container.querySelector(\".user-input-submit-btn\");\n\n    // Don't auto-focus - let users Tab to input after reading prompt\n    // This improves screen reader experience\n    // setTimeout(() => inputField.focus(), 100);\n\n    const submitInput = () => {\n      const userInput = inputField.value.trim();\n\n      if (!userInput) {\n        inputField.style.borderColor = \"var(--color-important)\";\n        inputField.placeholder = \"Please enter a value...\";\n        inputField.focus();\n        return;\n      }\n\n      try {\n        this.storyManager.story.variablesState.$(item.variableName, userInput);\n\n        // Restore state to before this content batch and re-set variable\n        if (this.storyManager.stateBeforeUserInput) {\n          this.storyManager.story.state.LoadJson(\n            this.storyManager.stateBeforeUserInput\n          );\n          this.storyManager.story.variablesState.$(\n            item.variableName,\n            userInput\n          );\n          this.storyManager.stateBeforeUserInput = null;\n        }\n\n        // Set flag so content-processor knows to skip input on re-process\n        // and clear and re-render with variable now set\n        this.storyManager.reprocessingAfterUserInput = true;\n        this.storyManager.continue();\n        this.storyManager.reprocessingAfterUserInput = false;\n      } catch (error) {\n        log.error(\"Failed to set user input variable\", error);\n        inputField.style.borderColor = \"var(--color-important)\";\n        inputField.placeholder = \"Error - please try again...\";\n      }\n    };\n\n    submitBtn.addEventListener(\"click\", submitInput);\n    inputField.addEventListener(\"keypress\", (e) => {\n      if (e.key === \"Enter\") submitInput();\n    });\n\n    inputField.addEventListener(\"input\", () => {\n      inputField.style.borderColor = \"\";\n    });\n\n    return container;\n  }\n\n  /**\n   * Retrieves the current value of an ink variable for stat bar display.\n   * @param {string} variableName - Name of the ink variable\n   * @returns {number} The variable's value, or 0 if not found\n   * @private\n   */\n  getStatValue(variableName) {\n    try {\n      return this.storyManager?.story?.variablesState?.[variableName] ?? 0;\n    } catch {\n      return 0;\n    }\n  }\n\n  /**\n   * Calculate stat bar display metrics\n   * @param {Object} item - Stat bar config with min, max, clamp\n   * @param {number} currentValue - Current variable value\n   * @returns {{fillPercent: number, displayValue: number, displayLeft: number, displayRight: number}}\n   */\n  calculateStatBarMetrics(item, currentValue) {\n    const range = item.max - item.min;\n    const fillPercent =\n      range > 0\n        ? Math.max(0, Math.min(100, ((currentValue - item.min) / range) * 100))\n        : 0;\n\n    const clampedValue = item.clamp\n      ? Math.max(item.min, Math.min(item.max, currentValue))\n      : currentValue;\n\n    return {\n      fillPercent,\n      displayValue: Math.round(clampedValue),\n      displayLeft: Math.round(Math.max(0, clampedValue - item.min)),\n      displayRight: Math.round(Math.max(0, item.max - clampedValue)),\n    };\n  }\n\n  /**\n   * Renders a simple (non-opposed) stat bar with label, value, and fill.\n   * @param {Object} item - Stat bar config\n   * @param {Object} metrics - Calculated metrics from calculateStatBarMetrics\n   * @returns {HTMLElement} The stat bar container element\n   * @private\n   */\n  renderSimpleStatBar(item, metrics) {\n    const container = document.createElement(\"div\");\n    container.className = \"stat-bar-container\";\n\n    const displayName =\n      item.leftLabel ||\n      item.variableName.charAt(0).toUpperCase() + item.variableName.slice(1);\n\n    container.innerHTML = `\n    <div class=\"stat-bar-header\" aria-hidden=\"true\">\n      <span class=\"stat-bar-label\">${displayName}</span>\n      <span class=\"stat-bar-value\">\n        <span class=\"stat-bar-current\">${metrics.displayValue}</span>/${item.max}\n      </span>\n    </div>\n    <div class=\"stat-bar-track\" role=\"progressbar\"\n       aria-valuenow=\"${metrics.displayValue}\"\n       aria-valuemin=\"${item.min}\"\n       aria-valuemax=\"${item.max}\"\n       aria-valuetext=\"${displayName}: ${metrics.displayValue} out of ${item.max}\">\n        <div class=\"stat-bar-fill\" style=\"width: ${metrics.fillPercent}%\"></div>\n    </div>\n  `;\n\n    return container;\n  }\n\n  /**\n   * Renders an opposed stat bar with left/right labels and split values.\n   * @param {Object} item - Stat bar config with leftLabel and rightLabel\n   * @param {Object} metrics - Calculated metrics from calculateStatBarMetrics\n   * @returns {HTMLElement} The stat bar container element\n   * @private\n   */\n  renderOpposedStatBar(item, metrics) {\n    const container = document.createElement(\"div\");\n    container.className = \"stat-bar-container stat-bar-opposed\";\n\n    container.innerHTML = `\n    <div class=\"stat-bar-labels\" aria-hidden=\"true\">\n      <span class=\"stat-bar-label stat-bar-label-left\">${item.leftLabel || item.variableName}</span>\n      <span class=\"stat-bar-value\">\n        <span class=\"stat-bar-current\">${metrics.displayLeft}</span>/\n        <span class=\"stat-bar-current\">${metrics.displayRight}</span>\n      </span>\n      <span class=\"stat-bar-label stat-bar-label-right\">${item.rightLabel || \"\"}</span>\n    </div>\n    <div class=\"stat-bar-track\" role=\"progressbar\"\n       aria-valuenow=\"${metrics.displayValue}\"\n       aria-valuemin=\"${item.min}\"\n       aria-valuemax=\"${item.max}\"\n       aria-valuetext=\"${item.leftLabel || item.variableName}: ${metrics.displayLeft} versus ${item.rightLabel || \"\"}: ${metrics.displayRight}\">\n        <div class=\"stat-bar-fill\" style=\"width: ${metrics.fillPercent}%\"></div>\n    </div>\n  `;\n\n    return container;\n  }\n\n  /**\n   * Checks whether content animations are enabled in settings.\n   * @returns {boolean} True if animations should play (defaults to true)\n   * @private\n   */\n  shouldAnimateContent() {\n    return this.settings?.getSetting(\"animations\") !== false;\n  }\n\n  /**\n   * Applies a fade-in animation to an element.\n   * @param {HTMLElement} element - Element to animate\n   * @private\n   */\n  fadeInElement(element) {\n    if (!element) return;\n    try {\n      element.style.opacity = \"0\";\n      element.offsetHeight; // Force reflow\n      element.style.opacity = \"1\";\n    } catch {\n      element.style.opacity = \"1\";\n    }\n  }\n\n  /**\n   * Clears all story content from the display and resets history.\n   */\n  clear() {\n    if (!this.domHelpers) {\n      log.error(\"Cannot clear - DOM helpers not available\");\n      return;\n    }\n\n    this.domHelpers.clearStoryContent();\n    this.history = [];\n  }\n\n  /**\n   * Clears story content from the display without resetting history.\n   */\n  clearContent() {\n    if (!this.domHelpers) {\n      log.error(\"Cannot clear content - DOM helpers not available\");\n      return;\n    }\n\n    this.domHelpers.clearStoryContent();\n  }\n\n  /**\n   * Scrolls the story container to the top.\n   */\n  scrollToTop() {\n    if (!this.scrollContainer) {\n      log.warning(\"Cannot scroll - scroll container not available\");\n      return;\n    }\n\n    if (!this.domHelpers) {\n      log.error(\"Cannot scroll - DOM helpers not available\");\n      return;\n    }\n\n    this.domHelpers.scrollToTop(this.scrollContainer);\n  }\n\n  /**\n   * Hides the page header element.\n   */\n  hideHeader() {\n    this.domHelpers?.setVisible?.(\".header\", false);\n  }\n\n  /**\n   * Shows the page header element.\n   */\n  showHeader() {\n    this.domHelpers?.setVisible?.(\".header\", true);\n  }\n\n  /**\n   * Resets the display to initial state (clears content and shows header).\n   */\n  reset() {\n    this.clear();\n    this.showHeader();\n  }\n\n  /**\n   * Get current display state for saving\n   * @returns {{history: Array}}\n   */\n  getState() {\n    return {\n      history: [...this.history],\n    };\n  }\n\n  /**\n   * Restore display from saved state\n   * @param {{history: Array}} state - Previously saved display state\n   */\n  restoreState(state) {\n    if (!state || typeof state !== \"object\") {\n      log.warning(\"Invalid state passed to restoreState\");\n      return;\n    }\n\n    this.clearContent();\n\n    // Don't set history directly - render will rebuild it\n    const savedHistory = Array.isArray(state.history) ? state.history : [];\n    this.history = [];\n\n    if (savedHistory.length > 0) {\n      this.render(savedHistory);\n    }\n  }\n\n  /**\n   * Adds a content item to the display history with a timestamp.\n   * @param {Object} item - Content item to track\n   * @private\n   */\n  trackInHistory(item) {\n    if (!item || typeof item !== \"object\") {\n      log.warning(\"Invalid item passed to trackInHistory\");\n      return;\n    }\n\n    this.history.push({\n      ...item,\n      timestamp: Date.now(),\n    });\n  }\n\n  /**\n   * Returns the number of items in display history.\n   * @returns {number} History length\n   */\n  getHistoryLength() {\n    return this.history.length;\n  }\n\n  /**\n   * Checks whether any content has been rendered.\n   * @returns {boolean} True if history contains items\n   */\n  hasContent() {\n    return this.history.length > 0;\n  }\n\n  /**\n   * Attempts to recover DOM references if they were lost.\n   * Useful after dynamic page changes or errors.\n   */\n  recover() {\n    if (!this.container) {\n      this.container = document.querySelector(\"#story\");\n    }\n\n    if (!this.scrollContainer) {\n      this.scrollContainer = document.querySelector(\".outerContainer\");\n    }\n\n    if (!this.domHelpers && this.container) {\n      this.domHelpers = new DOMHelpers(this.container);\n    }\n\n    if (!Array.isArray(this.history)) {\n      this.history = [];\n    }\n  }\n\n  /**\n   * Checks whether the display manager is ready to render.\n   * @returns {boolean} True if container and DOM helpers are available\n   */\n  isReady() {\n    return !!(this.container && this.domHelpers);\n  }\n\n  /**\n   * Returns diagnostic information about the display manager's state.\n   * @returns {{historyLength: number, hasContainer: boolean, hasScrollContainer: boolean, hasDomHelpers: boolean, containerElementCount: number}}\n   */\n  getStats() {\n    return {\n      historyLength: this.history.length,\n      hasContainer: !!this.container,\n      hasScrollContainer: !!this.scrollContainer,\n      hasDomHelpers: !!this.domHelpers,\n      containerElementCount: this.container\n        ? this.container.children.length\n        : 0,\n    };\n  }\n}\n\nexport { DisplayManager };\n", "import { TagRegistry, TAGS } from \"./tag-registry.js\";\nimport { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.CONTENT_PROCESSOR);\n\n/**\n * Processes raw ink story output into renderable content objects.\n * Handles text paragraphs, images, user input fields, and special content types.\n * Coordinates with TagProcessor for tag-based effects and styling.\n */\nclass ContentProcessor {\n  /**\n   * Creates the ContentProcessor with dependencies\n   * @param {Object} tagProcessor - TagProcessor instance for parsing ink tags\n   */\n  constructor(tagProcessor) {\n    if (!tagProcessor) {\n      log.warning(\"ContentProcessor created without tagProcessor\");\n    }\n    this.tagProcessor = tagProcessor;\n    this.storyManager = null; // Wired by main.js after StoryManager is created\n  }\n\n  /**\n   * Process story text and tags into a content object\n   * @param {string} text - Raw text from the story\n   * @param {Array} tags - Array of tags from the story\n   * @returns {Object|null} Processed content object or null if empty\n   */\n  process(text, tags) {\n    if (TAGS && Array.isArray(tags)) {\n      const contentOverride = this.checkContentTypeTags(tags, text);\n      if (contentOverride) return contentOverride;\n    }\n\n    return this.createParagraph(text, tags);\n  }\n\n  /**\n   * Creates a paragraph content object from text and tags.\n   * @param {string} text - The paragraph text\n   * @param {string[]} tags - Array of ink tags associated with this line\n   * @returns {{type: string, text: string, classes: string[], tags: string[], hasSpecialAction: boolean, action: *}}\n   * @private\n   */\n  createParagraph(text, tags) {\n    if (!Array.isArray(tags)) {\n      log.warning(\"Invalid tags array provided to createParagraph\");\n      tags = [];\n    }\n\n    if (!this.tagProcessor?.processLineTags) {\n      log.error(\"TagProcessor not available in ContentProcessor\");\n      return {\n        type: \"paragraph\",\n        text,\n        classes: [],\n        tags,\n        hasSpecialAction: false,\n        action: null,\n      };\n    }\n\n    const { customClasses, specialActions } =\n      this.tagProcessor.processLineTags(tags);\n    const specialAction = this.findSpecialAction(specialActions);\n\n    return {\n      type: \"paragraph\",\n      text,\n      classes: customClasses || [],\n      tags,\n      hasSpecialAction: !!specialAction,\n      action: specialAction?.(),\n    };\n  }\n\n  /**\n   * Checks tags for content-type overrides (STATBAR, USER_INPUT, IMAGE).\n   * If found, returns specialized content object(s) instead of a paragraph.\n   * @param {string[]} tags - Array of ink tags to check\n   * @param {string} text - The accompanying text (may be included with the content)\n   * @returns {Object|Array|null} Content object(s) if override found, null otherwise\n   * @private\n   */\n  checkContentTypeTags(tags, text) {\n    for (const tag of tags) {\n      if (typeof tag !== \"string\") continue;\n\n      const { tagDef, tagValue, invalid } = TagRegistry.parseTag(tag);\n      if (invalid) continue;\n\n      switch (tagDef) {\n        case TAGS.STATBAR:\n          return this.handleStatBarContent(tags, text);\n        case TAGS.USER_INPUT:\n          return this.handleUserInputContent(tagValue);\n        case TAGS.IMAGE:\n          return this.handleImageContent(tagValue, text, tags);\n      }\n    }\n\n    return null; // No content-type override found\n  }\n\n  /**\n   * Creates image content object(s) from an IMAGE tag.\n   * Returns both image and paragraph if text accompanies the tag.\n   * @param {string} tagValue - The IMAGE tag value (e.g., \"hero.png left 50%\")\n   * @param {string} text - Any text on the same line\n   * @param {string[]} tags - All tags for this line\n   * @returns {Object|Array} Image content object, or array with image and paragraph\n   * @private\n   */\n  handleImageContent(tagValue, text, tags) {\n    const imageData = this.parseImageTag(tagValue);\n\n    if (!text?.trim()) {\n      return {\n        type: \"image\",\n        ...imageData,\n      };\n    }\n\n    return [\n      {\n        type: \"image\",\n        ...imageData,\n      },\n      this.createParagraph(text, tags),\n    ];\n  }\n\n  /**\n   * Creates stat bar content object(s) from STATBAR tag(s).\n   * Supports multiple stat bars on the same line.\n   * @param {string[]} tags - All tags for this line (may contain multiple STATBAR tags)\n   * @param {string} text - Any text on the same line\n   * @returns {Object|Array} Stat bar content object(s), optionally with paragraph\n   * @private\n   */\n  handleStatBarContent(tags, text) {\n    const parsedTags = tags.map((t) => TagRegistry.parseTag(t));\n    const statBarTags = parsedTags.filter(\n      ({ tagDef, invalid }) => tagDef === TAGS.STATBAR && !invalid\n    );\n\n    const statBars = statBarTags.map(({ tagValue }) => ({\n      type: \"statbar\",\n      ...this.parseStatBarTag(tagValue),\n    }));\n\n    if (text?.trim()) {\n      return [...statBars, this.createParagraph(text, tags)];\n    }\n\n    return statBars.length === 1 ? statBars[0] : statBars;\n  }\n\n  /**\n   * Creates user input content object from USER_INPUT tag.\n   * Returns null if the variable already has a value (after input submission).\n   * @param {string} tagValue - The USER_INPUT tag value (e.g., \"player_name \\\"Enter name\\\"\")\n   * @returns {Object|null} User input content object, or null if already submitted\n   * @private\n   */\n  handleUserInputContent(tagValue) {\n    const userInputData = this.parseUserInputTag(tagValue);\n\n    // Check if variable already has a value (re-processing after input was submitted)\n    const currentValue =\n      this.storyManager?.story?.variablesState?.[userInputData.variableName];\n\n    if (\n      currentValue &&\n      currentValue !== \"\" &&\n      this.storyManager?.reprocessingAfterUserInput\n    ) {\n      // Variable already set AND we're re-processing after submit\n      // Return null to fall through to normal paragraph processing\n      return null;\n    }\n\n    return {\n      type: \"user-input\",\n      ...userInputData,\n    };\n  }\n\n  /**\n   * Parse IMAGE tag value into image data object.\n   * @param {string} value - The tag value (e.g., \"hero.png left 40% caption \"Alt text\"\")\n   * @returns {{src: string, alignment: string|null, width: string|null, altText: string|null, showCaption: boolean}}\n   */\n  parseImageTag(value) {\n    const imageValue = value.trim();\n\n    let altText = null;\n    let remainingValue = imageValue;\n    const altTextMatch = imageValue.match(/\"([^\"]*)\"/);\n    if (altTextMatch) {\n      altText = altTextMatch[1];\n      remainingValue = imageValue.replace(/\"([^\"]*)\"/, \"\").trim();\n    }\n\n    const parts = remainingValue.split(/\\s+/).filter((p) => p);\n    const src = parts[0] || null;\n\n    let alignment = null;\n    let width = null;\n    let showCaption = false;\n\n    for (let j = 1; j < parts.length; j++) {\n      const part = parts[j].toLowerCase();\n      if ([\"left\", \"right\", \"center\"].includes(part)) {\n        alignment = part;\n      } else if (part === \"caption\") {\n        showCaption = true;\n      } else if (part.match(/^\\d+(%|px|em|rem|vw)$/)) {\n        width = part;\n      }\n    }\n\n    return { src, alignment, width, altText, showCaption };\n  }\n\n  /**\n   * Parse STATBAR tag value\n   * @param {string} value - e.g., \"health 0 100 \"HP\"\" or \"morality \"Evil\" \"Good\"\"\n   * @returns {{variableName: string, min: number, max: number, leftLabel: string|null, rightLabel: string|null, isOpposed: boolean, clamp: boolean}}\n   */\n  parseStatBarTag(value) {\n    const statValue = value.trim();\n\n    const quotedStrings = [];\n    const quoteRegex = /\"([^\"]*)\"/g;\n    let match;\n\n    while ((match = quoteRegex.exec(statValue)) !== null) {\n      quotedStrings.push(match[1]);\n    }\n\n    const remainingValue = statValue.replace(/\"[^\"]*\"/g, \"\").trim();\n    const parts = remainingValue.split(/\\s+/).filter((p) => p);\n    const shouldClamp = parts.some((p) => p.toLowerCase() === \"clamp\");\n    const variableName = parts[0] || null;\n\n    let min = 0;\n    let max = 100;\n    const numbers = parts\n      .slice(1)\n      .map((p) => ({ value: parseFloat(p), original: p }))\n      .filter((p) => !isNaN(p.value));\n\n    if (numbers.length === 2) {\n      min = numbers[0].value;\n      max = numbers[1].value;\n    } else if (numbers.length === 1) {\n      log.warning(\n        `STATBAR \"${variableName}\" has only one number - provide both min and max (e.g., \"0 100\")`\n      );\n    } else if (numbers.length > 2) {\n      log.warning(\n        `STATBAR \"${variableName}\" has too many numbers - provide only min and max (e.g., \"0 100\")`\n      );\n    }\n\n    if (numbers.length === 2 && min >= max) {\n      log.warning(\n        `STATBAR \"${variableName}\" has min (${min}) >= max (${max}) - bar will not display correctly`\n      );\n    }\n\n    let leftLabel = null;\n    let rightLabel = null;\n    let isOpposed = false;\n\n    if (quotedStrings.length === 1) {\n      leftLabel = quotedStrings[0];\n    } else if (quotedStrings.length >= 2) {\n      leftLabel = quotedStrings[0];\n      rightLabel = quotedStrings[1];\n      isOpposed = true;\n    }\n    if (quotedStrings.length > 2) {\n      log.warning(\n        `STATBAR \"${variableName}\" has ${quotedStrings.length} labels - only first two are used`\n      );\n    }\n\n    const keywords = [\"clamp\"];\n    for (let i = 1; i < parts.length; i++) {\n      const part = parts[i].toLowerCase();\n      const isNumber = !isNaN(parseFloat(parts[i]));\n      const isKeyword = keywords.includes(part);\n\n      if (!isNumber && !isKeyword) {\n        log.warning(\n          `STATBAR \"${variableName}\" has unquoted text \"${parts[i]}\" - use quotes for labels (e.g., \"Label\")`\n        );\n        break;\n      }\n    }\n\n    return {\n      variableName,\n      min,\n      max,\n      leftLabel,\n      rightLabel,\n      isOpposed,\n      clamp: shouldClamp,\n    };\n  }\n\n  /**\n   * Parse USER_INPUT tag value\n   * @param {string} value - e.g., \"player_name \"Enter your name\"\"\n   * @returns {{variableName: string, placeholder: string}}\n   */\n  parseUserInputTag(value) {\n    const inputValue = value.trim();\n\n    let placeholder = \"\";\n    let remainingValue = inputValue;\n    const placeholderMatch = inputValue.match(/\"([^\"]*)\"/);\n    if (placeholderMatch) {\n      placeholder = placeholderMatch[1];\n      remainingValue = inputValue.replace(/\"([^\"]*)\"/, \"\").trim();\n    }\n\n    const parts = remainingValue.split(/\\s+/).filter((p) => p);\n    const variableName = parts[0];\n\n    return {\n      variableName,\n      placeholder,\n    };\n  }\n\n  /**\n   * Finds the first valid special action from an array of action functions.\n   * Special actions include RESTART, CLEAR, or page navigation objects.\n   * @param {Function[]} specialActions - Array of action functions to check\n   * @returns {Function|null} The first valid action function, or null if none found\n   * @private\n   */\n  findSpecialAction(specialActions) {\n    if (!Array.isArray(specialActions) || specialActions.length === 0) {\n      return null;\n    }\n\n    return specialActions.find((actionFn) => {\n      if (typeof actionFn !== \"function\") {\n        log.warning(\"Non-function found in specialActions array\");\n        return false;\n      }\n\n      try {\n        const result = actionFn();\n        return (\n          result === \"RESTART\" ||\n          result === \"CLEAR\" ||\n          (typeof result === \"object\" && result !== null)\n        );\n      } catch (error) {\n        log.error(\"Error executing special action function\", error);\n        return false;\n      }\n    });\n  }\n\n  /**\n   * Checks whether the processor is ready to process content.\n   * @returns {boolean} True if tagProcessor is available and functional\n   */\n  isReady() {\n    return !!this.tagProcessor?.processLineTags;\n  }\n\n  /**\n   * Returns diagnostic information about the processor's state.\n   * @returns {{hasTagProcessor: boolean, processorType: string, timestamp: string}}\n   */\n  getStats() {\n    return {\n      hasTagProcessor: !!this.tagProcessor,\n      processorType: this.tagProcessor?.constructor?.name || \"unknown\",\n      timestamp: new Date().toISOString(),\n    };\n  }\n}\n\nexport { ContentProcessor };\n", "import { TagRegistry, TAGS } from \"./tag-registry.js\";\nimport { Utils } from \"./utils.js\";\nimport { notificationManager } from \"./notification-manager.js\";\nimport { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.TAG_PROCESSOR);\n\n/**\n * Processes ink tags into actions, CSS classes, and side effects.\n * Handles audio playback, background images, notifications, and custom styling.\n * Uses a handler map pattern for extensible tag processing.\n */\nclass TagProcessor {\n  /**\n   * Creates the tag processor with optional settings for audio control.\n   * @param {Object} [settings=null] - SettingsManager instance for audio enabled state\n   */\n  constructor(settings = null) {\n    this.settings = settings;\n    this.storyContainer = document.querySelector(\"#story\");\n    this.outerScrollContainer = document.querySelector(\".outerContainer\");\n    this.audio = null;\n    this.audioLoop = null;\n    this.lastAudioLoopSrc = null;\n\n    this.tagHandlers = new Map([\n      [\n        TAGS.AUDIO,\n        (value, ctx) => {\n          ctx.specialActions?.push(() => this.playAudio(value));\n        },\n      ],\n      [\n        TAGS.AUDIOLOOP,\n        (value, ctx) => {\n          ctx.specialActions?.push(() => this.playAudioLoop(value));\n        },\n      ],\n      [\n        TAGS.BACKGROUND,\n        (value, ctx) => {\n          ctx.specialActions?.push(() => this.setBackground(value));\n        },\n      ],\n      [\n        TAGS.NOTIFICATION,\n        (value, ctx) => {\n          ctx.specialActions?.push(() => this.showNotification(value, \"info\"));\n        },\n      ],\n      [\n        TAGS.ACHIEVEMENT,\n        (value, ctx) => {\n          ctx.specialActions?.push(() =>\n            this.showNotification(value, \"success\", 6000)\n          );\n        },\n      ],\n      [\n        TAGS.WARNING,\n        (value, ctx) => {\n          ctx.specialActions?.push(() =>\n            this.showNotification(value, \"warning\")\n          );\n        },\n      ],\n      [\n        TAGS.ERROR,\n        (value, ctx) => {\n          ctx.specialActions?.push(() => this.showNotification(value, \"error\"));\n        },\n      ],\n      [\n        TAGS.CLASS,\n        (value, ctx) => {\n          if (value) ctx.customClasses.push(value);\n        },\n      ],\n    ]);\n\n    this.simpleTagHandlers = new Map([\n      [\n        TAGS.CLEAR,\n        (ctx) => {\n          ctx.specialActions?.push(() => \"CLEAR\");\n        },\n      ],\n      [\n        TAGS.RESTART,\n        (ctx) => {\n          ctx.specialActions?.push(() => \"RESTART\");\n        },\n      ],\n      [\n        TAGS.UNCLICKABLE,\n        (ctx) => {\n          ctx.isClickable = false;\n        },\n      ],\n    ]);\n  }\n\n  /**\n   * Processes tags attached to a story line (paragraph).\n   * Extracts CSS classes and queues special actions (audio, notifications, etc.).\n   * @param {string[]} tags - Array of tag strings from the story\n   * @returns {{customClasses: string[], specialActions: Array}} Processed tag results\n   */\n  processLineTags(tags) {\n    try {\n      if (!Array.isArray(tags)) {\n        log.warning(\"Invalid tags array passed to processLineTags\");\n        return { customClasses: [], specialActions: [] };\n      }\n\n      const ctx = { customClasses: [], specialActions: [] };\n      this._processTags(tags, ctx, \"line\", false);\n      return ctx;\n    } catch (error) {\n      log.error(\"Failed to process line tags\", error);\n      return { customClasses: [], specialActions: [] };\n    }\n  }\n\n  /**\n   * Processes tags attached to a choice.\n   * Extracts CSS classes and determines if choice is clickable.\n   * @param {string[]} choiceTags - Array of tag strings from the choice\n   * @returns {{customClasses: string[], isClickable: boolean}} Processed tag results\n   */\n  processChoiceTags(choiceTags) {\n    try {\n      if (!Array.isArray(choiceTags)) {\n        log.warning(\"Invalid choiceTags array passed to processChoiceTags\");\n        return { customClasses: [], isClickable: true };\n      }\n\n      const ctx = { customClasses: [], isClickable: true };\n      this._processTags(choiceTags, ctx, \"choice\", true);\n      return ctx;\n    } catch (error) {\n      log.error(\"Failed to process choice tags\", error);\n      return { customClasses: [], isClickable: true };\n    }\n  }\n\n  /**\n   * Internal tag processing logic shared by line and choice processing\n   * @param {Array} tags - Tags to process\n   * @param {Object} ctx - Context object to populate\n   * @param {string} context - 'line' or 'choice' for warnings\n   * @param {boolean} allowTones - Whether to allow tone indicators\n   */\n  _processTags(tags, ctx, context, allowTones) {\n    for (const tag of tags) {\n      const { tagDef, tagValue, invalid, error } = TagRegistry.parseTag(tag);\n\n      if (invalid) {\n        if (error) log.warning(error);\n        continue;\n      }\n\n      const handler = this.tagHandlers.get(tagDef);\n      if (handler) {\n        handler(tagValue, ctx);\n        continue;\n      }\n\n      const simpleHandler = this.simpleTagHandlers.get(tagDef);\n      if (simpleHandler) {\n        simpleHandler(ctx);\n        continue;\n      }\n\n      if (tagDef !== null) {\n        // Known marker tag (handled elsewhere) - skip silently\n        continue;\n      }\n\n      if (!tag || typeof tag !== \"string\") continue;\n\n      const isPropertyTag = tag.includes(\":\");\n      const tagName = isPropertyTag ? tag.split(\":\")[0].trim() : tag.trim();\n      if (!tagName) continue;\n\n      if (\n        allowTones &&\n        !isPropertyTag &&\n        TagRegistry.isRegisteredToneTag(tagName)\n      ) {\n        ctx.customClasses.push(tagName.toLowerCase());\n        continue;\n      }\n\n      this.warnUnknownTag(tagName, context, tag);\n    }\n  }\n\n  /**\n   * Plays a one-shot audio file.\n   * Respects the audioEnabled setting. Stops any currently playing one-shot audio.\n   * @param {string} src - Path to the audio file\n   */\n  playAudio(src) {\n    try {\n      if (this.settings && !this.settings.getSetting(\"audioEnabled\")) {\n        return;\n      }\n\n      if (!src || typeof src !== \"string\") {\n        log.warning(\"Invalid audio source provided\");\n        return;\n      }\n\n      if (this.audio) {\n        this.audio.pause();\n        this.audio.removeAttribute(\"src\");\n        this.audio.load();\n      }\n\n      this.audio = new Audio(src);\n      this.audio.play().catch((error) => {\n        log.warning(`Failed to play audio: ${src}`, error);\n      });\n    } catch (error) {\n      log.error(\"Failed to play audio\", error);\n    }\n  }\n\n  /**\n   * Plays a looping audio file (background music).\n   * Pass \"none\" or \"stop\" to stop the loop. Remembers last source for resume.\n   * @param {string} src - Path to the audio file, or \"none\"/\"stop\" to stop\n   */\n  playAudioLoop(src) {\n    try {\n      if (!src || typeof src !== \"string\") {\n        log.warning(\"Invalid audio loop source provided\");\n        return;\n      }\n\n      if (src.toLowerCase() === \"none\" || src === \"stop\") {\n        this.lastAudioLoopSrc = null;\n        if (this.audioLoop) {\n          this.audioLoop.pause();\n          this.audioLoop.removeAttribute(\"src\");\n          this.audioLoop.load();\n          this.audioLoop = null;\n        }\n        return;\n      }\n\n      this.lastAudioLoopSrc = src;\n\n      if (this.settings && !this.settings.getSetting(\"audioEnabled\")) {\n        return;\n      }\n\n      if (this.audioLoop) {\n        this.audioLoop.pause();\n        this.audioLoop.removeAttribute(\"src\");\n        this.audioLoop.load();\n        this.audioLoop = null;\n      }\n\n      this.audioLoop = new Audio(src);\n      this.audioLoop.loop = true;\n      this.audioLoop.play().catch((error) => {\n        log.warning(`Failed to play audio loop: ${src}`, error);\n      });\n    } catch (error) {\n      log.error(\"Failed to play audio loop\", error);\n    }\n  }\n\n  /**\n   * Stops all currently playing audio (both one-shot and looping).\n   */\n  stopAllAudio() {\n    try {\n      if (this.audio) {\n        this.audio.pause();\n        this.audio.removeAttribute(\"src\");\n        this.audio.load();\n        this.audio = null;\n      }\n\n      if (this.audioLoop) {\n        this.audioLoop.pause();\n        this.audioLoop.removeAttribute(\"src\");\n        this.audioLoop.load();\n        this.audioLoop = null;\n      }\n    } catch (error) {\n      log.warning(\"Failed to stop audio\", error);\n    }\n  }\n\n  /**\n   * Resumes the last audio loop if audio is enabled.\n   * Called when audio setting is re-enabled.\n   */\n  resumeAudioLoop() {\n    try {\n      if (this.lastAudioLoopSrc && this.settings?.getSetting(\"audioEnabled\")) {\n        this.playAudioLoop(this.lastAudioLoopSrc);\n      }\n    } catch (error) {\n      log.warning(\"Failed to resume audio loop\", error);\n    }\n  }\n\n  /**\n   * Sets the background image on the outer scroll container.\n   * Pass \"none\" or empty string to remove the background.\n   * @param {string} src - Path to the image file, or \"none\" to remove\n   */\n  setBackground(src) {\n    try {\n      if (!this.outerScrollContainer) {\n        log.warning(\"Outer scroll container not available for background\");\n        return;\n      }\n\n      if (!src || typeof src !== \"string\") {\n        log.warning(\"Invalid background source provided\");\n        return;\n      }\n\n      if (src.toLowerCase() === \"none\" || src === \"\") {\n        this.outerScrollContainer.style.backgroundImage = \"none\";\n      } else {\n        this.outerScrollContainer.style.backgroundImage = \"url(\" + src + \")\";\n      }\n    } catch (error) {\n      log.error(\"Failed to set background\", error);\n    }\n  }\n\n  /**\n   * Shows a notification via the notification manager.\n   * @param {string} message - The notification message\n   * @param {string} [type='info'] - Notification type (info, success, warning, error)\n   * @param {number} [duration=4000] - Duration in milliseconds\n   */\n  showNotification(message, type = \"info\", duration = 4000) {\n    if (notificationManager) {\n      notificationManager.show(message, { type, duration });\n    }\n  }\n\n  /**\n   * Warn about unknown tags with helpful suggestions\n   * @param {string} tagName - The unknown tag\n   * @param {string} context - 'line' or 'choice'\n   */\n  warnUnknownTag(tagName, context, fullTag = \"\") {\n    // Only warn once per tag name to avoid console spam\n    this.warnedTags = this.warnedTags || new Set();\n    if (this.warnedTags.has(tagName.toUpperCase())) return;\n    this.warnedTags.add(tagName.toUpperCase());\n\n    const similar = this.getSimilarTags(tagName);\n\n    let suggestion = \"\";\n    if (similar.length > 0) {\n      suggestion = ` Did you mean: ${similar.join(\", \")}?`;\n    } else {\n      if (context === \"line\") {\n        suggestion = \" Use # CLASS: for custom CSS classes.\";\n      } else if (context === \"choice\") {\n        suggestion =\n          \" For tone indicators, define with # TONE: tagname icon first.\";\n      }\n    }\n\n    log.warning(\n      `Unknown tag \"${tagName}\" on ${context}: \"# ${fullTag}\".${suggestion}`\n    );\n  }\n\n  /**\n   * Finds similar known tags for typo suggestions using prefix matching and Levenshtein distance.\n   * @param {string} tagName - The unknown tag name\n   * @returns {string[]} Up to 3 similar tag names\n   * @private\n   */\n  getSimilarTags(tagName) {\n    if (!TAGS) return [];\n\n    const input = tagName.toUpperCase();\n    const knownTags = Object.keys(TAGS);\n\n    return knownTags\n      .filter((known) => {\n        if (input.length >= 3 && known.startsWith(input.slice(0, 3)))\n          return true;\n        if (known.length >= 3 && input.startsWith(known.slice(0, 3)))\n          return true;\n        return Utils.levenshteinDistance(input, known) <= 2;\n      })\n      .slice(0, 3);\n  }\n\n  /**\n   * Checks whether the tag processor is ready for use.\n   * @returns {boolean} True if story container or outer container is available\n   */\n  isReady() {\n    try {\n      return !!(this.storyContainer || this.outerScrollContainer);\n    } catch (error) {\n      log.warning(\"Failed to check readiness\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Returns diagnostic information about the tag processor state.\n   * @returns {{hasStoryContainer: boolean, hasOuterScrollContainer: boolean, hasActiveAudio: boolean, hasActiveAudioLoop: boolean}}\n   */\n  getStats() {\n    try {\n      return {\n        hasStoryContainer: !!this.storyContainer,\n        hasOuterScrollContainer: !!this.outerScrollContainer,\n        hasActiveAudio: !!this.audio,\n        hasActiveAudioLoop: !!this.audioLoop,\n      };\n    } catch (error) {\n      log.warning(\"Failed to get stats\", error);\n      return {};\n    }\n  }\n\n  /**\n   * Cleans up audio resources when the processor is distroyed.\n   */\n  cleanup() {\n    try {\n      if (this.audio) {\n        this.audio.pause();\n        this.audio = null;\n      }\n      if (this.audioLoop) {\n        this.audioLoop.pause();\n        this.audioLoop = null;\n      }\n    } catch (error) {\n      log.warning(\"Failed to cleanup\", error);\n    }\n  }\n}\n\nexport { TagProcessor };\n", "import { TagRegistry, TAGS } from \"./tag-registry.js\";\nimport { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.SETTINGS_MANAGER);\n\n/**\n * Manages user preferences including theme, font, text size, animations,\n * and accessibility options. Persists settings to localStorage and applies\n * them to the DOM via CSS custom properties and classes.\n */\nclass SettingsManager {\n  /**\n   * Creates the settings manager and loads any saved user preferences.\n   */\n  constructor() {\n    this.settings = this.getDefaults();\n\n    // Wired by main.js after construction\n    this.storyManager = null;\n    this.keyboardShortcuts = null;\n    this.settingsModal = null;\n\n    this.storyTitle = \"Untitled\";\n    this.storyAuthor = null;\n    this.toneIndicatorsAvailable = false;\n    this.authorToneIndicators = true;\n    this.toneIndicatorsTrailing = false;\n    this.authorChoiceNumbering = \"auto\";\n\n    this.init();\n  }\n\n  /**\n   * Initializes settings by loading stored values, setting up theme detection, and applying.\n   * @private\n   */\n  init() {\n    this.loadSettings();\n    this.setupThemeDetection();\n    this.applySettings();\n  }\n\n  /**\n   * Opens the settings modal dialog.\n   */\n  showSettings() {\n    this.settingsModal?.show?.();\n  }\n\n  /**\n   * Returns the default settings object.\n   * @returns {Object} Default settings values\n   * @private\n   */\n  getDefaults() {\n    return {\n      theme: \"auto\",\n      textSize: \"medium\",\n      lineHeight: \"normal\",\n      fontFamily: \"serif\",\n      audioEnabled: true,\n      autoSave: true,\n      animations: true,\n      toneIndicators: this.authorToneIndicators || false,\n      choiceNumbering: this.authorChoiceNumbering || \"auto\",\n      keyboardShortcuts: true,\n    };\n  }\n\n  /**\n   * Sets up a listener for system theme changes (prefers-color-scheme).\n   * @private\n   */\n  setupThemeDetection() {\n    const mediaQuery = window.matchMedia(\"(prefers-color-scheme: dark)\");\n    mediaQuery.addEventListener(\"change\", () => {\n      if (this.settings.theme === \"auto\") {\n        this.applyTheme();\n      }\n    });\n  }\n\n  /**\n   * Gets a single setting value by key.\n   * @param {string} key - The setting key\n   * @returns {*} The setting value\n   */\n  getSetting(key) {\n    return this.settings[key];\n  }\n\n  /**\n   * Sets a single setting value, stores it, and applies all settings.\n   * @param {string} key - The setting key\n   * @param {*} value - The new value\n   */\n  setSetting(key, value) {\n    if (key in this.settings) {\n      this.settings[key] = value;\n      this.storeSettings();\n      this.applySettings();\n    }\n  }\n\n  /**\n   * Resets all settings to their default values and applies them.\n   */\n  resetToDefaults() {\n    this.settings = this.getDefaults();\n    this.applySettings();\n  }\n\n  /**\n   * Cycles through theme options (auto \u2192 light/dark \u2192 opposite).\n   */\n  toggleTheme() {\n    const currentIsDark = document.body?.classList.contains(\"dark\");\n\n    if (this.settings.theme === \"auto\") {\n      // If auto, switch to opposite of current state\n      this.settings.theme = currentIsDark ? \"light\" : \"dark\";\n    } else if (this.settings.theme === \"light\") {\n      this.settings.theme = \"dark\";\n    } else {\n      this.settings.theme = \"light\";\n    }\n\n    this.storeSettings();\n    this.applyTheme();\n  }\n\n  /**\n   * Loads settings from localStorage, merging with defaults.\n   * @private\n   */\n  loadSettings() {\n    try {\n      const parsed = this.getStoredSettings();\n      if (parsed) {\n        this.settings = { ...this.settings, ...parsed };\n      }\n    } catch (error) {\n      log.warning(\"Failed to load settings\", error);\n    }\n  }\n\n  /**\n   * Saves current settings to localStorage.\n   * @private\n   */\n  storeSettings() {\n    try {\n      localStorage.setItem(\n        \"ink-template-settings\",\n        JSON.stringify(this.settings)\n      );\n    } catch (error) {\n      log.error(\"Failed to store settings\", error);\n    }\n  }\n\n  /**\n   * Retrieves stored settings from localStorage.\n   * @returns {Object|null} Parsed settings object, or null if not found/invalid\n   * @private\n   */\n  getStoredSettings() {\n    try {\n      const stored = localStorage.getItem(\"ink-template-settings\");\n      return stored ? JSON.parse(stored) : null;\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Applies all settings to the DOM (theme, fonts, animations, etc.).\n   */\n  applySettings() {\n    this.applyTheme();\n    this.applyFontFamily();\n    this.applyTextSize();\n    this.applyLineHeight();\n    this.applyAnimations();\n    this.applyChoiceNumbering();\n    this.applyKeyboardShortcuts();\n  }\n\n  /**\n   * Applies a single setting by name (used for real-time preview).\n   * @param {string} setting - The setting key to apply\n   */\n  applyIndividualSetting(setting) {\n    switch (setting) {\n      case \"theme\":\n        this.applyTheme();\n        break;\n      case \"fontFamily\":\n        this.applyFontFamily();\n        break;\n      case \"textSize\":\n        this.applyTextSize();\n        break;\n      case \"lineHeight\":\n        this.applyLineHeight();\n        break;\n      case \"toneIndicators\":\n        this.refreshChoices();\n        break;\n      case \"choiceNumbering\":\n        this.applyChoiceNumbering();\n        break;\n      case \"keyboardShortcuts\":\n        this.applyKeyboardShortcuts();\n        break;\n    }\n  }\n\n  /**\n   * Applies the current theme setting to the document.\n   * Handles 'auto', 'light', and 'dark' modes.\n   * @private\n   */\n  applyTheme() {\n    const body = document.body;\n    const html = document.documentElement;\n    if (!body) return;\n\n    body.classList.remove(\"dark\");\n    html.classList.remove(\"dark\");\n\n    if (this.settings.theme === \"dark\") {\n      body.classList.add(\"dark\");\n      html.classList.add(\"dark\");\n    } else if (this.settings.theme === \"auto\") {\n      const prefersDark = window.matchMedia(\n        \"(prefers-color-scheme: dark)\"\n      ).matches;\n      if (prefersDark) {\n        body.classList.add(\"dark\");\n        html.classList.add(\"dark\");\n      }\n    }\n\n    body.classList.add(\"switched\");\n  }\n\n  /**\n   * Applies the font family setting via CSS custom property.\n   * @private\n   */\n  applyFontFamily() {\n    const root = document.documentElement;\n    if (!root) return;\n\n    const fonts = {\n      serif: \"var(--font-serif)\",\n      sans: \"var(--font-sans)\",\n      mono: \"var(--font-monospace)\",\n      dyslexic: \"var(--font-dyslexic)\",\n    };\n\n    root.style.setProperty(\n      \"--font-main\",\n      fonts[this.settings.fontFamily] || fonts.serif\n    );\n  }\n\n  /**\n   * Applies the text size setting via CSS custom property.\n   * @private\n   */\n  applyTextSize() {\n    const root = document.documentElement;\n    if (!root) return;\n\n    const sizes = {\n      small: \"11pt\",\n      medium: \"13pt\",\n      large: \"15pt\",\n      xl: \"17pt\",\n    };\n\n    root.style.setProperty(\n      \"--text-size-base\",\n      sizes[this.settings.textSize] || sizes.medium\n    );\n  }\n\n  /**\n   * Applies the line height setting via CSS custom properties.\n   * @private\n   */\n  applyLineHeight() {\n    const root = document.documentElement;\n    if (!root) return;\n\n    const heights = {\n      tight: \"1.4em\",\n      normal: \"1.7em\",\n      loose: \"2.0em\",\n    };\n\n    const height = heights[this.settings.lineHeight] || heights.normal;\n    root.style.setProperty(\"--line-height-text\", height);\n    root.style.setProperty(\"--line-height-choice\", height);\n  }\n\n  /**\n   * Applies or disables CSS transitions based on the animations setting.\n   * @private\n   */\n  applyAnimations() {\n    const root = document.documentElement;\n    if (!root) return;\n\n    if (!this.settings.animations) {\n      root.style.setProperty(\"--transition-fast\", \"0s\");\n      root.style.setProperty(\"--transition-medium\", \"0s\");\n      root.style.setProperty(\"--transition-slow\", \"0s\");\n      root.style.setProperty(\"--transition-very-slow\", \"0s\");\n    } else {\n      root.style.setProperty(\"--transition-fast\", \"0.1s\");\n      root.style.setProperty(\"--transition-medium\", \"0.2s\");\n      root.style.setProperty(\"--transition-slow\", \"0.6s\");\n      root.style.setProperty(\"--transition-very-slow\", \"1s\");\n    }\n  }\n\n  /**\n   * Applies the choice numbering mode via body class.\n   * @private\n   */\n  applyChoiceNumbering() {\n    document.body?.classList.remove(\n      \"choice-numbers-on\",\n      \"choice-numbers-off\",\n      \"choice-numbers-auto\"\n    );\n    document.body?.classList.add(\n      `choice-numbers-${this.settings.choiceNumbering || \"auto\"}`\n    );\n  }\n\n  /**\n   * Enables or disables keyboard shortcuts based on the setting.\n   * @private\n   */\n  applyKeyboardShortcuts() {\n    if (this.settings.keyboardShortcuts) {\n      this.keyboardShortcuts?.enable?.();\n    } else {\n      this.keyboardShortcuts?.disable?.();\n    }\n\n    this.settingsModal?.updateKeyboardHelpButtonVisibility?.();\n  }\n\n  /**\n   * Process global tags from the story for initial author setup\n   * @param {Array} globalTags - Array of global tags from the story\n   */\n  processGlobalTags(globalTags) {\n    if (!Array.isArray(globalTags)) return;\n\n    if (!TAGS || !TagRegistry.getTagDef) return;\n\n    for (const tag of globalTags) {\n      if (typeof tag !== \"string\") continue;\n\n      const { tagDef, tagValue, invalid } = TagRegistry.parseTag(tag);\n      if (invalid) continue;\n\n      switch (tagDef) {\n        case TAGS.THEME:\n          const storedSettings = this.getStoredSettings();\n          if (!storedSettings?.theme) {\n            this.settings.theme = tagValue === \"dark\" ? \"dark\" : \"light\";\n          }\n          break;\n\n        case TAGS.TITLE:\n          this.storyTitle = tagValue;\n          const titleElements = document.querySelectorAll(\".title\");\n          titleElements.forEach((el) => (el.textContent = tagValue));\n          break;\n\n        case TAGS.AUTHOR:\n          this.storyAuthor = tagValue;\n          const bylineElement = document.querySelector(\".byline\");\n          if (bylineElement) {\n            bylineElement.textContent = `by ${tagValue}`;\n          }\n          break;\n\n        case TAGS.CHOICE_NUMBERS: {\n          const numMode = tagValue.toLowerCase();\n          if (numMode === \"off\") {\n            this.authorChoiceNumbering = \"off\";\n          } else if (numMode === \"on\") {\n            this.authorChoiceNumbering = \"on\";\n          } else {\n            this.authorChoiceNumbering = \"auto\"; // = keyboard only (default)\n          }\n\n          const storedSettings = this.getStoredSettings();\n          if (!storedSettings?.choiceNumbering) {\n            this.settings.choiceNumbering = this.authorChoiceNumbering;\n          }\n\n          this.applyChoiceNumbering();\n          break;\n        }\n\n        case TAGS.TONE_INDICATORS:\n          const toneMode = tagValue.toLowerCase();\n          this.toneIndicatorsAvailable = true;\n          this.authorToneIndicators = toneMode !== \"off\" || false;\n          this.settings.toneIndicators = toneMode !== \"off\";\n          break;\n\n        case TAGS.TONE_TRAILING:\n          this.toneIndicatorsTrailing = true;\n          break;\n\n        case TAGS.TONE: // TONE: label icon\n          const spaceIndex = tagValue.indexOf(\" \");\n          if (spaceIndex !== -1) {\n            const label = tagValue.substring(0, spaceIndex).trim();\n            const icon = tagValue.substring(spaceIndex + 1).trim();\n            TagRegistry.registerTone(label, icon);\n            this.toneIndicatorsAvailable = true;\n          }\n          break;\n      }\n    }\n\n    // Update document title with both title and author (order-independent)\n    let fullTitle = this.storyTitle;\n    if (this.storyAuthor) {\n      fullTitle += `, by ${this.storyAuthor}`;\n    }\n    fullTitle += \" - Interactive Fiction\";\n    document.title = fullTitle;\n  }\n\n  /**\n   * Handles changes to the audio setting, stopping or resuming audio as needed.\n   * @param {boolean} wasEnabled - Previous audio enabled state\n   * @param {boolean} isEnabled - New audio enabled state\n   */\n  handleAudioSettingChange(wasEnabled, isEnabled) {\n    try {\n      const tagProcessor = this.storyManager?.contentProcessor?.tagProcessor;\n      if (!tagProcessor) {\n        return;\n      }\n\n      if (wasEnabled && !isEnabled) {\n        tagProcessor.stopAllAudio();\n      } else if (!wasEnabled && isEnabled) {\n        tagProcessor.resumeAudioLoop();\n      }\n    } catch (error) {\n      log.warning(\"Failed to handle audio setting change\", error);\n    }\n  }\n\n  /**\n   * Re-renders choices to reflect updated settings (e.g., tone indicators).\n   * @private\n   */\n  refreshChoices() {\n    if (\n      this.storyManager?.display?.domHelpers &&\n      this.storyManager?.story?.currentChoices?.length > 0\n    ) {\n      // Re-render existing choices\n      this.storyManager.display.domHelpers.removeAll(\".choice\");\n      this.storyManager.createChoices();\n    }\n  }\n\n  /**\n   * Checks if animations are currently enabled.\n   * @returns {boolean} True if animations are enabled\n   */\n  isAnimationEnabled() {\n    return this.settings.animations;\n  }\n\n  /**\n   * Get tone indicators for a set of choice tags\n   * @param {Array} tags - Choice tags\n   * @returns {Array} Array of icon strings (max 3)\n   */\n  getToneIndicators(tags) {\n    if (!this.toneIndicatorsAvailable || !this.settings.toneIndicators) {\n      return [];\n    }\n\n    const indicators = [];\n    for (const tag of tags) {\n      if (typeof tag !== \"string\") continue;\n      const normalizedTag = tag.trim().toLowerCase();\n      const icon = TagRegistry.getToneIcon(normalizedTag);\n      if (icon) {\n        indicators.push({\n          label: normalizedTag,\n          icon: icon,\n        });\n      }\n    }\n    return indicators;\n  }\n\n  /**\n   * Checks whether the settings manager is ready for use.\n   * @returns {boolean} True if document is available\n   */\n  isReady() {\n    return !!document.documentElement;\n  }\n\n  /**\n   * Returns diagnostic information about the settings state.\n   * @returns {{currentTheme: string, settingsCount: number}}\n   */\n  getStats() {\n    return {\n      currentTheme: this.settings.theme,\n      settingsCount: Object.keys(this.settings).length,\n    };\n  }\n}\n\nexport { SettingsManager };\n", "import { BaseModal } from \"./base-modal.js\";\nimport { StoryFeatures } from \"./tag-registry.js\";\nimport { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.SETTINGS_MANAGER);\n\n/**\n * Modal UI for user settings with tabbed interface.\n * Handles reading preferences, accessibility options, and audio settings.\n * Provides real-time preview of setting changes.\n */\nclass SettingsModal {\n  /**\n   * Creates the settings modal UI.\n   * @param {Object} settingsManager - The SettingsManager instance that handles settings logic\n   * @throws {Error} If settingsManager is not provided\n   */\n  constructor(settingsManager) {\n    if (!settingsManager) {\n      throw new Error(\"SettingsModal requires a SettingsManager instance\");\n    }\n    this.settingsManager = settingsManager;\n    this.modal = null;\n\n    // These will be wired by main.js\n    this.keyboardHelpModal = null;\n\n    this.init();\n  }\n\n  /**\n   * Initializes the modal and event listeners.\n   * @private\n   */\n  init() {\n    this.createModal();\n    this.setupEventListeners();\n  }\n\n  /**\n   * Creates the settings modal using BaseModal.\n   * @private\n   */\n  createModal() {\n    this.modal = new BaseModal({\n      title: \"Settings\",\n      className: \"settings-modal\",\n      maxWidth: \"500px\",\n      onShow: () => this.populateSettings(),\n      onHide: () => this.saveSettings(),\n    });\n  }\n\n  /**\n   * Sets up the settings button click handler.\n   * @private\n   */\n  setupEventListeners() {\n    const settingsBtn = document.getElementById(\"settings-btn\");\n    if (settingsBtn) {\n      settingsBtn.addEventListener(\"click\", (e) => {\n        e.preventDefault();\n        this.show();\n      });\n    }\n  }\n\n  /**\n   * Opens the settings modal and populates it with current values.\n   */\n  show() {\n    if (!this.modal?.isReady()) {\n      log.error(\"Cannot show settings - modal not available\");\n      return;\n    }\n\n    this.modal.show((modal) => {\n      modal.setContent(this.getSettingsHTML());\n\n      const footer = modal.getFooter();\n      if (footer) {\n        footer.innerHTML = \"\";\n        footer.className = \"modal-footer modal-footer-split\";\n\n        const resetBtn = modal.createButton(\"Reset to Defaults\", {\n          variant: \"secondary\",\n          onClick: () => this.resetSettings(),\n        });\n\n        const doneBtn = modal.createButton(\"Done\", {\n          variant: \"primary\",\n          onClick: () => this.hide(),\n        });\n\n        footer.appendChild(resetBtn);\n        footer.appendChild(doneBtn);\n      }\n\n      this.setupTabSwitching();\n      this.setupRealtimePreview();\n      this.updateKeyboardHelpButtonVisibility();\n\n      const helpBtn =\n        this.modal.modalElement.querySelector(\".keyboard-help-btn\");\n      if (helpBtn) {\n        helpBtn.addEventListener(\"click\", () => {\n          this.hide();\n          this.keyboardHelpModal?.show?.();\n        });\n      }\n    });\n  }\n\n  /**\n   * Closes the settings modal.\n   */\n  hide() {\n    this.modal?.hide();\n  }\n\n  /**\n   * Checks whether the modal is ready for use.\n   * @returns {boolean} True if modal is initialized\n   */\n  isReady() {\n    return !!this.modal?.isReady();\n  }\n\n  /**\n   * Resets all settings to defaults and updates the form.\n   */\n  resetSettings() {\n    this.settingsManager.resetToDefaults();\n    this.populateSettings();\n    this.modal.showNotification(\"Settings reset to defaults\");\n  }\n\n  /**\n   * Reads values from the form and saves them to the settings manager.\n   * Called automatically when the modal is closed.\n   * @private\n   */\n  saveSettings() {\n    if (!this.modal?.modalElement) return;\n\n    const getValue = (name, isCheckbox = false) => {\n      const element = this.modal.modalElement.querySelector(`[name=\"${name}\"]`);\n      return element ? (isCheckbox ? element.checked : element.value) : null;\n    };\n\n    const prevAudioEnabled = this.settingsManager.settings.audioEnabled;\n\n    const settings = this.settingsManager.settings;\n    settings.theme = getValue(\"theme\") || settings.theme;\n    settings.fontFamily = getValue(\"fontFamily\") || settings.fontFamily;\n    settings.textSize = getValue(\"textSize\") || settings.textSize;\n    settings.lineHeight = getValue(\"lineHeight\") || settings.lineHeight;\n    settings.audioEnabled =\n      getValue(\"audioEnabled\", true) ?? settings.audioEnabled;\n    settings.autoSave = getValue(\"autoSave\", true) ?? settings.autoSave;\n    settings.animations = getValue(\"animations\", true) ?? settings.animations;\n    settings.choiceNumbering =\n      getValue(\"choiceNumbering\") || settings.choiceNumbering;\n    settings.toneIndicators =\n      getValue(\"toneIndicators\", true) ?? settings.toneIndicators;\n    settings.keyboardShortcuts =\n      getValue(\"keyboardShortcuts\", true) ?? settings.keyboardShortcuts;\n\n    this.settingsManager.handleAudioSettingChange(\n      prevAudioEnabled,\n      settings.audioEnabled\n    );\n    this.settingsManager.storeSettings();\n    this.settingsManager.applySettings();\n\n    this.modal.showNotification(\"Settings saved successfully!\");\n  }\n\n  /**\n   * Populates form elements with current setting values.\n   * Called automatically when the modal is shown.\n   * @private\n   */\n  populateSettings() {\n    if (!this.modal?.modalElement) return;\n\n    const settings = this.settingsManager.settings;\n    const elements = [\n      { name: \"theme\", value: settings.theme },\n      { name: \"fontFamily\", value: settings.fontFamily },\n      { name: \"textSize\", value: settings.textSize },\n      { name: \"lineHeight\", value: settings.lineHeight },\n      { name: \"audioEnabled\", checked: settings.audioEnabled },\n      { name: \"autoSave\", checked: settings.autoSave },\n      { name: \"animations\", checked: settings.animations },\n      { name: \"choiceNumbering\", value: settings.choiceNumbering },\n      { name: \"toneIndicators\", checked: settings.toneIndicators },\n      { name: \"keyboardShortcuts\", checked: settings.keyboardShortcuts },\n    ];\n\n    elements.forEach(({ name, value, checked }) => {\n      const element = this.modal.modalElement.querySelector(`[name=\"${name}\"]`);\n      if (element) {\n        if (typeof checked !== \"undefined\") {\n          element.checked = checked;\n        } else {\n          element.value = value;\n        }\n      }\n    });\n  }\n\n  /**\n   * Sets up change listeners for real-time preview of settings.\n   * Changes are applied immediately as the user adjusts values.\n   * @private\n   */\n  setupRealtimePreview() {\n    if (!this.modal?.modalElement) return;\n\n    const elements = {\n      theme: this.modal.modalElement.querySelector('select[name=\"theme\"]'),\n      fontFamily: this.modal.modalElement.querySelector(\n        'select[name=\"fontFamily\"]'\n      ),\n      textSize: this.modal.modalElement.querySelector(\n        'select[name=\"textSize\"]'\n      ),\n      lineHeight: this.modal.modalElement.querySelector(\n        'select[name=\"lineHeight\"]'\n      ),\n      toneIndicators: this.modal.modalElement.querySelector(\n        'input[name=\"toneIndicators\"]'\n      ),\n      choiceNumbering: this.modal.modalElement.querySelector(\n        'select[name=\"choiceNumbering\"]'\n      ),\n      keyboardShortcuts: this.modal.modalElement.querySelector(\n        'input[name=\"keyboardShortcuts\"]'\n      ),\n    };\n\n    Object.entries(elements).forEach(([setting, element]) => {\n      if (element) {\n        element.addEventListener(\"change\", () => {\n          if (element.type === \"checkbox\") {\n            this.settingsManager.settings[setting] = element.checked;\n          } else {\n            this.settingsManager.settings[setting] = element.value;\n          }\n          this.settingsManager.applyIndividualSetting(setting);\n        });\n      }\n    });\n  }\n\n  /**\n   * Sets up click and keyboard handlers for tab navigation.\n   * @private\n   */\n  setupTabSwitching() {\n    if (!this.modal?.modalElement) return;\n\n    const tabs = this.modal.modalElement.querySelectorAll(\".settings-tab\");\n    tabs.forEach((tab) => {\n      tab.addEventListener(\"click\", () => this.switchTab(tab.dataset.tab));\n      tab.addEventListener(\"keydown\", (e) => this.handleTabKeydown(e, tabs));\n    });\n  }\n\n  /**\n   * Switches to the specified settings tab.\n   * @param {string} tabId - The tab ID to switch to (reading, accessibility, audio)\n   * @private\n   */\n  switchTab(tabId) {\n    if (!this.modal?.modalElement) return;\n\n    const tabs = this.modal.modalElement.querySelectorAll(\".settings-tab\");\n    tabs.forEach((tab) => {\n      const isActive = tab.dataset.tab === tabId;\n      tab.classList.toggle(\"active\", isActive);\n      tab.setAttribute(\"aria-selected\", isActive);\n      tab.setAttribute(\"tabindex\", isActive ? \"0\" : \"-1\");\n    });\n\n    const panels = this.modal.modalElement.querySelectorAll(\".settings-panel\");\n    panels.forEach((panel) => {\n      panel.classList.toggle(\"active\", panel.id === `panel-${tabId}`);\n    });\n  }\n\n  /**\n   * Handles keyboard navigation between tabs (arrow keys, Home, End).\n   * @param {KeyboardEvent} event - The keyboard event\n   * @param {NodeList} tabs - The list of tab elements\n   * @private\n   */\n  handleTabKeydown(event, tabs) {\n    const tabsArray = Array.from(tabs);\n    const currentIndex = tabsArray.findIndex((tab) => tab === event.target);\n\n    let newIndex;\n    switch (event.key) {\n      case \"ArrowRight\":\n        newIndex = (currentIndex + 1) % tabsArray.length;\n        break;\n      case \"ArrowLeft\":\n        newIndex = (currentIndex - 1 + tabsArray.length) % tabsArray.length;\n        break;\n      case \"Home\":\n        newIndex = 0;\n        break;\n      case \"End\":\n        newIndex = tabsArray.length - 1;\n        break;\n      default:\n        return;\n    }\n\n    event.preventDefault();\n    tabsArray[newIndex].focus();\n    this.switchTab(tabsArray[newIndex].dataset.tab);\n  }\n\n  /**\n   * Shows or hides the keyboard shortcuts help button based on availability and settings.\n   */\n  updateKeyboardHelpButtonVisibility() {\n    if (!this.modal?.modalElement) return;\n    const helpBtn = this.modal.modalElement.querySelector(\".keyboard-help-btn\");\n    if (helpBtn) {\n      const shouldShow =\n        this.keyboardHelpModal?.isAvailable() &&\n        this.settingsManager.settings.keyboardShortcuts;\n      helpBtn.style.display = shouldShow ? \"\" : \"none\";\n    }\n  }\n\n  /**\n   * Generates the complete settings modal HTML content.\n   * @returns {string} HTML string for the settings interface\n   * @private\n   */\n  getSettingsHTML() {\n    return `\n      ${this.renderSettingsTabs()}\n      <div class=\"settings-panels\">\n        ${this.renderReadingPanel()}\n        ${this.renderAccessibilityPanel()}\n        ${this.renderAudioPanel()}\n      </div>\n    `;\n  }\n\n  /**\n   * Generates HTML for the settings tab bar.\n   * @returns {string} HTML string for the tabs\n   * @private\n   */\n  renderSettingsTabs() {\n    return `\n    <div role=\"tablist\" class=\"settings-tabs\" aria-label=\"Settings categories\">\n      ${this.renderSettingsTab(\"reading\", \"menu_book\", \"Reading\", true)}\n      ${this.renderSettingsTab(\"accessibility\", \"accessibility\", \"Accessibility\")}\n      ${StoryFeatures.hasAudio ? this.renderSettingsTab(\"audio\", \"volume_up\", \"Audio\") : \"\"}\n    </div>\n    `;\n  }\n\n  /**\n   * Generates HTML for a single settings tab button.\n   * @param {string} id - Tab ID\n   * @param {string} icon - Material icon name\n   * @param {string} label - Accessible label for screen readers\n   * @param {boolean} [isActive=false] - Whether this tab is initially active\n   * @returns {string} HTML string for the tab button\n   * @private\n   */\n  renderSettingsTab(id, icon, label, isActive = false) {\n    return `\n      <button role=\"tab\" class=\"settings-tab ${isActive ? \"active\" : \"\"}\" \n              id=\"tab-${id}\"\n              data-tab=\"${id}\" \n              aria-selected=\"${isActive}\" \n              aria-controls=\"panel-${id}\"\n              tabindex=\"${isActive ? \"0\" : \"-1\"}\">\n        <span class=\"material-icons-outlined\" aria-hidden=\"true\">${icon}</span>\n        <span class=\"sr-only\">${label}</span>\n      </button>\n    `;\n  }\n\n  /**\n   * Generates HTML for the Reading settings panel.\n   * Includes theme, font, text size, line height, and autosave options.\n   * @returns {string} HTML string for the panel\n   * @private\n   */\n  renderReadingPanel() {\n    return `\n    <div role=\"tabpanel\" class=\"settings-panel active\" id=\"panel-reading\" aria-labelledby=\"tab-reading\">\n    ${this.renderDropdownSetting(\"theme\", \"setting-theme\", \"Theme\", [\n      { value: \"auto\", label: \"Auto (System)\" },\n      { value: \"light\", label: \"Light\" },\n      { value: \"dark\", label: \"Dark\" },\n    ])}\n    ${this.renderDropdownSetting(\"fontFamily\", \"setting-font\", \"Font Family\", [\n      { value: \"serif\", label: \"Serif\" },\n      { value: \"sans\", label: \"Sans-serif\" },\n      { value: \"mono\", label: \"Monospace\" },\n      { value: \"dyslexic\", label: \"OpenDyslexic\" },\n    ])}\n    ${this.renderDropdownSetting(\"textSize\", \"setting-size\", \"Text Size\", [\n      { value: \"small\", label: \"Small\" },\n      { value: \"medium\", label: \"Medium\" },\n      { value: \"large\", label: \"Large\" },\n      { value: \"xl\", label: \"Extra Large\" },\n    ])}\n    ${this.renderDropdownSetting(\n      \"lineHeight\",\n      \"setting-lineheight\",\n      \"Line Height\",\n      [\n        { value: \"tight\", label: \"Tight\" },\n        { value: \"normal\", label: \"Normal\" },\n        { value: \"loose\", label: \"Loose\" },\n      ]\n    )}\n      ${this.renderCheckboxSetting(\"autoSave\", \"Auto Save Progress\")}\n    </div>\n    `;\n  }\n\n  /**\n   * Generates HTML for the Accessibility settings panel.\n   * Includes animations, tone indicators, choice numbering, and keyboard shortcuts.\n   * @returns {string} HTML string for the panel\n   * @private\n   */\n  renderAccessibilityPanel() {\n    return `\n    <div role=\"tabpanel\" class=\"settings-panel\" id=\"panel-accessibility\" aria-labelledby=\"tab-accessibility\">\n      ${this.renderCheckboxSetting(\"animations\", \"Enable Animations\")}\n      ${\n        this.settingsManager.toneIndicatorsAvailable\n          ? this.renderCheckboxSetting(\n              \"toneIndicators\",\n              \"Show tone indicators on choices\"\n            )\n          : \"\"\n      }\n      ${this.renderDropdownSetting(\n        \"choiceNumbering\",\n        \"setting-choicenumbering\",\n        \"Choice Number Hints\",\n        [\n          { value: \"auto\", label: \"Auto (hide on mobile)\" },\n          { value: \"on\", label: \"Always Show\" },\n          { value: \"off\", label: \"Always Hide\" },\n        ]\n      )}\n      ${\n        this.keyboardHelpModal?.isAvailable()\n          ? this.renderCheckboxSetting(\n              \"keyboardShortcuts\",\n              \"Enable Keyboard Shortcuts\"\n            )\n          : \"\"\n      }\n      ${\n        this.keyboardHelpModal?.isAvailable()\n          ? this.renderButtonSetting(\"keyboard-help-btn\", \"Keyboard Shortcuts\")\n          : \"\"\n      }\n    </div>\n    `;\n  }\n\n  /**\n   * Generates HTML for the Audio settings panel.\n   * Only rendered if the story uses audio features.\n   * @returns {string} HTML string for the panel, or empty string if no audio\n   * @private\n   */\n  renderAudioPanel() {\n    if (!StoryFeatures.hasAudio) return \"\";\n\n    return `\n    <div role=\"tabpanel\" class=\"settings-panel\" id=\"panel-audio\" aria-labelledby=\"tab-audio\">\n      ${this.renderCheckboxSetting(\"audioEnabled\", \"Enable Audio\")}\n    </div>`;\n  }\n\n  /**\n   * Generates HTML for a checkbox setting item.\n   * @param {string} name - The setting name (used as input name attribute)\n   * @param {string} label - The display label\n   * @returns {string} HTML string for the checkbox setting\n   * @private\n   */\n  renderCheckboxSetting(name, label) {\n    return `\n      <div class=\"setting-item\">\n        <label class=\"setting-checkbox-label\">\n          <input type=\"checkbox\" name=\"${name}\" class=\"setting-checkbox\">\n          <span>${label}</span>\n        </label>\n      </div>`;\n  }\n\n  /**\n   * Generates HTML for a dropdown setting item.\n   * @param {string} name - The setting name (used as select name attribute)\n   * @param {string} id - The element ID\n   * @param {string} label - The display label\n   * @param {Array<{value: string, label: string}>} options - Dropdown options\n   * @returns {string} HTML string for the dropdown setting\n   * @private\n   */\n  renderDropdownSetting(name, id, label, options) {\n    const optionsHtml = options\n      .map((opt) => `<option value=\"${opt.value}\">${opt.label}</option>`)\n      .join(\"\\n          \");\n\n    return `\n      <div class=\"setting-item\">\n        <label class=\"setting-label\" for=\"${id}\">${label}</label>\n        <select name=\"${name}\" id=\"${id}\" class=\"setting-select\">\n          ${optionsHtml}\n        </select>\n      </div>`;\n  }\n\n  /**\n   * Generates HTML for a button setting item (e.g., keyboard help button).\n   * @param {string} className - CSS class for the button\n   * @param {string} label - Button text\n   * @returns {string} HTML string for the button setting\n   * @private\n   */\n  renderButtonSetting(className, label) {\n    return `\n      <div class=\"setting-item\">\n        <button type=\"button\" class=\"${className}\">${label}</button>\n      </div>`;\n  }\n}\n\nexport { SettingsModal };\n", "import { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\nimport { MarkdownProcessor } from \"./markdown-processor.js\";\nimport { TagRegistry, TAGS } from \"./tag-registry.js\";\nimport { Utils } from \"./utils.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.PAGE_MANAGER);\n\n/**\n * Manages special pages (reference content like help, credits, etc.)\n * that can be viewed without advancing the main story state.\n * Handles saving/restoring story state when entering/exiting special pages.\n */\nclass PageManager {\n  /**\n   * Creates the page manager.\n   * @param {Object} storyManager - The StoryManager instance\n   */\n  constructor(storyManager) {\n    this.storyManager = storyManager;\n    this.tagProcessor = storyManager.TagProcessor;\n    this.savedDisplayState = null;\n    this.savedStoryState = null;\n    this.currentPage = null;\n    this.availablePages = {};\n    this.pageMenuOrder = null;\n\n    if (!this.storyManager) {\n      log.critical(\n        \"PageManager requires a story manager\",\n        new Error(\"Invalid story manager\")\n      );\n    }\n  }\n\n  /**\n   * Show a special page by evaluating its knot\n   * @param {string} knotName - Name of the knot to show (internal identifier)\n   */\n  show(knotName) {\n    if (!knotName || typeof knotName !== \"string\") {\n      log.warning(\"Invalid knotName passed to show\");\n      return;\n    }\n\n    if (!this.isSpecialPage(knotName)) {\n      log.warning(`Page \"${knotName}\" is not marked as a special page`);\n      return;\n    }\n\n    // Only save state if we're not already viewing a special page\n    // This prevents overwriting the main story state when navigating between special pages\n    if (!this.isViewingSpecialPage()) {\n      this.saveCurrentState();\n    }\n\n    this.currentPage = knotName;\n\n    if (this.storyManager.display) {\n      this.storyManager.display.clear();\n\n      const content = this.generatePageContent(knotName);\n      if (content.length > 0) {\n        this.storyManager.display.render(content);\n      }\n\n      this.addReturnButton();\n      this.storyManager.display.scrollToTop();\n    }\n  }\n\n  /**\n   * Returns from a special page to the main story, restoring the previous state.\n   */\n  returnToStory() {\n    if (!this.currentPage) return;\n\n    try {\n      this.currentPage = null;\n\n      if (!this.storyManager.display) {\n        log.error(\"Display manager not available for return\");\n        return;\n      }\n\n      this.storyManager.display.clear();\n\n      if (this.savedStoryState) {\n        try {\n          this.storyManager.story.state.LoadJson(this.savedStoryState);\n        } catch (error) {\n          log.error(\"Failed to restore story state\", error);\n          if (this.storyManager.savePoint) {\n            this.storyManager.story.state.LoadJson(this.storyManager.savePoint);\n          }\n        }\n      }\n\n      if (this.savedDisplayState) {\n        try {\n          this.storyManager.display.restoreState(this.savedDisplayState);\n        } catch (error) {\n          log.error(\"Failed to restore display state\", error);\n          this.regenerateDisplayFromStoryState();\n        }\n      } else {\n        this.regenerateDisplayFromStoryState();\n      }\n\n      this.storyManager.display.showHeader();\n      this.storyManager.createChoices?.();\n      this.storyManager.display.scrollToTop();\n\n      // Focus story container for screen readers\n      this.storyManager.display?.container?.focus();\n\n      this.savedDisplayState = null;\n      this.savedStoryState = null;\n    } catch (error) {\n      log.error(\"Failed to return to story\", error);\n    }\n  }\n\n  /**\n   * Resets the page manager state (clears saved state and current page).\n   */\n  reset() {\n    this.savedDisplayState = null;\n    this.savedStoryState = null;\n    this.currentPage = null;\n  }\n\n  /**\n   * Checks if a special page is currently being viewed.\n   * @returns {boolean} True if viewing a special page\n   */\n  isViewingSpecialPage() {\n    return this.currentPage !== null;\n  }\n\n  /**\n   * Checks if a knot is marked as a special page.\n   * @param {string} knotName - The ink knot name\n   * @returns {boolean} True if the knot is a special page\n   */\n  isSpecialPage(knotName) {\n    const pageInfo = this.availablePages?.[knotName];\n    return pageInfo && pageInfo.isSpecialPage;\n  }\n\n  /**\n   * Checks if a special page exists by knot name.\n   * @param {string} knotName - The ink knot name\n   * @returns {boolean} True if the page exists\n   */\n  pageExists(knotName) {\n    return this.isSpecialPage(knotName);\n  }\n\n  /**\n   * Gets the knot name of the currently viewed special page.\n   * @returns {string|null} The knot name, or null if not viewing a special page\n   */\n  getCurrentPageKnotName() {\n    return this.currentPage || null;\n  }\n\n  /**\n   * Gets the display name of the currently viewed special page.\n   * @returns {string|null} The display name, or null if not viewing a special page\n   */\n  getCurrentPageDisplayName() {\n    const knotName = this.getCurrentPageKnotName();\n    return knotName ? this.getPageDisplayName(knotName) : null;\n  }\n\n  /**\n   * Gets the display name for a special page, falling back to formatted knot name.\n   * @param {string} knotName - The ink knot name\n   * @returns {string} The display name\n   */\n  getPageDisplayName(knotName) {\n    const pageInfo = this.availablePages?.[knotName];\n    if (pageInfo && pageInfo.displayName) {\n      return pageInfo.displayName;\n    }\n\n    return Utils.formatKnotName(knotName);\n  }\n\n  /**\n   * Returns a copy of all available special pages.\n   * @returns {Object.<string, {displayName: string, knotName: string, isSpecialPage: boolean}>}\n   */\n  getAvailablePages() {\n    return { ...this.availablePages } || {};\n  }\n\n  /**\n   * Returns display names for all available special pages.\n   * @returns {Array<{knotName: string, displayName: string}>}\n   */\n  getAvailablePageDisplayNames() {\n    const pages = this.getAvailablePages();\n    return Object.keys(pages).map((knotName) => ({\n      knotName: knotName,\n      displayName: pages[knotName].displayName || this.formatKnotName(knotName),\n    }));\n  }\n\n  /**\n   * Finds a knot name by its display name.\n   * @param {string} displayName - The display name to search for\n   * @returns {string|null} The knot name, or null if not found\n   */\n  findKnotByDisplayName(displayName) {\n    const pages = this.getAvailablePages();\n    for (const [knotName, pageInfo] of Object.entries(pages)) {\n      if (pageInfo.displayName === displayName) {\n        return knotName;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Gets detailed information about a special page including its content.\n   * @param {string} knotName - The ink knot name\n   * @returns {{knotName: string, displayName: string, isSpecialPage: boolean, content: string}|null}\n   */\n  getPageInfo(knotName) {\n    const pageInfo = this.availablePages?.[knotName];\n    if (!pageInfo) return null;\n\n    return {\n      knotName: knotName,\n      displayName: pageInfo.displayName || Utils.formatKnotName(knotName),\n      isSpecialPage: pageInfo.isSpecialPage,\n      content: this.evaluatePageContent(knotName),\n    };\n  }\n\n  /**\n   * Evaluates a special page's content by running through its knot in a temporary story.\n   * @param {string} knotName - The ink knot name\n   * @returns {string} The page's text content\n   * @private\n   */\n  evaluatePageContent(knotName) {\n    if (!this.pageExists(knotName)) return \"\";\n\n    try {\n      const tempStory = this.storyManager.createTempStory();\n      tempStory.ChoosePathString(knotName);\n\n      let fullText = \"\";\n      let isFirstLine = true;\n\n      while (tempStory.canContinue) {\n        const text = tempStory.Continue();\n        const tags = tempStory.currentTags || [];\n\n        if (isFirstLine && this.containsOnlySpecialPageTag(text, tags)) {\n          isFirstLine = false;\n          continue;\n        }\n        isFirstLine = false;\n\n        fullText += text;\n      }\n\n      return fullText.trim();\n    } catch (error) {\n      log.error(\"Failed to evaluate page content\", error);\n      return \"\";\n    }\n  }\n\n  /**\n   * Saves the current display and story state before viewing a special page.\n   * @private\n   */\n  saveCurrentState() {\n    if (this.storyManager.display) {\n      this.savedDisplayState = this.storyManager.display.getState();\n    }\n\n    this.savedStoryState =\n      this.storyManager.savePoint || this.storyManager.story.state.ToJson();\n  }\n\n  /**\n   * Regenerates display content from the current story state (fallback recovery).\n   * @private\n   */\n  regenerateDisplayFromStoryState() {\n    const currentText = this.storyManager.story?.state?.currentText;\n    if (currentText?.trim()) {\n      const processedText = MarkdownProcessor.process(currentText);\n      this.storyManager.display.render([{ text: processedText, classes: [] }]);\n    }\n  }\n\n  /**\n   * Generates processed content objects for a special page.\n   * @param {string} knotName - The ink knot name\n   * @returns {Array} Array of content objects ready for rendering\n   * @private\n   */\n  generatePageContent(knotName) {\n    try {\n      const tempStory = this.createPageStory(knotName);\n      return this.extractPageContent(tempStory);\n    } catch (error) {\n      log.error(\"Failed to generate page content\", error);\n      return [];\n    }\n  }\n\n  /**\n   * Creates a temporary story instance positioned at a special page knot.\n   * @param {string} knotName - The ink knot name\n   * @returns {Story} Temporary story instance\n   * @private\n   */\n  createPageStory(knotName) {\n    const tempStory = this.storyManager.createTempStory();\n    const currentState = this.storyManager.story.state.ToJson();\n    tempStory.state.LoadJson(currentState);\n    tempStory.ChoosePathString(knotName);\n    return tempStory;\n  }\n\n  /**\n   * Extracts and processes all content from a temporary story.\n   * @param {Story} tempStory - The temporary story instance\n   * @returns {Array} Array of processed content objects\n   * @private\n   */\n  extractPageContent(tempStory) {\n    const content = [];\n    let isFirstLine = true;\n\n    while (tempStory.canContinue) {\n      const text = tempStory.Continue();\n      const tags = tempStory.currentTags || [];\n\n      const items = this.processPageLine(text, tags, isFirstLine);\n      isFirstLine = false;\n\n      if (items) {\n        content.push(...items);\n      }\n    }\n\n    return content;\n  }\n\n  /**\n   * Processes a single line of page content into content objects.\n   * @param {string} text - The line text\n   * @param {string[]} tags - The line's tags\n   * @param {boolean} isFirstLine - Whether this is the first line (may contain only SPECIAL_PAGE tag)\n   * @returns {Array|null} Array of content objects, or null if line should be skipped\n   * @private\n   */\n  processPageLine(text, tags, isFirstLine) {\n    // Skip first line if only SPECIAL_PAGE tag\n    if (isFirstLine && this.containsOnlySpecialPageTag(text, tags)) {\n      return null;\n    }\n\n    const hasAnyTag = tags.some((tag) => typeof tag === \"string\" && tag.trim());\n    if (!text?.trim() && !hasAnyTag) {\n      return null;\n    }\n\n    const processed = this.storyManager.contentProcessor.process(text, tags);\n    const items = Array.isArray(processed) ? processed : [processed];\n\n    return items\n      .map((item) => {\n        if (item && (item.type === \"paragraph\" || !item.type)) {\n          item.classes = [\"special-page\", ...(item.classes || [])];\n        }\n        return item;\n      })\n      .filter(Boolean);\n  }\n\n  /**\n   * Check if text/tags only contain the SPECIAL_PAGE marker\n   * @param {string} text - The text content\n   * @param {Array} tags - The tags array\n   * @returns {boolean} True if this line only marks the page as special\n   */\n  containsOnlySpecialPageTag(text, tags) {\n    if (text && text.trim().length > 0) {\n      return false;\n    }\n    return TagRegistry.hasSpecialPageTag(tags);\n  }\n\n  /**\n   * Adds a \"Return to Story\" button at the bottom of the special page.\n   * @private\n   */\n  addReturnButton() {\n    if (!this.storyManager.choices || !this.storyManager.display) {\n      log.error(\"Required managers not available for return button\");\n      return;\n    }\n\n    try {\n      const returnChoice = this.storyManager.choices.createReturnChoice(() => {\n        this.returnToStory();\n      });\n\n      this.storyManager.display.renderChoices([returnChoice], false);\n    } catch (error) {\n      log.error(\"Failed to add return button\", error);\n    }\n  }\n\n  /**\n   * Scans all ink story knots to find those marked as special pages.\n   * Populates this.availablePages with page info.\n   * @private\n   */\n  detectSpecialPages() {\n    this.availablePages = {};\n\n    try {\n      const namedContent =\n        this.storyManager.story.mainContentContainer.namedContent;\n\n      for (const knotName of namedContent.keys()) {\n        try {\n          const pageInfo = this.getSpecialPageInfo(knotName);\n          if (pageInfo) {\n            this.availablePages[knotName] = {\n              displayName: pageInfo.displayName,\n              knotName: knotName,\n              isSpecialPage: true,\n            };\n          }\n        } catch (error) {\n          log.warning(`Failed to check if ${knotName} is special page`, error);\n        }\n      }\n    } catch (error) {\n      log.error(\"Failed to detect special pages\", error);\n    }\n  }\n\n  /**\n   * Checks if a knot is a special page and returns its info.\n   * @param {string} knotName - The ink knot name to check\n   * @returns {{displayName: string, isSpecialPage: boolean}|null} Page info or null\n   * @private\n   */\n  getSpecialPageInfo(knotName) {\n    if (!TAGS || !TagRegistry.getTagDef) return null;\n\n    try {\n      const tempStory = this.storyManager.createTempStory();\n      tempStory.ChoosePathString(knotName);\n\n      if (tempStory.canContinue) {\n        tempStory.Continue();\n\n        const tags = tempStory.currentTags || [];\n\n        for (const tag of tags) {\n          if (typeof tag !== \"string\") continue;\n\n          const { tagDef, tagValue } = TagRegistry.parseTag(tag);\n\n          if (tagDef === TAGS.SPECIAL_PAGE) {\n            return {\n              displayName: tagValue?.trim() || Utils.formatKnotName(knotName),\n              isSpecialPage: true,\n            };\n          }\n        }\n      }\n      return null;\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Processes the PAGE_MENU global tag to set page ordering.\n   * @param {string[]} globalTags - Array of global tags from the story\n   * @private\n   */\n  processMenuOrderTag(globalTags) {\n    if (!Array.isArray(globalTags)) return;\n\n    for (const tag of globalTags) {\n      if (typeof tag !== \"string\") continue;\n\n      const colonIndex = tag.indexOf(\":\");\n      if (colonIndex === -1) continue;\n\n      const property = tag.substring(0, colonIndex).trim().toUpperCase();\n      const value = tag.substring(colonIndex + 1).trim();\n\n      if (TagRegistry.getTagDef(property) === TAGS.PAGE_MENU) {\n        this.pageMenuOrder = this.parseMenuOrder(value);\n        break;\n      }\n    }\n  }\n\n  /**\n   * Parses a menu order string into structured page order data.\n   * Format: \"page1, page2,, page3\" where \",,\" separates sections.\n   * @param {string} menuString - The menu order string\n   * @returns {Array<{knotName: string, section: number}>|null} Parsed order or null\n   * @private\n   */\n  parseMenuOrder(menuString) {\n    const sections = menuString.split(\",,\").map((s) => s.trim());\n    const menuOrder = [];\n\n    sections.forEach((section, sectionIndex) => {\n      const pages = section\n        .split(\",\")\n        .map((p) => p.trim())\n        .filter((p) => p);\n\n      pages.forEach((pageName) => {\n        if (this.availablePages[pageName]) {\n          menuOrder.push({\n            knotName: pageName,\n            section: sectionIndex,\n          });\n        } else {\n          console.warn(\n            `Page '${pageName}' in PAGE_MENU not found in special pages`\n          );\n        }\n      });\n    });\n\n    return menuOrder.length > 0 ? menuOrder : null;\n  }\n\n  /**\n   * Checks whether the page manager is ready for use.\n   * @returns {boolean} True if story and display are available\n   */\n  isReady() {\n    return !!(this.storyManager?.story && this.storyManager?.display);\n  }\n\n  /**\n   * Returns diagnostic information about the page manager's state.\n   * @returns {{hasStoryManager: boolean, hasTagProcessor: boolean, currentPageKnotName: string|null, currentPageDisplayName: string|null, isViewingSpecialPage: boolean, availablePageCount: number, hasSavedState: boolean, pageDisplayNames: Array}}\n   */\n  getStats() {\n    const availablePages = this.getAvailablePages();\n    const currentKnotName = this.getCurrentPageKnotName();\n    const currentDisplayName = this.getCurrentPageDisplayName();\n\n    return {\n      hasStoryManager: !!this.storyManager,\n      hasTagProcessor: !!this.tagProcessor,\n      currentPageKnotName: currentKnotName,\n      currentPageDisplayName: currentDisplayName,\n      isViewingSpecialPage: this.isViewingSpecialPage(),\n      availablePageCount: Object.keys(availablePages).length,\n      hasSavedState: !!(this.savedDisplayState || this.savedStoryState),\n      pageDisplayNames: this.getAvailablePageDisplayNames(),\n    };\n  }\n\n  /**\n   * Validates all special pages by attempting to generate their content.\n   * Useful for debugging and ensuring all pages are properly configured.\n   * @returns {{valid: Array, invalid: Array, errors: Array}}\n   */\n  validatePages() {\n    const results = {\n      valid: [],\n      invalid: [],\n      errors: [],\n    };\n\n    const pages = this.getAvailablePages();\n\n    for (const [knotName, pageInfo] of Object.entries(pages)) {\n      try {\n        const content = this.evaluatePageContent(knotName);\n        if (content.length > 0) {\n          results.valid.push({\n            knotName,\n            displayName: pageInfo.displayName,\n            contentLength: content.length,\n          });\n        } else {\n          results.invalid.push({\n            knotName,\n            displayName: pageInfo.displayName,\n            reason: \"No content generated\",\n          });\n        }\n      } catch (error) {\n        results.errors.push({\n          knotName,\n          displayName: pageInfo.displayName,\n          error: error.message,\n        });\n      }\n    }\n\n    return results;\n  }\n}\n\nexport { PageManager };\n", "import { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.CHOICE_MANAGER);\n\n/**\n * Generates choice objects from ink story choices.\n * Processes choice tags for styling and clickability,\n * adds keyboard hints, and creates special navigation choices.\n */\nclass ChoiceManager {\n  /**\n   * Creates the ChoiceManager with dependencies\n   * @param {Object} storyManager - The StoryManager instance\n   * @param {Object} tagProcessor - Tag processor for parsing choice tags\n   * @param {Object} storyManager.settings - Settings manager for tone indicators\n   */\n  constructor(storyManager, tagProcessor) {\n    this.storyManager = storyManager;\n    this.tagProcessor = tagProcessor;\n  }\n\n  /**\n   * Generate choice objects from ink story choices\n   * @param {Array} storyChoices - Raw choices from ink story\n   * @returns {Array} Processed choice objects with text, classes, onClick, keyHint, etc.\n   */\n  generate(storyChoices) {\n    if (!Array.isArray(storyChoices)) {\n      log.error(\"Invalid storyChoices - expected array\");\n      return [];\n    }\n\n    return storyChoices.map((choice, index) => {\n      try {\n        const { customClasses, isClickable } =\n          this.tagProcessor?.processChoiceTags?.(choice.tags || []) || {\n            customClasses: [],\n            isClickable: true,\n          };\n\n        const toneIndicators =\n          this.storyManager?.settings?.getToneIndicators?.(choice.tags || []) ||\n          [];\n\n        return {\n          text: choice.text || \"\",\n          classes: customClasses,\n          isClickable,\n          onClick: () => this.selectChoice(index),\n          originalIndex: index,\n          tags: choice.tags || [],\n          keyHint: this.getKeyHint(index),\n          toneIndicators,\n        };\n      } catch (error) {\n        log.error(`Failed to process choice at index ${index}`, error);\n\n        return {\n          text: choice.text || \"Invalid choice\",\n          classes: [\"error-choice\"],\n          isClickable: false,\n          onClick: () => {},\n          originalIndex: index,\n          tags: [],\n          toneIndicators: [],\n        };\n      }\n    });\n  }\n\n  /**\n   * Selects a choice by index and advances the story.\n   * @param {number} choiceIndex - Zero-based index of the choice to select\n   */\n  selectChoice(choiceIndex) {\n    if (typeof choiceIndex !== \"number\" || choiceIndex < 0) {\n      log.error(`Invalid choice index: ${choiceIndex}`);\n      return;\n    }\n\n    if (!this.storyManager) {\n      log.error(\"Story manager not available\");\n      return;\n    }\n\n    try {\n      this.storyManager.selectChoice(choiceIndex);\n    } catch (error) {\n      log.error(\"Failed to select choice\", error);\n    }\n  }\n\n  /**\n   * Create a special choice (e.g., navigation buttons)\n   * @param {string} text - Choice text\n   * @param {Function} onClick - Click handler\n   * @param {string[]} [classes] - Additional CSS classes\n   * @returns {Object} Choice object with isSpecial: true\n   */\n  createSpecialChoice(text, onClick, classes = []) {\n    if (typeof text !== \"string\" || typeof onClick !== \"function\") {\n      log.error(\"Invalid parameters for special choice\");\n      return {\n        text: text || \"Error\",\n        classes: [\"error-choice\"],\n        isClickable: false,\n        onClick: () => {},\n        isSpecial: true,\n      };\n    }\n\n    const safeOnClick = () => {\n      try {\n        onClick();\n      } catch (error) {\n        log.error(\"Special choice click failed\", error);\n      }\n    };\n\n    return {\n      text,\n      classes: Array.isArray(classes) ? classes : [],\n      isClickable: true,\n      onClick: safeOnClick,\n      isSpecial: true,\n    };\n  }\n\n  /**\n   * Creates a \"Return to Story\" navigation choice.\n   * @param {Function} onReturn - Callback when the return button is clicked\n   * @returns {Object} Special choice object with return-button styling\n   */\n  createReturnChoice(onReturn) {\n    if (typeof onReturn !== \"function\") {\n      log.error(\"onReturn must be a function\");\n      return this.createSpecialChoice(\"\u2190 Return to Story\", () => {}, [\n        \"return-button\",\n        \"error-choice\",\n      ]);\n    }\n\n    return this.createSpecialChoice(\n      '<span aria-hidden=\"true\">\u2190</span> Return to Story',\n      onReturn,\n      [\"return-button\"]\n    );\n  }\n\n  /**\n   * Processes ink tags attached to a choice to extract styling and behavior.\n   * @param {string[]} tags - Array of ink tags from the choice\n   * @returns {{customClasses: string[], isClickable: boolean}} Processed tag results\n   */\n  processChoiceTags(tags) {\n    if (!this.tagProcessor?.processChoiceTags) {\n      log.warning(\"TagProcessor not available, using default choice behavior\");\n      return { customClasses: [], isClickable: true };\n    }\n\n    try {\n      return this.tagProcessor.processChoiceTags(tags || []);\n    } catch (error) {\n      log.warning(\"Failed to process choice tags\", error);\n      return { customClasses: [], isClickable: true };\n    }\n  }\n\n  /**\n   * Get keyboard hint for a choice index (1-9, then a-z)\n   * @param {number} index - Zero-based choice index\n   * @returns {string} Hint character\n   */\n  getKeyHint(index) {\n    if (index < 9) {\n      return String(index + 1); // 1-9\n    } else {\n      // a-z for indices 9-34\n      return String.fromCharCode(97 + (index - 9)); // 'a' = 97\n    }\n  }\n\n  /**\n   * Checks if at least one choice in the array is clickable.\n   * @param {Array} choices - Array of choice objects\n   * @returns {boolean} True if any choice is clickable (or has undefined isClickable)\n   */\n  hasClickableChoices(choices) {\n    if (!Array.isArray(choices)) return false;\n    return choices.some((choice) => choice?.isClickable !== false);\n  }\n\n  /**\n   * Filters choices, optionally returning only clickable ones.\n   * @param {Array} choices - Array of choice objects\n   * @param {boolean} [clickableOnly=false] - If true, exclude non-clickable choices\n   * @returns {Array} Filtered array of choices\n   */\n  filterChoices(choices, clickableOnly = false) {\n    if (!Array.isArray(choices)) return [];\n    if (!clickableOnly) return choices;\n    return choices.filter((choice) => choice?.isClickable !== false);\n  }\n\n  /**\n   * Validates that a choice object has the required properties.\n   * @param {Object} choice - Choice object to validate\n   * @returns {boolean} True if choice has both 'text' and 'onClick' properties\n   */\n  validateChoice(choice) {\n    if (!choice || typeof choice !== \"object\") return false;\n    return [\"text\", \"onClick\"].every((prop) => prop in choice);\n  }\n\n  /**\n   * Returns statistics about an array of choices.\n   * @param {Array} choices - Array of choice objects\n   * @returns {{total: number, clickable: number, special: number, withClasses: number}} Choice statistics\n   */\n  getChoiceStats(choices) {\n    if (!Array.isArray(choices)) {\n      return { total: 0, clickable: 0, special: 0, withClasses: 0 };\n    }\n\n    return {\n      total: choices.length,\n      clickable: choices.filter((c) => c?.isClickable !== false).length,\n      special: choices.filter((c) => c?.isSpecial).length,\n      withClasses: choices.filter((c) => c?.classes?.length > 0).length,\n    };\n  }\n}\n\nexport { ChoiceManager };\n", "import { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\nimport { Utils } from \"./utils.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.NAVIGATION_MANAGER);\n\n/**\n * Manages the navigation bar UI including core buttons (restart, saves, settings)\n * and dynamically generated special page buttons in a slide-out panel.\n */\nclass NavigationManager {\n  /**\n   * Creates the navigation manager and sets up core button handlers.\n   * @param {Object} storyManager - The StoryManager instance\n   */\n  constructor(storyManager) {\n    this.storyManager = storyManager;\n    this.dynamicButtons = new Map();\n    this.dropdown = null;\n    this.dropdownButton = null;\n\n    if (!this.storyManager) {\n      log.critical(\n        \"NavigationManager requires a story manager\",\n        new Error(\"Invalid story manager\"),\n        \"navigation\"\n      );\n      return;\n    }\n\n    this.setupButtons();\n  }\n\n  /**\n   * Sets up all navigation buttons (core and title).\n   * @private\n   */\n  setupButtons() {\n    this.setupCoreButtons();\n    this.setupClickableTitle();\n  }\n\n  /**\n   * Sets up the core navigation buttons (restart, etc.).\n   * @private\n   */\n  setupCoreButtons() {\n    this.setupButton(\"rewind\", () => {\n      this.storyManager.confirmRestart();\n    });\n\n    // Note: Saves and settings buttons are handled by their respective managers\n  }\n\n  /**\n   * Sets up the title as a clickable restart button.\n   * @private\n   */\n  setupClickableTitle() {\n    this.setupButton(\"title-restart\", () => {\n      this.storyManager.confirmRestart();\n    });\n  }\n\n  /**\n   * Setup a single button with event listener\n   * @param {string} buttonId - ID of the button element\n   * @param {Function} clickHandler - Function to call on click\n   */\n  setupButton(buttonId, clickHandler) {\n    if (!buttonId || typeof clickHandler !== \"function\") {\n      log.warning(\n        `Invalid parameters for button ${buttonId}`,\n        null,\n        \"navigation\"\n      );\n      return;\n    }\n\n    const button = document.getElementById(buttonId);\n    if (!button) {\n      log.warning(`Button not found: ${buttonId}`, null, \"navigation\");\n      return;\n    }\n\n    try {\n      const newButton = button.cloneNode(true);\n      button.parentNode.replaceChild(newButton, button);\n\n      newButton.addEventListener(\"click\", (e) => {\n        try {\n          clickHandler(e);\n        } catch (error) {\n          log.error(`Button click failed: ${buttonId}`, error, \"navigation\");\n        }\n      });\n    } catch (error) {\n      log.warning(`Failed to setup button ${buttonId}`, error, \"navigation\");\n    }\n  }\n\n  /**\n   * Update navigation button visibility based on available special pages\n   * @param {Object} availablePages - Object mapping knot names to page info\n   * @param {Array} pageMenuOrder - Optional array defining page order and sections\n   */\n  updateVisibility(availablePages, pageMenuOrder = null) {\n    if (!availablePages || typeof availablePages !== \"object\") {\n      log.warning(\n        \"Invalid availablePages object passed to updateVisibility\",\n        null,\n        \"navigation\"\n      );\n      return;\n    }\n\n    this.clearDynamicButtons();\n\n    this.createSlidePanel(availablePages, pageMenuOrder);\n  }\n\n  /**\n   * Refreshes the navigation to reflect current available pages.\n   */\n  refresh() {\n    const availablePages = this.storyManager?.pages?.availablePages || {};\n    this.updateVisibility(availablePages);\n  }\n\n  /**\n   * Resets all navigation buttons to their default enabled state.\n   */\n  reset() {\n    this.setButtonEnabled(\"rewind\", true);\n    this.setButtonEnabled(\"saves-btn\", true);\n    this.setButtonEnabled(\"settings-btn\", true);\n    this.clearDynamicButtons();\n    this.highlightActivePage(null);\n  }\n\n  /**\n   * Cleans up dynamic buttons when the manager is disposed.\n   */\n  cleanup() {\n    this.clearDynamicButtons();\n  }\n\n  /**\n   * Enables or disables a navigation button.\n   * @param {string} buttonId - The button's DOM ID\n   * @param {boolean} enabled - Whether the button should be enabled\n   */\n  setButtonEnabled(buttonId, enabled) {\n    const button = document.getElementById(buttonId);\n    if (!button) return;\n\n    if (enabled) {\n      button.removeAttribute(\"disabled\");\n      button.style.cursor = \"pointer\";\n      button.style.opacity = \"\";\n    } else {\n      button.setAttribute(\"disabled\", \"disabled\");\n      button.style.cursor = \"not-allowed\";\n      button.style.opacity = \"0.5\";\n    }\n  }\n\n  /**\n   * Shows or hides a navigation button.\n   * @param {string} buttonId - The button's DOM ID\n   * @param {boolean} visible - Whether the button should be visible\n   */\n  setButtonVisible(buttonId, visible) {\n    const button = document.getElementById(buttonId);\n    if (button) {\n      button.style.display = visible ? \"inline-block\" : \"none\";\n    }\n  }\n\n  /**\n   * Enables or disables a special page button by knot name.\n   * @param {string} knotName - The ink knot name for the special page\n   * @param {boolean} enabled - Whether the button should be enabled\n   */\n  setSpecialPageButtonEnabled(knotName, enabled) {\n    const button = this.findPageButton(knotName);\n    if (button) {\n      if (enabled) {\n        button.removeAttribute(\"disabled\");\n        button.style.cursor = \"pointer\";\n        button.style.opacity = \"\";\n      } else {\n        button.setAttribute(\"disabled\", \"disabled\");\n        button.style.cursor = \"not-allowed\";\n        button.style.opacity = \"0.5\";\n      }\n    }\n  }\n\n  /**\n   * Shows or hides a special page button by knot name.\n   * @param {string} knotName - The ink knot name for the special page\n   * @param {boolean} visible - Whether the button should be visible\n   */\n  setSpecialPageButtonVisible(knotName, visible) {\n    const button = this.findPageButton(knotName);\n    if (button) {\n      button.style.display = visible ? \"inline-block\" : \"none\";\n    }\n  }\n\n  /**\n   * Highlights the currently active special page in the navigation.\n   * @param {string|null} activeKnotName - The knot name to highlight, or null to clear\n   */\n  highlightActivePage(activeKnotName) {\n    for (const button of this.dynamicButtons.values()) {\n      button.classList.remove(\"active\", \"current-page\");\n    }\n\n    if (activeKnotName) {\n      const activeButton = this.findPageButton(activeKnotName);\n      if (activeButton) {\n        activeButton.classList.add(\"active\", \"current-page\");\n      }\n    }\n  }\n\n  /**\n   * Creates the slide-out panel containing special page links.\n   * @param {Object} availablePages - Object mapping knot names to page info\n   * @param {Array} pageMenuOrder - Optional array defining page order and sections\n   * @private\n   */\n  createSlidePanel(availablePages, pageMenuOrder) {\n    const navControls = document.querySelector(\".nav-controls\");\n    if (!navControls) return;\n\n    this.menuButton = document.createElement(\"button\");\n    this.menuButton.type = \"button\";\n    this.menuButton.id = \"pages-menu-btn\";\n    this.menuButton.setAttribute(\"aria-label\", \"Menu\");\n    this.menuButton.innerHTML =\n      '<span class=\"material-icons-outlined nav-icon\" aria-hidden=\"true\">menu</span>';\n\n    this.slidePanel = document.createElement(\"nav\");\n    this.slidePanel.className = \"slide-panel\";\n    this.slidePanel.setAttribute(\"aria-label\", \"Pages\");\n    this.slidePanel.setAttribute(\"aria-hidden\", \"true\");\n\n    const panelContent = document.createElement(\"div\");\n    panelContent.className = \"panel-content\";\n\n    if (pageMenuOrder && pageMenuOrder.length > 0) {\n      this.addOrderedPagesToPanel(panelContent, availablePages, pageMenuOrder);\n    } else {\n      this.addDefaultPagesToPanel(panelContent, availablePages);\n    }\n\n    this.slidePanel.appendChild(panelContent);\n\n    const closeButton = document.createElement(\"button\");\n    closeButton.type = \"button\";\n    closeButton.className = \"panel-close-bottom\";\n    closeButton.setAttribute(\"aria-label\", \"Close menu\");\n    closeButton.innerHTML =\n      '<span class=\"material-icons-outlined\" aria-hidden=\"true\">expand_less</span>';\n    this.menuButton.setAttribute(\"aria-expanded\", \"false\");\n    this.slidePanel.appendChild(closeButton);\n\n    document.body.appendChild(this.slidePanel);\n\n    const settingsBtn = document.getElementById(\"settings-btn\");\n    navControls.insertBefore(this.menuButton, settingsBtn);\n\n    this.menuButton.addEventListener(\"click\", (e) => {\n      e.stopPropagation();\n      this.togglePanel();\n    });\n\n    closeButton.addEventListener(\"click\", () => {\n      this.hidePanel();\n    });\n\n    document.addEventListener(\"click\", (e) => {\n      if (\n        this.slidePanel &&\n        this.slidePanel.classList.contains(\"show\") &&\n        !this.slidePanel.contains(e.target) &&\n        e.target !== this.menuButton\n      ) {\n        this.hidePanel();\n      }\n    });\n\n    this.dynamicButtons.set(\"pages-menu\", this.menuButton);\n  }\n\n  /**\n   * Adds pages to the panel in the order specified by pageMenuOrder.\n   * Inserts separators between different sections.\n   * @param {HTMLElement} panelContent - The panel content container\n   * @param {Object} availablePages - Object mapping knot names to page info\n   * @param {Array} pageMenuOrder - Array defining page order and sections\n   * @private\n   */\n  addOrderedPagesToPanel(panelContent, availablePages, pageMenuOrder) {\n    let currentSection = -1;\n    const addedPages = new Set();\n\n    pageMenuOrder.forEach((item) => {\n      const pageInfo = availablePages[item.knotName];\n      if (!pageInfo || !pageInfo.isSpecialPage) return;\n\n      if (item.section !== currentSection && currentSection !== -1) {\n        const separator = document.createElement(\"hr\");\n        separator.className = \"panel-separator\";\n        panelContent.appendChild(separator);\n      }\n      currentSection = item.section;\n\n      const link = this.createPageLink(item.knotName, pageInfo);\n      panelContent.appendChild(link);\n      addedPages.add(item.knotName);\n    });\n\n    const unorderedPages = Object.keys(availablePages).filter(\n      (knotName) =>\n        !addedPages.has(knotName) && availablePages[knotName].isSpecialPage\n    );\n\n    if (unorderedPages.length > 0 && addedPages.size > 0) {\n      const separator = document.createElement(\"hr\");\n      separator.className = \"panel-separator\";\n      panelContent.appendChild(separator);\n    }\n\n    unorderedPages.forEach((knotName) => {\n      const pageInfo = availablePages[knotName];\n      const link = this.createPageLink(knotName, pageInfo);\n      panelContent.appendChild(link);\n    });\n  }\n\n  /**\n   * Adds pages to the panel in alphabetical order (fallback when no order specified).\n   * @param {HTMLElement} panelContent - The panel content container\n   * @param {Object} availablePages - Object mapping knot names to page info\n   * @private\n   */\n  addDefaultPagesToPanel(panelContent, availablePages) {\n    const sortedPages = Object.keys(availablePages)\n      .filter((knotName) => availablePages[knotName]?.isSpecialPage)\n      .sort((a, b) => {\n        const nameA = availablePages[a].displayName.toLowerCase();\n        const nameB = availablePages[b].displayName.toLowerCase();\n        return nameA.localeCompare(nameB);\n      });\n\n    sortedPages.forEach((knotName) => {\n      const pageInfo = availablePages[knotName];\n      const link = this.createPageLink(knotName, pageInfo);\n      panelContent.appendChild(link);\n    });\n  }\n\n  /**\n   * Creates a link element for a special page.\n   * @param {string} knotName - The ink knot name\n   * @param {Object} pageInfo - Page info with displayName\n   * @returns {HTMLAnchorElement} The link element\n   * @private\n   */\n  createPageLink(knotName, pageInfo) {\n    const link = document.createElement(\"a\");\n    link.href = \"#\";\n    link.className = \"panel-link\";\n    link.textContent = pageInfo.displayName;\n\n    link.addEventListener(\"click\", (e) => {\n      e.preventDefault();\n      this.hidePanel(false);\n      this.storyManager.pages.show(knotName);\n      // Focus story container for screen readers\n      this.storyManager.display?.container?.focus();\n    });\n    return link;\n  }\n\n  /**\n   * Toggles the slide panel open/closed.\n   * @private\n   */\n  togglePanel() {\n    if (this.slidePanel) {\n      if (this.slidePanel.classList.contains(\"show\")) {\n        this.hidePanel();\n      } else {\n        this.showPanel();\n      }\n    }\n  }\n\n  /**\n   * Opens the slide panel and focuses the first link.\n   * @private\n   */\n  showPanel() {\n    if (this.slidePanel) {\n      this.slidePanel.classList.add(\"show\");\n      this.slidePanel.setAttribute(\"aria-hidden\", \"false\");\n      this.menuButton?.classList.add(\"active\");\n      this.menuButton?.setAttribute(\"aria-expanded\", \"true\");\n\n      const firstLink = this.slidePanel.querySelector(\".panel-link\");\n      if (firstLink) {\n        firstLink.focus();\n      }\n    }\n  }\n\n  /**\n   * Closes the slide panel and optionally returns focus to the menu button.\n   * @param {boolean} [restoreFocus=true] - Whether to focus the menu button after closing\n   * @private\n   */\n  hidePanel(restoreFocus = true) {\n    if (this.slidePanel) {\n      this.slidePanel.classList.remove(\"show\");\n      this.slidePanel.setAttribute(\"aria-hidden\", \"true\");\n      this.menuButton?.classList.remove(\"active\");\n      this.menuButton?.setAttribute(\"aria-expanded\", \"false\");\n      if (restoreFocus) {\n        this.menuButton?.focus();\n      }\n    }\n  }\n\n  /**\n   * Removes all dynamically created buttons and the slide panel from the DOM.\n   * @private\n   */\n  clearDynamicButtons() {\n    if (this.slidePanel && this.slidePanel.parentNode) {\n      this.slidePanel.parentNode.removeChild(this.slidePanel);\n    }\n    if (this.menuButton && this.menuButton.parentNode) {\n      this.menuButton.parentNode.removeChild(this.menuButton);\n    }\n    this.slidePanel = null;\n    this.menuButton = null;\n\n    for (const button of this.dynamicButtons) {\n      if (button && button.parentNode) {\n        button.parentNode.removeChild(button);\n      }\n    }\n    this.dynamicButtons.clear();\n  }\n\n  /**\n   * Returns information about all special page buttons.\n   * @returns {Array<{knotName: string, element: HTMLElement, pageInfo: Object}>}\n   */\n  getSpecialPageButtons() {\n    const buttons = [];\n    for (const [buttonId, buttonElement] of this.dynamicButtons) {\n      const knotName = buttonId.replace(\"special-page-\", \"\");\n      const pageInfo = this.storyManager?.pages?.availablePages?.[knotName];\n\n      buttons.push({\n        buttonId,\n        knotName,\n        displayName: pageInfo?.displayName || Utils.formatKnotName(knotName),\n        element: buttonElement,\n        visible: buttonElement.style.display !== \"none\",\n        enabled: !buttonElement.hasAttribute(\"disabled\"),\n      });\n    }\n    return buttons;\n  }\n\n  /**\n   * Returns the current state of all navigation buttons (core and dynamic).\n   * @returns {Object.<string, {visible: boolean, enabled: boolean, exists: boolean, isDynamic: boolean, knotName?: string, displayName?: string}>}\n   */\n  getButtonStates() {\n    const states = {};\n    const coreButtons = [\"rewind\", \"saves-btn\", \"settings-btn\"];\n\n    coreButtons.forEach((buttonId) => {\n      const button = document.getElementById(buttonId);\n      if (button) {\n        states[buttonId] = {\n          visible: button.style.display !== \"none\",\n          enabled: !button.hasAttribute(\"disabled\"),\n          exists: true,\n          isDynamic: false,\n        };\n      } else {\n        states[buttonId] = {\n          visible: false,\n          enabled: false,\n          exists: false,\n          isDynamic: false,\n        };\n      }\n    });\n\n    for (const [buttonId, button] of this.dynamicButtons) {\n      const knotName = buttonId.replace(\"special-page-\", \"\");\n      states[buttonId] = {\n        visible: button.style.display !== \"none\",\n        enabled: !button.hasAttribute(\"disabled\"),\n        exists: true,\n        isDynamic: true,\n        knotName: knotName,\n        displayName: this.getPageDisplayName(knotName),\n      };\n    }\n\n    return states;\n  }\n\n  /**\n   * Finds a special page button element by knot name.\n   * @param {string} knotName - The ink knot name\n   * @returns {HTMLElement|null} The button element, or null if not found\n   * @private\n   */\n  findPageButton(knotName) {\n    // Panel links aren't stored in dynamicButtons, search the panel directly\n    if (!this.slidePanel) return null;\n\n    const links = this.slidePanel.querySelectorAll(\".panel-link\");\n    for (const link of links) {\n      // Match by the click handler's knotName (stored in closure)\n      // Since we can't access that, match by display name\n      const pageInfo = this.storyManager?.pages?.availablePages?.[knotName];\n      if (pageInfo && link.textContent === pageInfo.displayName) {\n        return link;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Gets the display name for a special page, falling back to formatted knot name.\n   * @param {string} knotName - The ink knot name\n   * @returns {string} The display name\n   */\n  getPageDisplayName(knotName) {\n    const pageInfo = this.storyManager?.pages?.availablePages?.[knotName];\n    return pageInfo?.displayName || Utils.formatKnotName(knotName);\n  }\n\n  /**\n   * Checks whether the navigation manager is ready for use.\n   * @returns {boolean} True if storyManager exists and rewind button is present\n   */\n  isReady() {\n    return !!(this.storyManager && document.getElementById(\"rewind\"));\n  }\n\n  /**\n   * Returns diagnostic information about the navigation state.\n   * @returns {{hasStoryManager: boolean, totalButtons: number, dynamicButtons: number, existingButtons: number, visibleButtons: number, trackedDynamicButtons: number, specialPageButtons: number, specialPageButtonDetails: Array}}\n   */\n  getStats() {\n    const buttonStates = this.getButtonStates();\n    const specialPageButtons = this.getSpecialPageButtons();\n    const totalButtons = Object.keys(buttonStates).length;\n    const dynamicButtons = Object.values(buttonStates).filter(\n      (s) => s.isDynamic\n    ).length;\n    const existingButtons = Object.values(buttonStates).filter(\n      (s) => s.exists\n    ).length;\n    const visibleButtons = Object.values(buttonStates).filter(\n      (s) => s.visible\n    ).length;\n\n    return {\n      hasStoryManager: !!this.storyManager,\n      totalButtons,\n      dynamicButtons,\n      existingButtons,\n      visibleButtons,\n      trackedDynamicButtons: this.dynamicButtons.size,\n      specialPageButtons: specialPageButtons.length,\n      specialPageButtonDetails: specialPageButtons,\n    };\n  }\n\n  /**\n   * Returns detailed information about the current navigation state.\n   * Useful for debugging and external integrations.\n   * @returns {{currentPage: {knotName: string|null, displayName: string|null, isSpecialPage: boolean}, availablePages: Array<{knotName: string, displayName: string, hasButton: boolean}>, coreButtons: Object}}\n   */\n  getNavigationInfo() {\n    const currentPage = this.storyManager?.pages?.getCurrentPageKnotName();\n    const availablePages = this.storyManager?.pages?.availablePages || {};\n\n    return {\n      currentPage: {\n        knotName: currentPage,\n        displayName: currentPage ? this.getPageDisplayName(currentPage) : null,\n        isSpecialPage: !!currentPage,\n      },\n      availablePages: Object.keys(availablePages).map((knotName) => ({\n        knotName,\n        displayName: this.getPageDisplayName(knotName),\n        hasButton: this.findPageButton(knotName) !== null,\n      })),\n      coreButtons: {\n        restart: {\n          exists: !!document.getElementById(\"rewind\"),\n          enabled: !document.getElementById(\"rewind\")?.hasAttribute(\"disabled\"),\n        },\n        saves: {\n          exists: !!document.getElementById(\"saves-btn\"),\n          enabled: !document\n            .getElementById(\"saves-btn\")\n            ?.hasAttribute(\"disabled\"),\n        },\n        settings: {\n          exists: !!document.getElementById(\"settings-btn\"),\n          enabled: !document\n            .getElementById(\"settings-btn\")\n            ?.hasAttribute(\"disabled\"),\n        },\n      },\n    };\n  }\n}\n\nexport { NavigationManager };\n", "import { BaseModal } from \"./base-modal.js\";\nimport { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.SAVES_MODAL);\n\nconst REFRESH_DELAY_MS = 100;\n\n/**\n * Modal UI for save/load game functionality.\n * Displays save slots with options to save, load, export, import, and delete.\n */\nclass SavesModal {\n  /**\n   * Creates the saves modal UI.\n   * @param {Object} gameSaveSystem - The SavesManager instance that handles save operations\n   */\n  constructor(gameSaveSystem) {\n    this.gameSaveSystem = gameSaveSystem;\n    this.maxSaveSlots = gameSaveSystem.maxSaveSlots;\n    this.autosaveSlot = gameSaveSystem.autosaveSlot;\n    this.confirmModal = null;\n\n    if (!this.gameSaveSystem) {\n      log.critical(\n        \"SavesModal requires a save system\",\n        new Error(\"Invalid save system\")\n      );\n      return;\n    }\n\n    this.init();\n  }\n\n  /**\n   * Initializes the modal and confirmation dialog.\n   * @private\n   */\n  init() {\n    this.createModal();\n    this.createConfirmModal();\n  }\n\n  /**\n   * Creates the main save/load modal using BaseModal.\n   * @private\n   */\n  createModal() {\n    this.modal = new BaseModal({\n      title: \"Save & Load Game\",\n      className: \"saves-modal\",\n      maxWidth: \"600px\",\n      onShow: () => this.populateSaveSlots(),\n    });\n  }\n\n  /**\n   * Creates a secondary modal for delete confirmations.\n   * @private\n   */\n  createConfirmModal() {\n    this.confirmModal = new BaseModal({\n      title: \"Confirm\",\n      className: \"confirm-modal\",\n      maxWidth: \"400px\",\n      showFooter: true,\n    });\n  }\n\n  /**\n   * Opens the save/load modal.\n   */\n  show() {\n    this.modal?.show();\n  }\n\n  /**\n   * Closes the save/load modal.\n   */\n  hide() {\n    this.modal?.hide();\n  }\n\n  /**\n   * Populates the modal content with current save slot states.\n   * Called automatically when the modal is shown.\n   */\n  populateSaveSlots() {\n    if (!this.modal?.modalElement) return;\n\n    const contentHTML = `\n      <div class=\"saves-section\">\n        <h3>Save Slots</h3>\n        <div class=\"save-slots-container\">\n          ${this.generateSaveSlotsHTML()}\n        </div>\n        <div class=\"import-export-info\">\n          <strong>Tip:</strong> Use \"Export\" to save a slot to a file. Use \"Import Here\" on empty slots to load save files. Press Ctrl+S to quickly open this dialog.\n        </div>\n      </div>\n    `;\n\n    this.modal.setContent(contentHTML);\n\n    const footer = this.modal.getFooter();\n    if (footer) {\n      footer.innerHTML = \"\";\n      footer.className = \"modal-footer modal-footer-right\";\n\n      const closeBtn = this.modal.createButton(\"Close\", {\n        variant: \"primary\",\n        onClick: () => this.hide(),\n      });\n\n      footer.appendChild(closeBtn);\n    }\n\n    this.setupSlotEventListeners();\n  }\n\n  /**\n   * Shows a notification within the modal.\n   * @param {string} message - Message to display\n   * @param {boolean} [isError=false] - Whether this is an error notification\n   * @param {number} [duration=4000] - Duration in milliseconds\n   */\n  showNotification(message, isError = false, duration = 4000) {\n    this.modal?.showNotification(message, isError, duration);\n  }\n\n  /**\n   * Generates HTML for all save slots (autosave + manual slots).\n   * @returns {string} HTML string for all slots\n   * @private\n   */\n  generateSaveSlotsHTML() {\n    let html = \"\";\n\n    html += this.createSaveSlotHTML(this.autosaveSlot, true);\n\n    for (let i = 1; i <= this.maxSaveSlots; i++) {\n      html += this.createSaveSlotHTML(i, false);\n    }\n\n    return html;\n  }\n\n  /**\n   * Creates HTML for a single save slot (empty or filled).\n   * @param {number} slotNumber - Slot number (0 = autosave)\n   * @param {boolean} [isAutosave=false] - Whether this is the autosave slot\n   * @returns {string} HTML string for the slot\n   * @private\n   */\n  createSaveSlotHTML(slotNumber, isAutosave = false) {\n    try {\n      const saveData = this.gameSaveSystem.getSaveData(slotNumber);\n      const isEmpty = !saveData;\n\n      if (isEmpty) {\n        return `<div class=\"save-slot ${isAutosave ? \"autosave-slot\" : \"\"}\" data-slot=\"${slotNumber}\">\n          ${this.createEmptySlotHTML(slotNumber, isAutosave)}\n        </div>`;\n      } else {\n        return `<div class=\"save-slot ${isAutosave ? \"autosave-slot\" : \"\"}\" data-slot=\"${slotNumber}\">\n          ${this.createFilledSlotHTML(slotNumber, saveData, isAutosave)}\n        </div>`;\n      }\n    } catch (error) {\n      log.error(\"Failed to create save slot HTML\", error);\n      return \"\";\n    }\n  }\n\n  /**\n   * Creates HTML for an empty save slot.\n   * @param {number} slotNumber - The slot number\n   * @param {boolean} isAutosave - Whether this is the autosave slot\n   * @returns {string} HTML string for the empty slot\n   * @private\n   */\n  createEmptySlotHTML(slotNumber, isAutosave) {\n    const slotName = isAutosave ? \"Autosave\" : `Slot ${slotNumber}`;\n    const emptyText = isAutosave ? \"No autosave available\" : \"Empty\";\n    const helpText = isAutosave\n      ? \"Game will autosave after choices when enabled in settings\"\n      : \"\";\n\n    return `\n      <div class=\"save-slot-content\">\n        <div class=\"save-slot-info\">\n          <strong class=\"save-slot-name\">${slotName}</strong>\n          <span class=\"save-slot-meta\">${emptyText}</span>\n          ${helpText ? `<span class=\"save-slot-meta\">${helpText}</span>` : \"\"}\n        </div>\n        <div class=\"save-slot-actions\">\n          ${!isAutosave ? this.createActionButton(\"Save\", \"save-to-slot\", \"primary\", slotName) : \"\"}\n          ${!isAutosave ? this.createActionButton(\"Import\", \"import-to-slot\", \"secondary\", slotName) : \"\"}\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Creates HTML for a filled save slot with save data.\n   * @param {number} slotNumber - The slot number\n   * @param {Object} saveData - The save data object\n   * @param {boolean} isAutosave - Whether this is the autosave slot\n   * @returns {string} HTML string for the filled slot\n   * @private\n   */\n  createFilledSlotHTML(slotNumber, saveData, isAutosave) {\n    const slotName = isAutosave ? \"Autosave\" : `Slot ${slotNumber}`;\n    const timestamp = new Date(saveData.timestamp).toLocaleString();\n    const turnNumber = (saveData.turnIndex ?? 0) + 1;\n\n    return `\n      <div class=\"save-slot-content\">\n        <div class=\"save-slot-info\">\n          <strong class=\"save-slot-name\">${slotName}</strong>\n          <span class=\"save-slot-date\">${timestamp}</span>\n          <span class=\"save-slot-meta\">Turn ${turnNumber}${saveData.description ? ` \u00B7 ${saveData.description}` : \"\"}</span>\n        </div>\n        <div class=\"save-slot-actions\">\n          ${this.createActionButton(\"Load\", \"load-from-slot\", \"secondary\", slotName)}\n          ${this.createActionButton(\"Export\", \"export-from-slot\", \"primary\", slotName)}\n          ${!isAutosave ? this.createActionButton(\"Overwrite\", \"overwrite-slot\", \"warning\", slotName) : \"\"}\n          ${this.createActionButton(isAutosave ? \"Clear\" : \"Delete\", \"delete-slot\", \"danger\", slotName)}\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Creates an action button HTML string.\n   * @param {string} text - Button label\n   * @param {string} action - CSS class for the action (e.g., 'load-from-slot')\n   * @param {string} variant - Button style variant (primary, secondary, warning, danger)\n   * @returns {string} HTML string for the button\n   * @private\n   */\n  createActionButton(text, action, variant, slotName) {\n    const ariaLabel = `${text} ${slotName}`;\n    return `<button class=\"${action} save-action-button save-action-${variant}\" aria-label=\"${ariaLabel}\">${text}</button>`;\n  }\n\n  /**\n   * Sets up event listeners for save slot actions.\n   * @private\n   */\n  setupSlotEventListeners() {\n    if (!this.modal?.modalElement) return;\n\n    this.setupSlotActionHandlers();\n  }\n\n  /**\n   * Binds action handlers for all slot button types.\n   * @private\n   */\n  setupSlotActionHandlers() {\n    const actions = {\n      \"save-to-slot\": (n) => this.gameSaveSystem.saveToSlot(n),\n      \"load-from-slot\": (n) => this.gameSaveSystem.loadFromSlot(n),\n      \"export-from-slot\": (n) => this.gameSaveSystem.exportFromSlot(n),\n      \"import-to-slot\": (n) => this.gameSaveSystem.importToSlot(n),\n      \"overwrite-slot\": (n) => this.gameSaveSystem.saveToSlot(n),\n      \"delete-slot\": (n) => this.handleDeleteSlot(n),\n    };\n\n    Object.entries(actions).forEach(([className, handler]) => {\n      this.bindSlotAction(className, handler);\n    });\n  }\n\n  /**\n   * Handles delete button click, determining if it's autosave or manual slot.\n   * @param {number} slotNumber - The slot number to delete\n   * @private\n   */\n  handleDeleteSlot(slotNumber) {\n    const slot = this.modal.modalElement.querySelector(\n      `[data-slot=\"${slotNumber}\"]`\n    );\n    const isAutosave = slot?.classList.contains(\"autosave-slot\");\n    this.gameSaveSystem.deleteSlot(slotNumber, isAutosave);\n  }\n\n  /**\n   * Binds a click handler for a specific action class using event delegation.\n   * @param {string} className - The CSS class to bind to\n   * @param {Function} handler - Handler function that receives the slot number\n   * @private\n   */\n  bindSlotAction(className, handler) {\n    this.modal.addBodyEventListener(`.${className}`, \"click\", (e) => {\n      try {\n        const slot = e.target.closest(\"[data-slot]\");\n        const slotNumber = parseInt(slot?.dataset.slot);\n        if (!isNaN(slotNumber)) {\n          handler(slotNumber);\n          setTimeout(() => this.populateSaveSlots(), REFRESH_DELAY_MS);\n        }\n      } catch (error) {\n        log.error(\"Save slot action failed\", error);\n      }\n    });\n  }\n\n  /**\n   * Checks whether the modal is ready for use.\n   * @returns {boolean} True if modal and save system are available\n   */\n  isReady() {\n    return !!(this.modal?.isReady() && this.gameSaveSystem);\n  }\n\n  /**\n   * Returns diagnostic information about the modal state.\n   * @returns {{hasModal: boolean, hasGameSaveSystem: boolean, maxSaveSlots: number, autosaveSlot: number, modalVisible: boolean}}\n   */\n  getStats() {\n    return {\n      hasModal: !!this.modal,\n      hasGameSaveSystem: !!this.gameSaveSystem,\n      maxSaveSlots: this.maxSaveSlots,\n      autosaveSlot: this.autosaveSlot,\n      modalVisible: this.modal?.isVisible || false,\n    };\n  }\n}\n\nexport { SavesModal };\n", "/* global __TEMPLATE_VERSION__ */\n/**\n * Template version injected at build time via esbuild --define.\n * Returns 'dev' for local development, actual version (e.g., 'v1.2.0') for releases.\n * @type {string}\n */\nexport const TEMPLATE_VERSION =\n  typeof __TEMPLATE_VERSION__ !== \"undefined\" ? __TEMPLATE_VERSION__ : \"dev\";\n", "import { BaseModal } from \"./base-modal.js\";\nimport { Utils } from \"./utils.js\";\n\n/**\n * Reusable error modal for displaying user-friendly error messages\n * with optional technical details. Use for recoverable errors that\n * need user acknowledgment.\n */\nclass ErrorModal {\n  constructor() {\n    this.modal = null;\n    this.init();\n  }\n\n  /**\n   * Initialize the modal instance.\n   * @private\n   */\n  init() {\n    this.modal = new BaseModal({\n      title: \"Error\",\n      className: \"error-modal\",\n      maxWidth: \"500px\",\n      showFooter: true,\n    });\n  }\n\n  /**\n   * Display an error modal with details.\n   * @param {Object} options - Error display options\n   * @param {string} [options.title=\"Something went wrong\"] - Modal title\n   * @param {string} [options.message=\"An unexpected error occurred.\"] - User-friendly message\n   * @param {string[]} [options.suggestions=[]] - List of possible causes/solutions\n   * @param {Error|string|null} [options.error=null] - Error object for technical details\n   */\n  show({\n    title = \"Something went wrong\",\n    message = \"An unexpected error occurred.\",\n    suggestions = [],\n    error = null,\n  } = {}) {\n    if (!this.modal?.isReady()) {\n      console.error(\"[ErrorModal] Modal not initialized\");\n      return;\n    }\n\n    this.modal.show((modal) => {\n      const titleEl = modal.modalElement?.querySelector(\".modal-header h2\");\n      if (titleEl) {\n        titleEl.innerHTML = `<span class=\"material-icons error-modal-icon\" aria-hidden=\"true\">warning</span><span class=\"sr-only\">Error: </span>${this.escapeHtml(title)}`;\n      }\n      modal.setContent(this.buildContent(message, suggestions, error));\n      this.setupFooter(modal);\n    });\n  }\n\n  /**\n   * Build the modal content HTML.\n   * @param {string} message - Main message\n   * @param {string[]} suggestions - List of suggestions\n   * @param {Error|string|null} error - Error for technical details\n   * @returns {string} HTML content\n   * @private\n   */\n  buildContent(message, suggestions, error) {\n    let html = `<p class=\"error-modal-message\">${message}</p>`;\n\n    if (suggestions.length > 0) {\n      html += `\n        <div class=\"error-modal-suggestions\">\n          <p><strong>This might be because:</strong></p>\n          <ul>\n            ${suggestions.map((s) => `<li>${s}</li>`).join(\"\")}\n          </ul>\n        </div>\n      `;\n    }\n\n    if (error) {\n      const errorText =\n        error instanceof Error\n          ? `${error.message}${error.stack ? `\\n\\n${error.stack}` : \"\"}`\n          : String(error);\n\n      const consoleHint = Utils.isMobile()\n        ? \"\"\n        : `<p class=\"error-modal-console-hint\">\n        For more details, open browser console: <kbd>F12</kbd> \u2192 Console tab\n      </p>`;\n\n      html += `\n    <details class=\"error-modal-details\">\n      <summary>Technical Details</summary>\n      <pre>${this.escapeHtml(errorText)}</pre>\n      ${consoleHint}\n    </details>\n  `;\n    }\n\n    return html;\n  }\n\n  /**\n   * Set up the modal footer with close button.\n   * @param {BaseModal} modal - The modal instance\n   * @private\n   */\n  setupFooter(modal) {\n    const footer = modal.getFooter();\n    if (!footer) return;\n\n    footer.innerHTML = \"\";\n    footer.className = \"modal-footer modal-footer-right\";\n\n    const closeBtn = modal.createButton(\"Close\", {\n      variant: \"primary\",\n      onClick: () => modal.hide(),\n    });\n\n    footer.appendChild(closeBtn);\n  }\n\n  /**\n   * Escape HTML entities for safe display.\n   * @param {string} text - Text to escape\n   * @returns {string} Escaped text\n   * @private\n   */\n  escapeHtml(text) {\n    const div = document.createElement(\"div\");\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  /**\n   * Hide the modal.\n   */\n  hide() {\n    this.modal?.hide();\n  }\n}\n\n/** Singleton instance for global use */\nconst errorModal = new ErrorModal();\n\nexport { ErrorModal, errorModal };\n", "import { SavesModal } from \"./saves-modal.js\";\nimport { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\nimport { TEMPLATE_VERSION } from \"./version.js\";\nimport { errorModal } from \"./error-modal.js\";\n\nconst log = errorManager.forSource(ERROR_SOURCES.SAVE_SYSTEM);\n\nconst MAX_IMPORT_SIZE_BYTES = 10 * 1024 * 1024; // 10MB\nconst IMPORT_TIMEOUT_MS = 30000; // 30 seconds\n\n/**\n * Manages save/load functionality using localStorage and ink.js state serialization.\n * Supports multiple save slots, autosave, and import/export to files.\n */\nclass SavesManager {\n  /**\n   * Creates the saves manager with a modal UI for save/load operations.\n   * @param {Object} storyManager - The StoryManager instance\n   */\n  constructor(storyManager) {\n    this.storyManager = storyManager;\n    this.savePrefix = \"ink-save-slot-\";\n    this.autosaveSlot = 0;\n    this.maxSaveSlots = 5;\n    this.modal = new SavesModal(this);\n    this.setupEventListeners();\n  }\n\n  /**\n   * Sets up the saves button click handler.\n   * @private\n   */\n  setupEventListeners() {\n    const savesBtn = document.getElementById(\"saves-btn\");\n    if (savesBtn) {\n      savesBtn.addEventListener(\"click\", (e) => {\n        e.preventDefault();\n        this.showSaveDialog();\n      });\n    }\n  }\n\n  /**\n   * Opens the save/load dialog modal.\n   */\n  showSaveDialog() {\n    this.modal?.show?.();\n  }\n\n  /**\n   * Closes the save/load dialog modal.\n   */\n  hideSaveDialog() {\n    this.modal?.hide?.();\n  }\n\n  /**\n   * Save game to a specific slot using ink.js state\n   * @param {number} slotNumber - Slot number to save to\n   */\n  saveToSlot(slotNumber) {\n    try {\n      this.validateSlotNumber(slotNumber);\n      this.requireStorage();\n\n      const saveData = this.buildSaveData(slotNumber);\n      this.writeSaveData(slotNumber, saveData);\n\n      this.notifySaveSuccess(slotNumber);\n      this.modal?.populateSaveSlots?.();\n      return true;\n    } catch (error) {\n      log.error(\"Failed to save game\", error);\n      if (slotNumber !== this.autosaveSlot) {\n        errorModal.show({\n          title: \"Unable to Save\",\n          message: \"Your progress couldn't be saved.\",\n          suggestions: [\n            \"Your browser's storage may be full\",\n            \"Try deleting old saves to free up space\",\n            \"Private/incognito mode may be blocking storage\",\n          ],\n          error: error,\n        });\n      }\n      return false;\n    }\n  }\n\n  /**\n   * Load game from a specific slot using ink.js state\n   * @param {number} slotNumber - Slot number to load from\n   */\n  loadFromSlot(slotNumber) {\n    try {\n      const saveData = this.getSaveData(slotNumber);\n      if (!saveData) {\n        const slotName =\n          slotNumber === this.autosaveSlot ? \"autosave\" : \"this slot\";\n        throw new Error(`No save data found in ${slotName}`);\n      }\n\n      if (!saveData.gameState) {\n        throw new Error(\"Save data is corrupted: missing game state\");\n      }\n\n      this.storyManager.loadState(saveData);\n\n      const slotName =\n        slotNumber === this.autosaveSlot ? \"Autosave\" : `Slot ${slotNumber}`;\n      this.showNotification(`Game loaded from ${slotName}!`);\n      this.hideSaveDialog();\n      return true;\n    } catch (error) {\n      log.error(\"Failed to load game\", error);\n\n      errorModal.show({\n        title: \"Unable to Load Save\",\n        message: \"This save couldn't be loaded.\",\n        suggestions: [\n          \"The save data may be corrupted\",\n          \"It may be from an incompatible version of the story\",\n          \"Try loading a different save or restarting\",\n        ],\n        error: error,\n      });\n      return false;\n    }\n  }\n\n  /**\n   * Deletes a save slot after user confirmation.\n   * @param {number} slotNumber - Slot number to delete\n   * @param {boolean} [isAutosave=false] - Whether this is the autosave slot\n   */\n  deleteSlot(slotNumber, isAutosave = false) {\n    try {\n      const message = isAutosave\n        ? \"Are you sure you want to clear the autosave?\"\n        : `Are you sure you want to delete the save in Slot ${slotNumber}?`;\n\n      if (this.modal && this.modal.confirmModal) {\n        this.modal.confirmModal.showConfirmation(\n          message,\n          () => {\n            try {\n              if (!this.isStorageAvailable()) {\n                throw new Error(\"localStorage not available\");\n              }\n\n              const saveKey = this.savePrefix + slotNumber;\n              localStorage.removeItem(saveKey);\n\n              const confirmMessage = isAutosave\n                ? \"Autosave cleared.\"\n                : `Slot ${slotNumber} deleted.`;\n              this.showNotification(confirmMessage);\n\n              this.modal?.populateSaveSlots?.();\n            } catch (error) {\n              log.error(\"Failed to delete save slot\", error);\n            }\n          },\n          null, // No cancel callback needed\n          {\n            title: \"Delete Save\",\n            confirmText: \"Delete\",\n            cancelText: \"Cancel\",\n          }\n        );\n        return true;\n      } else {\n        if (confirm(message)) {\n          if (!this.isStorageAvailable()) {\n            throw new Error(\"localStorage not available\");\n          }\n\n          const saveKey = this.savePrefix + slotNumber;\n          localStorage.removeItem(saveKey);\n\n          const confirmMessage = isAutosave\n            ? \"Autosave cleared.\"\n            : `Slot ${slotNumber} deleted.`;\n          this.showNotification(confirmMessage);\n\n          this.modal?.populateSaveSlots?.();\n          return true;\n        }\n        return false;\n      }\n    } catch (error) {\n      log.error(\"Failed to delete save slot\", error);\n      errorModal.show({\n        title: \"Unable to Delete Save\",\n        message: \"This save couldn't be deleted.\",\n        suggestions: [\n          \"Your browser's storage may be unavailable\",\n          \"Private/incognito mode may be blocking storage\",\n          \"Try refreshing the page and trying again\",\n        ],\n        error: error,\n      });\n      return false;\n    }\n  }\n\n  /**\n   * Exports a save slot to a downloadable JSON file.\n   * @param {number} slotNumber - Slot number to export\n   */\n  exportFromSlot(slotNumber) {\n    try {\n      const saveData = this.getSaveData(slotNumber);\n      if (!saveData) {\n        throw new Error(\"No save data found in this slot to export\");\n      }\n\n      const dataStr = JSON.stringify(saveData);\n      const dataBlob = new Blob([dataStr], { type: \"application/json\" });\n      const link = document.createElement(\"a\");\n      link.href = URL.createObjectURL(dataBlob);\n\n      const timestamp = new Date(saveData.timestamp)\n        .toISOString()\n        .slice(0, 19)\n        .replace(/:/g, \"-\");\n      const slotName =\n        slotNumber === this.autosaveSlot ? \"autosave\" : `slot${slotNumber}`;\n      const titleSlug = this.slugifyTitle(\n        this.storyManager.settings?.storyTitle\n      );\n      link.download = `${titleSlug}-${slotName}-${timestamp}.json`;\n\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n\n      const exportSlotName =\n        slotNumber === this.autosaveSlot ? \"Autosave\" : `Slot ${slotNumber}`;\n      this.showNotification(`Save exported from ${exportSlotName}!`);\n      return true;\n    } catch (error) {\n      log.error(\"Failed to export save\", error);\n      errorModal.show({\n        title: \"Unable to Export Save\",\n        message: \"This save couldn't be exported.\",\n        suggestions: [\n          \"The save data may be corrupted\",\n          \"Try saving to a new slot first, then export\",\n        ],\n        error: error,\n      });\n      return false;\n    }\n  }\n\n  /**\n   * Opens a file picker to import a save file into a slot.\n   * Validates file size and format before importing.\n   * @param {number} slotNumber - Slot number to import into\n   */\n  importToSlot(slotNumber) {\n    const fileInput = document.createElement(\"input\");\n    fileInput.type = \"file\";\n    fileInput.accept = \".json\";\n    fileInput.style.display = \"none\";\n\n    fileInput.addEventListener(\"change\", (event) => {\n      const file = event.target.files[0];\n      if (!file) return;\n\n      if (file.size > MAX_IMPORT_SIZE_BYTES) {\n        const maxSizeMB = MAX_IMPORT_SIZE_BYTES / (1024 * 1024);\n        errorModal.show({\n          title: \"Unable to Import Save\",\n          message: \"This save file couldn't be loaded.\",\n          suggestions: [\n            `The file exceeds the ${maxSizeMB}MB size limit`,\n            \"Make sure you're importing a save file, not a story file\",\n          ],\n          error: new Error(\n            `File size ${file.size} exceeds limit of ${MAX_IMPORT_SIZE_BYTES}`\n          ),\n        });\n        log.error(\n          `Import file too large (>${maxSizeMB}MB)`,\n          new Error(\"File size exceeds limit\")\n        );\n        return;\n      }\n\n      const reader = new FileReader();\n      const timeout = setTimeout(() => {\n        reader.abort();\n        const error = new Error(\"FileReader timeout\");\n        errorModal.show({\n          title: \"Unable to Import Save\",\n          message: \"This save file couldn't be loaded.\",\n          suggestions: [\n            \"The file took too long to read\",\n            \"Try again or use a smaller file\",\n          ],\n          error: error,\n        });\n        log.error(\"File import timed out\", error);\n      }, IMPORT_TIMEOUT_MS);\n\n      reader.onload = (e) => {\n        clearTimeout(timeout);\n        try {\n          const importData = JSON.parse(e.target.result);\n\n          if (!importData?.gameState || !importData?.version) {\n            throw new Error(\"Invalid save file format\");\n          }\n\n          const testStory = this.storyManager.createTempStory();\n          testStory.state.LoadJson(importData.gameState);\n\n          this.writeSaveData(slotNumber, importData);\n\n          const slotName =\n            slotNumber === this.autosaveSlot\n              ? \"Autosave\"\n              : `Slot ${slotNumber}`;\n          this.showNotification(`Save imported to ${slotName}!`);\n\n          this.modal?.populateSaveSlots?.();\n        } catch (error) {\n          log.error(\"Failed to import save file\", error);\n\n          errorModal.show({\n            title: \"Unable to Import Save\",\n            message: \"This save file couldn't be loaded.\",\n            suggestions: [\n              \"The file may be corrupted or invalid\",\n              \"It may be from a different story\",\n              \"It may be from an incompatible version of the story\",\n            ],\n            error: error,\n          });\n        }\n      };\n\n      reader.onerror = () => {\n        clearTimeout(timeout);\n        const error = reader.error || new Error(\"Unknown read error\");\n        log.error(\"Failed to read import file\", error);\n        errorModal.show({\n          title: \"Unable to Import Save\",\n          message: \"This save file couldn't be loaded.\",\n          suggestions: [\n            \"The file couldn't be read\",\n            \"It may be corrupted\",\n            \"Try exporting the save again from the original source\",\n          ],\n          error: error,\n        });\n      };\n\n      reader.readAsText(file);\n      event.target.value = \"\";\n      document.body.removeChild(fileInput);\n    });\n\n    document.body.appendChild(fileInput);\n    fileInput.click();\n  }\n\n  /**\n   * Performs an autosave if enabled in settings and not viewing a special page.\n   */\n  autosave() {\n    if (\n      !this.shouldAutosave() ||\n      this.storyManager.pages?.isViewingSpecialPage?.()\n    ) {\n      return;\n    }\n\n    try {\n      this.saveToSlot(this.autosaveSlot);\n      console.log(\"[AUTOSAVE] Game autosaved successfully\");\n    } catch (error) {\n      log.error(\"Autosave failed\", error);\n    }\n  }\n\n  /**\n   * Checks if any save data exists (autosave or manual slots).\n   * @returns {boolean} True if at least one save exists\n   */\n  hasSaves() {\n    if (this.getSaveData(this.autosaveSlot)) return true;\n\n    for (let i = 1; i <= this.maxSaveSlots; i++) {\n      if (this.getSaveData(i)) return true;\n    }\n    return false;\n  }\n\n  /**\n   * Retrieves save data from a specific slot.\n   * @param {number} slotNumber - Slot number to read\n   * @returns {Object|null} The save data object, or null if empty/error\n   */\n  getSaveData(slotNumber) {\n    try {\n      if (!this.isStorageAvailable()) return null;\n\n      const saveKey = this.savePrefix + slotNumber;\n      const saveJson = localStorage.getItem(saveKey);\n      return saveJson ? JSON.parse(saveJson) : null;\n    } catch (error) {\n      log.error(\"Failed to get save data\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Returns statistics about all save slots.\n   * @returns {{totalSaves: number, hasAutosave: boolean, oldestSave: Object|null, newestSave: Object|null}}\n   */\n  getSaveStats() {\n    let totalSaves = 0;\n    let oldestSave = null;\n    let newestSave = null;\n\n    for (let i = 0; i <= this.maxSaveSlots; i++) {\n      const saveData = this.getSaveData(i);\n      if (saveData) {\n        totalSaves++;\n\n        if (!oldestSave || saveData.timestamp < oldestSave.timestamp) {\n          oldestSave = saveData;\n        }\n\n        if (!newestSave || saveData.timestamp > newestSave.timestamp) {\n          newestSave = saveData;\n        }\n      }\n    }\n\n    return {\n      totalSaves,\n      hasAutosave: !!this.getSaveData(this.autosaveSlot),\n      oldestSave,\n      newestSave,\n    };\n  }\n\n  /**\n   * Checks if autosave is enabled in settings.\n   * @returns {boolean} True if autosave is enabled\n   * @private\n   */\n  shouldAutosave() {\n    try {\n      return this.storyManager.settings?.getSetting?.(\"autoSave\") || false;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Tests whether localStorage is available and functional.\n   * @returns {boolean} True if localStorage can be used\n   * @private\n   */\n  isStorageAvailable() {\n    try {\n      const test = \"__storage_test__\";\n      localStorage.setItem(test, test);\n      localStorage.removeItem(test);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Validates that a slot number is within the allowed range.\n   * @param {number} slotNumber - Slot number to validate\n   * @throws {Error} If slot number is invalid\n   * @private\n   */\n  validateSlotNumber(slotNumber) {\n    if (\n      typeof slotNumber !== \"number\" ||\n      !Number.isInteger(slotNumber) ||\n      slotNumber < 0 ||\n      slotNumber > this.maxSaveSlots\n    ) {\n      throw new Error(`Invalid slot number: ${slotNumber}`);\n    }\n  }\n\n  /**\n   * Throws an error if localStorage is not available.\n   * @throws {Error} If localStorage is not available\n   * @private\n   */\n  requireStorage() {\n    if (!this.isStorageAvailable()) {\n      throw new Error(\"localStorage not available\");\n    }\n  }\n\n  /**\n   * Builds the complete save data object for a slot.\n   * Handles special page state correctly by using saved state instead of current.\n   * @param {number} slotNumber - Slot number being saved to\n   * @returns {Object} Complete save data object\n   * @private\n   */\n  buildSaveData(slotNumber) {\n    const isOnSpecialPage = this.storyManager.pages?.isViewingSpecialPage?.();\n\n    return {\n      gameState: this.getGameState(isOnSpecialPage),\n      displayState: this.getDisplayState(isOnSpecialPage),\n      turnIndex: this.storyManager.story.state.currentTurnIndex,\n      description: this.generateDescription(),\n      timestamp: Date.now(),\n      version: TEMPLATE_VERSION,\n      isAutosave: slotNumber === this.autosaveSlot,\n      currentPage: null,\n      stateBeforeUserInput: this.storyManager.stateBeforeUserInput || null,\n    };\n  }\n\n  /**\n   * Gets the appropriate game state JSON based on whether viewing a special page.\n   * @param {boolean} isOnSpecialPage - Whether currently viewing a special page\n   * @returns {string} Serialized ink story state\n   * @private\n   */\n  getGameState(isOnSpecialPage) {\n    return isOnSpecialPage\n      ? this.storyManager.pages.savedStoryState\n      : this.storyManager.story.state.ToJson();\n  }\n\n  /**\n   * Gets the appropriate display state based on whether viewing a special page.\n   * @param {boolean} isOnSpecialPage - Whether currently viewing a special page\n   * @returns {Object} Display state object\n   * @private\n   */\n  getDisplayState(isOnSpecialPage) {\n    return isOnSpecialPage\n      ? this.storyManager.pages.savedDisplayState\n      : this.storyManager.display.getState();\n  }\n\n  /**\n   * Write save data to a slot\n   * @param {number} slotNumber - Slot number to write to\n   * @param {Object} saveData - Save data to write\n   */\n  writeSaveData(slotNumber, saveData) {\n    if (!this.isStorageAvailable()) {\n      throw new Error(\"localStorage not available\");\n    }\n\n    const saveKey = this.savePrefix + slotNumber;\n    const dataStr = JSON.stringify(saveData);\n\n    try {\n      localStorage.setItem(saveKey, dataStr);\n    } catch (e) {\n      if (e.name === \"QuotaExceededError\") {\n        this.attemptStorageCleanup();\n        try {\n          localStorage.setItem(saveKey, dataStr);\n        } catch {\n          throw new Error(\n            \"Storage quota exceeded - please delete some saves manually\"\n          );\n        }\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  /**\n   * Converts a story title to a filename-safe slug.\n   * @param {string} title - The story title\n   * @returns {string} Slugified title (lowercase, dashes for spaces, no special chars)\n   * @private\n   */\n  slugifyTitle(title) {\n    if (!title || typeof title !== \"string\") {\n      return \"ink-story\";\n    }\n\n    const slug = title\n      .toLowerCase()\n      .trim()\n      .replace(/[^a-z0-9\\s-]/g, \"\") // remove special characters\n      .replace(/\\s+/g, \"-\") // spaces to dashes\n      .replace(/-+/g, \"-\") // collapse multiple dashes\n      .replace(/^-|-$/g, \"\"); // trim leading/trailing dashes\n\n    return slug || \"ink-story\"; // fallback if result is empty\n  }\n\n  /**\n   * Generates a description for a save based on current story location.\n   * @returns {string} Generated description or empty string\n   * @private\n   */\n  generateDescription() {\n    const currentPath = this.storyManager.story.state.currentPathString;\n    if (currentPath) {\n      return this.pathToDisplayName(currentPath);\n    }\n\n    const displayState = this.storyManager.display?.getState?.();\n    return this.descriptionFromHistory(displayState?.history);\n  }\n\n  /**\n   * Converts a path string to a Title Case display name.\n   * @param {string} path - Path like \"chapter_one.scene_two\"\n   * @returns {string} Title case name like \"Scene Two\"\n   */\n  pathToDisplayName(path) {\n    if (!path) return \"\";\n    const pathParts = path.split(\".\");\n    let name = pathParts[pathParts.length - 1];\n\n    name = name.replace(/_/g, \" \");\n    name = name.replace(/([a-z])([A-Z])/g, \"$1 $2\");\n    name = name\n      .toLowerCase()\n      .split(\" \")\n      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))\n      .join(\" \");\n\n    return name;\n  }\n\n  /**\n   * Extracts a description from the first history entry.\n   * @param {Array} history - Display history array\n   * @param {number} [maxLength=60] - Maximum description length\n   * @returns {string} Cleaned description or empty string\n   */\n  descriptionFromHistory(history, maxLength = 60) {\n    if (!history?.length) return \"\";\n\n    for (const entry of history) {\n      if (entry.type === \"paragraph\" && entry.text?.trim()) {\n        let description = entry.text.trim();\n        description = description.replace(/^:{1,3}\\s+/, \"\");\n        description = description.replace(/^>{1,2}\\s+/, \"\");\n        if (description.length > maxLength) {\n          description = description.substring(0, maxLength - 3) + \"...\";\n        }\n        return description;\n      }\n    }\n\n    return \"\";\n  }\n\n  /**\n   * Shows a success notification for manual saves (not autosaves).\n   * @param {number} slotNumber - Slot number that was saved\n   * @private\n   */\n  notifySaveSuccess(slotNumber) {\n    if (slotNumber !== this.autosaveSlot) {\n      this.showNotification(`Game saved to Slot ${slotNumber}!`);\n    }\n  }\n\n  /**\n   * Shows a notification in the save modal.\n   * @param {string} message - Message to display\n   * @param {number} [duration=4000] - Duration in milliseconds\n   * @private\n   */\n  showNotification(message, duration = 4000) {\n    this.modal?.showNotification?.(message, false, duration);\n  }\n\n  /**\n   * Attempts to free localStorage space by removing the oldest save.\n   * Called when a QuotaExceededError occurs.\n   * @private\n   */\n  attemptStorageCleanup() {\n    try {\n      const saves = [];\n\n      for (let i = 1; i <= this.maxSaveSlots; i++) {\n        const saveData = this.getSaveData(i);\n        if (saveData?.timestamp) {\n          saves.push({ slot: i, timestamp: saveData.timestamp });\n        }\n      }\n\n      saves.sort((a, b) => a.timestamp - b.timestamp);\n\n      if (saves.length > 0) {\n        const oldestSlot = saves[0].slot;\n        const saveKey = this.savePrefix + oldestSlot;\n        localStorage.removeItem(saveKey);\n        console.log(\n          `[STORAGE] Automatically removed oldest save from slot ${oldestSlot}`\n        );\n      }\n    } catch (error) {\n      log.error(\"Storage cleanup failed\", error);\n    }\n  }\n\n  /**\n   * Cleans up the modal when the manager is disposed.\n   */\n  cleanup() {\n    this.modal?.modalElement?.remove?.();\n  }\n}\n\nexport { SavesManager };\n", "import { StoryManager } from \"./story-manager.js\";\nimport { errorManager, ERROR_SOURCES } from \"./error-manager.js\";\nimport { notificationManager } from \"./notification-manager.js\";\nimport { StoryFeatures } from \"./tag-registry.js\";\nimport { Utils } from \"./utils.js\";\nimport { KeyboardShortcuts } from \"./keyboard-shortcuts.js\";\nimport { KeyboardHelpModal } from \"./keyboard-help-modal.js\";\nimport { DisplayManager } from \"./display-manager.js\";\nimport { ContentProcessor } from \"./content-processor.js\";\nimport { TagProcessor } from \"./tag-processor.js\";\nimport { SettingsManager } from \"./settings-manager.js\";\nimport { SettingsModal } from \"./settings-modal.js\";\nimport { PageManager } from \"./page-manager.js\";\nimport { ChoiceManager } from \"./choice-manager.js\";\nimport { NavigationManager } from \"./navigation-manager.js\";\nimport { SavesManager } from \"./saves-manager.js\";\n\n/**\n * Application entry point. Initializes all managers and starts the story.\n *\n * Initialization order:\n * 1. Fetch and parse story.json\n * 2. Create core services (settings, processors)\n * 3. Create display and story manager\n * 4. Create feature managers (pages, choices, navigation, saves)\n * 5. Wire circular dependencies\n * 6. Initialize keyboard features (desktop only)\n * 7. Start the story\n * 8. Expose public API on window.InkTemplate\n *\n * @module main\n */\n\n/**\n * Public API namespace for debugging and external access.\n * @type {{storyManager: StoryManager|null, errorManager: ErrorManager, notificationManager: NotificationManager, keyboardShortcuts: KeyboardShortcuts|null, keyboardHelpModal: KeyboardHelpModal|null}}\n */\nwindow.InkTemplate = {\n  storyManager: null,\n  errorManager,\n  notificationManager,\n  keyboardShortcuts: null,\n  keyboardHelpModal: null,\n};\n\nfetch(\"story.json\")\n  .then((response) => {\n    if (!response.ok) {\n      throw new Error(\n        `story.json not found (${response.status}). ` +\n          `Make sure story.json is in the root folder alongside index.html.`\n      );\n    }\n    return response.json();\n  })\n  .then((storyContent) => {\n    try {\n      StoryFeatures.scan(storyContent);\n\n      const settings = new SettingsManager();\n      const settingsModal = new SettingsModal(settings);\n      const tagProcessor = new TagProcessor(settings);\n      const contentProcessor = new ContentProcessor(tagProcessor);\n      const display = new DisplayManager(settings);\n      const storyManager = new StoryManager(storyContent, {\n        display,\n        settings,\n        contentProcessor,\n      });\n      const pages = new PageManager(storyManager);\n      const choices = new ChoiceManager(storyManager, tagProcessor);\n      const navigation = new NavigationManager(storyManager);\n      const saves = new SavesManager(storyManager);\n\n      // Wire circular dependencies\n      storyManager.pages = pages;\n      storyManager.choices = choices;\n      storyManager.navigation = navigation;\n      storyManager.saves = saves;\n      contentProcessor.storyManager = storyManager;\n      display.storyManager = storyManager;\n\n      // Initialize keyboard features (desktop only)\n      let keyboardShortcuts = null;\n      let keyboardHelpModal = null;\n      if (!Utils.isMobile()) {\n        keyboardHelpModal = new KeyboardHelpModal();\n        keyboardShortcuts = new KeyboardShortcuts();\n        keyboardShortcuts.storyManager = storyManager;\n        keyboardShortcuts.keyboardHelpModal = keyboardHelpModal;\n      }\n\n      // Wire settings dependencies\n      settings.storyManager = storyManager;\n      settings.keyboardShortcuts = keyboardShortcuts;\n      settings.settingsModal = settingsModal;\n      settingsModal.keyboardHelpModal = keyboardHelpModal;\n\n      // Start the story\n      storyManager.start();\n\n      // Set up public API\n      window.InkTemplate.storyManager = storyManager;\n      window.InkTemplate.keyboardShortcuts = keyboardShortcuts;\n      window.InkTemplate.keyboardHelpModal = keyboardHelpModal;\n\n      const loadingScreen = document.getElementById(\"loading-screen\");\n      if (loadingScreen) {\n        loadingScreen.classList.add(\"hidden\");\n        setTimeout(() => loadingScreen.remove(), 300);\n      }\n\n      const mainContent = document.getElementById(\"main-content\");\n      if (mainContent) {\n        mainContent.removeAttribute(\"aria-busy\");\n      }\n\n      // Handle skip link without adding hash to URL\n      const skipLink = document.querySelector(\".skip-link\");\n      if (skipLink) {\n        skipLink.addEventListener(\"click\", (e) => {\n          e.preventDefault();\n          const target = document.querySelector(skipLink.getAttribute(\"href\"));\n          if (target) {\n            target.focus();\n          }\n        });\n      }\n\n      // Debug tools (localhost only)\n      if (\n        window.location.hostname === \"localhost\" ||\n        window.location.hostname === \"127.0.0.1\"\n      ) {\n        window.debug = {\n          story: storyManager.story,\n          display: storyManager.display,\n          saves: storyManager.saves,\n          settings: storyManager.settings,\n          errors: errorManager,\n          getStats: () => storyManager.getStats(),\n          getFeatureInfo: () => storyManager.getFeatureInfo(),\n        };\n        console.log(\"Debug tools available in window.debug\");\n      }\n    } catch (error) {\n      errorManager.critical(\n        \"Failed to initialize story manager\",\n        error,\n        ERROR_SOURCES.SYSTEM\n      );\n      showFallbackUI(error);\n    }\n  })\n  .catch((error) => {\n    errorManager.critical(\n      \"Failed to load story file\",\n      error,\n      ERROR_SOURCES.SYSTEM\n    );\n    showFallbackUI(error);\n  });\n\n/**\n * Show fallback UI when story fails to load\n * @param {Error} error - The error that occurred\n */\nfunction showFallbackUI(error) {\n  const storyContainer = document.getElementById(\"story\");\n  if (!storyContainer) return;\n\n  const loadingScreen = document.getElementById(\"loading-screen\");\n  if (loadingScreen) {\n    loadingScreen.classList.add(\"hidden\");\n    setTimeout(() => loadingScreen.remove(), 300);\n  }\n\n  storyContainer.innerHTML = `\n    <div style=\"text-align: center; padding: 2rem; color: var(--color-important);\">\n      <h2>\u26A0\uFE0F Story Loading Error</h2>\n      <p>Unable to load the story. Please check the browser console (F12) for details.</p>\n      <div style=\"margin: 2rem 0;\">\n        <button onclick=\"window.location.reload()\" style=\"\n          background: var(--color-accent-primary);\n          color: var(--color-background);\n          border: none;\n          padding: 0.75rem 1.5rem;\n          border-radius: 4px;\n          cursor: pointer;\n          margin-right: 1rem;\n          font-size: 1rem;\n        \">Reload Page</button>\n        <button onclick=\"showConsoleHelp()\" style=\"\n          color: var(--color-text-primary);\n          border: 1px solid var(--color-border-medium);\n          padding: 0.75rem 1.5rem;\n          border-radius: 4px;\n          cursor: pointer;\n          font-size: 1rem;\n        \">How to Check Console</button>\n      </div>\n      <details style=\"margin-top: 1rem; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;\">\n        <summary style=\"cursor: pointer; font-weight: 600;\">Technical Details</summary>\n        <div style=\"background: var(--color-background); color: var(--color-text-primary); padding: 1rem; border-radius: 4px; margin-top: 0.5rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto;\">\n          Error: ${error.message}<br>\n          Time: ${new Date().toLocaleString()}<br>\n          ${error.stack ? `Stack: ${error.stack}` : \"\"}\n        </div>\n      </details>\n    </div>\n  `;\n}\n\nfunction showConsoleHelp() {\n  alert(`To check the console for error details:\n\n\u2022 Chrome/Edge: Press F12 or Ctrl+Shift+I, then click \"Console\"\n\u2022 Firefox: Press F12 or Ctrl+Shift+K\n\u2022 Safari: Press Cmd+Option+I (Mac), then click \"Console\"\n\u2022 Mobile: Console not easily accessible, try on desktop\n\nLook for red error messages that show what went wrong.`);\n}\n\nwindow.showConsoleHelp = showConsoleHelp;\n"],
  "mappings": "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",
  "names": ["Path", "constructor", "this", "_components", "_componentsString", "_isRelative", "arguments", "componentsString", "Component", "head", "tail", "push", "concat", "Array", "relative", "isRelative", "componentCount", "length", "tailComps", "slice", "self", "lastComponent", "lastComponentIdx", "containsNamedComponent", "i", "l", "isIndex", "path", "GetComponent", "index", "PathByAppendingPath", "pathToAppend", "p", "upwardMoves", "isParent", "join", "value", "substring", "componentStrings", "split", "str", "test", "parseInt", "toString", "Equals", "otherPath", "PathByAppendingComponent", "c", "Debug", "ValueType", "PushPopType", "ErrorType", "asOrNull", "obj", "type", "unsafeTypeAssertion", "asOrThrows", "Error", "asINamedContentOrNull", "hasValidName", "name", "nullIfUndefined", "isEquatable", "parentId", "indexOrName", "ToParent", "otherComp", "Assert", "condition", "message", "console", "warn", "trace", "AssertType", "variable", "NullException", "throwNullException", "InkObject", "parent", "_debugMetadata", "_path", "debugMetadata", "ownDebugMetadata", "DebugLineNumberOfPath", "root", "rootContentContainer", "targetContent", "ContentAtPath", "dm", "startLineNumber", "comps", "child", "container", "Container", "namedChild", "unshift", "content", "indexOf", "ResolvePath", "nearestContainer", "contentContainer", "ConvertPathToRelative", "globalPath", "ownPath", "minPathLength", "Math", "min", "lastSharedPathCompIndex", "ownComp", "numUpwardsMoves", "newPathComps", "up", "down", "CompactPathString", "globalPathStr", "relativePathStr", "ancestor", "Copy", "SetChild", "prop", "StringBuilder", "string", "Length", "Append", "AppendLine", "AppendFormat", "format", "_len", "args", "_key", "replace", "match", "num", "Clear", "InkListItem", "originName", "itemName", "nameParts", "Null", "isNull", "fullName", "otherItem", "copy", "serialized", "JSON", "stringify", "key", "parse", "isLikeInkListItem", "inkListItem", "item", "hasOwnProperty", "InkList", "Map", "super", "origins", "_originNames", "otherList", "otherOriginNames", "originNames", "singleOriginListName", "originStory", "SetInitialOriginName", "listDefinitions", "def", "TryListGetDefinition", "exists", "result", "singleElement", "Add", "Key", "Value", "myListItem", "listValue", "_a", "FindSingleItemListWithName", "AddItem", "itemOrItemName", "storyObject", "origin", "intVal", "TryGetValueForItem", "foundListDef", "ContainsItemWithName", "newItem", "FromString", "orderedItems", "itemVal", "ValueForItem", "ContainsItemNamed", "fromSerializedKey", "ContainsKey", "has", "serializedKey", "set", "Remove", "delete", "Count", "size", "originOfMaxItem", "maxOriginName", "maxItem", "every", "initialOriginName", "SetInitialOriginNames", "initialOriginNames", "max", "minItem", "inverse", "list", "items", "all", "Union", "union", "Intersect", "intersection", "HasIntersection", "Without", "listToRemove", "Contains", "what", "GreaterThan", "GreaterThanOrEquals", "LessThan", "LessThanOrEquals", "MaxAsList", "MinAsList", "ListWithSubRange", "minBound", "maxBound", "ordered", "minValue", "maxValue", "Number", "MAX_SAFE_INTEGER", "isInteger", "subList", "otherInkList", "sort", "x", "y", "localeCompare", "singleItem", "sb", "valueOf", "NaN", "StoryException", "useEndLineNumber", "tryGetValueFromMap", "map", "val", "get", "AbstractValue", "preferredNumberType", "Int", "IntValue", "Float", "isNaN", "FloatValue", "BoolValue", "Boolean", "StringValue", "String", "DivertTargetValue", "ListValue", "Create", "valueObject", "BadCastException", "targetType", "valueType", "isTruthy", "Bool", "Cast", "newType", "_isNewline", "_isInlineWhitespace", "isNewline", "isInlineWhitespace", "isNonWhitespace", "parsedInt", "defaultValue", "parsedFloat", "parseFloat", "DivertTarget", "targetPath", "VariablePointerValue", "variableName", "contextIndex", "_contextIndex", "VariablePointer", "List", "listOrSingleItem", "singleValue", "oldValue", "newValue", "oldList", "newList", "SearchResult", "approximate", "correctObj", "searchResult", "_content", "namedContent", "visitsShouldBeCounted", "turnIndexShouldBeCounted", "countingAtStartOnly", "_pathToFirstLeafContent", "AddContent", "namedOnlyContent", "namedOnlyContentDict", "inkObject", "named", "existingNamedOnly", "AddToNamedContentOnly", "countFlags", "flags", "CountFlags", "Visits", "Turns", "CountStartOnly", "flag", "pathToFirstLeafContent", "internalPathToFirstLeafContent", "components", "contentObjOrList", "contentList", "contentObj", "TryAddNamedContent", "namedContentObj", "partialPathStart", "partialPathLength", "currentContainer", "currentObj", "comp", "foundObj", "ContentWithPathComponent", "nextContainer", "InsertContent", "splice", "AddContentsOfContainer", "otherContainer", "component", "foundContent", "BuildStringOfHierarchy", "indentation", "pointedObj", "appendIndentation", "onlyNamed", "Glue", "ControlCommand", "commandType", "_commandType", "CommandType", "NotSet", "EvalStart", "EvalOutput", "EvalEnd", "Duplicate", "PopEvaluatedValue", "PopFunction", "PopTunnel", "BeginString", "EndString", "NoOp", "ChoiceCount", "TurnsSince", "ReadCount", "Random", "SeedRandom", "VisitIndex", "SequenceShuffleIndex", "StartThread", "Done", "End", "ListFromInt", "ListRange", "ListRandom", "BeginTag", "EndTag", "Pointer", "Resolve", "Divert", "_targetPath", "targetObj", "targetPointer", "_targetPointer", "StartOf", "targetPathString", "hasVariableTarget", "variableDivertName", "stackPushType", "pushesToStack", "isExternal", "externalArgs", "isConditional", "otherDivert", "targetStr", "Function", "ChoicePoint", "onceOnly", "_pathOnChoice", "hasCondition", "hasStartContent", "hasChoiceOnlyContent", "isInvisibleDefault", "pathOnChoice", "choiceTargetObj", "choiceTarget", "pathStringOnChoice", "VariableReference", "containerForCount", "pathForCount", "pathStringForCount", "VariableAssignment", "isNewDeclaration", "isGlobal", "Void", "NativeFunctionCall", "functionName", "GenerateNativeFunctionsIfNecessary", "_nativeFunctions", "_name", "_isPrototype", "_prototype", "numberOfParameters", "_numberOfParameters", "Call", "parameters", "hasList", "CallBinaryListOperation", "coercedParams", "CoerceValuesToSingleType", "coercedType", "CallType", "parametersOfSingleType", "param1", "valType", "val1", "paramCount", "_operationFuncs", "opForTypeObj", "val2", "opForType", "resultVal", "CallListIncrementOperation", "v1", "v2", "op", "listIntParams", "listVal", "resultInkList", "listItemKey", "listItemValue", "listItem", "intOp", "targetInt", "itemOrigin", "incrementedItem", "TryGetItemWithValue", "parametersIn", "specialCaseList", "parametersOut", "inkObjectVal", "castedValue", "t", "AddIntBinaryOp", "Subtract", "Multiply", "Divide", "floor", "Mod", "AddIntUnaryOp", "Negate", "Equal", "Greater", "Less", "NotEquals", "Not", "And", "Or", "Max", "Min", "Pow", "pow", "Floor", "Identity", "Ceiling", "AddFloatBinaryOp", "AddFloatUnaryOp", "ceil", "AddStringBinaryOp", "Has", "includes", "Hasnt", "AddListBinaryOp", "AddListUnaryOp", "Invert", "All", "ListMin", "ListMax", "ValueOfList", "divertTargetsEqual", "d1", "d2", "divertTargetsNotEqual", "AddOpToNativeFunc", "AddOpFuncForType", "nativeFunc", "Tag", "tagText", "text", "Choice", "threadAtGeneration", "sourcePath", "tags", "originalThreadIndex", "Clone", "ListDefinition", "_items", "_itemNameToValues", "ContainsItem", "ListDefinitionsOrigin", "lists", "_lists", "_allUnambiguousListValueCache", "listOfLists", "definition", "JsonSerialisation", "jArray", "skipLast", "count", "jTok", "runtimeObj", "JTokenToRuntimeObject", "writer", "dictionary", "WriteObjectStart", "WritePropertyStart", "WriteRuntimeObject", "WritePropertyEnd", "WriteObjectEnd", "WriteArrayStart", "WriteArrayEnd", "dict", "WriteIntProperty", "WriteRuntimeContainer", "divert", "divTypeKey", "Tunnel", "WriteProperty", "choicePoint", "boolVal", "WriteBool", "WriteInt", "floatVal", "WriteFloat", "strVal", "Write", "WriteStringStart", "WriteStringInner", "WriteStringEnd", "WriteInkList", "divTargetVal", "varPtrVal", "controlCmd", "_controlCommandNames", "varRef", "readCountPath", "varAss", "tag", "choice", "WriteChoice", "jObject", "token", "floatRepresentation", "exec", "firstChar", "CallExistsWithName", "CallWithName", "isArray", "propValue", "varPtr", "isDivert", "divPushType", "external", "target", "readCountVarRef", "isVarAss", "isGlobalVar", "varName", "isNewDecl", "listContent", "rawList", "namesAsObjs", "nameToVal", "JObjectToChoice", "JArrayToContainer", "toJson", "me", "removes", "space", "k", "v", "some", "r", "withoutName", "hasNameProperty", "hasTerminator", "namedContainer", "WriteNull", "JArrayToRuntimeObjList", "terminatingObj", "namedContentItem", "namedSubContainer", "jObj", "JArrayToTags", "WriteChoiceTags", "WritePropertyNameStart", "WritePropertyNameInner", "WritePropertyNameEnd", "listDefJson", "defsObj", "allDefs", "nameValueKey", "nameValue", "TOTAL_VALUES", "CallStack", "elements", "callStack", "depth", "currentElement", "cs", "_threads", "callstack", "currentElementIndex", "currentThread", "canPop", "_threadCounter", "_startOfRoot", "Story", "storyContext", "Reset", "toCopy", "otherThread", "Thread", "Element", "SetJsonToken", "jThreads", "jThreadTok", "jThreadObj", "thread", "WriteJson", "w", "WriteObject", "PushThread", "newThread", "threadIndex", "ForkThread", "forkedThread", "PopThread", "canPopThread", "elementIsEvaluateFromGame", "FunctionEvaluationFromGame", "Push", "externalEvaluationStackHeight", "outputStreamLengthWithPushed", "element", "currentPointer", "evaluationStackHeightWhenPushed", "functionStartInOutputStream", "CanPop", "Pop", "pop", "GetTemporaryVariableWithName", "varValue", "temporaryVariables", "SetTemporaryVariable", "declareNew", "contextElement", "RetainListOriginsForAssignment", "ContextForVariableNamed", "ThreadWithIndex", "filtered", "filter", "callStackTrace", "isCurrent", "pointer", "inExpressionEvaluation", "previousPointer", "jThreadCallstack", "jElTok", "currentContainerPathStr", "jElementObj", "pushPopType", "currentContainerPathStrToken", "threadPointerResult", "Warning", "el", "temps", "JObjectToDictionaryRuntimeObjs", "clear", "prevContentObjPath", "prevPath", "PointerAtPath", "e", "WriteDictionaryRuntimeObjs", "resolvedPointer", "VariablesState", "variableChangedEvent", "callback", "variableChangedEventCallbacks", "StartVariableObservation", "_batchObservingVariableChanges", "_changedVariablesForBatchObs", "Set", "CompleteVariableObservation", "changedVars", "currentValue", "_globalVariables", "patch", "changedVariables", "patchedVal", "TryGetGlobal", "NotifyObservers", "_callStack", "$", "varContents", "_defaultGlobalVariables", "SetGlobal", "listDefsOrigin", "_listDefsOrigin", "Proxy", "ownKeys", "keys", "getOwnPropertyDescriptor", "enumerable", "configurable", "ApplyPatch", "namedVarKey", "namedVarValue", "globals", "add", "jToken", "varValKey", "varValValue", "loadedToken", "tokenInkObject", "keyValKey", "keyValValue", "dontSaveDefaultValues", "defaultVal", "RuntimeObjectsEqual", "obj1", "obj2", "GetVariableWithName", "GetRawVariableWithName", "varPointer", "ValueAtVariablePointer", "TryGetDefaultVariableValue", "GlobalVariableExistsWithName", "variableValue", "Assign", "setGlobal", "ResolveVariablePointer", "existingPointer", "SnapshotDefaultGlobals", "AddChangedVariable", "GetContextIndexOfVariableNamed", "doubleRedirectionPointer", "ObserveVariableChange", "PRNG", "seed", "next", "nextFloat", "StatePatch", "_globals", "_changedVariables", "visitCounts", "_visitCounts", "turnIndices", "_turnIndices", "TryGetVisitCount", "SetVisitCount", "SetTurnIndex", "TryGetTurnIndex", "SimpleJson", "Reader", "ToDictionary", "ToArray", "_", "__", "context", "explicitFloatReviver", "source", "endsWith", "_rootObject", "jsonWithExplicitFloat", "Writer", "_currentPropertyName", "_currentString", "_stateStack", "_collectionStack", "_propertyNameStack", "_jsonObject", "inner", "StartNewObject", "newObject", "state", "State", "Property", "currentCollection", "currentPropertyName", "propertyName", "None", "StateElement", "Object", "innerOrContent", "WriteFloatProperty", "IncrementChildCount", "childCount", "PropertyName", "_addToCurrentObject", "error", "POSITIVE_INFINITY", "NEGATIVE_INFINITY", "currEl", "Flow", "story", "outputStream", "currentChoices", "jChoiceThreadsObj", "LoadFlowChoiceThreads", "WriteListRuntimeObjs", "hasChoiceThreads", "jChoiceThreads", "foundActiveThread", "jSavedChoiceThread", "StoryState", "ToJson", "indented", "LoadJson", "json", "TextToDictionary", "LoadJsonObj", "onDidLoadState", "VisitCountAtPathString", "pathString", "visitCountOut", "_patch", "VisitCountForContainer", "containerPathStr", "count2", "IncrementVisitCountForContainer", "currCount", "RecordTurnIndexVisitToContainer", "currentTurnIndex", "TurnsSinceForContainer", "index2", "callstackDepth", "_currentFlow", "canContinue", "generatedChoices", "currentErrors", "_currentErrors", "currentWarnings", "_currentWarnings", "variablesState", "_variablesState", "evaluationStack", "_evaluationStack", "_currentTurnIndex", "currentPathString", "previousPathString", "hasError", "hasWarning", "currentText", "_outputStreamTextDirty", "inTag", "outputObj", "textContent", "controlCommand", "_currentText", "CleanOutputWhitespace", "currentWhitespaceStart", "startOfLine", "charAt", "currentTags", "_outputStreamTagsDirty", "_currentTags", "txt", "currentFlowName", "currentFlowIsDefaultFlow", "kDefaultFlowName", "aliveFlowNames", "_aliveFlowNamesDirty", "_aliveFlowNames", "_namedFlows", "flowName", "kInkSaveStateVersion", "kMinCompatibleLoadVersion", "divertedPointer", "storySeed", "previousRandom", "didSafeExit", "OutputStreamDirty", "timeSeed", "Date", "getTime", "GoToStart", "mainContentContainer", "SwitchFlow_Internal", "flow", "SwitchToDefaultFlow_Internal", "RemoveFlow_Internal", "CopyAndStartPatching", "forBackgroundSave", "namedFlowKey", "namedFlowValue", "RestoreAfterPatch", "ApplyAnyPatch", "ApplyCountChanges", "newCount", "isVisit", "WriteIntDictionary", "inkVersionCurrent", "jSaveVersion", "flowsObj", "flowsObjDict", "flowsObjDictEntries", "entries", "namedFlowObjKey", "namedFlowObjValue", "flowObj", "currFlowName", "currentDivertTargetPath", "divertPath", "JObjectToIntDictionary", "ResetErrors", "ResetOutput", "objs", "PushToOutputStream", "listText", "TrySplittingHeadTailWhitespace", "textObj", "PushToOutputStreamIndividual", "PopFromOutputStream", "single", "headFirstNewlineIdx", "headLastNewlineIdx", "tailLastNewlineIdx", "tailFirstNewlineIdx", "listTexts", "innerStrStart", "innerStrEnd", "leadingSpaces", "innerStrText", "numSpaces", "trailingSpaces", "glue", "includeInOutput", "TrimNewlinesFromOutputStream", "functionTrimIndex", "glueTrimIndex", "o", "trimIndex", "RemoveExistingGlue", "callStackElements", "outputStreamEndsInNewline", "outputStreamContainsContent", "removeWhitespaceFrom", "cmd", "inStringEvaluation", "PushEvaluationStack", "n", "PopEvaluationStack", "numberOfObjects", "PeekEvaluationStack", "ForceEnd", "TrimWhitespaceFromFunctionEnd", "functionStartPoint", "PopCallStack", "popType", "SetChosenPath", "incrementingTurnIndex", "newPointer", "StartFunctionEvaluationFromGame", "funcContainer", "PassArgumentsToEvaluationStack", "TryExitFunctionEvaluationFromGame", "CompleteFunctionEvaluationFromGame", "originalEvaluationStackHeight", "returnedObj", "poppedObj", "returnVal", "AddError", "isWarning", "Stopwatch", "startTime", "ElapsedMilliseconds", "Start", "Stop", "nVal", "isFinite", "choices", "_state", "IfAsyncWeCant", "_listDefinitions", "StartProfiling", "EndProfiling", "inkVersionMinimumCompatible", "onError", "onDidContinue", "onMakeChoice", "onEvaluateFunction", "onCompleteEvaluateFunction", "onChoosePathString", "_prevContainers", "allowExternalFunctionFallbacks", "_variableObservers", "_hasValidatedExternals", "_temporaryEvaluationContainer", "_asyncContinueActive", "_stateSnapshotAtLastNewline", "_sawLookaheadUnsafeFunctionAfterNewline", "_recursiveContinueCount", "_asyncSaving", "_profiler", "_mainContentContainer", "jsonString", "_externals", "rootObject", "versionObj", "formatFromFile", "listDefsObj", "rootToken", "JTokenToListDefinitions", "ResetState", "shouldReturn", "VariableStateDidChangeEvent", "bind", "ResetGlobals", "ResetCallstack", "originalPointer", "ChoosePath", "ContinueInternal", "SwitchFlow", "RemoveFlow", "SwitchToDefaultFlow", "Continue", "ContinueAsync", "asyncContinueComplete", "millisecsLimitAsync", "ValidateExternalBindings", "PreContinue", "isAsyncTimeLimited", "durationStopwatch", "ContinueSingleStep", "changedVariablesToObserve", "RestoreStateSnapshot", "PostContinue", "err", "PreStep", "Step", "PostStep", "TryFollowDefaultInvisibleChoice", "PreSnapshot", "change", "CalculateNewlineOutputStateChange", "OutputStateChange", "ExtendedBeyondNewline", "NewlineRemoved", "DiscardSnapshot", "StateSnapshot", "PostSnapshot", "prevText", "currText", "prevTagCount", "currTagCount", "newlineStillExists", "NoChange", "ContinueMaximally", "KnotContainerWithName", "pathLengthToUse", "CopyStateForBackgroundThreadSave", "stateToSave", "BackgroundSaveComplete", "shouldAddToStream", "containerToEnter", "VisitContainer", "currentContentObj", "isLogicOrFlowControl", "PerformLogicAndFlowControl", "ProcessChoice", "contextIdx", "NextContent", "atStart", "VisitChangedContainersDueToDivert", "prevAncestor", "currentChildOfContainer", "currentContainerAncestor", "allChildrenEnteredAtStart", "enteringAtStart", "PopChoiceStringAndTags", "choiceOnlyStrVal", "showChoice", "conditionValue", "IsTruthy", "startText", "choiceOnlyText", "reverse", "divTarget", "currentDivert", "intContent", "errorMessage", "CallExternalFunction", "sourceName", "evalCommand", "output", "overrideTunnelReturnTarget", "popped", "names", "expected", "errorMsg", "contentStackForTag", "outputCountConsumed", "command", "choiceTag", "contentStackForString", "contentToRetain", "rescuedTag", "choiceCount", "extraNote", "eitherCount", "divertTarget", "maxInt", "minInt", "randomRange", "resultSeed", "nextRandom", "chosenValue", "shuffleIndex", "NextSequenceShuffleIndex", "listNameVal", "generatedListValue", "foundItem", "targetList", "listItemIndex", "listEnumerator", "randomItem", "assignedVal", "foundValue", "func", "funcParams", "ChoosePathString", "resetCallstack", "funcDetail", "activityStr", "ChooseChoiceIndex", "choiceIdx", "choiceToChoose", "HasFunction", "EvaluateFunction", "returnTextOutput", "trim", "outputStreamBefore", "stringOutput", "textOutput", "returned", "EvaluateExpression", "exprContainer", "startCallStackHeight", "evalStackHeight", "funcName", "numberOfArguments", "funcDef", "fallbackFunctionContainer", "foundExternal", "lookAheadSafe", "valueObj", "funcResult", "function", "returnObj", "BindExternalFunctionGeneral", "lookaheadSafe", "TryCoerce", "BindExternalFunction", "coercedArgs", "apply", "UnbindExternalFunction", "missingExternals", "from", "innerContent", "ObserveVariable", "observer", "ObserveVariables", "variableNames", "observers", "RemoveVariableObserver", "specificVariableName", "variableObservers", "newValueObj", "globalTags", "TagsAtStartOfFlowContainerWithPathString", "TagsForContentAtPath", "flowContainer", "firstContent", "BuildStringOfContainer", "IncrementContentPointer", "didPop", "successfulIncrement", "nextAncestor", "indexInAncestor", "allChoices", "invisibleChoices", "numElementsIntVal", "seqContainer", "numElements", "seqCount", "loopIndex", "iterationIndex", "seqPathStr", "sequenceHash", "charCodeAt", "randomSeed", "random", "unpickedIndices", "chosen", "chosenIndex", "currentDebugMetadata", "errorTypeStr", "lineNum", "endLineNumber", "fileName", "NotificationManager", "options", "positions", "pos", "message", "config", "icons", "notification", "notificationObj", "element", "error", "index", "content", "iconSpan", "messageSpan", "closeBtn", "e", "progress", "isRight", "isLeft", "oldest", "newConfig", "styles", "notificationManager", "InkFunctions", "story", "str", "search", "replacement", "value", "min", "max", "total", "stat", "percent", "result", "start", "seconds", "minutes", "hours", "days", "timestamp", "locale", "date", "options", "years", "months", "ErrorManager", "_ErrorManager", "event", "source", "message", "error", "func", "fallback", "severity", "prefix", "errorDetails", "type", "notificationManager", "storyManager", "recoveryError", "errorManager", "ERROR_SOURCES", "log", "errorManager", "ERROR_SOURCES", "BaseModal", "_BaseModal", "options", "modalBackdrop", "modalContent", "sizeClass", "focusable", "first", "last", "closeBtn", "contentCallback", "mainContent", "topNav", "skipLink", "error", "content", "heading", "message", "onConfirm", "onCancel", "settings", "originalConfig", "modal", "footer", "cancelBtn", "confirmBtn", "e", "html", "body", "selector", "event", "handler", "element", "text", "button", "property", "value", "isError", "duration", "type", "notificationManager", "except", "title", "confirmText", "cancelText", "confirmVariant", "log", "errorManager", "ERROR_SOURCES", "StoryManager", "storyContent", "display", "settings", "contentProcessor", "Q", "InkFunctions", "error", "required", "missing", "_", "value", "key", "isFirstTime", "stoppedForUserInput", "stateBeforeUserInput", "choices", "choiceIndex", "choice", "notificationManager", "BaseModal", "content", "stateAtStart", "text", "tags", "processedContent", "item", "actionResult", "state", "hasUserInput", "currentText", "tempStory", "TAG_PHASE", "TAG_VALUE", "TAGS", "key", "TAG_LOOKUP", "name", "upper", "getTagsByPhase", "phase", "tag", "isKnownTag", "tagName", "getTagDef", "validateTagValue", "tagDef", "tagValue", "hasValue", "TagRegistry", "splitTag", "validation", "colonIdx", "tags", "label", "icon", "StoryFeatures", "storyContent", "content", "usesAnyTag", "tagDefs", "names", "def", "Utils", "knotName", "word", "b", "matrix", "i", "j", "cost", "log", "errorManager", "ERROR_SOURCES", "SMALL_SCROLL_PERCENT", "LARGE_SCROLL_PERCENT", "KeyboardShortcuts", "Utils", "event", "error", "scrollContainer", "smallScroll", "largeScroll", "choices", "key", "choiceIndex", "active", "outerContainer", "log", "errorManager", "ERROR_SOURCES", "KeyboardHelpModal", "Utils", "BaseModal", "modal", "footer", "closeBtn", "mod", "log", "errorManager", "ERROR_SOURCES", "MarkdownProcessor", "_MarkdownProcessor", "match", "text", "target", "pattern", "replacement", "error", "tokens", "result", "token", "current", "codeContent", "href", "isExternal", "str", "url", "log", "errorManager", "ERROR_SOURCES", "DOMHelpers", "storyContainer", "settings", "text", "customClasses", "paragraphElement", "className", "error", "choiceText", "isClickable", "keyHint", "showHint", "toneIndicators", "choiceIndex", "totalChoices", "container", "choiceElement", "leadingToneHTML", "trailingToneHTML", "srOnlyLabels", "ind", "buildIconSpan", "indicator", "icon", "hintPrefix", "choicePosition", "srChoicePrefix", "callback", "event", "tagName", "elements", "i", "current", "next", "selector", "allElements", "el", "visible", "newContainer", "log", "errorManager", "ERROR_SOURCES", "DisplayManager", "settings", "DOMHelpers", "content", "item", "index", "element", "error", "choices", "showNumbers", "totalChoices", "choicesContainer", "choice", "processedText", "MarkdownProcessor", "isBlockElement", "wrapper", "className", "imageElement", "elementToInsert", "figure", "figcaption", "value", "calculations", "container", "placeholder", "inputField", "submitBtn", "submitInput", "userInput", "e", "variableName", "currentValue", "range", "fillPercent", "clampedValue", "metrics", "displayName", "state", "savedHistory", "log", "errorManager", "ERROR_SOURCES", "ContentProcessor", "tagProcessor", "text", "tags", "TAGS", "contentOverride", "customClasses", "specialActions", "specialAction", "tag", "tagDef", "tagValue", "invalid", "TagRegistry", "imageData", "statBars", "t", "userInputData", "currentValue", "value", "imageValue", "altText", "remainingValue", "altTextMatch", "parts", "p", "src", "alignment", "width", "showCaption", "j", "part", "statValue", "quotedStrings", "quoteRegex", "match", "shouldClamp", "variableName", "min", "max", "numbers", "leftLabel", "rightLabel", "isOpposed", "keywords", "i", "isNumber", "isKeyword", "inputValue", "placeholder", "placeholderMatch", "actionFn", "result", "error", "log", "errorManager", "ERROR_SOURCES", "TagProcessor", "settings", "TAGS", "value", "ctx", "tags", "error", "choiceTags", "context", "allowTones", "tag", "tagDef", "tagValue", "invalid", "TagRegistry", "handler", "simpleHandler", "isPropertyTag", "tagName", "src", "message", "type", "duration", "notificationManager", "fullTag", "similar", "suggestion", "input", "known", "Utils", "log", "errorManager", "ERROR_SOURCES", "SettingsManager", "key", "value", "currentIsDark", "parsed", "error", "stored", "setting", "body", "html", "root", "fonts", "sizes", "heights", "height", "globalTags", "TAGS", "TagRegistry", "tag", "tagDef", "tagValue", "invalid", "el", "bylineElement", "numMode", "toneMode", "spaceIndex", "label", "icon", "fullTitle", "wasEnabled", "isEnabled", "tagProcessor", "tags", "indicators", "normalizedTag", "log", "errorManager", "ERROR_SOURCES", "SettingsModal", "settingsManager", "BaseModal", "settingsBtn", "modal", "footer", "resetBtn", "doneBtn", "helpBtn", "getValue", "name", "isCheckbox", "element", "prevAudioEnabled", "settings", "value", "checked", "elements", "setting", "tabs", "tab", "e", "tabId", "isActive", "panel", "event", "tabsArray", "currentIndex", "newIndex", "shouldShow", "StoryFeatures", "id", "icon", "label", "options", "optionsHtml", "opt", "className", "log", "errorManager", "ERROR_SOURCES", "PageManager", "storyManager", "knotName", "content", "error", "pageInfo", "Utils", "pages", "displayName", "tempStory", "fullText", "isFirstLine", "text", "tags", "currentText", "processedText", "MarkdownProcessor", "currentState", "items", "hasAnyTag", "tag", "processed", "item", "TagRegistry", "returnChoice", "namedContent", "TAGS", "tagDef", "tagValue", "globalTags", "colonIndex", "property", "value", "menuString", "sections", "s", "menuOrder", "section", "sectionIndex", "p", "pageName", "availablePages", "currentKnotName", "currentDisplayName", "results", "log", "errorManager", "ERROR_SOURCES", "ChoiceManager", "storyManager", "tagProcessor", "storyChoices", "choice", "index", "customClasses", "isClickable", "toneIndicators", "error", "choiceIndex", "text", "onClick", "classes", "safeOnClick", "onReturn", "tags", "choices", "clickableOnly", "prop", "c", "log", "errorManager", "ERROR_SOURCES", "NavigationManager", "storyManager", "buttonId", "clickHandler", "button", "newButton", "e", "error", "availablePages", "pageMenuOrder", "enabled", "visible", "knotName", "activeKnotName", "activeButton", "navControls", "panelContent", "closeButton", "settingsBtn", "currentSection", "addedPages", "item", "pageInfo", "separator", "link", "unorderedPages", "a", "b", "nameA", "nameB", "firstLink", "restoreFocus", "buttons", "buttonElement", "Utils", "states", "links", "buttonStates", "specialPageButtons", "totalButtons", "dynamicButtons", "s", "existingButtons", "visibleButtons", "currentPage", "log", "errorManager", "ERROR_SOURCES", "REFRESH_DELAY_MS", "SavesModal", "gameSaveSystem", "BaseModal", "contentHTML", "footer", "closeBtn", "message", "isError", "duration", "html", "i", "slotNumber", "isAutosave", "saveData", "error", "slotName", "emptyText", "helpText", "timestamp", "turnNumber", "text", "action", "variant", "ariaLabel", "n", "className", "handler", "e", "slot", "TEMPLATE_VERSION", "ErrorModal", "BaseModal", "title", "message", "suggestions", "error", "modal", "titleEl", "html", "s", "errorText", "consoleHint", "Utils", "footer", "closeBtn", "text", "div", "errorModal", "log", "errorManager", "ERROR_SOURCES", "MAX_IMPORT_SIZE_BYTES", "IMPORT_TIMEOUT_MS", "SavesManager", "storyManager", "SavesModal", "savesBtn", "slotNumber", "saveData", "error", "errorModal", "slotName", "isAutosave", "message", "saveKey", "confirmMessage", "dataStr", "dataBlob", "link", "timestamp", "titleSlug", "exportSlotName", "fileInput", "event", "file", "maxSizeMB", "reader", "timeout", "e", "importData", "i", "saveJson", "totalSaves", "oldestSave", "newestSave", "test", "isOnSpecialPage", "TEMPLATE_VERSION", "title", "currentPath", "displayState", "path", "pathParts", "name", "word", "history", "maxLength", "entry", "description", "duration", "saves", "a", "b", "oldestSlot", "errorManager", "notificationManager", "response", "storyContent", "StoryFeatures", "settings", "SettingsManager", "settingsModal", "SettingsModal", "tagProcessor", "TagProcessor", "contentProcessor", "ContentProcessor", "display", "DisplayManager", "storyManager", "StoryManager", "pages", "PageManager", "choices", "ChoiceManager", "navigation", "NavigationManager", "saves", "SavesManager", "keyboardShortcuts", "keyboardHelpModal", "Utils", "KeyboardHelpModal", "KeyboardShortcuts", "loadingScreen", "mainContent", "skipLink", "e", "target", "error", "ERROR_SOURCES", "showFallbackUI", "storyContainer", "showConsoleHelp"]
}
